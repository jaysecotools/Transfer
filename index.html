<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360° Image Marker Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: #f0f2f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: #4a6fa5;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .app-container {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            position: relative;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #4a6fa5;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e9ecef;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: #4a6fa5;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .file-input {
            width: 100%;
            padding: 15px;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .file-input:hover {
            background: #e9ecef;
        }

        .file-input i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #4a6fa5;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
        }

        .marker-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .marker-type {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .marker-type:hover {
            border-color: #4a6fa5;
        }

        .marker-type.active {
            border-color: #4a6fa5;
            background: #4a6fa5;
            color: white;
        }

        #threeContainer {
            width: 100%;
            height: 100%;
            background: #f8f9fa;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #6c757d;
        }

        .viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .viewer-controls .btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #dee2e6;
        }

        #markerList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }

        .marker-item {
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }

        .marker-item:hover {
            background: #e9ecef;
        }

        .export-btn {
            background: #6f42c1;
            color: white;
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-globe-americas"></i> 360° Image Marker Tool</h1>
            <p>Add interactive markers to your panoramic images</p>
        </header>

        <div class="app-container">
            <div class="sidebar">
                <!-- Upload Section -->
                <div class="section">
                    <h3><i class="fas fa-upload"></i> Upload Image</h3>
                    <div class="file-input" id="fileInput">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div>Click to upload 360° image</div>
                    </div>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                </div>

                <!-- Marker Settings -->
                <div class="section">
                    <h3><i class="fas fa-map-pin"></i> Marker Settings</h3>
                    <div class="marker-types">
                        <div class="marker-type active" data-type="info">
                            <i class="fas fa-info-circle"></i>
                            <div>Info</div>
                        </div>
                        <div class="marker-type" data-type="link">
                            <i class="fas fa-link"></i>
                            <div>Link</div>
                        </div>
                        <div class="marker-type" data-type="video">
                            <i class="fas fa-video"></i>
                            <div>Video</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <input type="text" id="markerTitle" class="form-control" placeholder="Marker Title">
                    </div>

                    <div class="form-group">
                        <textarea id="markerDescription" class="form-control" placeholder="Marker Description" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <input type="text" id="markerLink" class="form-control" placeholder="URL (for link markers)">
                    </div>

                    <button id="addMarkerBtn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-plus"></i> Add Marker
                    </button>
                </div>

                <!-- Markers List -->
                <div class="section">
                    <h3><i class="fas fa-list"></i> Markers</h3>
                    <div id="markerList">
                        <div class="empty-state">No markers added</div>
                    </div>
                    <button id="clearMarkers" class="btn btn-danger" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-trash"></i> Clear All Markers
                    </button>
                    <button id="exportBtn" class="btn export-btn">
                        <i class="fas fa-download"></i> Export Project
                    </button>
                </div>
            </div>

            <div class="main-content">
                <div id="threeContainer">
                    <div class="empty-state">
                        <i class="fas fa-globe-americas" style="font-size: 64px; margin-bottom: 20px; color: #dee2e6;"></i>
                        <h3>Upload a 360° Image to Begin</h3>
                        <p>Upload an equirectangular panorama image</p>
                    </div>
                </div>
                <div class="viewer-controls">
                    <button id="resetView" class="btn">
                        <i class="fas fa-crosshairs"></i> Reset
                    </button>
                    <button id="autoRotateBtn" class="btn">
                        <i class="fas fa-sync"></i> Auto Rotate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple state management
        let markers = [];
        let currentMarkerType = 'info';
        let scene, camera, renderer, controls, sphere;
        let autoRotate = false;
        
        // Initialize when page loads
        window.onload = function() {
            console.log('Page loaded, setting up...');
            setupEventListeners();
            initThreeJS();
        };

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // File upload
            document.getElementById('fileInput').onclick = function() {
                document.getElementById('imageUpload').click();
            };
            
            document.getElementById('imageUpload').onchange = function(e) {
                loadImage(e.target.files[0]);
            };
            
            // Marker type selection
            document.querySelectorAll('.marker-type').forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll('.marker-type').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMarkerType = this.dataset.type;
                };
            });
            
            // Add marker button
            document.getElementById('addMarkerBtn').onclick = function() {
                addMarker();
            };
            
            // Clear markers button
            document.getElementById('clearMarkers').onclick = function() {
                if (confirm('Clear all markers?')) {
                    markers = [];
                    updateMarkerList();
                    // Clear 3D markers
                    if (scene) {
                        scene.children.forEach(child => {
                            if (child.userData && child.userData.isMarker) {
                                scene.remove(child);
                            }
                        });
                    }
                }
            };
            
            // Export button
            document.getElementById('exportBtn').onclick = function() {
                exportProject();
            };
            
            // Viewer controls
            document.getElementById('resetView').onclick = function() {
                if (controls) controls.reset();
            };
            
            document.getElementById('autoRotateBtn').onclick = function() {
                autoRotate = !autoRotate;
                this.innerHTML = autoRotate ? 
                    '<i class="fas fa-pause"></i> Stop' : 
                    '<i class="fas fa-sync"></i> Auto Rotate';
            };
            
            console.log('Event listeners setup complete');
        }

        function initThreeJS() {
            console.log('Initializing Three.js...');
            
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f2f5);
            
            // Create camera
            const container = document.getElementById('threeContainer');
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 0.1);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // Create controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            // Add lights
            const light = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(light);
            
            // Start animation loop
            animate();
            
            console.log('Three.js initialized');
        }

        function loadImage(file) {
            if (!file) return;
            
            console.log('Loading image:', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Remove existing sphere
                if (sphere) {
                    scene.remove(sphere);
                }
                
                // Clear markers
                markers = [];
                updateMarkerList();
                
                // Create texture
                const texture = new THREE.TextureLoader().load(e.target.result);
                
                // Create sphere
                const geometry = new THREE.SphereGeometry(10, 64, 32);
                geometry.scale(-1, 1, 1); // Invert to see from inside
                
                const material = new THREE.MeshBasicMaterial({ map: texture });
                sphere = new THREE.Mesh(geometry, material);
                scene.add(sphere);
                
                // Hide empty state
                document.querySelector('#threeContainer .empty-state').style.display = 'none';
                
                console.log('Image loaded successfully');
            };
            
            reader.readAsDataURL(file);
        }

        function addMarker() {
            if (!sphere) {
                alert('Please upload an image first');
                return;
            }
            
            const title = document.getElementById('markerTitle').value || 'New Marker';
            const description = document.getElementById('markerDescription').value;
            const link = document.getElementById('markerLink').value;
            
            // Get camera direction for marker position
            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            const position = direction.multiplyScalar(10);
            
            // Create marker object
            const marker = {
                id: Date.now(),
                type: currentMarkerType,
                title: title,
                description: description,
                link: link,
                position: { x: position.x, y: position.y, z: position.z }
            };
            
            markers.push(marker);
            
            // Create 3D marker
            create3DMarker(marker);
            
            // Update UI
            updateMarkerList();
            
            // Clear form
            document.getElementById('markerTitle').value = '';
            document.getElementById('markerDescription').value = '';
            document.getElementById('markerLink').value = '';
            
            console.log('Marker added:', marker);
        }

        function create3DMarker(marker) {
            const colors = {
                info: 0x17a2b8,
                link: 0x28a745,
                video: 0xdc3545
            };
            
            // Create marker sphere
            const geometry = new THREE.SphereGeometry(0.3, 16, 16);
            const material = new THREE.MeshBasicMaterial({ 
                color: colors[marker.type] || 0x17a2b8,
                transparent: true,
                opacity: 0.8
            });
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(marker.position.x, marker.position.y, marker.position.z);
            mesh.userData = { 
                isMarker: true,
                markerId: marker.id,
                markerData: marker
            };
            
            scene.add(mesh);
            
            // Add click interaction
            renderer.domElement.addEventListener('click', function onClick(event) {
                const rect = renderer.domElement.getBoundingClientRect();
                const mouse = new THREE.Vector2();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, camera);
                
                const intersects = raycaster.intersectObject(mesh);
                if (intersects.length > 0) {
                    showMarkerInfo(marker);
                }
            });
            
            return mesh;
        }

        function showMarkerInfo(marker) {
            let info = `<strong>${marker.title}</strong>`;
            if (marker.description) info += `<br>${marker.description}`;
            if (marker.link) info += `<br><a href="${marker.link}" target="_blank">${marker.link}</a>`;
            
            alert(info);
        }

        function updateMarkerList() {
            const list = document.getElementById('markerList');
            
            if (markers.length === 0) {
                list.innerHTML = '<div class="empty-state">No markers added</div>';
                return;
            }
            
            let html = '';
            markers.forEach(marker => {
                const icons = {
                    info: 'info-circle',
                    link: 'link',
                    video: 'video'
                };
                
                html += `
                    <div class="marker-item" data-id="${marker.id}">
                        <i class="fas fa-${icons[marker.type] || 'info-circle'}"></i>
                        ${marker.title}
                    </div>
                `;
            });
            
            list.innerHTML = html;
            
            // Add click handlers to list items
            list.querySelectorAll('.marker-item').forEach(item => {
                item.onclick = function() {
                    const markerId = parseInt(this.dataset.id);
                    const marker = markers.find(m => m.id === markerId);
                    if (marker) {
                        showMarkerInfo(marker);
                    }
                };
            });
        }

        function exportProject() {
            if (markers.length === 0) {
                alert('Please add some markers first');
                return;
            }
            
            const projectData = {
                markers: markers,
                exportDate: new Date().toISOString()
            };
            
            // Create HTML content
            const html = `
<!DOCTYPE html>
<html>
<head>
    <title>360° Viewer</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #viewer { width: 100vw; height: 100vh; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"><\/script>
</head>
<body>
    <div id="viewer"></div>
    <script>
        // Simple exported viewer
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('viewer').appendChild(renderer.domElement);
        
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        camera.position.set(0, 0, 0.1);
        
        // Note: Image would need to be hosted separately or included as base64
        // Markers data: ${JSON.stringify(projectData.markers)}
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    <\/script>
</body>
</html>`;
            
            // Download the file
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '360-viewer.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Project exported as 360-viewer.html');
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (autoRotate && sphere) {
                sphere.rotation.y += 0.001;
            }
            
            if (controls) controls.update();
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('threeContainer');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>
