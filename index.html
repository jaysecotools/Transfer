<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Australian Retirement Financial Planner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px 0;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        .compliance-banner {
            background: var(--warning);
            color: white;
            padding: 10px;
            font-size: 0.9rem;
            border-radius: 5px;
            margin: 15px auto;
            max-width: 90%;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .user-guide-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        
        .user-guide-btn:hover {
            background: white;
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .user-guide-btn i {
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .user-guide-btn {
                position: relative;
                top: auto;
                right: auto;
                margin: 15px auto 0;
                display: inline-flex;
                width: auto;
            }
            
            header {
                padding-bottom: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .user-guide-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            
            .user-guide-btn i {
                font-size: 1rem;
            }
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }
        
        .input-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .results-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .input-with-info {
            display: flex;
            align-items: center;
        }
        
        .info-icon {
            margin-left: 10px;
            color: var(--secondary);
            cursor: help;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .input-error {
            border-color: var(--danger);
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .btn {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .result-card {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .result-label {
            font-size: 0.9rem;
            color: var(--dark);
            opacity: 0.8;
        }
        
        .chart-container {
            height: 300px;
            margin: 25px 0;
        }
        
        .recommendations {
            margin-top: 30px;
        }
        
        .recommendation {
            background: var(--light);
            padding: 15px;
            border-left: 4px solid var(--secondary);
            margin-bottom: 15px;
            border-radius: 0 5px 5px 0;
        }
        
        .recommendation.warning {
            border-left-color: var(--warning);
        }
        
        .recommendation.success {
            border-left-color: var(--success);
        }
        
        .recommendation.danger {
            border-left-color: var(--danger);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .hidden {
            display: none;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--dark);
            opacity: 0.7;
            font-size: 0.9rem;
        }
        
        .scenario-comparison {
            margin-top: 30px;
        }
        
        .scenario-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        
        .scenario-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .scenario-tab.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }
        
        .scenario-content {
            display: none;
        }
        
        .scenario-content.active {
            display: block;
        }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .scenario-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .scenario-age {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .scenario-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .super-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary);
        }
        
        .strategy-section {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary);
        }
        
        .strategy-option {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #e1e8ed;
        }
        
        .tax-impact {
            background: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid var(--warning);
        }
        
        .pension-test {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid var(--success);
        }
        
        .allocation-chart {
            height: 200px;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .allocation-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        .allocation-label {
            font-weight: 500;
        }
        
        .allocation-percent {
            font-weight: 600;
            color: var(--primary);
        }
        
        .net-worth-summary {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .net-worth-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .net-worth-total {
            font-weight: bold;
            font-size: 1.2rem;
            border-bottom: none;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid var(--dark);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .last-updated {
            font-size: 0.8rem;
            color: var(--dark);
            opacity: 0.7;
            margin-top: 10px;
            text-align: center;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .validation-summary {
            background: #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning);
            display: none;
        }
        
        .validation-summary ul {
            margin-left: 20px;
        }
        
        .smsf-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid var(--info);
        }
        
        .debt-section {
            background: #fff5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid var(--danger);
        }
        
        .insurance-section {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid var(--info);
        }

        .auto-calc-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .auto-calc-label {
            font-weight: 600;
            color: var(--dark);
        }

        .auto-calc-note {
            font-size: 0.8rem;
            color: var(--dark);
            opacity: 0.7;
            margin-top: 5px;
        }

        .auto-retirement-section {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--info);
        }

        .auto-retirement-result {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            border: 1px solid var(--secondary);
        }

        .calculated-age {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
            margin: 10px 0;
        }

        .use-calculated-btn {
            margin-top: 10px;
            background: var(--info);
        }

        .use-calculated-btn:hover {
            background: #138496;
        }
        
        .min-retirement-section {
            background: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid var(--warning);
        }
        
        .min-retirement-result {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            border: 1px solid var(--warning);
        }
        
        .min-calculated-age {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--warning);
            margin: 10px 0;
        }
        
        .use-min-calculated-btn {
            margin-top: 10px;
            background: var(--warning);
        }
        
        .use-min-calculated-btn:hover {
            background: #e67e22;
        }
        
        .shortfall {
            color: var(--danger);
        }
        
        .surplus {
            color: var(--success);
        }

        /* Dependents Section Styles */
        .dependents-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--info);
        }

        .dependent-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #e1e8ed;
            position: relative;
        }

        .dependent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .dependent-title {
            font-weight: 600;
            color: var(--primary);
        }

        .remove-dependent {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .dependent-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .dependent-fields {
                grid-template-columns: 1fr;
            }
        }

        .expense-timeline {
            background: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid var(--warning);
        }

        .timeline-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .timeline-year {
            font-weight: 600;
            color: var(--primary);
        }

        .timeline-change {
            font-weight: 600;
        }

        .positive-change {
            color: var(--success);
        }

        .negative-change {
            color: var(--danger);
        }

        .text-muted {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="USER_GUIDE.html" class="user-guide-btn">
                <i class="fas fa-book"></i>
                User Guide
            </a>
            
            <h1>Advanced Australian Retirement Financial Planner</h1>
            <p class="subtitle">Comprehensive retirement planning with dependents, expense timeline & family considerations</p>
            
            <div class="compliance-banner">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Important:</strong> This tool provides general information only and does not constitute financial advice. 
                You should consult with a qualified financial advisor before making any financial decisions. 
                Calculations are based on current Australian rules as of 2024 and are subject to change.
            </div>
        </header>
        
        <div class="validation-summary" id="validation-summary">
            <h3><i class="fas fa-exclamation-triangle"></i> Please correct the following issues:</h3>
            <ul id="validation-errors"></ul>
        </div>
        
        <div class="app-container">
            <div class="input-section">
                <h2 class="section-title">Your Financial Information</h2>
                
                <div class="auto-calc-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-calculate">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="auto-calc-label">Enable Auto-Calculation</span>
                </div>
                <div class="auto-calc-note">
                    When enabled, calculations will update automatically as you change values
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="basic">Basic Info</div>
                    <div class="tab" data-tab="dependents">Dependents</div>
                    <div class="tab" data-tab="partner">Partner</div>
                    <div class="tab" data-tab="super">Super & Assets</div>
                    <div class="tab" data-tab="strategies">Strategies</div>
                    <div class="tab" data-tab="income">Income & Expenses</div>
                </div>
                
                <div class="tab-content active" id="basic-tab">
                    <div class="form-group">
                        <label for="current-age">Your Current Age</label>
                        <input type="number" id="current-age" min="18" max="100" value="45">
                        <div class="error-message" id="current-age-error">Age must be between 18 and 100</div>
                    </div>
                    
                    <div class="auto-retirement-section">
                        <h4>Auto Retirement Age Calculation</h4>
                        <p>Based on your financial inputs, we'll calculate retirement age options for you.</p>
                        <button id="calculate-retirement-age" class="btn btn-block">Calculate Retirement Age Options</button>
                        
                        <div id="auto-retirement-result" class="auto-retirement-result hidden">
                            <div class="result-label">Calculated Optimal Retirement Age</div>
                            <div class="calculated-age" id="calculated-age">65</div>
                            <p>This age is calculated based on your current savings, contributions, and retirement goals.</p>
                            <button id="use-calculated-age" class="btn use-calculated-btn">Use This Age</button>
                        </div>
                        
                        <div id="min-retirement-result" class="min-retirement-result hidden">
                            <div class="result-label">Minimum Viable Retirement Age</div>
                            <div class="min-calculated-age" id="min-calculated-age">60</div>
                            <p>This is the earliest age you could potentially retire while maintaining basic expenses.</p>
                            <button id="use-min-calculated-age" class="btn use-min-calculated-btn">Use This Age</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="retirement-age">Your Desired Retirement Age</label>
                        <input type="number" id="retirement-age" min="40" max="100" value="65">
                        <div class="error-message" id="retirement-age-error">Retirement age must be after current age</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="life-expectancy">Life Expectancy</label>
                        <select id="life-expectancy">
                            <option value="85">Average (85 years)</option>
                            <option value="90" selected>Above Average (90 years)</option>
                            <option value="95">Longevity (95 years)</option>
                            <option value="100">Exceptional Longevity (100 years)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="inflation">Expected Annual Inflation (%)</label>
                        <div class="input-with-info">
                            <input type="number" id="inflation" min="0" max="10" step="0.1" value="2.5">
                            <div class="tooltip info-icon">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltiptext">Reserve Bank of Australia targets 2-3% inflation. Historical average is around 2.5%.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="investment-return">Expected Annual Investment Return (%)</label>
                        <div class="input-with-info">
                            <input type="number" id="investment-return" min="0" max="20" step="0.1" value="7">
                            <div class="tooltip info-icon">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltiptext">Historical average for balanced super funds is 6-8% p.a. over the long term.</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dependents Tab -->
                <div class="tab-content" id="dependents-tab">
                    <div class="dependents-section">
                        <h3>Dependents & Family Structure</h3>
                        <p>Add your children or other dependents to calculate how their education and living expenses will impact your finances over time.</p>
                        
                        <div id="dependents-container">
                            <!-- Dynamic dependent items will be added here -->
                        </div>
                        
                        <button id="add-dependent" class="btn btn-block">Add Dependent</button>
                    </div>
                    
                    <div class="expense-timeline">
                        <h4>Expense Timeline Preview</h4>
                        <p>Based on your dependents' ages and education plans:</p>
                        <div id="expense-timeline-preview">
                            <p class="text-muted">Add dependents to see how your expenses will change over time</p>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="partner-tab">
                    <div class="checkbox-group">
                        <input type="checkbox" id="has-partner">
                        <label for="has-partner">I have a partner/spouse</label>
                    </div>
                    
                    <div id="partner-details" class="hidden">
                        <div class="form-group">
                            <label for="partner-age">Partner's Age</label>
                            <input type="number" id="partner-age" min="18" max="100" value="42">
                            <div class="error-message" id="partner-age-error">Partner age must be between 18 and 100</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="partner-retirement-age">Partner's Retirement Age</label>
                            <input type="number" id="partner-retirement-age" min="40" max="100" value="65">
                            <div class="error-message" id="partner-retirement-age-error">Partner retirement age must be after partner's current age</div>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="partner-keep-working" checked>
                            <label for="partner-keep-working">Partner continues working after I retire</label>
                        </div>
                        
                        <div class="form-group">
                            <label for="partner-income">Partner's Annual Income</label>
                            <input type="number" id="partner-income" min="0" value="70000">
                        </div>
                        
                        <div class="form-group">
                            <label for="partner-super">Partner's Super Balance</label>
                            <input type="number" id="partner-super" min="0" value="120000">
                        </div>
                        
                        <div class="form-group">
                            <label for="partner-contribution">Partner's Annual Super Contribution</label>
                            <input type="number" id="partner-contribution" min="0" value="8500">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="super-tab">
                    <div class="super-info">
                        <h4>Australian Superannuation</h4>
                        <p>Your employer contributes 11% of your earnings to super (increasing to 11.5% from 1 July 2024). Additional contributions may be tax-deductible.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="current-income">Your Current Annual Income</label>
                        <input type="number" id="current-income" min="0" value="95000">
                    </div>
                    
                    <div class="form-group">
                        <label for="current-super">Your Current Super Balance</label>
                        <input type="number" id="current-super" min="0" value="280000">
                    </div>
                    
                    <div class="form-group">
                        <label for="additional-contribution">Additional Salary Sacrifice (Annual)</label>
                        <input type="number" id="additional-contribution" min="0" value="5000">
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="high-income-earner">
                        <label for="high-income-earner">I earn over $250,000 annually (Division 293 tax may apply)</label>
                    </div>
                    
                    <div class="smsf-section">
                        <h4>Self-Managed Super Fund (SMSF)</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="has-smsf">
                            <label for="has-smsf">I have a Self-Managed Super Fund</label>
                        </div>
                        
                        <div id="smsf-details" class="hidden">
                            <div class="form-group">
                                <label for="smsf-admin-costs">Annual SMSF Administration Costs</label>
                                <input type="number" id="smsf-admin-costs" min="0" value="4000">
                            </div>
                        </div>
                    </div>
                    
                    <h3>Property Assets</h3>
                    
                    <div class="form-group">
                        <label for="primary-residence-value">Primary Residence Value</label>
                        <input type="number" id="primary-residence-value" min="0" value="750000">
                    </div>
                    
                    <div class="form-group">
                        <label for="primary-residence-debt">Primary Residence Mortgage</label>
                        <input type="number" id="primary-residence-debt" min="0" value="250000">
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="consider-downsizing">
                        <label for="consider-downsizing">Considering downsizing primary residence</label>
                    </div>
                    
                    <div id="downsizing-details" class="hidden">
                        <div class="form-group">
                            <label for="downsize-value">Expected Downsized Property Value</label>
                            <input type="number" id="downsize-value" min="0" value="500000">
                        </div>
                        
                        <div class="form-group">
                            <label for="downsize-age">Planned Downsizing Age</label>
                            <input type="number" id="downsize-age" min="55" max="85" value="70">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="investment-properties">Investment Properties Value</label>
                        <input type="number" id="investment-properties" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="investment-properties-debt">Investment Properties Debt</label>
                        <input type="number" id="investment-properties-debt" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="other-assets">Other Assets Value (Shares, Savings, etc.)</label>
                        <input type="number" id="other-assets" min="0" value="50000">
                    </div>
                    
                    <div class="debt-section">
                        <h4>Other Debts</h4>
                        <div class="form-group">
                            <label for="personal-debt">Personal Loans/Credit Cards</label>
                            <input type="number" id="personal-debt" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="strategies-tab">
                    <div class="strategy-section">
                        <h3>Transition to Retirement (TTR) Strategy</h3>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="consider-ttr">
                            <label for="consider-ttr">Consider Transition to Retirement strategy</label>
                        </div>
                        
                        <div id="ttr-details" class="hidden">
                            <div class="form-group">
                                <label for="ttr-start-age">Start TTR at Age</label>
                                <input type="number" id="ttr-start-age" min="55" max="75" value="60">
                            </div>
                            
                            <div class="form-group">
                                <label for="ttr-income">Desired TTR Income (% of salary)</label>
                                <input type="number" id="ttr-income" min="10" max="100" value="50">
                            </div>
                            
                            <div class="form-group">
                                <label for="ttr-salary-sacrifice">Additional Salary Sacrifice during TTR (%)</label>
                                <input type="number" id="ttr-salary-sacrifice" min="0" max="50" value="15">
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-section">
                        <h3>Investment Strategy</h3>
                        
                        <div class="form-group">
                            <label for="risk-profile">Your Risk Profile</label>
                            <select id="risk-profile">
                                <option value="conservative">Conservative</option>
                                <option value="moderate" selected>Moderate</option>
                                <option value="balanced">Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="high-growth">High Growth</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="current-allocation">Current Super Asset Allocation</label>
                            <select id="current-allocation">
                                <option value="conservative">Conservative (30% growth)</option>
                                <option value="moderate">Moderate (50% growth)</option>
                                <option value="balanced" selected>Balanced (70% growth)</option>
                                <option value="growth">Growth (85% growth)</option>
                                <option value="high-growth">High Growth (100% growth)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="insurance-section">
                        <h3>Insurance Considerations</h3>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="has-income-protection">
                            <label for="has-income-protection">I have income protection insurance</label>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="has-life-insurance">
                            <label for="has-life-insurance">I have life insurance</label>
                        </div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="has-tpd-insurance">
                            <label for="has-tpd-insurance">I have total and permanent disability (TPD) insurance</label>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="income-tab">
                    <div class="form-group">
                        <label for="current-expenses">Current Annual Household Expenses</label>
                        <input type="number" id="current-expenses" min="0" value="85000">
                        <div class="tooltip info-icon">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltiptext">Include all living costs: mortgage, food, utilities, insurance, transport, education, etc.</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="annual-child-cost">Average Annual Cost per Child at Home</label>
                        <input type="number" id="annual-child-cost" min="0" value="15000">
                        <div class="tooltip info-icon">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltiptext">Includes food, clothing, extracurricular activities, share of utilities, etc. Excludes major education costs.</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="education-costs">Total Annual Education Costs</label>
                        <input type="number" id="education-costs" min="0" value="25000">
                        <div class="tooltip info-icon">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltiptext">School fees, tutoring, uniforms, books, etc. This will reduce as children finish education.</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="retirement-expenses">Expected Retirement Expenses (% of Current)</label>
                        <input type="number" id="retirement-expenses" min="50" max="150" value="65">
                        <div class="tooltip info-icon">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltiptext">Typically 60-80% of pre-retirement expenses. Lower if mortgage paid off and children independent.</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="healthcare-costs">Expected Annual Healthcare Costs in Retirement</label>
                        <input type="number" id="healthcare-costs" min="0" value="7000">
                    </div>
                    
                    <div class="form-group">
                        <label for="travel-budget">Annual Travel Budget in Retirement</label>
                        <input type="number" id="travel-budget" min="0" value="5000">
                    </div>
                    
                    <div class="form-group">
                        <label for="other-retirement-costs">Other Expected Retirement Costs</label>
                        <input type="number" id="other-retirement-costs" min="0" value="3000">
                    </div>
                </div>
                
                <button id="calculate-btn" class="btn btn-block">Calculate Retirement Plan</button>
                
                <div class="loading" id="calculation-loading">
                    <div class="loading-spinner"></div>
                    <p>Calculating your retirement plan...</p>
                </div>
                
                <div class="action-buttons">
                    <button id="save-btn" class="btn btn-success">Save Data Locally</button>
                    <button id="load-btn" class="btn btn-warning">Load Saved Data</button>
                    <button id="reset-btn" class="btn btn-danger">Reset to Defaults</button>
                </div>
                
                <div class="last-updated">
                    Last updated: July 2024 | Based on current Australian regulations
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title">Your Retirement Plan</h2>
                
                <div id="results-placeholder">
                    <p>Enter your financial information and click "Calculate Retirement Plan" to see your personalized retirement strategy.</p>
                </div>
                
                <div id="results-content" class="hidden">
                    <div class="net-worth-summary">
                        <h3>Current Net Worth Summary</h3>
                        <div class="net-worth-item">
                            <span>Assets:</span>
                            <span id="net-worth-assets">$0</span>
                        </div>
                        <div class="net-worth-item">
                            <span>Liabilities:</span>
                            <span id="net-worth-liabilities">$0</span>
                        </div>
                        <div class="net-worth-item net-worth-total">
                            <span>Net Worth:</span>
                            <span id="net-worth-total">$0</span>
                        </div>
                    </div>
                    
                    <!-- Family Expense Timeline -->
                    <div class="strategy-section">
                        <h3>Family Expense Timeline</h3>
                        <div id="family-timeline-analysis">
                            <!-- Timeline will be populated here -->
                        </div>
                    </div>
                    
                    <div class="scenario-comparison">
                        <h3>Retirement Scenarios</h3>
                        <div class="scenario-tabs">
                            <div class="scenario-tab active" data-scenario="55">Age 55</div>
                            <div class="scenario-tab" data-scenario="60">Age 60</div>
                            <div class="scenario-tab" data-scenario="65">Age 65</div>
                            <div class="scenario-tab" data-scenario="67">Age 67</div>
                            <div class="scenario-tab" data-scenario="70">Age 70</div>
                        </div>
                        
                        <div class="scenario-content active" id="scenario-55">
                            <div class="scenario-grid">
                                <div class="scenario-card">
                                    <div class="scenario-age">Age 55</div>
                                    <div class="result-label">Years to Retirement</div>
                                    <div class="scenario-value" id="scenario-55-years">10</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Projected Super</div>
                                    <div class="scenario-value" id="scenario-55-super">$450,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Annual Retirement Income</div>
                                    <div class="scenario-value" id="scenario-55-income">$42,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Retirement Shortfall</div>
                                    <div class="scenario-value shortfall" id="scenario-55-shortfall" style="display: none;">$18,000</div>
                                    <div class="result-label">Retirement Surplus</div>
                                    <div class="scenario-value surplus" id="scenario-55-surplus" style="display: none;">$0</div>
                                </div>
                            </div>
                            <div class="recommendation warning">
                                <h4>Age 55 Retirement Considerations</h4>
                                <p id="scenario-55-family-context">Family context will be shown here</p>
                                <p><strong>Preservation Age:</strong> You've reached preservation age, allowing access to super via TTR strategy.</p>
                            </div>
                        </div>
                        
                        <div class="scenario-content" id="scenario-60">
                            <div class="scenario-grid">
                                <div class="scenario-card">
                                    <div class="scenario-age">Age 60</div>
                                    <div class="result-label">Years to Retirement</div>
                                    <div class="scenario-value" id="scenario-60-years">15</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Projected Super</div>
                                    <div class="scenario-value" id="scenario-60-super">$680,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Annual Retirement Income</div>
                                    <div class="scenario-value" id="scenario-60-income">$54,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Retirement Shortfall</div>
                                    <div class="scenario-value shortfall" id="scenario-60-shortfall" style="display: none;">$6,000</div>
                                    <div class="result-label">Retirement Surplus</div>
                                    <div class="scenario-value surplus" id="scenario-60-surplus" style="display: none;">$0</div>
                                </div>
                            </div>
                            <div class="recommendation">
                                <h4>Age 60 Retirement Considerations</h4>
                                <p id="scenario-60-family-context">Family context will be shown here</p>
                                <p><strong>Tax Benefits:</strong> Super withdrawals are tax-free from age 60 for most people.</p>
                            </div>
                        </div>
                        
                        <div class="scenario-content" id="scenario-65">
                            <div class="scenario-grid">
                                <div class="scenario-card">
                                    <div class="scenario-age">Age 65</div>
                                    <div class="result-label">Years to Retirement</div>
                                    <div class="scenario-value" id="scenario-65-years">20</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Projected Super</div>
                                    <div class="scenario-value" id="scenario-65-super">$950,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Annual Retirement Income</div>
                                    <div class="scenario-value" id="scenario-65-income">$68,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Retirement Shortfall</div>
                                    <div class="scenario-value shortfall" id="scenario-65-shortfall" style="display: none;">$0</div>
                                    <div class="result-label">Retirement Surplus</div>
                                    <div class="scenario-value surplus" id="scenario-65-surplus" style="display: none;">$8,000</div>
                                </div>
                            </div>
                            <div class="recommendation success">
                                <h4>Age 65 Retirement Considerations</h4>
                                <p id="scenario-65-family-context">Family context will be shown here</p>
                                <p><strong>Age Pension:</strong> You may be eligible for a full or partial Age Pension depending on your assets.</p>
                            </div>
                        </div>
                        
                        <div class="scenario-content" id="scenario-67">
                            <div class="scenario-grid">
                                <div class="scenario-card">
                                    <div class="scenario-age">Age 67</div>
                                    <div class="result-label">Years to Retirement</div>
                                    <div class="scenario-value" id="scenario-67-years">22</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Projected Super</div>
                                    <div class="scenario-value" id="scenario-67-super">$1,100,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Annual Retirement Income</div>
                                    <div class="scenario-value" id="scenario-67-income">$75,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Retirement Shortfall</div>
                                    <div class="scenario-value shortfall" id="scenario-67-shortfall" style="display: none;">$0</div>
                                    <div class="result-label">Retirement Surplus</div>
                                    <div class="scenario-value surplus" id="scenario-67-surplus" style="display: none;">$15,000</div>
                                </div>
                            </div>
                            <div class="recommendation success">
                                <h4>Age 67 Retirement Considerations</h4>
                                <p id="scenario-67-family-context">Family context will be shown here</p>
                                <p><strong>Age Pension Age:</strong> This is the current eligibility age for Age Pension.</p>
                            </div>
                        </div>
                        
                        <div class="scenario-content" id="scenario-70">
                            <div class="scenario-grid">
                                <div class="scenario-card">
                                    <div class="scenario-age">Age 70</div>
                                    <div class="result-label">Years to Retirement</div>
                                    <div class="scenario-value" id="scenario-70-years">25</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Projected Super</div>
                                    <div class="scenario-value" id="scenario-70-super">$1,250,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Annual Retirement Income</div>
                                    <div class="scenario-value" id="scenario-70-income">$82,000</div>
                                </div>
                                <div class="scenario-card">
                                    <div class="result-label">Retirement Shortfall</div>
                                    <div class="scenario-value shortfall" id="scenario-70-shortfall" style="display: none;">$0</div>
                                    <div class="result-label">Retirement Surplus</div>
                                    <div class="scenario-value surplus" id="scenario-70-surplus" style="display: none;">$22,000</div>
                                </div>
                            </div>
                            <div class="recommendation success">
                                <h4>Age 70 Retirement Considerations</h4>
                                <p id="scenario-70-family-context">Family context will be shown here</p>
                                <p><strong>Transfer Balance Cap:</strong> Be mindful of the $1.9 million cap on super in retirement phase.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="strategy-section">
                        <h3>Transition to Retirement Analysis</h3>
                        <div id="ttr-analysis">
                            <!-- TTR analysis will be populated here -->
                        </div>
                    </div>
                    
                    <div class="strategy-section">
                        <h3>Downsizing Strategy Analysis</h3>
                        <div id="downsizing-analysis">
                            <!-- Downsizing analysis will be populated here -->
                        </div>
                    </div>
                    
                    <div class="strategy-section">
                        <h3>Age Pension Eligibility</h3>
                        <div class="pension-test" id="pension-test">
                            <!-- Age Pension test results will be populated here -->
                        </div>
                    </div>
                    
                    <div class="strategy-section">
                        <h3>Tax Considerations in Retirement</h3>
                        <div class="tax-impact" id="tax-analysis">
                            <!-- Tax analysis will be populated here -->
                        </div>
                    </div>
                    
                    <div class="strategy-section">
                        <h3>Recommended Asset Allocation</h3>
                        <div class="allocation-chart">
                            <canvas id="allocation-chart"></canvas>
                        </div>
                        <div id="allocation-recommendation">
                            <!-- Allocation recommendation will be populated here -->
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="retirement-chart"></canvas>
                    </div>
                    
                    <div class="recommendations">
                        <h3 class="section-title">Strategic Recommendations</h3>
                        <div id="recommendations-list">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="export-pdf" class="btn">Export as PDF</button>
                        <button id="print-plan" class="btn">Print Plan</button>
                        <button id="save-report" class="btn btn-success">Save Report</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>Disclaimer:</strong> This retirement planner is for informational purposes only and does not constitute financial advice. 
            The calculations are based on current Australian regulations as of 2024 and are subject to change. 
            You should consult with a qualified financial advisor before making any financial decisions.</p>
            <p>All data is stored locally on your device and is not transmitted to any server.</p>
            <p>Australian Superannuation and Age Pension rules are subject to change. Verify current regulations with the ATO and Services Australia.</p>
            <p>This tool considers: Superannuation Industry (Supervision) Act 1993, Social Security Act 1991, and relevant tax legislation.</p>
        </div>
    </div>

    <script>
    // Australian Financial Constants (2024)
    const AUSTRALIAN_RULES = {
        SUPER_CONTRIBUTION_RATE: 0.11,
        SUPER_CONTRIBUTION_RATE_2024: 0.115,
        TRANSFER_BALANCE_CAP: 1900000,
        DIVISION_293_THRESHOLD: 250000,
        DOWNSIZER_CONTRIBUTION_LIMIT: 300000,
        AGE_PENSION_AGE: 67,
        PRESERVATION_AGE: 55,
        TAX_FREE_SUPER_AGE: 60,
        
        AGE_PENSION: {
            SINGLE: {
                FULL: 1364.80,
                ASSETS_TEST: {
                    FULL: 301750,
                    PARTIAL: 935000
                },
                INCOME_TEST: {
                    FULL: 204,
                    PARTIAL: 2368
                }
            },
            COUPLE: {
                FULL: 2057.00,
                ASSETS_TEST: {
                    FULL: 451500,
                    PARTIAL: 1402000
                },
                INCOME_TEST: {
                    FULL: 360,
                    PARTIAL: 3640
                }
            }
        },
        
        TAX_RATES: {
            INDIVIDUAL: [
                { threshold: 0, rate: 0 },
                { threshold: 18200, rate: 0.19 },
                { threshold: 45000, rate: 0.325 },
                { threshold: 120000, rate: 0.37 },
                { threshold: 180000, rate: 0.45 }
            ],
            SUPER_CONTRIBUTIONS: 0.15,
            DIVISION_293: 0.15
        }
    };

    // Dependent management
    let dependents = [];
    let dependentCounter = 0;

    // Chart variables
    let retirementChart = null;
    let allocationChart = null;
    let autoCalculateTimeout = null;

    function formatCurrency(amount) {
        try {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '$0';
            }
            return new Intl.NumberFormat('en-AU', {
                style: 'currency',
                currency: 'AUD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        } catch (error) {
            console.error('Currency formatting error:', error);
            return '$0';
        }
    }

    function calculateInflationAdjustedValue(currentValue, years, inflationRate) {
        return safeCalculate(() => {
            return currentValue * Math.pow(1 + inflationRate, years);
        }) || currentValue;
    }

    function projectSuperBalance(currentBalance, annualContribution, years, returnRate) {
        return safeCalculate(() => {
            let balance = currentBalance;
            for (let i = 0; i < years; i++) {
                balance = balance * (1 + returnRate) + annualContribution;
            }
            return balance;
        }) || currentBalance;
    }

    function calculateSustainableWithdrawal(superBalance, retirementYears, returnRate, inflationRate) {
        return safeCalculate(() => {
            const conservativeWithdrawalRate = 0.04;
            const dynamicRate = Math.min(0.05, 0.04 + (returnRate - inflationRate - 0.02));
            return superBalance * dynamicRate;
        }) || (superBalance * 0.04);
    }

    function validateFinancialInput(value, fieldName) {
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue < 0) {
            console.warn(`Invalid ${fieldName}: ${value}`);
            return 0;
        }
        return numValue;
    }

    function safeCalculate(callback, fallback = null) {
        try {
            const result = callback();
            if (result !== null && result !== undefined && !isNaN(result)) {
                return result;
            }
            return fallback;
        } catch (error) {
            console.error('Calculation error:', error);
            return fallback;
        }
    }

    function calculateAgePension(assets, income, isCouple, age) {
        return safeCalculate(() => {
            if (age < AUSTRALIAN_RULES.AGE_PENSION_AGE) {
                return 0;
            }
            
            const rules = isCouple ? AUSTRALIAN_RULES.AGE_PENSION.COUPLE : AUSTRALIAN_RULES.AGE_PENSION.SINGLE;
            
            let pensionFromAssets = rules.FULL * 26;
            
            if (assets > rules.ASSETS_TEST.FULL) {
                const excessAssets = assets - rules.ASSETS_TEST.FULL;
                const reduction = (excessAssets / 1000) * 3 * 26;
                pensionFromAssets = Math.max(0, pensionFromAssets - reduction);
            }
            
            if (assets >= rules.ASSETS_TEST.PARTIAL) {
                pensionFromAssets = 0;
            }
            
            const fortnightlyIncome = income / 26;
            let pensionFromIncome = rules.FULL * 26;
            
            if (fortnightlyIncome > rules.INCOME_TEST.FULL) {
                const excessIncome = fortnightlyIncome - rules.INCOME_TEST.FULL;
                const reduction = excessIncome * 0.5 * 26;
                pensionFromIncome = Math.max(0, pensionFromIncome - reduction);
            }
            
            if (fortnightlyIncome >= rules.INCOME_TEST.PARTIAL) {
                pensionFromIncome = 0;
            }
            
            return Math.min(pensionFromAssets, pensionFromIncome);
        }) || 0;
    }

    // Dependent management functions
    function addDependent() {
        const dependent = {
            id: dependentCounter++,
            name: `Child ${dependentCounter}`,
            age: 15,
            educationType: 'secondary',
            supportUntil: 18,
            annualCost: 15000
        };
        
        dependents.push(dependent);
        renderDependents();
        updateExpenseTimelinePreview();
    }

    function removeDependent(id) {
        dependents = dependents.filter(dep => dep.id !== id);
        renderDependents();
        updateExpenseTimelinePreview();
    }

    function renderDependents() {
        const container = document.getElementById('dependents-container');
        container.innerHTML = '';
        
        dependents.forEach(dependent => {
            const dependentElement = document.createElement('div');
            dependentElement.className = 'dependent-item';
            dependentElement.innerHTML = `
                <div class="dependent-header">
                    <div class="dependent-title">${dependent.name}</div>
                    <button type="button" class="remove-dependent" onclick="removeDependent(${dependent.id})">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <div class="dependent-fields">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" value="${dependent.name}" onchange="updateDependent(${dependent.id}, 'name', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Current Age</label>
                        <input type="number" min="0" max="30" value="${dependent.age}" onchange="updateDependent(${dependent.id}, 'age', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Education Type</label>
                        <select onchange="updateDependent(${dependent.id}, 'educationType', this.value)">
                            <option value="secondary" ${dependent.educationType === 'secondary' ? 'selected' : ''}>Secondary School</option>
                            <option value="university" ${dependent.educationType === 'university' ? 'selected' : ''}>University</option>
                            <option value="tafe" ${dependent.educationType === 'tafe' ? 'selected' : ''}>TAFE/Apprenticeship</option>
                            <option value="none" ${dependent.educationType === 'none' ? 'selected' : ''}>No Further Education</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Support Until Age</label>
                        <input type="number" min="18" max="30" value="${dependent.supportUntil}" onchange="updateDependent(${dependent.id}, 'supportUntil', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(dependentElement);
        });
        
        if (dependents.length === 0) {
            container.innerHTML = '<p class="text-muted">No dependents added yet. Click "Add Dependent" to start.</p>';
        }
    }

    function updateDependent(id, field, value) {
        const dependent = dependents.find(dep => dep.id === id);
        if (dependent) {
            dependent[field] = value;
            if (field === 'educationType') {
                switch(value) {
                    case 'secondary':
                        dependent.supportUntil = 18;
                        break;
                    case 'university':
                        dependent.supportUntil = 22;
                        break;
                    case 'tafe':
                        dependent.supportUntil = 20;
                        break;
                    case 'none':
                        dependent.supportUntil = 18;
                        break;
                }
            }
            renderDependents();
            updateExpenseTimelinePreview();
        }
    }

    // Fixed: Expense timeline calculation
    function calculateExpenseTimeline(currentAge, currentExpenses, dependents, educationCosts, annualChildCost) {
        const timeline = [];
        const currentYear = new Date().getFullYear();
        const baseExpenses = currentExpenses - (dependents.length * annualChildCost) - educationCosts;
        
        const dependentLeavingYears = dependents.map(dep => {
            return {
                year: currentYear + (dep.supportUntil - dep.age),
                costReduction: annualChildCost,
                name: dep.name
            };
        });
        
        const educationEndYears = dependents.map(dep => {
            let educationEndAge = dep.supportUntil;
            if (dep.educationType === 'secondary') {
                educationEndAge = 18;
            }
            return {
                year: currentYear + (educationEndAge - dep.age),
                costReduction: educationCosts / dependents.length,
                name: `${dep.name} education`
            };
        });
        
        const allEvents = [...dependentLeavingYears, ...educationEndYears];
        allEvents.sort((a, b) => a.year - b.year);
        
        let currentAnnualExpense = currentExpenses;
        let year = currentYear;
        const maxYears = 30;
        
        for (let i = 0; i < maxYears; i++) {
            const eventsThisYear = allEvents.filter(event => event.year === year);
            
            eventsThisYear.forEach(event => {
                currentAnnualExpense -= event.costReduction;
            });
            
            if (eventsThisYear.length > 0 || year === currentYear) {
                timeline.push({
                    year: year,
                    age: currentAge + (year - currentYear),
                    annualExpense: currentAnnualExpense,
                    events: eventsThisYear
                });
            }
            
            year++;
        }
        
        return timeline;
    }

    function updateExpenseTimelinePreview() {
        const container = document.getElementById('expense-timeline-preview');
        
        if (dependents.length === 0) {
            container.innerHTML = '<p class="text-muted">Add dependents to see how your expenses will change over time</p>';
            return;
        }
        
        const currentAge = validateFinancialInput(document.getElementById('current-age').value, 'current age');
        const currentExpenses = validateFinancialInput(document.getElementById('current-expenses').value, 'current expenses');
        const educationCosts = validateFinancialInput(document.getElementById('education-costs').value, 'education costs');
        const annualChildCost = validateFinancialInput(document.getElementById('annual-child-cost').value, 'annual child cost');
        
        const timeline = calculateExpenseTimeline(currentAge, currentExpenses, dependents, educationCosts, annualChildCost);
        
        let html = '<div class="expense-timeline">';
        timeline.slice(0, 5).forEach(item => {
            html += `<div class="timeline-item">
                <div class="timeline-year">${item.year} (Age ${item.age})</div>
                <div class="timeline-value">${formatCurrency(item.annualExpense)}</div>
            </div>`;
            
            item.events.forEach(event => {
                html += `<div class="timeline-item" style="padding-left: 20px; font-size: 0.9rem;">
                    <div class="timeline-event">${event.name} ends</div>
                    <div class="timeline-change negative-change">-${formatCurrency(event.costReduction)}</div>
                </div>`;
            });
        });
        
        if (timeline.length > 5) {
            html += `<div class="timeline-item">
                <div class="timeline-year">...</div>
                <div class="timeline-value">...</div>
            </div>`;
            
            const finalState = timeline[timeline.length - 1];
            html += `<div class="timeline-item">
                <div class="timeline-year">${finalState.year} (Age ${finalState.age})</div>
                <div class="timeline-value">${formatCurrency(finalState.annualExpense)}</div>
            </div>`;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    // Fixed: Enhanced expense calculation for retirement scenarios
    function calculateRetirementExpensesWithDependents(scenarioAge, currentAge, currentExpenses, retirementExpenseRate, 
                                                     dependents, educationCosts, annualChildCost, inflationRate) {
        const yearsToRetirement = scenarioAge - currentAge;
        const currentYear = new Date().getFullYear();
        const retirementYear = currentYear + yearsToRetirement;
        
        const baseHouseholdExpenses = currentExpenses - (dependents.length * annualChildCost) - educationCosts;
        
        // FIXED: Properly calculate which dependents will still be at home at retirement
        const dependentsAtRetirement = dependents.filter(dep => {
            const ageAtRetirement = dep.age + yearsToRetirement;
            // A dependent is only at home if they haven't reached their supportUntil age
            return ageAtRetirement < dep.supportUntil;
        });
        
        // FIXED: Calculate remaining education costs more accurately
        let remainingEducationCosts = 0;
        dependents.forEach(dep => {
            const ageAtRetirement = dep.age + yearsToRetirement;
            
            // Only count education costs if the dependent is still in education at retirement
            if (ageAtRetirement < dep.supportUntil) {
                if (dep.educationType === 'secondary' && ageAtRetirement < 18) {
                    // Full secondary education costs
                    remainingEducationCosts += educationCosts / dependents.length;
                } else if ((dep.educationType === 'university' || dep.educationType === 'tafe') && ageAtRetirement >= 18) {
                    // Tertiary education costs (typically lower than full household costs)
                    remainingEducationCosts += (educationCosts / dependents.length) * 0.7;
                }
            }
        });
        
        let retirementExpenses = baseHouseholdExpenses * (retirementExpenseRate / 100);
        retirementExpenses += (dependentsAtRetirement.length * annualChildCost);
        retirementExpenses += remainingEducationCosts;
        
        retirementExpenses = calculateInflationAdjustedValue(retirementExpenses, yearsToRetirement, inflationRate);
        
        return {
            retirementExpenses: retirementExpenses,
            dependentsAtRetirement: dependentsAtRetirement,
            remainingEducationCosts: remainingEducationCosts
        };
    }

    // Initialize function
    function initializeApp() {
        // DOM Elements
        const calculateBtn = document.getElementById('calculate-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const resetBtn = document.getElementById('reset-btn');
        const exportPdfBtn = document.getElementById('export-pdf');
        const printPlanBtn = document.getElementById('print-plan');
        const saveReportBtn = document.getElementById('save-report');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const resultsContent = document.getElementById('results-content');
        const hasPartnerCheckbox = document.getElementById('has-partner');
        const partnerDetails = document.getElementById('partner-details');
        const partnerKeepWorking = document.getElementById('partner-keep-working');
        const considerDownsizingCheckbox = document.getElementById('consider-downsizing');
        const downsizingDetails = document.getElementById('downsizing-details');
        const considerTTRCheckbox = document.getElementById('consider-ttr');
        const ttrDetails = document.getElementById('ttr-details');
        const hasSmsfCheckbox = document.getElementById('has-smsf');
        const smsfDetails = document.getElementById('smsf-details');
        const highIncomeEarnerCheckbox = document.getElementById('high-income-earner');
        const scenarioTabs = document.querySelectorAll('.scenario-tab');
        const scenarioContents = document.querySelectorAll('.scenario-content');
        const validationSummary = document.getElementById('validation-summary');
        const validationErrors = document.getElementById('validation-errors');
        const calculationLoading = document.getElementById('calculation-loading');
        const autoCalculateCheckbox = document.getElementById('auto-calculate');
        
        // New elements for auto retirement age calculation
        const calculateRetirementAgeBtn = document.getElementById('calculate-retirement-age');
        const autoRetirementResult = document.getElementById('auto-retirement-result');
        const calculatedAgeElement = document.getElementById('calculated-age');
        const useCalculatedAgeBtn = document.getElementById('use-calculated-age');
        
        // New elements for minimum retirement age calculation
        const minRetirementResult = document.getElementById('min-retirement-result');
        const minCalculatedAgeElement = document.getElementById('min-calculated-age');
        const useMinCalculatedAgeBtn = document.getElementById('use-min-calculated-age');
        
        // Dependents elements
        const addDependentBtn = document.getElementById('add-dependent');
        
        // Input fields
        const currentAge = document.getElementById('current-age');
        const retirementAge = document.getElementById('retirement-age');
        const lifeExpectancy = document.getElementById('life-expectancy');
        const inflation = document.getElementById('inflation');
        const investmentReturn = document.getElementById('investment-return');
        const currentSuper = document.getElementById('current-super');
        const currentIncome = document.getElementById('current-income');
        const additionalContribution = document.getElementById('additional-contribution');
        const currentExpenses = document.getElementById('current-expenses');
        const retirementExpenses = document.getElementById('retirement-expenses');
        const healthcareCosts = document.getElementById('healthcare-costs');
        const travelBudget = document.getElementById('travel-budget');
        const otherRetirementCosts = document.getElementById('other-retirement-costs');
        
        // Expense inputs
        const annualChildCost = document.getElementById('annual-child-cost');
        const educationCosts = document.getElementById('education-costs');
        
        // Partner fields
        const partnerAge = document.getElementById('partner-age');
        const partnerRetirementAge = document.getElementById('partner-retirement-age');
        const partnerIncome = document.getElementById('partner-income');
        const partnerSuper = document.getElementById('partner-super');
        const partnerContribution = document.getElementById('partner-contribution');
        
        // Strategy fields
        const downsizeValue = document.getElementById('downsize-value');
        const downsizeAge = document.getElementById('downsize-age');
        const ttrStartAge = document.getElementById('ttr-start-age');
        const ttrIncome = document.getElementById('ttr-income');
        const ttrSalarySacrifice = document.getElementById('ttr-salary-sacrifice');
        const riskProfile = document.getElementById('risk-profile');
        const currentAllocation = document.getElementById('current-allocation');
        
        // Asset and debt fields
        const investmentProperties = document.getElementById('investment-properties');
        const investmentPropertiesDebt = document.getElementById('investment-properties-debt');
        const primaryResidenceValue = document.getElementById('primary-residence-value');
        const primaryResidenceDebt = document.getElementById('primary-residence-debt');
        const otherAssets = document.getElementById('other-assets');
        const personalDebt = document.getElementById('personal-debt');
        const smsfAdminCosts = document.getElementById('smsf-admin-costs');
        
        // Insurance fields
        const hasIncomeProtection = document.getElementById('has-income-protection');
        const hasLifeInsurance = document.getElementById('has-life-insurance');
        const hasTpdInsurance = document.getElementById('has-tpd-insurance');
        
        // Result fields
        const netWorthAssets = document.getElementById('net-worth-assets');
        const netWorthLiabilities = document.getElementById('net-worth-liabilities');
        const netWorthTotal = document.getElementById('net-worth-total');
        
        const scenario55Years = document.getElementById('scenario-55-years');
        const scenario55Super = document.getElementById('scenario-55-super');
        const scenario55Income = document.getElementById('scenario-55-income');
        const scenario55Shortfall = document.getElementById('scenario-55-shortfall');
        const scenario55Surplus = document.getElementById('scenario-55-surplus');
        
        const scenario60Years = document.getElementById('scenario-60-years');
        const scenario60Super = document.getElementById('scenario-60-super');
        const scenario60Income = document.getElementById('scenario-60-income');
        const scenario60Shortfall = document.getElementById('scenario-60-shortfall');
        const scenario60Surplus = document.getElementById('scenario-60-surplus');
        
        const scenario65Years = document.getElementById('scenario-65-years');
        const scenario65Super = document.getElementById('scenario-65-super');
        const scenario65Income = document.getElementById('scenario-65-income');
        const scenario65Shortfall = document.getElementById('scenario-65-shortfall');
        const scenario65Surplus = document.getElementById('scenario-65-surplus');
        
        const scenario67Years = document.getElementById('scenario-67-years');
        const scenario67Super = document.getElementById('scenario-67-super');
        const scenario67Income = document.getElementById('scenario-67-income');
        const scenario67Shortfall = document.getElementById('scenario-67-shortfall');
        const scenario67Surplus = document.getElementById('scenario-67-surplus');
        
        const scenario70Years = document.getElementById('scenario-70-years');
        const scenario70Super = document.getElementById('scenario-70-super');
        const scenario70Income = document.getElementById('scenario-70-income');
        const scenario70Shortfall = document.getElementById('scenario-70-shortfall');
        const scenario70Surplus = document.getElementById('scenario-70-surplus');
        
        const ttrAnalysis = document.getElementById('ttr-analysis');
        const downsizingAnalysis = document.getElementById('downsizing-analysis');
        const pensionTest = document.getElementById('pension-test');
        const taxAnalysis = document.getElementById('tax-analysis');
        const allocationRecommendation = document.getElementById('allocation-recommendation');
        const recommendationsList = document.getElementById('recommendations-list');

        // Add default dependents for demonstration (3 teenage children)
        addDependent();
        addDependent();
        addDependent();

        // Dependents event listeners
        addDependentBtn.addEventListener('click', addDependent);
        
        // Update timeline when relevant inputs change
        [currentAge, currentExpenses, educationCosts, annualChildCost].forEach(input => {
            if (input) {
                input.addEventListener('input', updateExpenseTimelinePreview);
            }
        });

        // Tab functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });
        

        function calculateOptimalRetirementAge() {
            return safeCalculate(() => {
                // Get input values with proper sanitization and defaults
                const age = validateFinancialInput(currentAge.value, 'current age') || 45;
                const superBalance = validateFinancialInput(currentSuper.value, 'super balance') || 0;
                const income = validateFinancialInput(currentIncome.value, 'income') || 0;
                const additionalContributionValue = validateFinancialInput(additionalContribution.value, 'additional contribution') || 0;
                
                // FIXED: Use current super contribution rate, not 2024 rate
                const employerContribution = income * AUSTRALIAN_RULES.SUPER_CONTRIBUTION_RATE;
                const totalContribution = employerContribution + additionalContributionValue;
                
                const expenses = validateFinancialInput(currentExpenses.value, 'expenses') || 0;
                const retirementExpenseRate = Math.max(0.5, Math.min(1.5, (validateFinancialInput(retirementExpenses.value, 'retirement expenses') || 75) / 100));
                const healthcare = validateFinancialInput(healthcareCosts.value, 'healthcare costs') || 0;
                const travel = validateFinancialInput(travelBudget.value, 'travel budget') || 0;
                const otherCosts = validateFinancialInput(otherRetirementCosts.value, 'other costs') || 0;
                const inflationRate = Math.max(0, Math.min(0.1, (validateFinancialInput(inflation.value, 'inflation') || 2.5) / 100));
                const returnRate = Math.max(-0.5, Math.min(0.2, (validateFinancialInput(investmentReturn.value, 'investment return') || 7) / 100));
                const expectancy = Math.max(age + 10, Math.min(120, validateFinancialInput(lifeExpectancy.value, 'life expectancy') || 90));
                
                // Calculate base retirement expenses (adjusted for inflation)
                const baseRetirementExpenses = (expenses * retirementExpenseRate) + healthcare + travel + otherCosts;
                
                // Calculate required retirement savings using the 4% rule with safety check
                const requiredSavings = baseRetirementExpenses > 0 ? baseRetirementExpenses / 0.04 : expenses * 10;
                
                // Calculate years needed to reach required savings
                let projectedSuper = superBalance;
                let years = 0;
                let maxYears = Math.min(50, expectancy - age - 5); // Reasonable maximum
                
                while (projectedSuper < requiredSavings && years < maxYears && returnRate > -0.5) {
                    projectedSuper = projectedSuper * (1 + returnRate) + totalContribution;
                    years++;
                    
                    // NEW: Use inflation adjustment function
                    const inflationAdjustedRequiredSavings = calculateInflationAdjustedValue(requiredSavings, years, inflationRate);
                    
                    if (projectedSuper >= inflationAdjustedRequiredSavings || years >= maxYears) {
                        break;
                    }
                }
                
                // Calculate optimal retirement age with constraints
                let optimalAge = age + years;
                optimalAge = Math.max(optimalAge, AUSTRALIAN_RULES.PRESERVATION_AGE);
                optimalAge = Math.min(optimalAge, expectancy - 5, 75);
                
                return Math.round(optimalAge);
            }) || 65;
        }
        
        // New function to calculate minimum retirement age
        function calculateMinimumRetirementAge() {
            return safeCalculate(() => {
                // Get input values with proper sanitization and defaults
                const age = validateFinancialInput(currentAge.value, 'current age') || 45;
                const superBalance = validateFinancialInput(currentSuper.value, 'super balance') || 0;
                const income = validateFinancialInput(currentIncome.value, 'income') || 0;
                const additionalContributionValue = validateFinancialInput(additionalContribution.value, 'additional contribution') || 0;
                
                // FIXED: Use current super contribution rate, not 2024 rate
                const employerContribution = income * AUSTRALIAN_RULES.SUPER_CONTRIBUTION_RATE;
                const totalContribution = employerContribution + additionalContributionValue;
                
                const expenses = validateFinancialInput(currentExpenses.value, 'expenses') || 0;
                const retirementExpenseRate = Math.max(0.5, Math.min(1.5, (validateFinancialInput(retirementExpenses.value, 'retirement expenses') || 75) / 100));
                const healthcare = validateFinancialInput(healthcareCosts.value, 'healthcare costs') || 0;
                const travel = validateFinancialInput(travelBudget.value, 'travel budget') || 0;
                const otherCosts = validateFinancialInput(otherRetirementCosts.value, 'other costs') || 0;
                const inflationRate = Math.max(0, Math.min(0.1, (validateFinancialInput(inflation.value, 'inflation') || 2.5) / 100));
                const returnRate = Math.max(-0.5, Math.min(0.2, (validateFinancialInput(investmentReturn.value, 'investment return') || 7) / 100));
                const expectancy = Math.max(age + 10, Math.min(120, validateFinancialInput(lifeExpectancy.value, 'life expectancy') || 90));
                
                // Calculate minimum viable retirement expenses (basic needs only)
                const basicRetirementExpenses = (expenses * 0.5) + healthcare; // Only basic expenses + healthcare
                
                // Calculate required retirement savings for basic needs
                const requiredBasicSavings = basicRetirementExpenses > 0 ? basicRetirementExpenses / 0.04 : expenses * 5;
                
                // Calculate years needed to reach basic savings
                let projectedSuper = superBalance;
                let years = 0;
                let maxYears = Math.min(50, expectancy - age - 5); // Reasonable maximum
                
                while (projectedSuper < requiredBasicSavings && years < maxYears && returnRate > -0.5) {
                    projectedSuper = projectedSuper * (1 + returnRate) + totalContribution;
                    years++;
                    
                    // NEW: Use inflation adjustment function
                    const inflationAdjustedRequiredSavings = calculateInflationAdjustedValue(requiredBasicSavings, years, inflationRate);
                    
                    if (projectedSuper >= inflationAdjustedRequiredSavings || years >= maxYears) {
                        break;
                    }
                }
                
                // Calculate minimum retirement age with constraints
                let minAge = age + years;
                minAge = Math.max(minAge, AUSTRALIAN_RULES.PRESERVATION_AGE);
                minAge = Math.min(minAge, expectancy - 5, 75);
                
                return Math.round(minAge);
            }) || 60;
        }
        
        // Event listener for calculating retirement age options
        calculateRetirementAgeBtn.addEventListener('click', function() {
            const optimalAge = calculateOptimalRetirementAge();
            const minAge = calculateMinimumRetirementAge();
            
            calculatedAgeElement.textContent = optimalAge;
            minCalculatedAgeElement.textContent = minAge;
            
            autoRetirementResult.classList.remove('hidden');
            minRetirementResult.classList.remove('hidden');
        });
        
        // Event listener for using calculated optimal age
        useCalculatedAgeBtn.addEventListener('click', function() {
            const optimalAge = calculatedAgeElement.textContent;
            retirementAge.value = optimalAge;
            autoRetirementResult.classList.add('hidden');
            minRetirementResult.classList.add('hidden');
            
            // If auto-calculation is enabled, recalculate the full plan
            if (autoCalculateCheckbox.checked && validateInputs()) {
                calculateRetirement();
            }
        });
        
        // Event listener for using calculated minimum age
        useMinCalculatedAgeBtn.addEventListener('click', function() {
            const minAge = minCalculatedAgeElement.textContent;
            retirementAge.value = minAge;
            autoRetirementResult.classList.add('hidden');
            minRetirementResult.classList.add('hidden');
            
            // If auto-calculation is enabled, recalculate the full plan
            if (autoCalculateCheckbox.checked && validateInputs()) {
                calculateRetirement();
            }
        });
        
        // Auto-calculation function
        function setupAutoCalculation() {
            // Get all input elements that should trigger auto-calculation
            const inputElements = [
                currentAge, retirementAge, lifeExpectancy, inflation, investmentReturn,
                currentSuper, currentIncome, additionalContribution, currentExpenses,
                retirementExpenses, healthcareCosts, travelBudget, otherRetirementCosts,
                partnerAge, partnerRetirementAge, partnerIncome, partnerSuper, partnerContribution,
                downsizeValue, downsizeAge, ttrStartAge, ttrIncome, ttrSalarySacrifice,
                investmentProperties, investmentPropertiesDebt, primaryResidenceValue,
                primaryResidenceDebt, otherAssets, personalDebt, smsfAdminCosts
            ];
            
            // Get all select elements
            const selectElements = [riskProfile, currentAllocation];
            
            // Get all checkbox elements
            const checkboxElements = [
                hasPartnerCheckbox, partnerKeepWorking, considerDownsizingCheckbox,
                considerTTRCheckbox, hasSmsfCheckbox, highIncomeEarnerCheckbox,
                hasIncomeProtection, hasLifeInsurance, hasTpdInsurance
            ];
            
            // Add event listeners to all inputs
            inputElements.forEach(input => {
                if (input) {
                    input.addEventListener('input', handleAutoCalculation);
                }
            });
            
            // Add event listeners to all selects
            selectElements.forEach(select => {
                if (select) {
                    select.addEventListener('change', handleAutoCalculation);
                }
            });
            
            // Add event listeners to all checkboxes
            checkboxElements.forEach(checkbox => {
                if (checkbox) {
                    checkbox.addEventListener('change', handleAutoCalculation);
                }
            });
        }
        
        // Handle auto-calculation with debouncing
        function handleAutoCalculation() {
            if (!autoCalculateCheckbox.checked) return;
            
            // Clear existing timeout
            if (autoCalculateTimeout) {
                clearTimeout(autoCalculateTimeout);
            }
            
            // Set new timeout for calculation (500ms delay)
            autoCalculateTimeout = setTimeout(() => {
                if (validateInputs()) {
                    calculateRetirement();
                }
            }, 500);
        }
        
        // Auto-calculation toggle event
        autoCalculateCheckbox.addEventListener('change', function() {
            if (this.checked && resultsContent.classList.contains('hidden')) {
                // If auto-calc is enabled but no results yet, do initial calculation
                if (validateInputs()) {
                    calculateRetirement();
                }
            }
        });
        
        // Tab functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show active tab content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });
        
        // Scenario tab functionality
        scenarioTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const scenarioId = tab.getAttribute('data-scenario');
                
                // Update active scenario tab
                scenarioTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show active scenario content
                scenarioContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `scenario-${scenarioId}`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // Scenario tab functionality
        scenarioTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const scenarioId = tab.getAttribute('data-scenario');
                
                scenarioTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                scenarioContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `scenario-${scenarioId}`) {
                        content.classList.add('active');
                    }
                });
            });
        });
        
        // Partner checkbox toggle
        hasPartnerCheckbox.addEventListener('change', function() {
            if (this.checked) {
                partnerDetails.classList.remove('hidden');
            } else {
                partnerDetails.classList.add('hidden');
            }
        });
        
        // Downsizing checkbox toggle
        considerDownsizingCheckbox.addEventListener('change', function() {
            if (this.checked) {
                downsizingDetails.classList.remove('hidden');
            } else {
                downsizingDetails.classList.add('hidden');
            }
        });
        
        // TTR checkbox toggle
        considerTTRCheckbox.addEventListener('change', function() {
            if (this.checked) {
                ttrDetails.classList.remove('hidden');
            } else {
                ttrDetails.classList.add('hidden');
            }
        });
        
        // SMSF checkbox toggle
        hasSmsfCheckbox.addEventListener('change', function() {
            if (this.checked) {
                smsfDetails.classList.remove('hidden');
            } else {
                smsfDetails.classList.add('hidden');
            }
        });
        
        // Input validation
        function validateInputs() {
            const errors = [];
            
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            
            const age = validateFinancialInput(currentAge.value, 'current age') || 45;
            if (isNaN(age) || age < 18 || age > 100) {
                errors.push("Current age must be between 18 and 100");
                currentAge.classList.add('input-error');
                document.getElementById('current-age-error').style.display = 'block';
            }
            
            const retireAge = validateFinancialInput(retirementAge.value, 'retirement age') || 65;
            if (isNaN(retireAge) || retireAge < age || retireAge > 100) {
                errors.push("Retirement age must be after current age and no more than 100");
                retirementAge.classList.add('input-error');
                document.getElementById('retirement-age-error').style.display = 'block';
            }
            
            if (hasPartnerCheckbox.checked) {
                const partnerAgeValue = validateFinancialInput(partnerAge.value, 'partner age') || 42;
                if (isNaN(partnerAgeValue) || partnerAgeValue < 18 || partnerAgeValue > 100) {
                    errors.push("Partner age must be between 18 and 100");
                    partnerAge.classList.add('input-error');
                    document.getElementById('partner-age-error').style.display = 'block';
                }
                
                const partnerRetireAge = validateFinancialInput(partnerRetirementAge.value, 'partner retirement age') || 65;
                if (isNaN(partnerRetireAge) || partnerRetireAge < partnerAgeValue || partnerRetireAge > 100) {
                    errors.push("Partner retirement age must be after partner's current age");
                    partnerRetirementAge.classList.add('input-error');
                    document.getElementById('partner-retirement-age-error').style.display = 'block';
                }
            }
            
            const investmentReturnValue = validateFinancialInput(investmentReturn.value, 'investment return');
            if (isNaN(investmentReturnValue) || investmentReturnValue < -50 || investmentReturnValue > 50) {
                errors.push("Investment return must be between -50% and 50%");
                investmentReturn.classList.add('input-error');
            }
            
            if (errors.length > 0) {
                validationErrors.innerHTML = '';
                errors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    validationErrors.appendChild(li);
                });
                validationSummary.style.display = 'block';
                return false;
            } else {
                validationSummary.style.display = 'none';
                return true;
            }
        }
        
        // Calculate retirement plan
        calculateBtn.addEventListener('click', function() {
            if (!validateInputs()) {
                return;
            }
            
            calculationLoading.style.display = 'block';
            calculateBtn.disabled = true;
            setLoadingState(true);
            
            setTimeout(() => {
                try {
                    calculateRetirement();
                } catch (error) {
                    console.error("Calculation error:", error);
                    alert("There was an error calculating your retirement plan. Please check your inputs and try again.");
                } finally {
                    calculationLoading.style.display = 'none';
                    calculateBtn.disabled = false;
                    setLoadingState(false);
                }
            }, 100);
        });
        
        function setLoadingState(isLoading) {
            document.body.style.cursor = isLoading ? 'wait' : 'default';
        }
        
        function calculateRetirement() {
            return safeCalculate(() => {
                // Get input values with enhanced sanitization
                const age = validateFinancialInput(currentAge.value, 'current age') || 45;
                const retireAge = Math.max(age + 1, validateFinancialInput(retirementAge.value, 'retirement age') || 65);
                const expectancy = Math.max(retireAge + 1, validateFinancialInput(lifeExpectancy.value, 'life expectancy') || 90);
                const inflationRate = Math.max(0, (validateFinancialInput(inflation.value, 'inflation') || 2.5) / 100);
                const returnRate = Math.max(-0.5, Math.min(0.2, (validateFinancialInput(investmentReturn.value, 'investment return') || 7) / 100));
                const superBalance = validateFinancialInput(currentSuper.value, 'super balance') || 0;
                const income = validateFinancialInput(currentIncome.value, 'income') || 0;
                const additionalContributionValue = validateFinancialInput(additionalContribution.value, 'additional contribution') || 0;
                
                const employerContribution = income * AUSTRALIAN_RULES.SUPER_CONTRIBUTION_RATE;
                const totalContribution = employerContribution + additionalContributionValue;
                
                // Get expense inputs with dependents
                const currentExpensesValue = validateFinancialInput(currentExpenses.value, 'current expenses') || 0;
                const annualChildCostValue = validateFinancialInput(annualChildCost.value, 'annual child cost') || 0;
                const educationCostsValue = validateFinancialInput(educationCosts.value, 'education costs') || 0;
                const retirementExpenseRate = Math.max(0.5, Math.min(1.5, (validateFinancialInput(retirementExpenses.value, 'retirement expenses') || 65) / 100));
                
                const healthcare = validateFinancialInput(healthcareCosts.value, 'healthcare costs') || 0;
                const travel = validateFinancialInput(travelBudget.value, 'travel budget') || 0;
                const otherCosts = validateFinancialInput(otherRetirementCosts.value, 'other costs') || 0;
                
                // Partner data with sanitization
                let partnerData = null;
                if (hasPartnerCheckbox.checked) {
                    partnerData = {
                        age: validateFinancialInput(partnerAge.value, 'partner age') || 42,
                        retirementAge: validateFinancialInput(partnerRetirementAge.value, 'partner retirement age') || 65,
                        keepWorking: partnerKeepWorking.checked,
                        income: validateFinancialInput(partnerIncome.value, 'partner income') || 0,
                        super: validateFinancialInput(partnerSuper.value, 'partner super') || 0,
                        contribution: validateFinancialInput(partnerContribution.value, 'partner contribution') || 0
                    };
                }
                
                // Strategy data with sanitization
                const downsizingData = considerDownsizingCheckbox.checked ? {
                    planned: true,
                    downsizeValue: validateFinancialInput(downsizeValue.value, 'downsize value') || 0,
                    downsizeAge: Math.max(55, Math.min(85, validateFinancialInput(downsizeAge.value, 'downsize age') || 70))
                } : { planned: false };
                
                const ttrData = considerTTRCheckbox.checked ? {
                    planned: true,
                    startAge: Math.max(55, Math.min(75, validateFinancialInput(ttrStartAge.value, 'ttr start age') || 60)),
                    incomePercent: Math.max(0.1, Math.min(1, (validateFinancialInput(ttrIncome.value, 'ttr income') || 50) / 100)),
                    salarySacrificePercent: Math.max(0, Math.min(0.5, (validateFinancialInput(ttrSalarySacrifice.value, 'ttr salary sacrifice') || 15) / 100))
                } : { planned: false };
                
                // Asset and debt data with sanitization
                const investmentPropsValue = validateFinancialInput(investmentProperties.value, 'investment properties') || 0;
                const investmentPropsDebtValue = validateFinancialInput(investmentPropertiesDebt.value, 'investment properties debt') || 0;
                const residenceValue = validateFinancialInput(primaryResidenceValue.value, 'primary residence value') || 0;
                const residenceDebtValue = validateFinancialInput(primaryResidenceDebt.value, 'primary residence debt') || 0;
                const otherAssetsValue = validateFinancialInput(otherAssets.value, 'other assets') || 0;
                const personalDebtValue = validateFinancialInput(personalDebt.value, 'personal debt') || 0;
                
                // SMSF data with sanitization
                const smsfData = hasSmsfCheckbox.checked ? {
                    hasSmsf: true,
                    adminCosts: validateFinancialInput(smsfAdminCosts.value, 'smsf admin costs') || 0
                } : { hasSmsf: false };
                
                // Insurance data
                const insuranceData = {
                    incomeProtection: hasIncomeProtection.checked,
                    lifeInsurance: hasLifeInsurance.checked,
                    tpdInsurance: hasTpdInsurance.checked
                };
                
                // High income earner flag
                const isHighIncomeEarner = highIncomeEarnerCheckbox.checked;
                
                // Risk profile
                const riskProfileValue = riskProfile.value;
                const currentAllocationValue = currentAllocation.value;
                
                // Calculate net worth
                const totalAssets = superBalance + residenceValue + investmentPropsValue + otherAssetsValue;
                const totalLiabilities = residenceDebtValue + investmentPropsDebtValue + personalDebtValue;
                const netWorth = totalAssets - totalLiabilities;
                
                // Update net worth display
                netWorthAssets.textContent = formatCurrency(totalAssets);
                netWorthLiabilities.textContent = formatCurrency(totalLiabilities);
                netWorthTotal.textContent = formatCurrency(netWorth);
                
                // Generate family timeline analysis
                generateFamilyTimelineAnalysis(age, currentExpensesValue, dependents, educationCostsValue, annualChildCostValue);
                
                // Calculate and display all scenarios with dependents
                calculateAndDisplayScenario(55, age, expectancy, inflationRate, returnRate, superBalance, totalContribution, 
                                currentExpensesValue, retirementExpenseRate, healthcare, travel, otherCosts, 
                                dependents, educationCostsValue, annualChildCostValue, partnerData, downsizingData, ttrData,
                                investmentPropsValue, residenceValue, otherAssetsValue, smsfData, isHighIncomeEarner);
                calculateAndDisplayScenario(60, age, expectancy, inflationRate, returnRate, superBalance, totalContribution, 
                                currentExpensesValue, retirementExpenseRate, healthcare, travel, otherCosts, 
                                dependents, educationCostsValue, annualChildCostValue, partnerData, downsizingData, ttrData,
                                investmentPropsValue, residenceValue, otherAssetsValue, smsfData, isHighIncomeEarner);
                calculateAndDisplayScenario(65, age, expectancy, inflationRate, returnRate, superBalance, totalContribution, 
                                currentExpensesValue, retirementExpenseRate, healthcare, travel, otherCosts, 
                                dependents, educationCostsValue, annualChildCostValue, partnerData, downsizingData, ttrData,
                                investmentPropsValue, residenceValue, otherAssetsValue, smsfData, isHighIncomeEarner);
                calculateAndDisplayScenario(67, age, expectancy, inflationRate, returnRate, superBalance, totalContribution, 
                                currentExpensesValue, retirementExpenseRate, healthcare, travel, otherCosts, 
                                dependents, educationCostsValue, annualChildCostValue, partnerData, downsizingData, ttrData,
                                investmentPropsValue, residenceValue, otherAssetsValue, smsfData, isHighIncomeEarner);
                calculateAndDisplayScenario(70, age, expectancy, inflationRate, returnRate, superBalance, totalContribution, 
                                currentExpensesValue, retirementExpenseRate, healthcare, travel, otherCosts, 
                                dependents, educationCostsValue, annualChildCostValue, partnerData, downsizingData, ttrData,
                                investmentPropsValue, residenceValue, otherAssetsValue, smsfData, isHighIncomeEarner);
                
                // Generate strategy analyses
                generateTTRAnalysis(age, ttrData, superBalance, income, isHighIncomeEarner);
                generateDownsizingAnalysis(downsizingData, residenceValue, residenceDebtValue);
                generatePensionTest(superBalance, residenceValue, investmentPropsValue, otherAssetsValue, partnerData, retireAge);
                generateTaxAnalysis(retireAge, superBalance, income, isHighIncomeEarner);
                generateAllocationRecommendation(age, riskProfileValue, currentAllocationValue);
                
                // Generate recommendations
                generateRecommendations(age, retireAge, superBalance, totalContribution, partnerData, ttrData, downsizingData, 
                                      insuranceData, smsfData, isHighIncomeEarner, netWorth, dependents);
                
                // Generate charts
                generateChart(age, expectancy, returnRate, superBalance, totalContribution, partnerData, ttrData);
                generateAllocationChart(riskProfileValue, age);
                
                // Show results
                resultsPlaceholder.classList.add('hidden');
                resultsContent.classList.remove('hidden');
            });
        }

        // Family timeline analysis generation
        function generateFamilyTimelineAnalysis(currentAge, currentExpenses, dependents, educationCosts, annualChildCost) {
            const timeline = calculateExpenseTimeline(currentAge, currentExpenses, dependents, educationCosts, annualChildCost);
            
            let html = '<div class="expense-timeline">';
            html += '<h4>Your Household Expense Projection</h4>';
            
            timeline.forEach(item => {
                html += `<div class="timeline-item">
                    <div class="timeline-year">${item.year} (Age ${item.age})</div>
                    <div class="timeline-value">${formatCurrency(item.annualExpense)}</div>
                </div>`;
                
                item.events.forEach(event => {
                    html += `<div class="timeline-item" style="padding-left: 20px; font-size: 0.9rem;">
                        <div class="timeline-event">${event.name} ends</div>
                        <div class="timeline-change negative-change">-${formatCurrency(event.costReduction)}</div>
                    </div>`;
                });
            });
            
            html += '</div>';
            document.getElementById('family-timeline-analysis').innerHTML = html;
        }

        // Fixed: Enhanced scenario calculation with dependents
        function calculateAndDisplayScenario(scenarioAge, currentAge, lifeExpectancy, inflationRate, returnRate, 
                                 superBalance, contribution, currentExpenses, retirementExpenseRate, healthcare, travel, otherCosts,
                                 dependents, educationCosts, annualChildCost, partnerData, downsizingData, ttrData, 
                                 investmentPropsValue, residenceValue, otherAssetsValue, smsfData, isHighIncomeEarner) {
            return safeCalculate(() => {
                const yearsToRetirement = Math.max(0, scenarioAge - currentAge);
                const retirementYears = Math.max(0, lifeExpectancy - scenarioAge);
                
                // Calculate future super balance
                let projectedSuper = projectSuperBalance(superBalance, contribution, yearsToRetirement, returnRate);
                
                // Apply SMSF costs if applicable
                if (smsfData.hasSmsf) {
                    for (let i = 0; i < yearsToRetirement; i++) {
                        projectedSuper -= smsfData.adminCosts;
                    }
                }
                
                // Apply TTR strategy if applicable
                if (ttrData.planned && scenarioAge >= ttrData.startAge) {
                    const ttrYears = Math.min(yearsToRetirement, scenarioAge - ttrData.startAge);
                    const preTTRYears = yearsToRetirement - ttrYears;
                    
                    projectedSuper = projectSuperBalance(superBalance, contribution, preTTRYears, returnRate);
                    
                    for (let i = 0; i < ttrYears; i++) {
                        const ttrWithdrawal = contribution * ttrData.incomePercent;
                        projectedSuper -= ttrWithdrawal;
                        
                        const ttrContribution = contribution * (1 + ttrData.salarySacrificePercent);
                        projectedSuper = projectedSuper * (1 + returnRate) + ttrContribution;
                    }
                } else {
                    projectedSuper = projectSuperBalance(superBalance, contribution, yearsToRetirement, returnRate);
                }
                
                // Apply downsizing if applicable
                if (downsizingData.planned && scenarioAge >= downsizingData.downsizeAge) {
                    const downsizingProceeds = Math.max(0, downsizingData.downsizeValue - residenceValue);
                    if (downsizingProceeds > 0) {
                        const downsizerContribution = Math.min(AUSTRALIAN_RULES.DOWNSIZER_CONTRIBUTION_LIMIT, downsizingProceeds);
                        projectedSuper += downsizerContribution;
                    }
                }
                
                // Add partner's super if applicable
                if (partnerData && partnerData.retirementAge <= scenarioAge) {
                    const partnerYearsToRetirement = scenarioAge - partnerData.age;
                    const partnerProjectedSuper = projectSuperBalance(
                        partnerData.super, 
                        partnerData.contribution, 
                        partnerYearsToRetirement, 
                        returnRate
                    );
                    
                    projectedSuper += partnerProjectedSuper;
                }
                
                // Fixed: Calculate retirement expenses considering dependents
                const expenseData = calculateRetirementExpensesWithDependents(
                    scenarioAge, currentAge, currentExpenses, retirementExpenseRate, 
                    dependents, educationCosts, annualChildCost, inflationRate
                );
                
                const futureRetirementExpenses = expenseData.retirementExpenses + healthcare + travel + otherCosts;
                
                // Calculate retirement income
                const superIncome = calculateSustainableWithdrawal(
                    projectedSuper, 
                    retirementYears, 
                    returnRate, 
                    inflationRate
                );
                
                // Estimate Age Pension
                let agePension = calculateAgePension(
                    projectedSuper + investmentPropsValue + otherAssetsValue, 
                    superIncome, 
                    partnerData !== null,
                    scenarioAge
                );
                
                const totalRetirementIncome = superIncome + agePension;
                
                // Calculate shortfall/surplus
                const shortfall = Math.max(0, futureRetirementExpenses - totalRetirementIncome);
                const surplus = Math.max(0, totalRetirementIncome - futureRetirementExpenses);
                
                // Update scenario display
                const yearsElement = document.getElementById(`scenario-${scenarioAge}-years`);
                const superElement = document.getElementById(`scenario-${scenarioAge}-super`);
                const incomeElement = document.getElementById(`scenario-${scenarioAge}-income`);
                const shortfallElement = document.getElementById(`scenario-${scenarioAge}-shortfall`);
                const surplusElement = document.getElementById(`scenario-${scenarioAge}-surplus`);
                
                if (yearsElement) yearsElement.textContent = yearsToRetirement;
                if (superElement) superElement.textContent = formatCurrency(projectedSuper);
                if (incomeElement) incomeElement.textContent = formatCurrency(totalRetirementIncome);
                
                if (shortfallElement) {
                    if (shortfall > 0) {
                        shortfallElement.textContent = formatCurrency(shortfall);
                        shortfallElement.style.display = 'block';
                        shortfallElement.className = 'scenario-value shortfall';
                        if (surplusElement) {
                            surplusElement.style.display = 'none';
                        }
                    } else {
                        shortfallElement.style.display = 'none';
                    }
                }
                
                if (surplusElement) {
                    if (surplus > 0) {
                        surplusElement.textContent = formatCurrency(surplus);
                        surplusElement.style.display = 'block';
                        surplusElement.className = 'scenario-value surplus';
                        if (shortfallElement) {
                            shortfallElement.style.display = 'none';
                        }
                    } else {
                        surplusElement.style.display = 'none';
                    }
                }
                
                // Fixed: Update scenario context with accurate family information
                const scenarioContextElement = document.getElementById(`scenario-${scenarioAge}-family-context`);
                if (scenarioContextElement) {
                    let contextText = `At age ${scenarioAge}, `;
                    
                    if (expenseData.dependentsAtRetirement.length > 0) {
                        const dependentAges = expenseData.dependentsAtRetirement.map(dep => {
                            const ageAtRetirement = dep.age + yearsToRetirement;
                            return `${dep.name} (age ${ageAtRetirement})`;
                        });
                        
                        contextText += `you'll still have ${expenseData.dependentsAtRetirement.length} dependent${expenseData.dependentsAtRetirement.length > 1 ? 's' : ''} at home: ${dependentAges.join(', ')}. `;
                    } else {
                        contextText += `all your dependents will have left home. `;
                    }
                    
                    contextText += `Your household expenses are projected to be ${formatCurrency(futureRetirementExpenses)} annually.`;
                    scenarioContextElement.textContent = contextText;
                }
                
                return {
                    age: scenarioAge,
                    yearsToRetirement,
                    projectedSuper,
                    retirementIncome: totalRetirementIncome,
                    shortfall,
                    surplus
                };
            });
        }
        
        function generateTTRAnalysis(currentAge, ttrData, superBalance, income, isHighIncomeEarner) {
            return safeCalculate(() => {
                if (!ttrData.planned) {
                    ttrAnalysis.innerHTML = `
                        <div class="recommendation">
                            <h4>Transition to Retirement Strategy</h4>
                            <p>You are not currently considering a Transition to Retirement strategy. This strategy can help you:</p>
                            <ul>
                                <li>Reduce working hours while maintaining income</li>
                                <li>Boost super savings through salary sacrifice</li>
                                <li>Smooth the transition into full retirement</li>
                                <li>Potentially reduce tax if you're a high-income earner</li>
                            </ul>
                            <p>Consider enabling TTR in the Strategies tab to see potential benefits.</p>
                        </div>
                    `;
                    return;
                }
                
                const ttrStartAge = ttrData.startAge;
                const yearsToTTR = Math.max(0, ttrStartAge - currentAge);
                
                const ttrIncomeAmount = income * ttrData.incomePercent;
                const salarySacrificeAmount = income * ttrData.salarySacrificePercent;
                
                const marginalTaxRate = calculateMarginalTaxRate(income);
                const taxSavings = salarySacrificeAmount * (marginalTaxRate - AUSTRALIAN_RULES.TAX_RATES.SUPER_CONTRIBUTIONS);
                
                ttrAnalysis.innerHTML = `
                    <div class="strategy-option">
                        <h4>Transition to Retirement Analysis</h4>
                        <div class="scenario-grid">
                            <div class="scenario-card">
                                <div class="result-label">TTR Start Age</div>
                                <div class="scenario-value">${ttrStartAge}</div>
                            </div>
                            <div class="scenario-card">
                                <div class="result-label">Years Until TTR</div>
                                <div class="scenario-value">${yearsToTTR}</div>
                            </div>
                            <div class="scenario-card">
                                <div class="result-label">TTR Income</div>
                                <div class="scenario-value">${formatCurrency(ttrIncomeAmount)}</div>
                            </div>
                            <div class="scenario-card">
                                <div class="result-label">Additional Salary Sacrifice</div>
                                <div class="scenario-value">${formatCurrency(salarySacrificeAmount)}</div>
                            </div>
                        </div>
                        <div class="tax-impact">
                            <h5>Tax Benefits</h5>
                            <p>By salary sacrificing ${formatCurrency(salarySacrificeAmount)} annually into super during TTR, you could save approximately ${formatCurrency(taxSavings)} in tax each year.</p>
                            ${isHighIncomeEarner ? `<p><strong>Division 293 Tax:</strong> As a high-income earner, you'll pay an additional 15% tax on your contributions, reducing the net benefit.</p>` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        function calculateMarginalTaxRate(income) {
            return safeCalculate(() => {
                const taxRates = AUSTRALIAN_RULES.TAX_RATES.INDIVIDUAL;
                for (let i = taxRates.length - 1; i >= 0; i--) {
                    if (income > taxRates[i].threshold) {
                        return taxRates[i].rate;
                    }
                }
                return 0;
            }) || 0;
        }
        
        function generateDownsizingAnalysis(downsizingData, residenceValue, residenceDebt) {
            return safeCalculate(() => {
                if (!downsizingData.planned) {
                    downsizingAnalysis.innerHTML = `
                        <div class="recommendation">
                            <h4>Property Downsizing Strategy</h4>
                            <p>You are not currently considering downsizing your primary residence. Downsizing can help you:</p>
                            <ul>
                                <li>Unlock home equity for retirement income</li>
                                <li>Reduce maintenance costs and responsibilities</li>
                                <li>Make a downsizer contribution to super (up to $300,000 per person)</li>
                            </ul>
                            <p>Consider enabling downsizing in the Strategies tab to see potential benefits.</p>
                        </div>
                    `;
                    return;
                }
                
                const homeEquity = residenceValue - residenceDebt;
                const downsizingProceeds = Math.max(0, downsizingData.downsizeValue - residenceValue);
                const netDownsizingGain = downsizingProceeds + homeEquity;
                
                const downsizerContribution = Math.min(AUSTRALIAN_RULES.DOWNSIZER_CONTRIBUTION_LIMIT, netDownsizingGain);
                
                downsizingAnalysis.innerHTML = `
                    <div class="strategy-option">
                        <h4>Downsizing Strategy Analysis</h4>
                        <div class="scenario-grid">
                            <div class="scenario-card">
                                <div class="result-label">Planned Downsizing Age</div>
                                <div class="scenario-value">${downsizingData.downsizeAge}</div>
                            </div>
                            <div class="scenario-card">
                                <div class="result-label">Current Home Equity</div>
                                <div class="scenario-value">${formatCurrency(homeEquity)}</div>
                            </div>
                            <div class="scenario-card">
                                <div class="result-label">Downsized Home Value</div>
                                <div class="scenario-value">${formatCurrency(downsizingData.downsizeValue)}</div>
                            </div>
                            <div class="scenario-card">
                                <div class="result-label">Potential Proceeds</div>
                                <div class="scenario-value">${formatCurrency(netDownsizingGain)}</div>
                            </div>
                        </div>
                        <div class="tax-impact">
                            <h5>Downsizer Contribution</h5>
                            <p>You could contribute up to ${formatCurrency(downsizerContribution)} to super from the sale proceeds, potentially boosting your retirement savings significantly.</p>
                            <p><em>Note: Primary residence is exempt from Age Pension assets test. Downsizing may affect your Age Pension eligibility if you have significant proceeds left outside super.</em></p>
                        </div>
                    </div>
                `;
            });
        }
        
        function generatePensionTest(superBalance, residenceValue, investmentPropsValue, otherAssetsValue, partnerData, retireAge) {
            return safeCalculate(() => {
                const totalAssets = superBalance + investmentPropsValue + otherAssetsValue;
                const hasPartner = partnerData !== null;
                
                const agePension = calculateAgePension(totalAssets, 0, hasPartner, retireAge);
                const pensionStatus = agePension > 0 ? 
                    (agePension >= (hasPartner ? AUSTRALIAN_RULES.AGE_PENSION.COUPLE.FULL * 26 : AUSTRALIAN_RULES.AGE_PENSION.SINGLE.FULL * 26) ? 
                     'Full Age Pension likely' : 'Partial Age Pension likely') : 
                    'No Age Pension due to assets';
                
                pensionTest.innerHTML = `
                    <h4>Age Pension Eligibility Assessment</h4>
                    <div class="scenario-grid">
                        <div class="scenario-card">
                            <div class="result-label">Assessable Assets</div>
                            <div class="scenario-value">${formatCurrency(totalAssets)}</div>
                        </div>
                        <div class="scenario-card">
                            <div class="result-label">Home Exemption</div>
                            <div class="scenario-value">${formatCurrency(residenceValue)}</div>
                        </div>
                        <div class="scenario-card">
                            <div class="result-label">Pension Status</div>
                            <div class="scenario-value">${pensionStatus}</div>
                        </div>
                        <div class="scenario-card">
                            <div class="result-label">Estimated Pension</div>
                            <div class="scenario-value">${formatCurrency(agePension)}</div>
                        </div>
                    </div>
                    <p><em>Based on current asset levels. Age Pension also depends on income tests and eligibility age requirements (currently ${AUSTRALIAN_RULES.AGE_PENSION_AGE}).</em></p>
                `;
            });
        }
        
        function generateTaxAnalysis(retireAge, superBalance, income, isHighIncomeEarner) {
            return safeCalculate(() => {
                let taxStatus = '';
                let taxExplanation = '';
                
                if (retireAge < AUSTRALIAN_RULES.TAX_FREE_SUPER_AGE) {
                    taxStatus = 'Taxable super income';
                    taxExplanation = `If you retire before age ${AUSTRALIAN_RULES.TAX_FREE_SUPER_AGE}, your super income stream payments may be taxable, with a 15% tax offset. Lump sum withdrawals may have tax-free and taxable components.`;
                } else {
                    taxStatus = 'Tax-free super income';
                    taxExplanation = `From age ${AUSTRALIAN_RULES.TAX_FREE_SUPER_AGE}, super income stream payments and lump sum withdrawals are generally tax-free when received from a taxed super fund.`;
                }
                
                taxAnalysis.innerHTML = `
                    <h4>Retirement Phase Tax Considerations</h4>
                    <div class="scenario-grid">
                        <div class="scenario-card">
                            <div class="result-label">Planned Retirement Age</div>
                            <div class="scenario-value">${retireAge}</div>
                        </div>
                        <div class="scenario-card">
                            <div class="result-label">Tax Status</div>
                            <div class="scenario-value">${taxStatus}</div>
                        </div>
                        <div class="scenario-card">
                            <div class="result-label">Transfer Balance Cap</div>
                            <div class="scenario-value">${formatCurrency(AUSTRALIAN_RULES.TRANSFER_BALANCE_CAP)}</div>
                        </div>
                        ${isHighIncomeEarner ? `
                        <div class="scenario-card">
                            <div class="result-label">Division 293 Tax</div>
                            <div class="scenario-value">Applies</div>
                        </div>
                        ` : ''}
                    </div>
                    <p>${taxExplanation}</p>
                    <p><strong>Other considerations:</strong></p>
                    <ul>
                        <li>Super earnings in retirement phase are tax-free</li>
                        <li>Age Pension payments are tax-free</li>
                        <li>Other investment income may be taxable</li>
                        <li>Consider the transfer balance cap (${formatCurrency(AUSTRALIAN_RULES.TRANSFER_BALANCE_CAP)}) for retirement phase super</li>
                        ${isHighIncomeEarner ? `<li>As a high-income earner, you pay Division 293 tax (additional 15%) on super contributions.</li>` : ''}
                    </ul>
                `;
            });
        }
        
        function generateAllocationRecommendation(currentAge, riskProfile, currentAllocation) {
            return safeCalculate(() => {
                let recommendedAllocation = {};
                let recommendationText = '';
                
                if (currentAge < 50) {
                    if (riskProfile === 'conservative') {
                        recommendedAllocation = { growth: 40, defensive: 60 };
                        recommendationText = 'Given your conservative risk profile but younger age, we recommend a slightly higher growth allocation to maximize long-term returns.';
                    } else if (riskProfile === 'moderate') {
                        recommendedAllocation = { growth: 60, defensive: 40 };
                        recommendationText = 'A balanced growth approach suits your moderate risk tolerance and time horizon until retirement.';
                    } else {
                        recommendedAllocation = { growth: 80, defensive: 20 };
                        recommendationText = 'With your growth-oriented risk profile and time until retirement, a high growth allocation is appropriate.';
                    }
                } else if (currentAge < 60) {
                    if (riskProfile === 'conservative') {
                        recommendedAllocation = { growth: 30, defensive: 70 };
                        recommendationText = 'A conservative allocation is appropriate as you approach retirement, focusing on capital preservation.';
                    } else if (riskProfile === 'moderate') {
                        recommendedAllocation = { growth: 50, defensive: 50 };
                        recommendationText = 'A moderate allocation balances growth potential with risk management as retirement approaches.';
                    } else {
                        recommendedAllocation = { growth: 65, defensive: 35 };
                        recommendationText = 'A growth-oriented allocation can still be appropriate, but with increased defensive assets for stability.';
                    }
                } else {
                    if (riskProfile === 'conservative') {
                        recommendedAllocation = { growth: 20, defensive: 80 };
                        recommendationText = 'In retirement, a conservative allocation focuses on income generation and capital preservation.';
                    } else if (riskProfile === 'moderate') {
                        recommendedAllocation = { growth: 40, defensive: 60 };
                        recommendationText = 'A moderate allocation in retirement provides some growth while prioritizing stability and income.';
                    } else {
                        recommendedAllocation = { growth: 50, defensive: 50 };
                        recommendationText = 'Even with a growth orientation in retirement, maintaining significant defensive assets is important for sequence risk.';
                    }
                }
                
                allocationRecommendation.innerHTML = `
                    <h4>Asset Allocation Strategy</h4>
                    <p>${recommendationText}</p>
                    <div class="allocation-item">
                        <span class="allocation-label">Growth Assets (Shares, Property)</span>
                        <span class="allocation-percent">${recommendedAllocation.growth}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${recommendedAllocation.growth}%; background-color: #3498db;"></div>
                    </div>
                    <div class="allocation-item">
                        <span class="allocation-label">Defensive Assets (Cash, Bonds)</span>
                        <span class="allocation-percent">${recommendedAllocation.defensive}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${recommendedAllocation.defensive}%; background-color: #2ecc71;"></div>
                    </div>
                    <p><em>Consider reviewing your super investment option to align with this recommended allocation.</em></p>
                `;
                
                return recommendedAllocation;
            }) || { growth: 50, defensive: 50 };
        }
        
        function generateAllocationChart(riskProfile, currentAge) {
            return safeCalculate(() => {
                const ctx = document.getElementById('allocation-chart');
                
                if (allocationChart) {
                    allocationChart.destroy();
                }
                
                let growth, defensive;
                
                let ageAdjustment = 0;
                if (currentAge >= 60) ageAdjustment = -20;
                else if (currentAge >= 50) ageAdjustment = -10;
                
                switch(riskProfile) {
                    case 'conservative':
                        growth = 30 + ageAdjustment;
                        defensive = 70 - ageAdjustment;
                        break;
                    case 'moderate':
                        growth = 50 + ageAdjustment;
                        defensive = 50 - ageAdjustment;
                        break;
                    case 'balanced':
                        growth = 70 + ageAdjustment;
                        defensive = 30 - ageAdjustment;
                        break;
                    case 'growth':
                        growth = 85 + ageAdjustment;
                        defensive = 15 - ageAdjustment;
                        break;
                    case 'high-growth':
                        growth = 100;
                        defensive = 0;
                        break;
                    default:
                        growth = 50 + ageAdjustment;
                        defensive = 50 - ageAdjustment;
                }
                
                growth = Math.max(0, Math.min(100, growth));
                defensive = Math.max(0, Math.min(100, defensive));
                
                allocationChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Growth Assets', 'Defensive Assets'],
                        datasets: [{
                            data: [growth, defensive],
                            backgroundColor: ['#3498db', '#2ecc71'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Recommended Asset Allocation'
                            }
                        }
                    }
                });
            });
        }
        
        function generateChart(currentAge, lifeExpectancy, returnRate, superBalance, contribution, partnerData, ttrData) {
            return safeCalculate(() => {
                const ctx = document.getElementById('retirement-chart');
                
                if (retirementChart) {
                    retirementChart.destroy();
                }
                
                const labels = ['Age 55', 'Age 60', 'Age 65', 'Age 67', 'Age 70'];
                const superData = [];
                const incomeData = [];
                
                for (let i = 0; i < labels.length; i++) {
                    const scenarioAge = 55 + i * (i < 3 ? 5 : 2);
                    const yearsToRetirement = Math.max(0, scenarioAge - currentAge);
                    
                    let projectedSuper = projectSuperBalance(superBalance, contribution, yearsToRetirement, returnRate);
                    
                    if (partnerData && partnerData.retirementAge <= scenarioAge) {
                        const partnerYearsToRetirement = scenarioAge - partnerData.age;
                        const partnerProjectedSuper = projectSuperBalance(
                            partnerData.super, 
                            partnerData.contribution, 
                            partnerYearsToRetirement, 
                            returnRate
                        );
                        
                        projectedSuper += partnerProjectedSuper;
                    }
                    
                    superData.push(projectedSuper);
                    
                    const retirementIncome = calculateSustainableWithdrawal(projectedSuper, lifeExpectancy - scenarioAge, returnRate, 0.025);
                    incomeData.push(retirementIncome);
                }
                
                retirementChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Projected Super Balance',
                                data: superData,
                                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                borderColor: 'rgba(52, 152, 219, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Annual Retirement Income',
                                data: incomeData,
                                backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                borderColor: 'rgba(46, 204, 113, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Retirement Projections by Age'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }
        
        // Enhanced recommendations with dependents
        function generateRecommendations(currentAge, retirementAge, superBalance, contribution, partnerData, ttrData, downsizingData, 
                                       insuranceData, smsfData, isHighIncomeEarner, netWorth, dependents) {
            return safeCalculate(() => {
                recommendationsList.innerHTML = '';
                
                // Net worth assessment
                if (netWorth < 500000) {
                    recommendationsList.innerHTML += `
                        <div class="recommendation warning">
                            <h4>Build Your Net Worth</h4>
                            <p>Your current net worth is below the recommended level for a comfortable retirement. Consider:</p>
                            <ul>
                                <li>Increasing your super contributions</li>
                                <li>Paying down high-interest debt</li>
                                <li>Building an emergency fund</li>
                                <li>Exploring additional income streams</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Dependents recommendations
                if (dependents.length > 0) {
                    const dependentsAtRetirement = dependents.filter(dep => {
                        const ageAtRetirement = dep.age + (retirementAge - currentAge);
                        return ageAtRetirement < dep.supportUntil;
                    });
                    
                    if (dependentsAtRetirement.length > 0) {
                        recommendationsList.innerHTML += `
                            <div class="recommendation warning">
                                <h4>Plan for Dependents in Retirement</h4>
                                <p>You'll still have ${dependentsAtRetirement.length} dependent${dependentsAtRetirement.length > 1 ? 's' : ''} when you retire. Consider:</p>
                                <ul>
                                    <li>Higher retirement expenses for household costs</li>
                                    <li>Potential education costs continuing into your retirement</li>
                                    <li>Delaying retirement until dependents are independent for better financial security</li>
                                    <li>Budgeting for potential financial support during their transition to independence</li>
                                </ul>
                            </div>
                        `;
                    } else {
                        recommendationsList.innerHTML += `
                            <div class="recommendation success">
                                <h4>Dependents Strategy</h4>
                                <p>All your dependents will be independent by retirement. This significantly reduces your retirement expense needs.</p>
                                <ul>
                                    <li>Your expenses will drop by approximately ${formatCurrency(dependents.length * 15000)} annually</li>
                                    <li>Consider redirecting these savings to super once dependents leave home</li>
                                    <li>Review your retirement expense projections as each child becomes independent</li>
                                </ul>
                            </div>
                        `;
                    }
                }
                
                // TTR recommendations
                if (currentAge >= AUSTRALIAN_RULES.PRESERVATION_AGE && !ttrData.planned) {
                    recommendationsList.innerHTML += `
                        <div class="recommendation">
                            <h4>Consider Transition to Retirement</h4>
                            <p>You've reached preservation age (${AUSTRALIAN_RULES.PRESERVATION_AGE}+). A Transition to Retirement strategy could help you:</p>
                            <ul>
                                <li>Reduce working hours while maintaining income</li>
                                <li>Boost super through salary sacrifice with tax benefits</li>
                                <li>Gradually transition to full retirement</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Downsizing recommendations
                if (currentAge >= 55 && !downsizingData.planned) {
                    recommendationsList.innerHTML += `
                        <div class="recommendation">
                            <h4>Evaluate Downsizing Potential</h4>
                            <p>As you approach retirement, consider whether downsizing could benefit your retirement plan:</p>
                            <ul>
                                <li>Unlock home equity for retirement income</li>
                                <li>Reduce maintenance costs and responsibilities</li>
                                <li>Make tax-advantaged downsizer contributions to super</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Asset allocation recommendations
                if (currentAge >= 50) {
                    recommendationsList.innerHTML += `
                        <div class="recommendation">
                            <h4>Review Investment Strategy</h4>
                            <p>As you approach retirement, consider gradually shifting to a more conservative asset allocation:</p>
                            <ul>
                                <li>Reduce exposure to volatile growth assets</li>
                                <li>Increase defensive assets for stability</li>
                                <li>Consider the impact of sequence risk on your retirement savings</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Insurance recommendations
                if (!insuranceData.incomeProtection || !insuranceData.lifeInsurance || !insuranceData.tpdInsurance) {
                    recommendationsList.innerHTML += `
                        <div class="recommendation">
                            <h4>Review Insurance Coverage</h4>
                            <p>Ensure you have adequate insurance protection:</p>
                            <ul>
                                ${!insuranceData.incomeProtection ? '<li>Consider income protection insurance to safeguard your earning capacity</li>' : ''}
                                ${!insuranceData.lifeInsurance ? '<li>Evaluate life insurance needs, especially if you have dependents</li>' : ''}
                                ${!insuranceData.tpdInsurance ? '<li>Total and permanent disability insurance can provide financial security</li>' : ''}
                            </ul>
                        </div>
                    `;
                }
                
                // SMSF recommendations
                if (superBalance < 200000 && smsfData.hasSmsf) {
                    recommendationsList.innerHTML += `
                        <div class="recommendation warning">
                            <h4>Review SMSF Viability</h4>
                            <p>With a super balance below $200,000, the costs of running an SMSF may outweigh the benefits. Consider:</p>
                            <ul>
                                <li>Comparing costs with industry or retail super funds</li>
                                <li>The time commitment required for SMSF administration</li>
                                <li>Whether you have the expertise to manage your own fund</li>
                            </ul>
                        </div>
                    `;
                }
                
                // High income earner recommendations
                if (isHighIncomeEarner) {
                    recommendationsList.innerHTML += `
                        <div class="recommendation">
                            <h4>High Income Earner Strategies</h4>
                            <p>As a high-income earner, consider these strategies:</p>
                            <ul>
                                <li>Maximize concessional contributions ($27,500 annually)</li>
                                <li>Consider non-concessional contributions if eligible</li>
                                <li>Plan for Division 293 tax liabilities</li>
                                <li>Explore debt recycling strategies</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Age Pension planning
                recommendationsList.innerHTML += `
                    <div class="recommendation">
                        <h4>Age Pension Strategy</h4>
                        <p>Plan for Age Pension eligibility and optimize your assets:</p>
                        <ul>
                            <li>Understand asset and income test thresholds</li>
                            <li>Consider restructuring assets to maximize eligibility</li>
                            <li>Plan for the impact of the transfer balance cap (${formatCurrency(AUSTRALIAN_RULES.TRANSFER_BALANCE_CAP)})</li>
                        </ul>
                    </div>
                `;
                
                // General recommendations
                recommendationsList.innerHTML += `
                    <div class="recommendation">
                        <h4>Ongoing Retirement Planning</h4>
                        <p>Continue to monitor and adjust your retirement strategy:</p>
                        <ul>
                            <li>Review your plan annually or when circumstances change</li>
                            <li>Consider consulting a qualified financial advisor</li>
                            <li>Stay informed about changes to super and pension rules</li>
                            <li>Update your plan as you approach different life stages</li>
                        </ul>
                    </div>
                `;
            });
        }
        
        // Save data to local storage
        saveBtn.addEventListener('click', saveData);
        
        function saveData() {
            const data = {
                currentAge: currentAge.value,
                retirementAge: retirementAge.value,
                lifeExpectancy: lifeExpectancy.value,
                inflation: inflation.value,
                investmentReturn: investmentReturn.value,
                currentSuper: currentSuper.value,
                currentIncome: currentIncome.value,
                additionalContribution: additionalContribution.value,
                currentExpenses: currentExpenses.value,
                retirementExpenses: retirementExpenses.value,
                healthcareCosts: healthcareCosts.value,
                travelBudget: travelBudget.value,
                otherRetirementCosts: otherRetirementCosts.value,
                annualChildCost: annualChildCost.value,
                educationCosts: educationCosts.value,
                hasPartner: hasPartnerCheckbox.checked,
                partnerAge: partnerAge.value,
                partnerRetirementAge: partnerRetirementAge.value,
                partnerKeepWorking: partnerKeepWorking.checked,
                partnerIncome: partnerIncome.value,
                partnerSuper: partnerSuper.value,
                partnerContribution: partnerContribution.value,
                considerDownsizing: considerDownsizingCheckbox.checked,
                downsizeValue: downsizeValue.value,
                downsizeAge: downsizeAge.value,
                considerTTR: considerTTRCheckbox.checked,
                ttrStartAge: ttrStartAge.value,
                ttrIncome: ttrIncome.value,
                ttrSalarySacrifice: ttrSalarySacrifice.value,
                riskProfile: riskProfile.value,
                currentAllocation: currentAllocation.value,
                investmentProperties: investmentProperties.value,
                investmentPropertiesDebt: investmentPropertiesDebt.value,
                primaryResidenceValue: primaryResidenceValue.value,
                primaryResidenceDebt: primaryResidenceDebt.value,
                otherAssets: otherAssets.value,
                personalDebt: personalDebt.value,
                hasSmsf: hasSmsfCheckbox.checked,
                smsfAdminCosts: smsfAdminCosts.value,
                highIncomeEarner: highIncomeEarnerCheckbox.checked,
                hasIncomeProtection: hasIncomeProtection.checked,
                hasLifeInsurance: hasLifeInsurance.checked,
                hasTpdInsurance: hasTpdInsurance.checked,
                dependents: dependents,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('australianRetirementPlannerData', JSON.stringify(data));
            alert('Your retirement data has been saved locally!');
        }
        
        // Load data from local storage
        loadBtn.addEventListener('click', loadData);
        
        function loadData() {
            const savedData = localStorage.getItem('australianRetirementPlannerData');
            
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // Load basic data
                currentAge.value = data.currentAge || 45;
                retirementAge.value = data.retirementAge || 65;
                lifeExpectancy.value = data.lifeExpectancy || '90';
                inflation.value = data.inflation || 2.5;
                investmentReturn.value = data.investmentReturn || 7;
                currentSuper.value = data.currentSuper || 0;
                currentIncome.value = data.currentIncome || 0;
                additionalContribution.value = data.additionalContribution || 0;
                currentExpenses.value = data.currentExpenses || 0;
                retirementExpenses.value = data.retirementExpenses || 65;
                healthcareCosts.value = data.healthcareCosts || 0;
                travelBudget.value = data.travelBudget || 0;
                otherRetirementCosts.value = data.otherRetirementCosts || 0;
                annualChildCost.value = data.annualChildCost || 15000;
                educationCosts.value = data.educationCosts || 25000;
                
                // Load dependents data
                if (data.dependents && data.dependents.length > 0) {
                    dependents = data.dependents;
                    dependentCounter = Math.max(...dependents.map(d => d.id)) + 1;
                    renderDependents();
                    updateExpenseTimelinePreview();
                }
                
                // Load partner data
                hasPartnerCheckbox.checked = data.hasPartner || false;
                if (data.hasPartner) {
                    partnerDetails.classList.remove('hidden');
                    partnerAge.value = data.partnerAge || 42;
                    partnerRetirementAge.value = data.partnerRetirementAge || 65;
                    partnerKeepWorking.checked = data.partnerKeepWorking || false;
                    partnerIncome.value = data.partnerIncome || 0;
                    partnerSuper.value = data.partnerSuper || 0;
                    partnerContribution.value = data.partnerContribution || 0;
                } else {
                    partnerDetails.classList.add('hidden');
                }
                
                // Load strategy data
                considerDownsizingCheckbox.checked = data.considerDownsizing || false;
                if (data.considerDownsizing) {
                    downsizingDetails.classList.remove('hidden');
                    downsizeValue.value = data.downsizeValue || 0;
                    downsizeAge.value = data.downsizeAge || 70;
                } else {
                    downsizingDetails.classList.add('hidden');
                }
                
                considerTTRCheckbox.checked = data.considerTTR || false;
                if (data.considerTTR) {
                    ttrDetails.classList.remove('hidden');
                    ttrStartAge.value = data.ttrStartAge || 60;
                    ttrIncome.value = data.ttrIncome || 50;
                    ttrSalarySacrifice.value = data.ttrSalarySacrifice || 15;
                } else {
                    ttrDetails.classList.add('hidden');
                }
                
                riskProfile.value = data.riskProfile || 'moderate';
                currentAllocation.value = data.currentAllocation || 'balanced';
                
                // Load asset and debt data
                investmentProperties.value = data.investmentProperties || 0;
                investmentPropertiesDebt.value = data.investmentPropertiesDebt || 0;
                primaryResidenceValue.value = data.primaryResidenceValue || 0;
                primaryResidenceDebt.value = data.primaryResidenceDebt || 0;
                otherAssets.value = data.otherAssets || 0;
                personalDebt.value = data.personalDebt || 0;
                
                // Load SMSF data
                hasSmsfCheckbox.checked = data.hasSmsf || false;
                if (data.hasSmsf) {
                    smsfDetails.classList.remove('hidden');
                    smsfAdminCosts.value = data.smsfAdminCosts || 0;
                } else {
                    smsfDetails.classList.add('hidden');
                }
                
                // Load high income earner flag
                highIncomeEarnerCheckbox.checked = data.highIncomeEarner || false;
                
                // Load insurance data
                hasIncomeProtection.checked = data.hasIncomeProtection || false;
                hasLifeInsurance.checked = data.hasLifeInsurance || false;
                hasTpdInsurance.checked = data.hasTpdInsurance || false;
                
                alert('Your saved retirement data has been loaded!');
                
                // Recalculate with loaded data
                calculateRetirement();
            } else {
                alert('No saved data found. Please save your data first.');
            }
        }
        
        // Reset to defaults
        resetBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all fields to their default values? This will erase any unsaved changes.')) {
                location.reload();
            }
        });
        
        // Export as PDF
        exportPdfBtn.addEventListener('click', () => {
            alert('In a full implementation, this would generate a PDF report. For now, use the print function.');
        });
        
        // Print plan
        printPlanBtn.addEventListener('click', () => {
            window.print();
        });
        
        // Save report
        saveReportBtn.addEventListener('click', () => {
            const reportData = {
                timestamp: new Date().toISOString(),
                inputs: {
                    currentAge: currentAge.value,
                    retirementAge: retirementAge.value,
                    currentSuper: currentSuper.value,
                    currentIncome: currentIncome.value,
                    dependents: dependents.length
                },
                results: {
                    netWorth: netWorthTotal.textContent,
                }
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(reportData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "retirement_plan_report.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            alert('Retirement report saved!');
        });
        
        // Set up auto-calculation
        function setupAutoCalculation() {
            const inputElements = [
                currentAge, retirementAge, lifeExpectancy, inflation, investmentReturn,
                currentSuper, currentIncome, additionalContribution, currentExpenses,
                retirementExpenses, healthcareCosts, travelBudget, otherRetirementCosts,
                annualChildCost, educationCosts,
                partnerAge, partnerRetirementAge, partnerIncome, partnerSuper, partnerContribution,
                downsizeValue, downsizeAge, ttrStartAge, ttrIncome, ttrSalarySacrifice,
                investmentProperties, investmentPropertiesDebt, primaryResidenceValue,
                primaryResidenceDebt, otherAssets, personalDebt, smsfAdminCosts
            ];
            
            const selectElements = [riskProfile, currentAllocation];
            
            const checkboxElements = [
                hasPartnerCheckbox, partnerKeepWorking, considerDownsizingCheckbox,
                considerTTRCheckbox, hasSmsfCheckbox, highIncomeEarnerCheckbox,
                hasIncomeProtection, hasLifeInsurance, hasTpdInsurance
            ];
            
            inputElements.forEach(input => {
                if (input) {
                    input.addEventListener('input', handleAutoCalculation);
                }
            });
            
            selectElements.forEach(select => {
                if (select) {
                    select.addEventListener('change', handleAutoCalculation);
                }
            });
            
            checkboxElements.forEach(checkbox => {
                if (checkbox) {
                    checkbox.addEventListener('change', handleAutoCalculation);
                }
            });
        }
        
        function handleAutoCalculation() {
            if (!autoCalculateCheckbox.checked) return;
            
            if (autoCalculateTimeout) {
                clearTimeout(autoCalculateTimeout);
            }
            
            autoCalculateTimeout = setTimeout(() => {
                if (validateInputs()) {
                    calculateRetirement();
                }
            }, 500);
        }
        
        autoCalculateCheckbox.addEventListener('change', function() {
            if (this.checked && resultsContent.classList.contains('hidden')) {
                if (validateInputs()) {
                    calculateRetirement();
                }
            }
        });
        
        // Set up event listeners for checkboxes
        hasPartnerCheckbox.dispatchEvent(new Event('change'));
        considerDownsizingCheckbox.dispatchEvent(new Event('change'));
        considerTTRCheckbox.dispatchEvent(new Event('change'));
        hasSmsfCheckbox.dispatchEvent(new Event('change'));
        
        // Set up auto-calculation
        setupAutoCalculation();
        
        // Try to load saved data, otherwise run initial calculation
        const savedData = localStorage.getItem('australianRetirementPlannerData');
        if (savedData) {
            loadData();
        }
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
