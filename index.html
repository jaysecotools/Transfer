<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Your existing head content remains the same -->
  <!-- ... -->
</head>
<body>
  <!-- Your existing HTML body remains the same -->
  <!-- ... -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Application State - Add this at the top of your script
    const state = {
      projects: [],
      monitoringPoints: [],
      activities: [],
      teamMembers: [],
      selectedTab: 'dashboard',
      projectMap: null,
      monitoringMap: null,
      projectLocationMap: null,
      monitoringLocationMap: null,
      projectDetailMap: null,
      projectLocationMarker: null,
      monitoringLocationMarker: null,
      charts: {},
      tempPhotos: {
        project: [],
        monitoring: [],
        observation: []
      },
      currentProject: null,
      currentMonitoringPoint: null,
      currentObservation: null,
      currentProjectFilter: 'all',
      searchFilters: {
        projects: '',
        monitoring: '',
        team: ''
      }
    };

    // Fixed handlePhotoUpload function
    function handlePhotoUpload(files, type) {
      const previewContainer = document.getElementById(`${type}-photo-preview`);
      if (!previewContainer) return;
      
      Array.from(files).forEach(file => {
        if (!file.type.match('image.*')) {
          showToast('Please select image files only', 'warning');
          return;
        }
        
        if (file.size > 2 * 1024 * 1024) {
          showToast('File size too large. Please select files smaller than 2MB.', 'warning');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const imgContainer = document.createElement('div');
          imgContainer.style.position = 'relative';
          imgContainer.style.display = 'inline-block';
          imgContainer.style.margin = '5px';
          
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'photo-thumbnail';
          img.style.objectFit = 'cover';
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-photo';
          deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
          deleteBtn.onclick = (ev) => {
            ev.stopPropagation();
            imgContainer.remove();
            state.tempPhotos[type] = state.tempPhotos[type].filter(p => p.data !== e.target.result);
          };
          
          imgContainer.appendChild(img);
          imgContainer.appendChild(deleteBtn);
          previewContainer.appendChild(imgContainer);
          
          // Store photo data
          state.tempPhotos[type].push({
            id: 'photo-' + Date.now() + Math.random(),
            name: file.name,
            data: e.target.result,
            size: file.size,
            type: file.type,
            uploadedAt: new Date().toISOString()
          });
        };
        
        reader.onerror = function() {
          showToast('Error reading file: ' + file.name, 'error');
        };
        
        reader.readAsDataURL(file);
      });
    }

    // Fixed showProjectForm function - photo preview section
    function showProjectForm(projectId = null) {
      try {
        const formContainer = document.getElementById('project-form-container');
        const formTitle = document.getElementById('project-form-title');
        const previewContainer = document.getElementById('photo-preview');
        
        if (projectId) {
          const project = state.projects.find(p => p.id === projectId);
          if (!project) return;
          
          formTitle.textContent = 'Edit Project';
          document.getElementById('project-id').value = project.id;
          document.getElementById('project-name').value = project.name;
          document.getElementById('project-type').value = project.type;
          document.getElementById('project-status').value = project.status;
          document.getElementById('project-location').value = project.location.name;
          document.getElementById('project-lat').value = project.location.coords[0];
          document.getElementById('project-lng').value = project.location.coords[1];
          document.getElementById('project-start-date').value = project.startDate;
          document.getElementById('project-end-date').value = project.endDate || '';
          document.getElementById('project-area').value = project.area || '';
          document.getElementById('project-budget').value = project.budget || '';
          document.getElementById('project-description').value = project.description || '';
          
          // Set up map marker
          if (state.projectLocationMap && state.projectLocationMarker) {
            state.projectLocationMap.removeLayer(state.projectLocationMarker);
          }
          if (state.projectLocationMap) {
            state.projectLocationMarker = L.marker(project.location.coords).addTo(state.projectLocationMap);
            state.projectLocationMap.setView(project.location.coords, 13);
          }
          
          // Handle photo previews
          previewContainer.innerHTML = '';
          state.tempPhotos.project = [...project.photos];
          
          project.photos.forEach(photo => {
            const imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';
            imgContainer.style.display = 'inline-block';
            imgContainer.style.margin = '5px';
            
            const img = document.createElement('img');
            img.src = photo.data || photo.url;
            img.className = 'photo-thumbnail';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-photo';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.onclick = (ev) => {
              ev.stopPropagation();
              imgContainer.remove();
              state.tempPhotos.project = state.tempPhotos.project.filter(p => 
                (p.data !== photo.data) && (p.url !== photo.url)
              );
            };
            
            imgContainer.appendChild(img);
            imgContainer.appendChild(deleteBtn);
            previewContainer.appendChild(imgContainer);
          });
        } else {
          formTitle.textContent = 'Create New Project';
          document.getElementById('project-form').reset();
          previewContainer.innerHTML = '';
          state.tempPhotos.project = [];
          
          if (state.projectLocationMap) {
            const center = state.projectLocationMap.getCenter();
            document.getElementById('project-lat').value = center.lat;
            document.getElementById('project-lng').value = center.lng;
          }
        }
        
        document.getElementById('projects-list').style.display = 'none';
        formContainer.style.display = 'block';
      } catch (error) {
        console.error('Error showing project form:', error);
        showToast('Error loading project form: ' + error.message, 'error');
      }
    }

    // Fixed filterMonitoringPoints function
    function filterMonitoringPoints() {
      const searchTerm = document.getElementById('monitoring-search').value.toLowerCase();
      const projectFilter = document.getElementById('monitoring-project-filter').value;
      
      state.searchFilters.monitoring = searchTerm;
      renderMonitoringPoints(projectFilter);
    }

    // Fixed monitoring form submission
    function handleMonitoringSubmit(e) {
      e.preventDefault();
      
      const monitoringId = document.getElementById('monitoring-id').value;
      const projectId = document.getElementById('monitoring-project').value;
      const name = document.getElementById('monitoring-name').value.trim();
      const type = document.getElementById('monitoring-type').value;
      const lat = document.getElementById('monitoring-lat').value;
      const lng = document.getElementById('monitoring-lng').value;
      
      if (!projectId || !name || !type || !lat || !lng) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      const monitoringPoint = {
        id: monitoringId || 'monitoring-' + Date.now(),
        projectId: projectId,
        name: name,
        type: type,
        coords: [parseFloat(lat), parseFloat(lng)],
        photos: [...state.tempPhotos.monitoring],
        observations: monitoringId ? 
          (state.monitoringPoints.find(m => m.id === monitoringId)?.observations || []) : []
      };
      
      if (monitoringId) {
        const index = state.monitoringPoints.findIndex(m => m.id === monitoringId);
        if (index !== -1) {
          state.monitoringPoints[index] = monitoringPoint;
        }
      } else {
        state.monitoringPoints.push(monitoringPoint);
      }
      
      saveData();
      renderMonitoringPoints();
      showMonitoringTab('all');
      showToast('Monitoring point saved successfully', 'success');
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      try {
        showLoading(true);
        loadData();
        initNavigation();
        renderProjects();
        renderMonitoringPoints();
        renderTeamMembers();
        updateDashboard();
        initCharts();
        
        setTimeout(() => {
          initMaps();
          updateCharts();
          showLoading(false);
        }, 100);
        
        // Form event listeners using event delegation
        document.addEventListener('submit', function(e) {
          if (e.target.matches('#project-form')) {
            e.preventDefault();
            handleProjectSubmit(e);
          } else if (e.target.matches('#monitoring-form')) {
            e.preventDefault();
            handleMonitoringSubmit(e);
          } else if (e.target.matches('#report-form')) {
            e.preventDefault();
            handleReportSubmit(e);
          } else if (e.target.matches('#team-member-form')) {
            e.preventDefault();
            handleTeamMemberSubmit(e);
          } else if (e.target.matches('#observation-form')) {
            e.preventDefault();
            handleObservationSubmit(e);
          }
        });

        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('project-start-date').value = today;
        document.getElementById('observation-date').value = today;
        
        const nextYear = new Date();
        nextYear.setFullYear(nextYear.getFullYear() + 1);
        document.getElementById('project-end-date').value = nextYear.toISOString().split('T')[0];
        
        const firstDay = new Date();
        firstDay.setDate(1);
        document.getElementById('report-start-date').value = firstDay.toISOString().split('T')[0];
        document.getElementById('report-end-date').value = today;
        
        initTooltips();
        populateProjectDropdown('monitoring-project-filter');
        populateProjectDropdown('observation-project');
        populateProjectDropdown('report-project');
        
      } catch (error) {
        console.error('Error during initialization:', error);
        showToast('Error initializing application: ' + error.message, 'error');
        showLoading(false);
      }
    });

    // Add any other missing functions you need here
    function saveData() {
      try {
        localStorage.setItem('erpm-projects', JSON.stringify(state.projects));
        localStorage.setItem('erpm-monitoring', JSON.stringify(state.monitoringPoints));
        localStorage.setItem('erpm-activities', JSON.stringify(state.activities));
        localStorage.setItem('erpm-team', JSON.stringify(state.teamMembers));
      } catch (error) {
        console.error('Error saving data:', error);
        showToast('Error saving data: ' + error.message, 'error');
      }
    }

    function loadData() {
      try {
        const savedProjects = localStorage.getItem('erpm-projects');
        const savedMonitoring = localStorage.getItem('erpm-monitoring');
        const savedActivities = localStorage.getItem('erpm-activities');
        const savedTeam = localStorage.getItem('erpm-team');
        
        if (savedProjects) state.projects = JSON.parse(savedProjects);
        if (savedMonitoring) state.monitoringPoints = JSON.parse(savedMonitoring);
        if (savedActivities) state.activities = JSON.parse(savedActivities);
        if (savedTeam) state.teamMembers = JSON.parse(savedTeam);
        
        // Load sample data if no data exists
        if (state.projects.length === 0) {
          state.projects = [
            {
              id: '1',
              name: 'Riverside Wetland Restoration',
              type: 'wetland',
              status: 'active',
              location: {
                name: 'Smith River, NSW',
                coords: [-33.8688, 151.2093]
              },
              description: 'Restoring 5ha of degraded wetland habitat with native vegetation and improving water quality.',
              startDate: '2023-01-01',
              endDate: '2023-12-31',
              area: 5.2,
              budget: 125000,
              photos: [],
              milestones: [
                {
                  id: '1',
                  name: 'Site Assessment',
                  date: '2023-01-15',
                  completed: true,
                  description: 'Initial ecological assessment completed'
                }
              ]
            }
          ];
          saveData();
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading saved data: ' + error.message, 'error');
      }
    }

    // Add other essential functions as needed...

  </script>
</body>
</html>
