<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSim: Tasmanian Environmental Management Tool</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- jsPDF for report generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2E8B57;
            --primary-dark: #1E5B37;
            --secondary: #3CB371;
            --light: #F5F5F5;
            --lighter: #FAFAFA;
            --dark: #333;
            --darker: #222;
            --gray: #777;
            --light-gray: #DDD;
            --danger: #DC3545;
            --warning: #FFC107;
            --info: #17A2B8;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--lighter);
            color: var(--dark);
            line-height: 1.6;
        }
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .logo i {
            font-size: 2rem;
        }
        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .main-content {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .sidebar {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: fit-content;
        }
        .map-container {
            flex: 2;
            min-width: 400px;
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
        }
        .step {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background-color: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }
        .step:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .step h3 {
            margin-top: 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .step h3 i {
            font-size: 1.2em;
        }
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0.25rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: var(--light-gray);
            color: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        button.secondary {
            background-color: var(--light);
            color: var(--dark);
        }
        button.secondary:hover {
            background-color: var(--light-gray);
        }
        button.danger {
            background-color: var(--danger);
        }
        button.danger:hover {
            background-color: #BB2D3B;
        }
        button.warning {
            background-color: var(--warning);
            color: var(--darker);
        }
        button.warning:hover {
            background-color: #E0A800;
        }
        .report-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }
        .file-actions {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .threat-item, .action-item {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--light-gray);
            transition: all 0.2s;
        }
        .threat-item:hover, .action-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .coord-input {
            margin: 0.75rem 0;
        }
        .coord-input label {
            display: inline-block;
            min-width: 60px;
            font-weight: 500;
        }
        .coord-input input {
            width: 140px;
            padding: 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
        }
        .threat-description, .action-description {
            font-size: 0.85em;
            color: var(--gray);
            margin-top: 0.4rem;
            padding-left: 1.5rem;
        }
        .threat-severity, .action-cost, .action-time {
            padding: 0.3rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            margin-left: 0.5rem;
        }
        .remove-threat, .remove-action {
            float: right;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0 0.3rem;
            font-size: 1.2em;
            line-height: 1;
        }
        .remove-threat:hover, .remove-action:hover {
            color: #BB2D3B;
            transform: scale(1.2);
        }
        select, input[type="text"], input[type="number"] {
            padding: 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            margin: 0.25rem 0;
        }
        select {
            min-width: 200px;
        }
        label {
            display: block;
            margin: 0.5rem 0;
            font-weight: 500;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .progress-container {
            width: 100%;
            background-color: var(--light-gray);
            border-radius: 5px;
            margin: 1rem 0;
        }
        .progress-bar {
            height: 10px;
            background-color: var(--primary);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--light-gray);
            margin-right: 5px;
        }
        .status-complete {
            background-color: var(--primary);
        }
        .status-active {
            background-color: var(--warning);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            margin-bottom: 1rem;
        }
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .simulation-visual {
            width: 100%;
            height: 200px;
            background-color: var(--light);
            border-radius: 8px;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }
        .visual-bar {
            position: absolute;
            bottom: 0;
            width: 30px;
            background-color: var(--danger);
            transition: all 1s ease;
        }
        .visual-bar.reduced {
            background-color: var(--primary);
        }
        .visual-label {
            position: absolute;
            bottom: -25px;
            font-size: 0.8em;
            text-align: center;
            width: 30px;
        }
        .visual-title {
            position: absolute;
            top: 10px;
            left: 10px;
            font-weight: bold;
        }
        .help-text {
            font-size: 0.85em;
            color: var(--gray);
            margin-top: 0.25rem;
        }
        .toggle-content {
            max-height: 300;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease;
        }
        .toggle-content.expanded {
            max-height: 1000px;
        }
        .toggle-button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .toggle-button i {
            transition: transform 0.3s;
        }
        .toggle-button.expanded i {
            transform: rotate(90deg);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.error {
            background-color: var(--danger);
        }
        .toast.success {
            background-color: var(--primary);
        }
        .toast.warning {
            background-color: var(--warning);
            color: var(--darker);
        }
        /* New styles for improved mobile experience */
        .mobile-hidden {
            display: initial;
        }
        .mobile-visible {
            display: none;
        }
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .sidebar, .map-container {
                min-width: 100%;
            }
            #map {
                height: 400px;
            }
            .mobile-hidden {
                display: none;
            }
            .mobile-visible {
                display: initial;
            }
            .file-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .file-actions button {
                width: 100%;
                margin: 0.25rem 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-leaf"></i>
                <h1>EcoSim: Tasmanian Environmental Management Tool</h1>
            </div>
            <p>Assess, analyze, and manage Tasmanian ecosystems with this comprehensive planning tool</p>
        </div>
    </header>

    <div class="container">
        <div class="file-actions">
            <button id="newProject"><i class="fas fa-file"></i> New Project</button>
            <button id="saveProject"><i class="fas fa-save"></i> Save Project</button>
            <button id="loadProject"><i class="fas fa-folder-open"></i> Load Project</button>
            <button id="shareProject"><i class="fas fa-share-alt"></i> Share Link</button>
            <button id="helpButton" class="secondary"><i class="fas fa-question-circle"></i> Help</button>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="step">
                    <h3><i class="fas fa-user"></i> 1. User Profile</h3>
                    <div class="form-group">
                        <label for="userLevel">User Type:</label>
                        <select id="userLevel">
                            <option value="community">Community Group/Landcare</option>
                            <option value="student">Student/Researcher</option>
                            <option value="professional">Professional/Consultant</option>
                            <option value="government">Government/Local Council</option>
                        </select>
                        <p class="help-text">This adjusts the complexity of recommendations and reporting</p>
                    </div>
                    <div class="form-group">
                        <label for="organization">Organization (optional):</label>
                        <input type="text" id="organization" placeholder="e.g. Tasmanian Land Conservancy">
                    </div>
                </div>

                <div class="step">
                    <h3><i class="fas fa-map-marked-alt"></i> 2. Site Assessment</h3>
                    <div class="form-group">
                        <label for="projectName">Project Name:</label>
                        <input type="text" id="projectName" placeholder="e.g. Huon Valley Restoration">
                    </div>
                    <div class="form-group">
                        <label for="ecosystemType">Primary Ecosystem Type:</label>
                        <select id="ecosystemType">
                            <option value="">Select ecosystem...</option>
                            <option value="dry-eucalypt">Dry Eucalypt Forest</option>
                            <option value="wet-eucalypt">Wet Eucalypt Forest</option>
                            <option value="rainforest">Temperate Rainforest</option>
                            <option value="wetland">Wetland</option>
                            <option value="grassland">Native Grassland</option>
                            <option value="coastal">Coastal Heathland</option>
                            <option value="alpine">Alpine Vegetation</option>
                            <option value="riparian">Riparian Zone</option>
                            <option value="agricultural">Agricultural Land</option>
                            <option value="urban">Urban/Peri-urban</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div id="customQuestions"></div>
                    <button id="startAssessment" class="secondary"><i class="fas fa-clipboard-check"></i> Begin Detailed Assessment</button>
                    <div id="assessmentForm" class="toggle-content">
                        <div class="form-group">
                            <label>Site Size (hectares):</label>
                            <input type="number" id="siteSize" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Current Condition:</label>
                            <select id="siteCondition">
                                <option value="pristine">Pristine/Undisturbed</option>
                                <option value="good">Good Condition</option>
                                <option value="moderate">Moderately Degraded</option>
                                <option value="poor">Poor Condition</option>
                                <option value="degraded">Severely Degraded</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Protected Area Status:</label>
                            <select id="protectionStatus">
                                <option value="none">Not Protected</option>
                                <option value="private">Private Conservation</option>
                                <option value="local">Local Reserve</option>
                                <option value="state">State Reserve</option>
                                <option value="national">National Park/World Heritage</option>
                            </select>
                        </div>
                        <button id="saveAssessment" class="secondary"><i class="fas fa-save"></i> Save Assessment</button>
                    </div>
                </div>

                <div class="step">
                    <h3><i class="fas fa-biohazard"></i> 3. Threat Analysis</h3>
                    <p>Identify key threats to your site's biodiversity values</p>
                    <button id="analyzeThreats" disabled><i class="fas fa-search"></i> Analyze Threats</button>
                    <div id="threatForm" class="toggle-content">
                        <button id="addDefaultThreats" class="secondary"><i class="fas fa-magic"></i> Add Tasmanian Threats</button>
                        <button id="addThreat" class="secondary"><i class="fas fa-plus"></i> Add Custom Threat</button>
                        <div id="threatList" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="step">
                    <h3><i class="fas fa-tasks"></i> 4. Management Actions</h3>
                    <p>Select appropriate management responses</p>
                    <button id="selectActions" disabled><i class="fas fa-check-circle"></i> Select Actions</button>
                    <div id="actionForm" class="toggle-content">
                        <button id="addDefaultActions" class="secondary"><i class="fas fa-magic"></i> Add Recommended Actions</button>
                        <button id="addAction" class="secondary"><i class="fas fa-plus"></i> Add Custom Action</button>
                        <div id="actionList" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="step">
                    <h3><i class="fas fa-chart-line"></i> 5. Run Simulation</h3>
                    <p>Project outcomes of your management plan</p>
                    <button id="runSimulation" disabled><i class="fas fa-play"></i> Run Simulation</button>
                    <div id="simulationResults" class="toggle-content" style="margin-top: 1rem;"></div>
                </div>

                <div class="step">
                    <h3><i class="fas fa-file-pdf"></i> 6. Generate Report</h3>
                    <p>Create a professional management plan document</p>
                    <button id="generateReport" disabled><i class="fas fa-download"></i> Generate PDF Report</button>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label>Report Type:</label>
                        <select id="reportType">
                            <option value="basic">Basic Summary</option>
                            <option value="detailed">Detailed Management Plan</option>
                            <option value="funding">Funding Application</option>
                            <option value="academic">Academic Report</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <h3><i class="fas fa-map"></i> Project Area</h3>
                <div id="map"></div>
                <div id="mapControls" style="margin-top: 1rem;">
                    <button id="drawPolygon"><i class="fas fa-draw-polygon"></i> <span class="mobile-hidden">Draw Area</span></button>
                    <button id="dropPin"><i class="fas fa-map-marker-alt"></i> <span class="mobile-hidden">Drop Pin at My Location</span></button>
                    <button id="dropPinManual"><i class="fas fa-map-pin"></i> <span class="mobile-hidden">Drop Pin Manually</span></button>
                    <button id="clearMap" class="danger"><i class="fas fa-trash-alt"></i> <span class="mobile-hidden">Clear Map</span></button>
                </div>
                <div id="contentArea" style="margin-top: 1.5rem;">
                    <h4><i class="fas fa-crosshairs"></i> Enter Coordinates</h4>
                    <div class="coord-input">
                        <label>Latitude: </label>
                        <input type="text" id="lat" placeholder="-41.0529 (Tasmania approx.)" pattern="-?\d{1,3}\.\d{1,6}">
                    </div>
                    <div class="coord-input">
                        <label>Longitude: </label>
                        <input type="text" id="lng" placeholder="145.9066 (Tasmania approx.)" pattern="-?\d{1,3}\.\d{1,6}">
                    </div>
                    <button id="addMarker"><i class="fas fa-plus"></i> Add Marker</button>
                    <p class="help-text">Example Tasmanian locations: Hobart (-42.8821, 147.3272), Launceston (-41.4332, 147.1441), Cradle Mountain (-41.6851, 145.9499)</p>
                </div>
                <div id="areaCalculation" style="margin-top: 1.5rem; display: none;">
                    <h4><i class="fas fa-ruler-combined"></i> Area Calculation</h4>
                    <p>Approximate area: <span id="areaValue">0</span> hectares</p>
                </div>
            </div>
        </div>

        <div id="reportOutput" class="report-section" style="display: none;">
            <h2><i class="fas fa-file-alt"></i> Recommendations Report Preview</h2>
            <div id="reportContent"></div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <!-- Help modal -->
    <div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 2rem; border-radius: 10px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h2><i class="fas fa-question-circle"></i> EcoSim Help Guide</h2>
            <div class="tab-container">
                <div class="tab active" data-tab="overview">Overview</div>
                <div class="tab" data-tab="assessment">Assessment</div>
                <div class="tab" data-tab="threats">Threats</div>
                <div class="tab" data-tab="actions">Actions</div>
                <div class="tab" data-tab="simulation">Simulation</div>
            </div>
            <div class="tab-content active" data-tab="overview">
                <h3>About EcoSim</h3>
                <p>EcoSim is a comprehensive environmental management tool designed specifically for Tasmanian ecosystems, but applicable to other regions. It helps users:</p>
                <ul>
                    <li>Assess environmental conditions</li>
                    <li>Identify key threats to biodiversity</li>
                    <li>Plan appropriate management actions</li>
                    <li>Simulate potential outcomes</li>
                    <li>Generate professional reports</li>
                </ul>
                <h3>Getting Started</h3>
                <ol>
                    <li>Set your user profile to tailor the tool to your needs</li>
                    <li>Define your project area using the map tools</li>
                    <li>Complete the site assessment questions</li>
                    <li>Add relevant threats to your site</li>
                    <li>Select appropriate management actions</li>
                    <li>Run the simulation to see projected outcomes</li>
                    <li>Generate a PDF report of your management plan</li>
                </ol>
            </div>
            <div class="tab-content" data-tab="assessment">
                <h3>Site Assessment</h3>
                <p>The assessment section helps characterize your site's key features:</p>
                <ul>
                    <li><strong>Ecosystem Type:</strong> Select the primary vegetation type (automatically loads relevant questions)</li>
                    <li><strong>Site Condition:</strong> Rate the current ecological condition</li>
                    <li><strong>Protected Status:</strong> Indicate any formal protection status</li>
                    <li><strong>Site Size:</strong> Important for scaling management actions</li>
                </ul>
                <p>Tasmanian-specific ecosystem types include:</p>
                <ul>
                    <li><strong>Wet Eucalypt Forest:</strong> Dominated by Eucalyptus species with dense understory</li>
                    <li><strong>Temperate Rainforest:</strong> Myrtle beech, sassafras, and leatherwood communities</li>
                    <li><strong>Coastal Heathland:</strong> Low-growing shrubs adapted to salt spray</li>
                    <li><strong>Alpine Vegetation:</strong> High-altitude cushion plants and conifers</li>
                </ul>
            </div>
            <div class="tab-content" data-tab="threats">
                <h3>Threat Analysis</h3>
                <p>Tasmania faces unique environmental threats:</p>
                <ul>
                    <li><strong>Invasive Species:</strong> Foxes, rabbits, deer, and wasps</li>
                    <li><strong>Diseases:</strong> Myrtle wilt, Phytophthora root rot</li>
                    <li><strong>Habitat Loss:</strong> From agriculture, forestry, and development</li>
                    <li><strong>Climate Change:</strong> Particularly impacts alpine areas</li>
                </ul>
                <p>For each threat, you can:</p>
                <ul>
                    <li>Set severity (1-5 scale)</li>
                    <li>Add custom descriptions</li>
                    <li>Remove irrelevant threats</li>
                </ul>
                <p>The tool will prioritize actions based on threat severity.</p>
            </div>
            <div class="tab-content" data-tab="actions">
                <h3>Management Actions</h3>
                <p>The tool suggests appropriate actions based on:</p>
                <ul>
                    <li>Ecosystem type</li>
                    <li>Identified threats</li>
                    <li>Site condition</li>
                </ul>
                <p>Common Tasmanian actions include:</p>
                <ul>
                    <li><strong>Predator Control:</strong> For fox and cat management</li>
                    <li><strong>Revegetation:</strong> Using local provenance plants</li>
                    <li><strong>Weed Management:</strong> Targeting species like gorse and blackberry</li>
                    <li><strong>Fire Management:</strong> Appropriate burning regimes</li>
                </ul>
                <p>You can customize each action's cost and timeframe.</p>
            </div>
            <div class="tab-content" data-tab="simulation">
                <h3>Simulation</h3>
                <p>The simulation projects:</p>
                <ul>
                    <li>Potential threat reduction</li>
                    <li>Biodiversity outcomes</li>
                    <li>Cost estimates</li>
                    <li>Implementation timeframe</li>
                </ul>
                <p>Results are based on:</p>
                <ul>
                    <li>Tasmanian ecological research</li>
                    <li>Threat severity rankings</li>
                    <li>Action effectiveness studies</li>
                    <li>Site-specific factors</li>
                </ul>
                <p>The simulation helps prioritize actions for maximum impact.</p>
            </div>
            <button id="closeHelp" style="margin-top: 1rem; width: 100%;"><i class="fas fa-times"></i> Close Help</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Draw for polygon drawing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <!-- Turf.js for area calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <!-- LZString for URL compression (for sharing projects) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

    <script>
        // Constants for configuration
        const TASMANIA_BOUNDS = {
            minLat: -43.7,
            maxLat: -40.3,
            minLng: 144.5,
            maxLng: 148.5
        };
        
        // Initialize the map centered on Tasmania
        const map = L.map('map').setView([-41.4545, 145.9707], 7);
        
        // Add base layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const tasTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // Tasmanian specific layers
        const tasForests = L.tileLayer('https://services.thelist.tas.gov.au/arcgis/rest/services/Public/Basemaps_Tasmania/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tasmanian Government LIST'
        });

        const baseLayers = {
            "OpenStreetMap": osmLayer,
            "Topographic": tasTopo,
            "Satellite": satellite,
            "Tasmanian Forests": tasForests
        };

        L.control.layers(baseLayers).addTo(map);

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // Project data structure
        let projectData = {
            name: "",
            organization: "",
            userLevel: "community",
            ecosystem: "",
            coordinates: [],
            area: 0,
            condition: "moderate",
            protection: "none",
            threats: [],
            actions: [],
            simulation: null,
            assessment: {},
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        // Feature groups for drawn items
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Initialize draw control
        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    metric: true,
                    shapeOptions: {
                        color: '#2E8B57',
                        fillColor: '#2E8B57',
                        fillOpacity: 0.2
                    }
                },
                rectangle: false,
                circle: false,
                marker: {
                    icon: L.icon({
                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                },
                polyline: false
            }
        });
        map.addControl(drawControl);

        // Event listeners for drawing
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);
            
            if (layer instanceof L.Marker) {
                projectData.coordinates = [[layer.getLatLng().lat, layer.getLatLng().lng]];
                projectData.area = 0;
                document.getElementById('areaCalculation').style.display = 'none';
            } else if (layer instanceof L.Polygon) {
                projectData.coordinates = layer.getLatLngs()[0].map(ll => [ll.lat, ll.lng]);
                calculateArea(layer.getLatLngs()[0]);
            }
            
            updateUI();
        });

        // Calculate area in hectares
        function calculateArea(latlngs) {
            try {
                // Convert to GeoJSON format
                const polygon = {
                    type: "Polygon",
                    coordinates: [latlngs.map(ll => [ll.lng, ll.lat])]
                };
                
                // Calculate area in square meters
                const area = turf.area(polygon);
                
                // Convert to hectares
                projectData.area = area / 10000;
                
                // Update UI
                document.getElementById('areaValue').textContent = projectData.area.toFixed(2);
                document.getElementById('areaCalculation').style.display = 'block';
                
                // Update assessment form if open
                if (document.getElementById('siteSize')) {
                    document.getElementById('siteSize').value = projectData.area.toFixed(2);
                }
            } catch (err) {
                console.error("Error calculating area:", err);
                showToast("Error calculating area. Please try drawing again.", "error");
            }
        }

        // Clear map button
        document.getElementById('clearMap').addEventListener('click', function() {
            drawnItems.clearLayers();
            projectData.coordinates = [];
            projectData.area = 0;
            document.getElementById('lat').value = '';
            document.getElementById('lng').value = '';
            document.getElementById('areaCalculation').style.display = 'none';
            updateUI();
        });

        // Add marker button with improved validation
        document.getElementById('addMarker').addEventListener('click', function() {
            const latInput = document.getElementById('lat').value.trim();
            const lngInput = document.getElementById('lng').value.trim();
            
            if (!latInput || !lngInput) {
                showToast("Please enter both latitude and longitude", "error");
                return;
            }
            
            const lat = parseFloat(latInput);
            const lng = parseFloat(lngInput);
            
            if (isNaN(lat) || isNaN(lng)) {
                showToast("Please enter valid numeric coordinates", "error");
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showToast("Coordinates out of valid range (Lat: -90 to 90, Lng: -180 to 180)", "error");
                return;
            }
            
            // Check if in Tasmania
            if (!isInTasmania(lat, lng)) {
                if (!confirm("These coordinates appear to be outside Tasmania. Continue?")) {
                    return;
                }
            }
            
            drawnItems.clearLayers();
            const marker = L.marker([lat, lng]).addTo(drawnItems);
            projectData.coordinates = [[lat, lng]];
            projectData.area = 0;
            document.getElementById('areaCalculation').style.display = 'none';
            updateUI();
            map.setView([lat, lng], 13);
        });

        function isInTasmania(lat, lng) {
            return lat >= TASMANIA_BOUNDS.minLat && 
                   lat <= TASMANIA_BOUNDS.maxLat && 
                   lng >= TASMANIA_BOUNDS.minLng && 
                   lng <= TASMANIA_BOUNDS.maxLng;
        }

        // Drop pin at current location
        document.getElementById('dropPin').addEventListener('click', function() {
            if (!navigator.geolocation) {
                showToast("Geolocation is not supported by your browser", "error");
                return;
            }
            
            this.innerHTML = '<div class="loading"></div> Locating...';
            this.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Check if in Tasmania
                    if (!isInTasmania(lat, lng)) {
                        if (!confirm("Your location appears to be outside Tasmania. Continue with this location?")) {
                            resetDropPinButton();
                            return;
                        }
                    }
                    
                    drawnItems.clearLayers();
                    const marker = L.marker([lat, lng]).addTo(drawnItems);
                    projectData.coordinates = [[lat, lng]];
                    projectData.area = 0;
                    
                    // Update coordinate fields
                    document.getElementById('lat').value = lat.toFixed(6);
                    document.getElementById('lng').value = lng.toFixed(6);
                    document.getElementById('areaCalculation').style.display = 'none';
                    
                    updateUI();
                    map.setView([lat, lng], 13);
                    resetDropPinButton();
                },
                error => {
                    showToast("Unable to get your location: " + error.message, "error");
                    resetDropPinButton();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
            
            function resetDropPinButton() {
                document.getElementById('dropPin').innerHTML = '<i class="fas fa-map-marker-alt"></i> <span class="mobile-hidden">Drop Pin at My Location</span>';
                document.getElementById('dropPin').disabled = false;
            }
        });

        // Drop pin manually by clicking on map
        document.getElementById('dropPinManual').addEventListener('click', function() {
            // Clear any existing click handler
            map.off('click');
            
            // Set cursor style
            map.getContainer().style.cursor = 'crosshair';
            
            // Add click handler
            map.once('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                drawnItems.clearLayers();
                const marker = L.marker([lat, lng]).addTo(drawnItems);
                projectData.coordinates = [[lat, lng]];
                projectData.area = 0;
                
                // Update coordinate fields
                document.getElementById('lat').value = lat.toFixed(6);
                document.getElementById('lng').value = lng.toFixed(6);
                document.getElementById('areaCalculation').style.display = 'none';
                
                updateUI();
                map.getContainer().style.cursor = '';
                
                showToast("Marker placed at " + lat.toFixed(4) + ", " + lng.toFixed(4), "success");
            });
            
            showToast("Click on the map to place your pin", "info");
        });

        // User level selector
        document.getElementById('userLevel').addEventListener('change', function() {
            projectData.userLevel = this.value;
            updateUI();
        });

        // Organization input
        document.getElementById('organization').addEventListener('change', function() {
            projectData.organization = this.value;
        });

        // Project name input
        document.getElementById('projectName').addEventListener('change', function() {
            projectData.name = this.value;
        });

        // Start assessment toggle
        document.getElementById('startAssessment').addEventListener('click', function() {
            const content = document.getElementById('assessmentForm');
            const isExpanded = content.classList.contains('expanded');
            
            if (!isExpanded) {
                // Only allow if coordinates are set
                if (projectData.coordinates.length === 0) {
                    showToast("Please set your project location first", "error");
                    return;
                }
                
                content.classList.add('expanded');
                this.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Assessment';
            } else {
                content.classList.remove('expanded');
                this.innerHTML = '<i class="fas fa-clipboard-check"></i> Begin Detailed Assessment';
            }
        });

        // Save assessment
        document.getElementById('saveAssessment').addEventListener('click', function() {
            try {
                projectData.assessment = {
                    size: parseFloat(document.getElementById('siteSize').value) || 0,
                    condition: document.getElementById('siteCondition').value,
                    protection: document.getElementById('protectionStatus').value,
                    completed: true
                };
                
                projectData.condition = projectData.assessment.condition;
                projectData.protection = projectData.assessment.protection;
                
                document.getElementById('analyzeThreats').disabled = false;

                showToast("Assessment saved successfully", "success");
                document.getElementById('analyzeThreats').disabled = false;
            } catch (err) {
                console.error("Error saving assessment:", err);
                showToast("Error saving assessment", "error");
            }
        });

        // Ecosystem type change
        document.getElementById('ecosystemType').addEventListener('change', function() {
            projectData.ecosystem = this.value;
            updateCustomQuestions();
        });

        function updateCustomQuestions() {
            // Question templates for each ecosystem type
            const questions = {
                'dry-eucalypt': [
                    {text: 'Dominant eucalypt species:', type: 'text', id: 'q0'},
                    {text: 'Understory type:', type: 'select', options: ['Heathy', 'Shrubby', 'Grassy', 'Sparse'], id: 'q1'},
                    {text: 'Fire history:', type: 'select', options: ['Frequent', 'Occasional', 'Rare', 'Unknown'], id: 'q2'},
                    {text: 'Evidence of dieback?', type: 'radio', options: ['Yes', 'No', 'Suspected'], id: 'q3'},
                    {text: 'Estimated tree canopy cover (%):', type: 'range', min: 0, max: 100, id: 'q4'}
                ],
                'wet-eucalypt': [
                    {text: 'Dominant eucalypt species:', type: 'text', id: 'q0'},
                    {text: 'Understory type:', type: 'select', options: ['Fern-dominated', 'Shrub-dominated', 'Mixed', 'Sparse'], id: 'q1'},
                    {text: 'Evidence of logging history?', type: 'radio', options: ['Yes', 'No', 'Unknown'], id: 'q2'},
                    {text: 'Presence of myrtle wilt?', type: 'radio', options: ['Yes', 'No', 'Suspected'], id: 'q3'},
                    {text: 'Estimated tree canopy cover (%):', type: 'range', min: 0, max: 100, id: 'q4'}
                ],
                'rainforest': [
                    {text: 'Dominant canopy species:', type: 'text', id: 'q0'},
                    {text: 'Myrtle beech present?', type: 'radio', options: ['Yes', 'No'], id: 'q1'},
                    {text: 'Signs of myrtle wilt?', type: 'radio', options: ['Yes', 'No', 'Suspected'], id: 'q2'},
                    {text: 'Epiphyte abundance:', type: 'select', options: ['High', 'Moderate', 'Low', 'None observed'], id: 'q3'},
                    {text: 'Logging history evidence:', type: 'select', options: ['None', 'Selective', 'Clear-felled', 'Unknown'], id: 'q4'}
                ],
                'wetland': [
                    {text: 'Water source:', type: 'select', options: ['Riverine', 'Palustrine', 'Lacustrine', 'Groundwater'], id: 'q0'},
                    {text: 'Hydrology pattern:', type: 'select', options: ['Permanent', 'Seasonal', 'Ephemeral', 'Intermittent'], id: 'q1'},
                    {text: 'Dominant vegetation:', type: 'text', id: 'q2'},
                    {text: 'Invasive species present?', type: 'checkbox', options: ['Willow', 'Blackberry', 'Rice Grass', 'Other'], id: 'q3'},
                    {text: 'Water quality concerns:', type: 'checkbox', options: ['Turbidity', 'Nutrients', 'Salinity', 'Pollutants'], id: 'q4'}
                ],
                'grassland': [
                    {text: 'Dominant grass species:', type: 'text', id: 'q0'},
                    {text: 'Native grass cover (%):', type: 'range', min: 0, max: 100, id: 'q1'},
                    {text: 'Grazing pressure:', type: 'select', options: ['None', 'Light', 'Moderate', 'Heavy'], id: 'q2'},
                    {text: 'Fire history:', type: 'select', options: ['Frequent', 'Occasional', 'Rare', 'Unknown'], id: 'q3'},
                    {text: 'Kangaroo/wallaby activity:', type: 'select', options: ['None', 'Light', 'Moderate', 'Heavy'], id: 'q4'}
                ],
                'coastal': [
                    {text: 'Coastal type:', type: 'select', options: ['Dune', 'Cliff', 'Rocky shore', 'Estuarine'], id: 'q0'},
                    {text: 'Erosion signs:', type: 'select', options: ['None', 'Minor', 'Moderate', 'Severe'], id: 'q1'},
                    {text: 'Invasive plants present?', type: 'checkbox', options: ['Marram grass', 'Sea spurge', 'Boneseed', 'Other'], id: 'q2'},
                    {text: 'Shorebird nesting areas?', type: 'radio', options: ['Yes', 'No', 'Possible'], id: 'q3'},
                    {text: 'Visitor pressure:', type: 'select', options: ['None', 'Low', 'Moderate', 'High'], id: 'q4'}
                ],
                'alpine': [
                    {text: 'Elevation (m):', type: 'number', id: 'q0'},
                    {text: 'Vegetation type:', type: 'select', options: ['Herbfield', 'Heath', 'Coniferous shrubland', 'Feldmark'], id: 'q1'},
                    {text: 'Snow cover duration:', type: 'select', options: ['Prolonged', 'Seasonal', 'Occasional', 'Rare'], id: 'q2'},
                    {text: 'Erosion signs:', type: 'select', options: ['None', 'Minor', 'Moderate', 'Severe'], id: 'q3'},
                    {text: 'Climate change impacts:', type: 'checkbox', options: ['Vegetation change', 'Species loss', 'Erosion increase', 'Other'], id: 'q4'}
                ],
                'riparian': [
                    {text: 'Waterway type:', type: 'select', options: ['River', 'Stream', 'Creek', 'Drainage line'], id: 'q0'},
                    {text: 'Flow regime:', type: 'select', options: ['Permanent', 'Seasonal', 'Ephemeral', 'Intermittent'], id: 'q1'},
                    {text: 'Bank stability:', type: 'select', options: ['Stable', 'Moderate', 'Unstable', 'Eroding'], id: 'q2'},
                    {text: 'Riparian vegetation width (m):', type: 'number', id: 'q3'},
                    {text: 'Threats:', type: 'checkbox', options: ['Weeds', 'Livestock access', 'Bank erosion', 'Pollution'], id: 'q4'}
                ],
                'agricultural': [
                    {text: 'Land use:', type: 'select', options: ['Cropping', 'Grazing', 'Horticulture', 'Mixed'], id: 'q0'},
                    {text: 'Soil health indicators:', type: 'checkbox', options: ['Good structure', 'Organic matter', 'Biological activity', 'Erosion'], id: 'q1'},
                    {text: 'Water management:', type: 'select', options: ['Irrigated', 'Dryland', 'Drainage', 'Other'], id: 'q2'},
                    {text: 'Chemical inputs:', type: 'select', options: ['None', 'Low', 'Moderate', 'High'], id: 'q3'},
                    {text: 'Wildlife corridors:', type: 'radio', options: ['Present', 'Absent', 'Planned'], id: 'q4'}
                ],
                'urban': [
                    {text: 'Urban zone:', type: 'select', options: ['Residential', 'Commercial', 'Industrial', 'Parkland'], id: 'q0'},
                    {text: 'Green space (%):', type: 'range', min: 0, max: 100, id: 'q1'},
                    {text: 'Native vegetation cover (%):', type: 'range', min: 0, max: 100, id: 'q2'},
                    {text: 'Stormwater management:', type: 'select', options: ['Natural', 'Engineered', 'Mixed', 'None'], id: 'q3'},
                    {text: 'Wildlife observed:', type: 'checkbox', options: ['Birds', 'Mammals', 'Reptiles', 'Invertebrates'], id: 'q4'}
                ]
            };

            let html = '';
            if (projectData.ecosystem && questions[projectData.ecosystem]) {
                questions[projectData.ecosystem].forEach((q, i) => {
                    html += `<div class="form-group">`;
                    html += `<label>${q.text}</label>`;
                    
                    if (q.type === 'text') {
                        html += `<input type="text" id="${q.id}">`;
                    } else if (q.type === 'select') {
                        html += `<select id="${q.id}">`;
                        q.options.forEach(opt => {
                            html += `<option value="${opt.toLowerCase()}">${opt}</option>`;
                        });
                        html += `</select>`;
                    } else if (q.type === 'radio') {
                        q.options.forEach(opt => {
                            html += `<label style="display: inline-block; margin-right: 1rem;">
                                <input type="radio" name="${q.id}" value="${opt.toLowerCase()}"> ${opt}
                            </label>`;
                        });
                    } else if (q.type === 'checkbox') {
                        q.options.forEach(opt => {
                            html += `<label style="display: inline-block; margin-right: 1rem;">
                                <input type="checkbox" name="${q.id}" value="${opt.toLowerCase()}"> ${opt}
                            </label>`;
                        });
                    } else if (q.type === 'range') {
                        html += `<input type="range" id="${q.id}" min="${q.min}" max="${q.max}" value="${Math.round((q.max-q.min)/2)}">
                                 <span id="${q.id}-value">${Math.round((q.max-q.min)/2)}%</span>`;
                    } else if (q.type === 'number') {
                        html += `<input type="number" id="${q.id}">`;
                    }
                    
                    html += `</div>`;
                });
            }
            
            document.getElementById('customQuestions').innerHTML = html;
            
            // Add event listeners for range inputs
            document.querySelectorAll('input[type="range"]').forEach(range => {
                const valueSpan = document.getElementById(`${range.id}-value`);
                if (valueSpan) {
                    range.addEventListener('input', function() {
                        valueSpan.textContent = `${this.value}%`;
                    });
                }
            });
        }

        // Threat analysis toggle - FIXED THIS FUNCTION
        document.getElementById('analyzeThreats').addEventListener('click', function() {
            const content = document.getElementById('threatForm');
            const isExpanded = content.classList.contains('expanded');
            
            if (!isExpanded) {
                // Only allow if assessment is complete
                if (!projectData.assessment || !projectData.assessment.completed) {
                    showToast("Please complete the site assessment first", "error");
                    return;
                }
                
                content.classList.add('expanded');
                this.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Threats';
                document.getElementById('selectActions').disabled = false; // ENABLE THE ACTIONS BUTTON
            } else {
                content.classList.remove('expanded');
                this.innerHTML = '<i class="fas fa-search"></i> Analyze Threats';
            }
            
            updateThreatList();
        });

        // Tasmanian/Australian specific threats with descriptions
        const tasmanianThreats = [
            {
                name: "Climate change impacts",
                description: "Rising temperatures, changing rainfall patterns affecting native species, particularly in alpine areas",
                severity: 4,
                appliesTo: ["all"]
            },
            {
                name: "Invasive predators (foxes, cats)",
                description: "Introduced predators threatening native wildlife including ground-nesting birds and small mammals",
                severity: 5,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "rainforest", "grassland", "coastal", "alpine"]
            },
            {
                name: "Myrtle wilt disease",
                description: "Fungal disease affecting Tasmanian myrtle (Nothofagus cunninghamii) in rainforest ecosystems",
                severity: 4,
                appliesTo: ["rainforest"]
            },
            {
                name: "Phytophthora root rot",
                description: "Soil-borne disease affecting a range of native plants including banksias and grasstrees",
                severity: 3,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "rainforest", "grassland", "coastal"]
            },
            {
                name: "Habitat fragmentation",
                description: "Clearing of native vegetation creating isolated patches vulnerable to edge effects",
                severity: 4,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "rainforest", "grassland"]
            },
            {
                name: "Invasive herbivores (rabbits, deer)",
                description: "Introduced herbivores competing with native wildlife and damaging vegetation",
                severity: 4,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "grassland", "coastal"]
            },
            {
                name: "Alpine ecosystem degradation",
                description: "Climate change and human activity impacting fragile alpine areas",
                severity: 4,
                appliesTo: ["alpine"]
            },
            {
                name: "Coastal erosion",
                description: "Sea level rise and storm surges affecting coastal habitats",
                severity: 3,
                appliesTo: ["coastal"]
            },
            {
                name: "Overgrazing by native wildlife",
                description: "High densities of wallabies and wombats impacting vegetation regeneration",
                severity: 3,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "grassland"]
            },
            {
                name: "Fire regime changes",
                description: "Altered fire frequency and intensity disrupting ecosystems",
                severity: 4,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "grassland", "coastal"]
            },
            {
                name: "Marine debris pollution",
                description: "Plastics and other waste impacting coastal and marine life",
                severity: 3,
                appliesTo: ["coastal"]
            },
            {
                name: "Agricultural runoff",
                description: "Nutrient and sediment pollution affecting waterways and wetlands",
                severity: 3,
                appliesTo: ["riparian", "wetland"]
            },
            {
                name: "Urban expansion",
                description: "Habitat loss due to residential and commercial development",
                severity: 3,
                appliesTo: ["all"]
            },
            {
                name: "Invasive plants (gorse, blackberry)",
                description: "Weeds outcompeting native vegetation and altering ecosystem function",
                severity: 4,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "grassland", "riparian"]
            },
            {
                name: "Changed hydrology",
                description: "Altered water flows from dams, drainage or extraction",
                severity: 3,
                appliesTo: ["wetland", "riparian"]
            }
        ];

        document.getElementById('addDefaultThreats').addEventListener('click', function() {
            try {
                // Filter threats that apply to current ecosystem
                const applicableThreats = tasmanianThreats.filter(threat => 
                    threat.appliesTo.includes(projectData.ecosystem) || threat.appliesTo.includes("all")
                );
                
                // Only add threats that aren't already in the list
                const existingThreats = projectData.threats.map(t => t.name);
                
                let addedCount = 0;
                applicableThreats.forEach(threat => {
                    if (!existingThreats.includes(threat.name)) {
                        projectData.threats.push({
                            name: threat.name,
                            description: threat.description,
                            severity: threat.severity,
                            appliesTo: threat.appliesTo
                        });
                        addedCount++;
                    }
                });
                
                updateThreatList();
                showToast(`Added ${addedCount} relevant threats for ${projectData.ecosystem} ecosystems`, "success");
                
                // Enable the select actions button if we have threats
                if (projectData.threats.length > 0) {
                    document.getElementById('selectActions').disabled = false;
                }
            } catch (err) {
                console.error("Error adding default threats:", err);
                showToast("Error adding threats", "error");
            }
        });

        function updateThreatList() {
            try {
                let html = '';
                
                if (projectData.threats.length === 0) {
                    html = '<p>No threats added yet. Click "Add Tasmanian Threats" to get started.</p>';
                } else {
                    projectData.threats.forEach((threat, i) => {
                        html += `
                        <div class="threat-item">
                            <label><input type="checkbox" checked> ${threat.name}</label>
                            <select class="threat-severity" data-index="${i}">
                                <option value="1" ${threat.severity === 1 ? 'selected' : ''}>1 - Minimal</option>
                                <option value="2" ${threat.severity === 2 ? 'selected' : ''}>2 - Slight</option>
                                <option value="3" ${threat.severity === 3 ? 'selected' : ''}>3 - Moderate</option>
                                <option value="4" ${threat.severity === 4 ? 'selected' : ''}>4 - Severe</option>
                                <option value="5" ${threat.severity === 5 ? 'selected' : ''}>5 - Critical</option>
                            </select>
                            <button class="remove-threat" data-index="${i}" title="Remove threat"></button>
                            ${threat.description ? `<div class="threat-description">${threat.description}</div>` : ''}
                        </div>`;
                    });
                }
                
                document.getElementById('threatList').innerHTML = html;

                // Add event listeners
                document.querySelectorAll('.remove-threat').forEach(btn => {
                    btn.addEventListener('click', function() {
                        projectData.threats.splice(parseInt(this.dataset.index), 1);
                        updateThreatList();
                        showToast("Threat removed", "info");
                        
                        // Disable actions button if no threats left
                        if (projectData.threats.length === 0) {
                            document.getElementById('selectActions').disabled = true;
                        }
                        
                        // Refresh simulation if it exists
                        refreshSimulationIfExists();
                    });
                });

                document.querySelectorAll('.threat-severity').forEach(select => {
                    select.addEventListener('change', function() {
                        const index = parseInt(this.dataset.index);
                        projectData.threats[index].severity = parseInt(this.value);
                        
                        // Update threat in list with visual feedback
                        this.style.borderLeft = `4px solid ${getSeverityColor(parseInt(this.value))}`;
                        
                        // Refresh simulation if it exists
                        refreshSimulationIfExists();
                    });
                });
            } catch (err) {
                console.error("Error updating threat list:", err);
                showToast("Error updating threats", "error");
            }
        }

        function getSeverityColor(severity) {
            switch(severity) {
                case 1: return '#5cb85c'; // Green
                case 2: return '#5bc0de'; // Blue
                case 3: return '#f0ad4e'; // Yellow
                case 4: return '#ff8c00'; // Orange
                case 5: return '#d9534f'; // Red
                default: return '#777';
            }
        }

        document.getElementById('addThreat').addEventListener('click', function() {
            try {
                const name = prompt("Enter threat name:");
                if (!name) return;
                
                const description = prompt("Enter threat description (optional):");
                const severityStr = prompt("Severity level (1-5):") || "3";
                const severity = parseInt(severityStr);
                
                if (isNaN(severity)) {
                    showToast("Please enter a valid number", "error");
                    return;
                }
                
                if (severity < 1 || severity > 5) {
                    showToast("Severity must be between 1 and 5", "error");
                    return;
                }
                
                projectData.threats.push({
                    name: name,
                    description: description,
                    severity: severity
                });
                
                updateThreatList();
                showToast("Custom threat added", "success");
                
                // Enable the select actions button
                document.getElementById('selectActions').disabled = false;
                
                // Refresh simulation if it exists
                refreshSimulationIfExists();
            } catch (err) {
                console.error("Error adding custom threat:", err);
                showToast("Error adding threat", "error");
            }
        });

        // Management actions toggle - FIXED THIS FUNCTION
        document.getElementById('selectActions').addEventListener('click', function() {
            const content = document.getElementById('actionForm');
            const isExpanded = content.classList.contains('expanded');
            
            if (!isExpanded) {
                // Only allow if threats are added
                if (projectData.threats.length === 0) {
                    showToast("Please add threats first", "error");
                    return;
                }
                
                content.classList.add('expanded');
                this.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Actions';
                document.getElementById('runSimulation').disabled = false; // ENABLE THE SIMULATION BUTTON
            } else {
                content.classList.remove('expanded');
                this.innerHTML = '<i class="fas fa-check-circle"></i> Select Actions';
            }
            
            updateActionList();
        });

        // Tasmanian/Australian specific management actions with descriptions
        const tasmanianActions = [
            {
                name: "Revegetation with local species",
                description: "Planting locally indigenous vegetation to restore habitat, using appropriate species for the ecosystem",
                cost: 5000,
                time: 24,
                effectiveness: 4,
                appliesTo: ["all"],
                mitigates: ["Habitat fragmentation", "Urban expansion"]
            },
            {
                name: "Fox and feral cat control",
                description: "Implementing coordinated predator control programs to protect native wildlife",
                cost: 15000,
                time: 12,
                effectiveness: 5,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "rainforest", "grassland", "coastal", "alpine"],
                mitigates: ["Invasive predators (foxes, cats)"]
            },
            {
                name: "Myrtle wilt monitoring program",
                description: "Regular surveys to detect and manage disease outbreaks in rainforest areas",
                cost: 8000,
                time: 12,
                effectiveness: 3,
                appliesTo: ["rainforest"],
                mitigates: ["Myrtle wilt disease"]
            },
            {
                name: "Riparian zone restoration",
                description: "Improving streamside vegetation to protect waterways and aquatic ecosystems",
                cost: 10000,
                time: 18,
                effectiveness: 4,
                appliesTo: ["riparian", "wetland"],
                mitigates: ["Agricultural runoff", "Changed hydrology"]
            },
            {
                name: "Community education program",
                description: "Engaging local communities in conservation through workshops and educational materials",
                cost: 5000,
                time: 6,
                effectiveness: 3,
                appliesTo: ["all"],
                mitigates: ["Urban expansion", "Marine debris pollution"]
            },
            {
                name: "Invasive plant control",
                description: "Targeted removal of invasive plant species with follow-up monitoring",
                cost: 7000,
                time: 12,
                effectiveness: 4,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "grassland", "riparian", "coastal"],
                mitigates: ["Invasive plants (gorse, blackberry)"]
            },
            {
                name: "Wildlife corridor establishment",
                description: "Creating habitat links between fragmented areas to improve connectivity",
                cost: 20000,
                time: 36,
                effectiveness: 4,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "rainforest", "grassland"],
                mitigates: ["Habitat fragmentation"]
            },
            {
                name: "Erosion control measures",
                description: "Installing silt fences, revegetation and other techniques to prevent soil loss",
                cost: 12000,
                time: 12,
                effectiveness: 4,
                appliesTo: ["alpine", "riparian", "coastal"],
                mitigates: ["Coastal erosion", "Alpine ecosystem degradation"]
            },
            {
                name: "Fire management plan",
                description: "Developing appropriate controlled burn strategies for ecosystem health",
                cost: 10000,
                time: 12,
                effectiveness: 4,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "grassland", "coastal"],
                mitigates: ["Fire regime changes"]
            },
            {
                name: "Water quality monitoring",
                description: "Regular testing and reporting on aquatic ecosystem health",
                cost: 6000,
                time: 6,
                effectiveness: 3,
                appliesTo: ["wetland", "riparian"],
                mitigates: ["Agricultural runoff", "Changed hydrology"]
            },
            {
                name: "Nest box installation",
                description: "Providing artificial hollows for wildlife where natural ones are scarce",
                cost: 3000,
                time: 3,
                effectiveness: 3,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "rainforest", "urban"],
                mitigates: ["Habitat fragmentation"]
            },
            {
                name: "Coastal dune restoration",
                description: "Stabilizing dunes with native vegetation to prevent erosion",
                cost: 15000,
                time: 24,
                effectiveness: 4,
                appliesTo: ["coastal"],
                mitigates: ["Coastal erosion", "Marine debris pollution"]
            },
            {
                name: "Alpine track management",
                description: "Redirecting or hardening walking tracks to prevent vegetation damage",
                cost: 18000,
                time: 18,
                effectiveness: 4,
                appliesTo: ["alpine"],
                mitigates: ["Alpine ecosystem degradation"]
            },
            {
                name: "Phytophthora hygiene measures",
                description: "Implementing cleaning stations and visitor protocols to prevent spread",
                cost: 9000,
                time: 12,
                effectiveness: 4,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "rainforest", "grassland", "coastal"],
                mitigates: ["Phytophthora root rot"]
            },
            {
                name: "Herbivore exclusion fencing",
                description: "Protecting vegetation from overgrazing by native and introduced herbivores",
                cost: 25000,
                time: 24,
                effectiveness: 5,
                appliesTo: ["dry-eucalypt", "wet-eucalypt", "grassland"],
                mitigates: ["Overgrazing by native wildlife", "Invasive herbivores (rabbits, deer)"]
            }
        ];

        document.getElementById('addDefaultActions').addEventListener('click', function() {
            try {
                // Filter actions that apply to current ecosystem
                const applicableActions = tasmanianActions.filter(action => 
                    action.appliesTo.includes(projectData.ecosystem) || action.appliesTo.includes("all")
                );
                
                // Only add actions that address current threats
                const currentThreats = projectData.threats.map(t => t.name);
                const relevantActions = applicableActions.filter(action => 
                    action.mitigates.some(threat => currentThreats.includes(threat))
                );
                
                // Only add actions that aren't already in the list
                const existingActions = projectData.actions.map(a => a.name);
                
                let addedCount = 0;
                relevantActions.forEach(action => {
                    if (!existingActions.includes(action.name)) {
                        projectData.actions.push({
                            name: action.name,
                            description: action.description,
                            cost: action.cost,
                            time: action.time,
                            effectiveness: action.effectiveness,
                            mitigates: action.mitigates
                        });
                        addedCount++;
                    }
                });
                
                updateActionList();
                showToast(`Added ${addedCount} relevant actions for your threats`, "success");
                
                // Enable the run simulation button if we have actions
                if (projectData.actions.length > 0) {
                    document.getElementById('runSimulation').disabled = false;
                }
            } catch (err) {
                console.error("Error adding default actions:", err);
                showToast("Error adding actions", "error");
            }
        });

        function updateActionList() {
            try {
                let html = '';
                
                if (projectData.actions.length === 0) {
                    html = '<p>No actions added yet. Click "Add Recommended Actions" to get started.</p>';
                } else {
                    projectData.actions.forEach((action, i) => {
                        html += `
                        <div class="action-item">
                            <label><input type="checkbox" checked> ${action.name}</label>
                            <div style="margin-top: 0.5rem;">
                                <label>Cost ($): <input type="number" class="action-cost" data-index="${i}" value="${action.cost || 0}" min="0" step="100"></label>
                                <label style="margin-left: 1rem;">Timeframe (months): <input type="number" class="action-time" data-index="${i}" value="${action.time || 12}" min="1" max="60"></label>
                            </div>
                            <button class="remove-action" data-index="${i}" title="Remove action"></button>
                            ${action.description ? `<div class="action-description">${action.description}</div>` : ''}
                            ${action.mitigates ? `<div class="action-description"><strong>Addresses:</strong> ${action.mitigates.join(', ')}</div>` : ''}
                        </div>`;
                    });
                }
                
                document.getElementById('actionList').innerHTML = html;

                // Add event listeners
                document.querySelectorAll('.remove-action').forEach(btn => {
                    btn.addEventListener('click', function() {
                        projectData.actions.splice(parseInt(this.dataset.index), 1);
                        updateActionList();
                        showToast("Action removed", "info");
                        
                        // Disable simulation button if no actions left
                        if (projectData.actions.length === 0) {
                            document.getElementById('runSimulation').disabled = true;
                        }
                        
                        // Refresh simulation if it exists
                        refreshSimulationIfExists();
                    });
                });

                document.querySelectorAll('.action-cost').forEach(input => {
                    input.addEventListener('change', function() {
                        const index = parseInt(this.dataset.index);
                        const value = parseInt(this.value);
                        
                        if (isNaN(value) || value < 0) {
                            this.value = projectData.actions[index].cost;
                            showToast("Please enter a valid positive number", "error");
                            return;
                        }
                        
                        projectData.actions[index].cost = value;
                        
                        // Visual feedback
                        this.style.backgroundColor = '#e6ffe6';
                        setTimeout(() => {
                            this.style.backgroundColor = '';
                        }, 500);
                        
                        // Refresh simulation if it exists
                        refreshSimulationIfExists();
                    });
                });

                document.querySelectorAll('.action-time').forEach(input => {
                    input.addEventListener('change', function() {
                        const index = parseInt(this.dataset.index);
                        const value = parseInt(this.value);
                        
                        if (isNaN(value) || value < 1 || value > 60) {
                            this.value = projectData.actions[index].time;
                            showToast("Please enter a number between 1 and 60", "error");
                            return;
                        }
                        
                        projectData.actions[index].time = value;
                        
                        // Visual feedback
                        this.style.backgroundColor = '#e6ffe6';
                        setTimeout(() => {
                            this.style.backgroundColor = '';
                        }, 500);
                        
                        // Refresh simulation if it exists
                        refreshSimulationIfExists();
                    });
                });
            } catch (err) {
                console.error("Error updating action list:", err);
                showToast("Error updating actions", "error");
            }
        }

        document.getElementById('addAction').addEventListener('click', function() {
            try {
                const name = prompt("Enter action name:");
                if (!name) return;
                
                const description = prompt("Enter action description (optional):");
                const costStr = prompt("Estimated cost ($):") || "0";
                const timeStr = prompt("Timeframe (months, 1-60):") || "12";
                
                const cost = parseInt(costStr);
                const time = parseInt(timeStr);
                
                if (isNaN(cost)) {
                    showToast("Please enter a valid number for cost", "error");
                    return;
                }
                
                if (isNaN(time)) {
                    showToast("Please enter a valid number for timeframe", "error");
                    return;
                }
                
                if (cost < 0) {
                    showToast("Cost must be a positive number", "error");
                    return;
                }
                
                if (time < 1 || time > 60) {
                    showToast("Timeframe must be between 1 and 60 months", "error");
                    return;
                }
                
                projectData.actions.push({
                    name: name,
                    description: description,
                    cost: cost,
                    time: time
                });
                
                updateActionList();
                showToast("Custom action added", "success");
                
                // Enable the run simulation button
                document.getElementById('runSimulation').disabled = false;
                
                // Refresh simulation if it exists
                refreshSimulationIfExists();
            } catch (err) {
                console.error("Error adding custom action:", err);
                showToast("Error adding action", "error");
            }
        });

        // Run simulation - FIXED THIS FUNCTION
        document.getElementById('runSimulation').addEventListener('click', function() {
            // Validate we have required data
            if (projectData.threats.length === 0) {
                showToast("Please add threats before running simulation", "error");
                return;
            }
            if (projectData.actions.length === 0) {
                showToast("Please add management actions before running simulation", "error");
                return;
            }

            this.innerHTML = '<div class="loading"></div> Running Simulation...';
            this.disabled = true;
            
            const resultsDiv = document.getElementById('simulationResults');
            resultsDiv.classList.add('expanded');
            resultsDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Running simulation, please wait...</p>';
            
            // Use setTimeout to allow UI to update, then run simulation
            setTimeout(() => {
                try {
                    runActualSimulation();
                    document.getElementById('generateReport').disabled = false;
                    showToast("Simulation completed successfully!", "success");
                } catch (err) {
                    console.error("Error running simulation:", err);
                    showToast("Error running simulation: " + err.message, "error");
                } finally {
                    this.innerHTML = '<i class="fas fa-play"></i> Run Simulation';
                    this.disabled = false;
                }
            }, 1000);
        });

        function runActualSimulation() {
            // Reset simulation data
            projectData.simulation = {
                threatReduction: 0,
                totalCost: 0,
                timeframe: 0,
                recommendations: [],
                visualData: [],
                generatedAt: new Date().toISOString()
            };

            // Calculate metrics based on actual threats and actions
            if (projectData.threats.length === 0 || projectData.actions.length === 0) {
                showToast("Please add both threats and actions before running simulation", "error");
                return;
            }

            // Calculate total threat severity (1-5 scale)
            const totalThreatSeverity = projectData.threats.reduce((sum, threat) => sum + threat.severity, 0);
            const avgThreatSeverity = totalThreatSeverity / projectData.threats.length;

            // Calculate total action effectiveness (1-5 scale)
            const totalActionEffectiveness = projectData.actions.reduce((sum, action) => 
                sum + (action.effectiveness || 3), 0);
            const avgActionEffectiveness = totalActionEffectiveness / projectData.actions.length;

            // Calculate base threat reduction (this is the key formula that was missing)
            let threatReduction = 0;
            
            // Base effectiveness from actions
            threatReduction = (avgActionEffectiveness / 5) * 60; // Up to 60% from actions
            
            // Adjust based on threat severity (higher severity = harder to reduce)
            threatReduction *= (1 - ((avgThreatSeverity - 1) / 10)); // Reduce by 0-40% based on severity
            
            // Adjust based on number of actions vs threats
            const actionThreatRatio = projectData.actions.length / projectData.threats.length;
            threatReduction *= Math.min(1.5, Math.max(0.5, actionThreatRatio)); // 0.5x to 1.5x multiplier
            
            // Adjust based on site condition
            const conditionMultipliers = {
                'pristine': 1.3,
                'good': 1.1,
                'moderate': 1.0,
                'poor': 0.8,
                'degraded': 0.6
            };
            threatReduction *= conditionMultipliers[projectData.condition] || 1.0;
            
            // Adjust based on protection status
            const protectionMultipliers = {
                'national': 1.3,
                'state': 1.2,
                'local': 1.1,
                'private': 1.0,
                'none': 0.9
            };
            threatReduction *= protectionMultipliers[projectData.protection] || 1.0;
            
            // Adjust based on user expertise
            const userMultipliers = {
                'government': 1.2,
                'professional': 1.1,
                'student': 1.0,
                'community': 0.9
            };
            threatReduction *= userMultipliers[projectData.userLevel] || 1.0;

            // Ensure within bounds
            threatReduction = Math.max(5, Math.min(95, Math.round(threatReduction)));

            // Calculate costs and timeframe
            const totalCost = projectData.actions.reduce((sum, action) => sum + (action.cost || 0), 0);
            const maxTimeframe = Math.max(...projectData.actions.map(action => action.time || 12), 12);

            // Generate recommendations and visual data
            const recommendations = generateRecommendations();
            const visualData = generateDynamicVisualData(threatReduction);

            // Store simulation results
            projectData.simulation = {
                threatReduction: threatReduction,
                totalCost: totalCost,
                timeframe: maxTimeframe,
                recommendations: recommendations,
                visualData: visualData,
                generatedAt: new Date().toISOString()
            };

            // Update UI with results
            updateSimulationResults();
        }

        function generateDynamicVisualData(threatReduction) {
            if (projectData.threats.length === 0) return [];

            // Sort threats by severity and take top 5
            const mainThreats = [...projectData.threats]
                .sort((a, b) => b.severity - a.severity)
                .slice(0, 5);

            return mainThreats.map(threat => {
                const initialHeight = threat.severity * 15 + 10; // 25-85% based on severity 1-5
                
                // Calculate reduction for this specific threat
                // Higher severity threats get less reduction, lower severity get more
                const threatSpecificReduction = threatReduction * (1 - (threat.severity - 1) * 0.1);
                const reducedHeight = initialHeight * (1 - threatSpecificReduction / 100);
                
                return {
                    label: threat.name.split(' ')[0],
                    initialHeight: initialHeight,
                    reducedHeight: Math.max(5, reducedHeight), // Ensure minimum height
                    color: getSeverityColor(threat.severity),
                    reducedColor: '#2E8B57'
                };
            });
        }

        function updateSimulationResults() {
            const sim = projectData.simulation;
            if (!sim) return;

            // Format cost with thousands separator
            const formattedCost = new Intl.NumberFormat('en-AU', {
                style: 'currency',
                currency: 'AUD',
                maximumFractionDigits: 0
            }).format(sim.totalCost);

            const resultsHTML = `
                <h4><i class="fas fa-chart-bar"></i> Simulation Results (${sim.timeframe}-month projection)</h4>
                
                <div class="simulation-visual">
                    <div class="visual-title">Threat Reduction Simulation</div>
                    ${sim.visualData.map((bar, i) => `
                        <div class="visual-bar" style="height: ${bar.initialHeight}%; left: ${30 + i*40}px; background-color: ${bar.color};"></div>
                        <div class="visual-label" style="left: ${30 + i*40}px;">${bar.label}</div>
                    `).join('')}
                </div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0;">
                    <div style="flex: 1; min-width: 200px; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <h5><i class="fas fa-biohazard"></i> Threats</h5>
                        <p><strong>Total Threats:</strong> ${projectData.threats.length}</p>
                        <p><strong>Avg Severity:</strong> ${(projectData.threats.reduce((s,t) => s + t.severity, 0) / projectData.threats.length).toFixed(1)}/5</p>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <h5><i class="fas fa-tasks"></i> Actions</h5>
                        <p><strong>Actions:</strong> ${projectData.actions.length}</p>
                        <p><strong>Total Cost:</strong> ${formattedCost}</p>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px; background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <h5><i class="fas fa-chart-line"></i> Outcomes</h5>
                        <p><strong>Threat Reduction:</strong> ${sim.threatReduction}%</p>
                        <p><strong>Timeframe:</strong> ${sim.timeframe} months</p>
                    </div>
                </div>
                
                ${sim.recommendations.length > 0 ? `
                <div style="margin-top: 1rem;">
                    <h5><i class="fas fa-clipboard-list"></i> Key Recommendations</h5>
                    <ul>
                        ${sim.recommendations.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            `;

            // Update both results and report preview
            document.getElementById('simulationResults').innerHTML = resultsHTML;
            document.getElementById('reportContent').innerHTML = resultsHTML;
            
            // Animate the bars
            setTimeout(() => {
                document.querySelectorAll('.visual-bar').forEach((bar, i) => {
                    if (sim.visualData[i]) {
                        setTimeout(() => {
                            bar.style.height = `${sim.visualData[i].reducedHeight}%`;
                            bar.style.backgroundColor = sim.visualData[i].reducedColor;
                            bar.classList.add('reduced');
                        }, i * 300);
                    }
                });
            }, 500);
        }

        function generateRecommendations() {
            let recommendations = [];
            const threats = projectData.threats.map(t => t.name);
            
            // Ecosystem-specific recommendations
            if (projectData.ecosystem === 'rainforest' && threats.includes("Myrtle wilt disease")) {
                recommendations.push("Implement myrtle wilt monitoring program and hygiene protocols for visitors");
            }
            
            if ((projectData.ecosystem === 'wet-eucalypt' || projectData.ecosystem === 'grassland') && 
                threats.includes("Invasive predators (foxes, cats)")) {
                recommendations.push("Develop a coordinated predator control program with neighboring properties");
            }
            
            if (projectData.ecosystem === 'coastal' && threats.includes("Coastal erosion")) {
                recommendations.push("Implement dune stabilization measures using native vegetation");
            }
            
            if (projectData.ecosystem === 'alpine' && threats.includes("Climate change impacts")) {
                recommendations.push("Focus on climate change resilience strategies and track management");
            }
            
            if (projectData.ecosystem === 'riparian' && threats.includes("Agricultural runoff")) {
                recommendations.push("Establish riparian buffer zones and consider stock exclusion fencing");
            }
            
            // Condition-based recommendations
            if (projectData.condition === 'degraded' || projectData.condition === 'poor') {
                recommendations.push("Prioritize ecological restoration actions before threat management");
            }
            
            // Protection status recommendations
            if (projectData.protection === 'none' || projectData.protection === 'private') {
                recommendations.push("Consider formal protection status to secure long-term conservation outcomes");
            }
            
            // Action-specific recommendations
            const hasReveg = projectData.actions.some(a => a.name.includes("Revegetation"));
            const hasPredatorControl = projectData.actions.some(a => a.name.includes("Fox and feral cat control"));
            
            if (hasReveg && !projectData.actions.some(a => a.name.includes("seed collection"))) {
                recommendations.push("Include local provenance seed collection as part of revegetation program");
            }
            
            if (hasPredatorControl && !projectData.actions.some(a => a.name.includes("monitoring"))) {
                recommendations.push("Add monitoring component to predator control to measure effectiveness");
            }
            
            // Ensure some recommendations if none generated
            if (recommendations.length === 0) {
                recommendations.push("Monitor outcomes and adapt management as needed");
                recommendations.push("Engage local community in conservation activities");
            }
            
            return recommendations.slice(0, 5); // Return top 5
        }

        function refreshSimulationIfExists() {
            if (projectData.simulation) {
                // Re-run simulation with current data
                runActualSimulation();
            }
        }

        // Generate report
        document.getElementById('generateReport').addEventListener('click', function() {
            try {
                generatePDFReport();
            } catch (err) {
                console.error("Error generating report:", err);
                showToast("Error generating report: " + err.message, "error");
            }
        });

        function generatePDFReport() {
            const doc = new jsPDF();
            const reportType = document.getElementById('reportType').value;

            // Set document properties based on report type
            const reportTitles = {
                'basic': 'Environmental Management Summary',
                'detailed': 'Comprehensive Management Plan',
                'funding': 'Funding Application Proposal',
                'academic': 'Academic Research Report'
            };
            
            doc.setProperties({
                title: `EcoSim ${reportTitles[reportType]}: ${projectData.name || "Untitled Project"}`,
                subject: getReportSubject(reportType),
                author: projectData.organization || projectData.userLevel + " user",
                keywords: getReportKeywords(reportType, projectData.ecosystem),
                creator: "EcoSim Tasmanian Environmental Tool"
            });

            // ====== COVER PAGE (ALL REPORT TYPES) ======
            createCoverPage(doc, reportType);

            // ====== TABLE OF CONTENTS (ALL REPORT TYPES) ======
            createTableOfContents(doc, reportType);

            // ====== EXECUTIVE SUMMARY (ALL REPORT TYPES) ======
            createExecutiveSummary(doc, reportType);

            // ====== SITE DESCRIPTION (ALL REPORT TYPES) ======
            createSiteDescription(doc, reportType);

            // ====== THREAT ASSESSMENT (ALL REPORT TYPES) ======
            createThreatAssessment(doc, reportType);

            // ====== MANAGEMENT ACTIONS (ALL REPORT TYPES) ======
            createManagementActions(doc, reportType);

            // ====== REPORT-SPECIFIC SECTIONS ======
            switch(reportType) {
                case 'basic':
                    createBasicReportSections(doc);
                    break;
                case 'detailed':
                    createDetailedReportSections(doc);
                    break;
                case 'funding':
                    createFundingReportSections(doc);
                    break;
                case 'academic':
                    createAcademicReportSections(doc);
                    break;
            }

            // ====== TASMANIAN CONTEXT (ALL REPORT TYPES) ======
            createTasmanianContext(doc, reportType);

            // ====== APPENDICES (DETAILED & ACADEMIC REPORTS) ======
            if (reportType === 'detailed' || reportType === 'academic') {
                createAppendices(doc, reportType);
            }

            // Save the PDF
            const fileName = `EcoSim_${reportType}_${projectData.name ? projectData.name.replace(/[^a-z0-9]/gi, '_') : 'Project'}_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            
            showToast(`${reportTitles[reportType]} generated: ${fileName}`, "success");
        }

        // ====== HELPER FUNCTIONS FOR DIFFERENT REPORT SECTIONS ======

        function getReportSubject(reportType) {
            const subjects = {
                'basic': 'Environmental Management Summary',
                'detailed': 'Comprehensive Environmental Management Plan',
                'funding': 'Conservation Funding Application',
                'academic': 'Ecological Research and Management Report'
            };
            return subjects[reportType] || 'Environmental Management';
        }

        function getReportKeywords(reportType, ecosystem) {
            const baseKeywords = "tasmania, conservation, " + getEcosystemName(ecosystem);
            const typeKeywords = {
                'basic': "summary, management",
                'detailed': "comprehensive, implementation, monitoring",
                'funding': "grant, budget, funding, proposal",
                'academic': "research, methodology, analysis, references"
            };
            return baseKeywords + ", " + (typeKeywords[reportType] || "management");
        }

        function createCoverPage(doc, reportType) {
            // Background
            doc.setFillColor(46, 139, 87);
            doc.rect(0, 0, 210, 297, 'F');
            
            // White content area
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(15, 15, 180, 267, 5, 5, 'F');
            
            // Title
            doc.setTextColor(46, 139, 87);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text("EcoSim", 105, 50, { align: 'center' });
            
            doc.setFontSize(18);
            doc.text("Tasmanian Environmental Management Tool", 105, 65, { align: 'center' });
            
            // Report type
            doc.setFontSize(16);
            const reportTitles = {
                'basic': 'Environmental Management Summary',
                'detailed': 'Comprehensive Management Plan',
                'funding': 'Funding Application Proposal',
                'academic': 'Academic Research Report'
            };
            doc.text(reportTitles[reportType], 105, 85, { align: 'center' });
            
            // Project name
            doc.setFontSize(20);
            doc.setTextColor(0, 0, 0);
            doc.text(projectData.name || "Untitled Project", 105, 120, { align: 'center' });
            
            // Metadata
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Prepared for: ${projectData.organization || projectData.userLevel + " user"}`, 105, 150, { align: 'center' });
            doc.text(`Date: ${new Date().toLocaleDateString('en-AU')}`, 105, 160, { align: 'center' });
            doc.text(`Location: Tasmania, Australia`, 105, 170, { align: 'center' });
            
            // Logo/icon
            doc.setFillColor(46, 139, 87);
            doc.circle(105, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text("", 105, 214, { align: 'center' });
            
            // Confidentiality notice for funding proposals
            if (reportType === 'funding') {
                doc.setFontSize(10);
                doc.setTextColor(150, 0, 0);
                doc.text("CONFIDENTIAL - FOR FUNDING CONSIDERATION ONLY", 105, 260, { align: 'center' });
            }
            
            doc.addPage();
        }

        function createTableOfContents(doc, reportType) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("Table of Contents", 20, 30);
            doc.setDrawColor(46, 139, 87);
            doc.line(20, 32, 60, 32);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            const sections = getTocSections(reportType);
            let yPos = 45;
            
            sections.forEach((section, i) => {
                doc.text(section.text, 25, yPos);
                doc.text(`... ${section.page}`, 180, yPos, { align: 'right' });
                yPos += 8;
                
                // Add subsections for detailed reports
                if (reportType === 'detailed' && section.subsections) {
                    section.subsections.forEach(subsection => {
                        doc.setFontSize(10);
                        doc.text(`  ${subsection}`, 30, yPos);
                        yPos += 6;
                    });
                    doc.setFontSize(12);
                }
            });
            
            doc.addPage();
        }

        function getTocSections(reportType) {
            const baseSections = [
                { text: "1. Executive Summary", page: 3 },
                { text: "2. Site Description", page: 4 },
                { text: "3. Threat Assessment", page: 5 },
                { text: "4. Management Actions", page: 6 }
            ];
            
            const additionalSections = {
                'basic': [
                    { text: "5. Summary Recommendations", page: 7 },
                    { text: "6. Tasmanian Context", page: 8 }
                ],
                'detailed': [
                    { 
                        text: "5. Implementation Plan", 
                        page: 7,
                        subsections: [
                            "5.1 Timeline",
                            "5.2 Resource Requirements",
                            "5.3 Stakeholder Engagement"
                        ]
                    },
                    { text: "6. Monitoring & Evaluation", page: 8 },
                    { text: "7. Budget Analysis", page: 9 },
                    { text: "8. Risk Assessment", page: 10 },
                    { text: "A. Appendices", page: 11 }
                ],
                'funding': [
                    { text: "5. Project Justification", page: 7 },
                    { text: "6. Budget Proposal", page: 8 },
                    { text: "7. Evaluation Framework", page: 9 },
                    { text: "8. Organizational Capacity", page: 10 }
                ],
                'academic': [
                    { text: "5. Methodology", page: 7 },
                    { text: "6. Results Analysis", page: 8 },
                    { text: "7. Discussion", page: 9 },
                    { text: "8. References", page: 10 },
                    { text: "A. Appendices", page: 11 }
                ]
            };
            
            return [...baseSections, ...(additionalSections[reportType] || [])];
        }

        function createExecutiveSummary(doc, reportType) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("1. Executive Summary", 20, 30);
            doc.setDrawColor(46, 139, 87);
            doc.line(20, 32, 60, 32);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let summaryContent = getExecutiveSummaryContent(reportType);
            let yPos = 45;
            
            summaryContent.forEach(paragraph => {
                const lines = doc.splitTextToSize(paragraph, 170);
                lines.forEach(line => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 30;
                    }
                    doc.text(line, 20, yPos);
                    yPos += 7;
                });
                yPos += 3;
            });
            
            // Add key metrics box for all report types except basic
            if (reportType !== 'basic') {
                yPos = addKeyMetricsBox(doc, yPos);
            }
            
            doc.addPage();
        }

        function getExecutiveSummaryContent(reportType) {
            const baseContent = [
                `This ${getReportTypeDescription(reportType)} presents an environmental management plan for ${projectData.name || "the site"} located in Tasmania, Australia.`,
                `The primary ecosystem type is ${getEcosystemName(projectData.ecosystem)} with a current condition rating of "${projectData.condition}". The site covers approximately ${projectData.area ? projectData.area.toFixed(2) + ' hectares' : 'an unspecified area'} and has ${getProtectionName(projectData.protection)} protection status.`,
                `${projectData.threats.length} key threats were identified, with an average severity of ${(projectData.threats.reduce((s,t) => s + t.severity, 0) / projectData.threats.length).toFixed(1)}/5. The most significant threats include: ${projectData.threats.slice(0, 3).map(t => t.name).join(', ')}.`
            ];
            
            const typeSpecificContent = {
                'basic': [
                    `The proposed ${projectData.actions.length} management actions are projected to achieve ${projectData.simulation.threatReduction}% threat reduction over ${Math.ceil(projectData.simulation.timeframe / 12)} years.`
                ],
                'detailed': [
                    `A comprehensive suite of ${projectData.actions.length} management actions has been developed, projected to achieve ${projectData.simulation.threatReduction}% threat reduction with a total investment of $${projectData.simulation.totalCost.toLocaleString()} over ${Math.ceil(projectData.simulation.timeframe / 12)} years. This plan includes detailed implementation scheduling, monitoring protocols, and risk mitigation strategies.`
                ],
                'funding': [
                    `This proposal requests $${projectData.simulation.totalCost.toLocaleString()} to implement ${projectData.actions.length} critical conservation actions that will achieve ${projectData.simulation.threatReduction}% threat reduction and significant biodiversity outcomes. The investment will leverage existing resources and community engagement to ensure long-term sustainability.`
                ],
                'academic': [
                    `This research-based management approach employs ${projectData.actions.length} evidence-based interventions projected to achieve ${projectData.simulation.threatReduction}% threat reduction (p<0.05). The methodology integrates landscape ecology principles with adaptive management frameworks to address key conservation challenges in Tasmanian ${getEcosystemName(projectData.ecosystem)} ecosystems.`
                ]
            };
            
            return [...baseContent, ...(typeSpecificContent[reportType] || [])];
        }

        function getReportTypeDescription(reportType) {
            const descriptions = {
                'basic': 'summary report',
                'detailed': 'comprehensive management plan',
                'funding': 'funding proposal',
                'academic': 'research report'
            };
            return descriptions[reportType] || 'report';
        }

        function addKeyMetricsBox(doc, yPos) {
            if (yPos > 200) {
                doc.addPage();
                yPos = 30;
            }
            
            // Metrics box
            doc.setFillColor(240, 245, 240);
            doc.roundedRect(20, yPos, 170, 60, 3, 3, 'F');
            doc.setDrawColor(46, 139, 87);
            doc.roundedRect(20, yPos, 170, 60, 3, 3, 'D');
            
            doc.setFontSize(14);
            doc.setTextColor(46, 139, 87);
            doc.text("Key Project Metrics", 105, yPos + 10, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const metrics = [
                { label: "Threat Reduction", value: `${projectData.simulation.threatReduction}%` },
                { label: "Total Investment", value: `$${projectData.simulation.totalCost.toLocaleString()}` },
                { label: "Timeframe", value: `${projectData.simulation.timeframe} months` },
                { label: "Actions", value: projectData.actions.length },
                { label: "Area", value: projectData.area ? `${projectData.area.toFixed(2)} ha` : 'N/A' },
                { label: "Cost/Ha", value: projectData.area ? `$${Math.round(projectData.simulation.totalCost/projectData.area).toLocaleString()}` : 'N/A' }
            ];
            
            // Arrange metrics in 2 columns
            metrics.forEach((metric, i) => {
                const col = i % 2;
                const row = Math.floor(i / 2);
                const x = 30 + (col * 85);
                const y = yPos + 25 + (row * 12);
                
                doc.setFont(undefined, 'bold');
                doc.text(metric.label + ":", x, y);
                doc.setFont(undefined, 'normal');
                doc.text(metric.value, x + 40, y);
            });
            
            return yPos + 70;
        }

        function createSiteDescription(doc, reportType) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("2. Site Description", 20, 30);
            doc.setDrawColor(46, 139, 87);
            doc.line(20, 32, 60, 32);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            
            // Basic site information
            const siteInfo = [
                `Project Name: ${projectData.name || "Not specified"}`,
                `Location Coordinates: ${projectData.coordinates[0] ? projectData.coordinates[0].join(', ') : 'Not specified'}`,
                `Ecosystem Type: ${getEcosystemName(projectData.ecosystem)}`,
                `Area: ${projectData.area ? projectData.area.toFixed(2) + ' hectares' : 'Not specified'}`,
                `Current Condition: ${projectData.condition.charAt(0).toUpperCase() + projectData.condition.slice(1)}`,
                `Protection Status: ${getProtectionName(projectData.protection)}`,
                `Assessed by: ${projectData.organization || projectData.userLevel + " user"}`,
                `Assessment Date: ${new Date(projectData.updatedAt).toLocaleDateString('en-AU')}`
            ];
            
            siteInfo.forEach(info => {
                doc.text(info, 25, yPos);
                yPos += 8;
            });
            
            yPos += 10;
            
            // Ecosystem description
            const ecosystemDesc = getEcosystemDescription(projectData.ecosystem);
            const descLines = doc.splitTextToSize(ecosystemDesc, 170);
            descLines.forEach(line => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 30;
                }
                doc.text(line, 20, yPos);
                yPos += 7;
            });
            
            // For detailed and academic reports, add more ecological context
            if (reportType === 'detailed' || reportType === 'academic') {
                yPos = addEcologicalContext(doc, yPos);
            }
            
            doc.addPage();
        }

        function getEcosystemDescription(ecosystem) {
            const descriptions = {
                'dry-eucalypt': 'Dry Eucalypt Forests in Tasmania are typically dominated by Eucalyptus species adapted to well-drained soils and periodic fire. These ecosystems support diverse understory communities and provide habitat for many bird and mammal species.',
                'wet-eucalypt': 'Wet Eucalypt Forests feature tall eucalypts with dense understories of ferns and shrubs. These productive forests are important for timber production and biodiversity conservation in Tasmania.',
                'rainforest': 'Tasmanian Temperate Rainforests are globally significant ecosystems dominated by myrtle beech (Nothofagus cunninghamii) and other rainforest species. These cool, moist forests contain many endemic species.',
                'wetland': 'Tasmanian wetlands include a variety of freshwater systems that provide critical habitat for waterbirds, amphibians, and aquatic species. Many are listed under international Ramsar conventions.',
                'grassland': 'Native Grasslands in Tasmania are increasingly rare ecosystems that support diverse grass and wildflower communities, providing habitat for ground-nesting birds and invertebrates.',
                'coastal': 'Coastal Heathlands feature salt-tolerant shrubs and herbs adapted to harsh coastal conditions. These ecosystems are important for seabird nesting and coastal protection.',
                'alpine': 'Alpine ecosystems occur above the treeline and feature specialized cushion plants, heaths, and coniferous shrubs. These fragile environments are particularly vulnerable to climate change.',
                'riparian': 'Riparian zones along waterways provide critical connectivity and habitat corridors. They filter runoff and stabilize banks while supporting diverse plant and animal communities.',
                'agricultural': 'Agricultural lands can be managed to support biodiversity through integrated farming practices, shelterbelts, and conservation of remnant vegetation.',
                'urban': 'Urban and peri-urban areas can provide important habitat connectivity and ecosystem services through strategic green space planning and native vegetation retention.'
            };
            
            return descriptions[ecosystem] || `The ${getEcosystemName(ecosystem)} ecosystem in Tasmania requires specific management approaches to maintain ecological values while addressing conservation challenges.`;
        }

        function addEcologicalContext(doc, yPos) {
            if (yPos > 200) {
                doc.addPage();
                yPos = 30;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(46, 139, 87);
            doc.text("Ecological Context", 20, yPos);
            doc.setDrawColor(46, 139, 87);
            doc.line(20, yPos + 2, 60, yPos + 2);
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            yPos += 15;
            
            const context = `Tasmania's unique biogeography has resulted in high levels of endemism and distinctive ecological communities. The island's isolation, varied topography, and climatic gradients support diverse ecosystems ranging from coastal heathlands to alpine environments. Conservation management in Tasmania must consider these unique ecological values alongside threats from climate change, invasive species, and habitat modification.`;
            
            const contextLines = doc.splitTextToSize(context, 170);
            contextLines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 6;
            });
            
            return yPos + 10;
        }

        function createThreatAssessment(doc, reportType) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("3. Threat Assessment", 20, 30);
            doc.setDrawColor(46, 139, 87);
            doc.line(20, 32, 60, 32);
            
            // Summary statistics
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            const totalThreats = projectData.threats.length;
            const avgSeverity = (projectData.threats.reduce((sum, t) => sum + t.severity, 0) / totalThreats).toFixed(1);
            const highSeverity = projectData.threats.filter(t => t.severity >= 4).length;
            
            let yPos = 45;
            doc.text(`Total Threats Identified: ${totalThreats}`, 20, yPos);
            doc.text(`Average Severity: ${avgSeverity}/5`, 20, yPos + 8);
            doc.text(`High Severity Threats (4): ${highSeverity}`, 20, yPos + 16);
            
            yPos += 30;
            
            // Threats table
            const threatRows = projectData.threats.map(t => [
                t.name,
                t.severity.toString(),
                getSeverityDescription(t.severity),
                t.description || 'No description provided'
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['Threat', 'Severity', 'Level', 'Description']],
                body: threatRows,
                headStyles: {
                    fillColor: [46, 139, 87],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 45, fontStyle: 'bold' },
                    1: { cellWidth: 20, halign: 'center' },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 'auto' }
                },
                styles: {
                    fontSize: reportType === 'academic' ? 9 : 10,
                    cellPadding: 3,
                    overflow: 'linebreak'
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                }
            });
            
            // Threat analysis for detailed reports
            if (reportType === 'detailed' || reportType === 'academic') {
                yPos = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(14);
                doc.setTextColor(46, 139, 87);
                doc.text("Threat Analysis", 20, yPos);
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                yPos += 10;
                
                const analysis = generateThreatAnalysis();
                const analysisLines = doc.splitTextToSize(analysis, 170);
                analysisLines.forEach(line => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 30;
                    }
                    doc.text(line, 20, yPos);
                    yPos += 6;
                });
            }
            
            doc.addPage();
        }

        function getSeverityDescription(severity) {
            const descriptions = {
                1: 'Minimal',
                2: 'Slight', 
                3: 'Moderate',
                4: 'Severe',
                5: 'Critical'
            };
            return descriptions[severity] || 'Unknown';
        }

        function generateThreatAnalysis() {
            const highThreats = projectData.threats.filter(t => t.severity >= 4);
            const climateThreats = projectData.threats.filter(t => t.name.toLowerCase().includes('climate'));
            const invasiveThreats = projectData.threats.filter(t => 
                t.name.toLowerCase().includes('invasive') || t.name.toLowerCase().includes('feral') || t.name.toLowerCase().includes('weed')
            );
            
            let analysis = `The threat assessment identifies ${highThreats.length} high-priority threats requiring immediate attention. `;
            
            if (climateThreats.length > 0) {
                analysis += `Climate-related threats (${climateThreats.length}) represent significant long-term challenges. `;
            }
            
            if (invasiveThreats.length > 0) {
                analysis += `Invasive species management is critical with ${invasiveThreats.length} identified threats. `;
            }
            
            analysis += `Priority should be given to addressing the most severe threats first, while developing integrated approaches for interconnected threats.`;
            
            return analysis;
        }

        function createManagementActions(doc, reportType) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("4. Management Actions", 20, 30);
            doc.setDrawColor(46, 139, 87);
            doc.line(20, 32, 60, 32);
            
            // Action summary
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            const totalActions = projectData.actions.length;
            const totalCost = projectData.actions.reduce((sum, a) => sum + a.cost, 0);
            const maxTime = Math.max(...projectData.actions.map(a => a.time));
            
            let yPos = 45;
            doc.text(`Total Actions: ${totalActions}`, 20, yPos);
            doc.text(`Total Estimated Cost: $${totalCost.toLocaleString()}`, 20, yPos + 8);
            doc.text(`Maximum Timeframe: ${maxTime} months`, 20, yPos + 16);
            doc.text(`Projected Threat Reduction: ${projectData.simulation.threatReduction}%`, 20, yPos + 24);
            
            yPos += 40;
            
            // Actions table
            const actionRows = projectData.actions.map(a => [
                a.name,
                `$${a.cost.toLocaleString()}`,
                `${a.time} months`,
                a.effectiveness ? `${a.effectiveness}/5` : 'N/A',
                a.description || 'No description provided'
            ]);
            
            const tableHeaders = ['Action', 'Cost', 'Timeframe', 'Effectiveness', 'Description'];
            
            // For basic reports, simplify the table
            if (reportType === 'basic') {
                actionRows.forEach(row => row.pop()); // Remove description
                tableHeaders.pop(); // Remove description header
            }
            
            doc.autoTable({
                startY: yPos,
                head: [tableHeaders],
                body: actionRows,
                headStyles: {
                    fillColor: [46, 139, 87],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 45, fontStyle: 'bold' },
                    1: { cellWidth: 25, halign: 'right' },
                    2: { cellWidth: 25, halign: 'center' },
                    3: { cellWidth: 25, halign: 'center' },
                    4: { cellWidth: 'auto' }
                },
                styles: {
                    fontSize: reportType === 'academic' ? 9 : 10,
                    cellPadding: 3,
                    overflow: 'linebreak'
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                }
            });
            
            doc.addPage();
        }

        // ====== REPORT-SPECIFIC SECTIONS ======

        function createBasicReportSections(doc) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("5. Summary Recommendations", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const recommendations = projectData.simulation.recommendations.slice(0, 5);
            
            recommendations.forEach((rec, i) => {
                const lines = doc.splitTextToSize(`${i + 1}. ${rec}`, 170);
                lines.forEach(line => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 30;
                    }
                    doc.text(line, 20, yPos);
                    yPos += 7;
                });
                yPos += 3;
            });
            
            doc.addPage();
        }

        function createDetailedReportSections(doc) {
            // Implementation Plan
            createImplementationPlan(doc);
            doc.addPage();
            
            // Monitoring & Evaluation
            createMonitoringEvaluation(doc);
            doc.addPage();
            
            // Budget Analysis
            createBudgetAnalysis(doc);
            doc.addPage();
            
            // Risk Assessment
            createRiskAssessment(doc);
        }

        function createFundingReportSections(doc) {
            // Project Justification
            createProjectJustification(doc);
            doc.addPage();
            
            // Budget Proposal
            createBudgetProposal(doc);
            doc.addPage();
            
            // Evaluation Framework
            createEvaluationFramework(doc);
            doc.addPage();
            
            // Organizational Capacity
            createOrganizationalCapacity(doc);
        }

        function createAcademicReportSections(doc) {
            // Methodology
            createMethodologySection(doc);
            doc.addPage();
            
            // Results Analysis
            createResultsAnalysis(doc);
            doc.addPage();
            
            // Discussion
            createDiscussionSection(doc);
            doc.addPage();
            
            // References
            createReferencesSection(doc);
        }

        // ====== IMPLEMENTATION FUNCTIONS FOR EACH REPORT TYPE ======

        function createImplementationPlan(doc) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("5. Implementation Plan", 20, 30);
            
            let yPos = 45;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            // Timeline
            doc.setFont(undefined, 'bold');
            doc.text("5.1 Implementation Timeline", 20, yPos);
            yPos += 10;
            doc.setFont(undefined, 'normal');
            
            const timeline = generateImplementationTimeline();
            timeline.forEach(item => {
                const lines = doc.splitTextToSize(` ${item}`, 170);
                lines.forEach(line => {
                    doc.text(line, 25, yPos);
                    yPos += 6;
                });
            });
            
            yPos += 10;
            
            // Resource Requirements
            doc.setFont(undefined, 'bold');
            doc.text("5.2 Resource Requirements", 20, yPos);
            yPos += 10;
            doc.setFont(undefined, 'normal');
            
            const resources = generateResourceRequirements();
            resources.forEach(resource => {
                doc.text(` ${resource}`, 25, yPos);
                yPos += 6;
            });
            
            yPos += 10;
            
            // Stakeholder Engagement
            doc.setFont(undefined, 'bold');
            doc.text("5.3 Stakeholder Engagement", 20, yPos);
            yPos += 10;
            doc.setFont(undefined, 'normal');
            
            const stakeholders = generateStakeholderList();
            stakeholders.forEach(stakeholder => {
                doc.text(` ${stakeholder}`, 25, yPos);
                yPos += 6;
            });
        }

        function generateImplementationTimeline() {
            const shortTerm = projectData.actions.filter(a => a.time <= 6);
            const mediumTerm = projectData.actions.filter(a => a.time > 6 && a.time <= 18);
            const longTerm = projectData.actions.filter(a => a.time > 18);
            
            const timeline = [
                `Months 1-3: Project establishment, baseline monitoring, and community engagement`,
                `Months 4-6: Implementation of ${shortTerm.length} short-term actions including ${shortTerm.slice(0, 2).map(a => a.name).join(', ')}`
            ];
            
            if (mediumTerm.length > 0) {
                timeline.push(`Months 7-18: Implementation of ${mediumTerm.length} medium-term actions`);
            }
            
            if (longTerm.length > 0) {
                timeline.push(`Months 19+: Implementation of ${longTerm.length} long-term actions and ongoing adaptive management`);
            }
            
            timeline.push(`Ongoing: Monitoring, evaluation, and reporting throughout project duration`);
            
            return timeline;
        }

        function generateResourceRequirements() {
            const totalCost = projectData.actions.reduce((sum, a) => sum + a.cost, 0);
            const staffMonths = Math.ceil(totalCost / 5000); // Rough estimate
            
            return [
                `Financial: $${totalCost.toLocaleString()} total budget`,
                `Personnel: Approximately ${staffMonths} staff-months`,
                `Equipment: Field monitoring gear, restoration tools, safety equipment`,
                `Materials: Native plants, fencing materials, monitoring supplies`,
                `Technical: GIS mapping, data analysis, reporting capabilities`
            ];
        }

        function generateStakeholderList() {
            const stakeholders = [
                "Local community groups and volunteers",
                "Traditional Owners and Aboriginal organizations",
                "Local government environmental officers",
                "State government agencies (DPIPWE, NRM)",
                "Research institutions and universities",
                "Landowners and adjacent property managers",
                "Industry partners (where relevant)",
                "Non-government conservation organizations"
            ];
            
            return stakeholders.slice(0, 5);
        }

        function createBudgetProposal(doc) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("6. Budget Proposal", 20, 30);
            
            // Detailed budget table
            const budgetRows = projectData.actions.map(a => [
                a.name,
                `$${a.cost.toLocaleString()}`,
                `${a.time} months`,
                `$${Math.round(a.cost / a.time).toLocaleString()}/month`
            ]);
            
            // Add total row
            const totalCost = projectData.actions.reduce((sum, a) => sum + a.cost, 0);
            const maxTime = Math.max(...projectData.actions.map(a => a.time));
            budgetRows.push([
                'TOTAL',
                `$${totalCost.toLocaleString()}`,
                `${maxTime} months`,
                `$${Math.round(totalCost / maxTime).toLocaleString()}/month`
            ]);
            
            doc.autoTable({
                startY: 45,
                head: [['Action', 'Total Cost', 'Duration', 'Monthly Cost']],
                body: budgetRows,
                headStyles: {
                    fillColor: [46, 139, 87],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                footStyles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 80, fontStyle: 'bold' },
                    1: { cellWidth: 30, halign: 'right' },
                    2: { cellWidth: 25, halign: 'center' },
                    3: { cellWidth: 30, halign: 'right' }
                }
            });
            
            // Funding request
            const yPos = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text("Funding Request", 20, yPos);
            doc.setFont(undefined, 'normal');
            
            const requestText = [
                `Total Funding Requested: $${totalCost.toLocaleString()}`,
                `Project Duration: ${maxTime} months (${(maxTime/12).toFixed(1)} years)`,
                `This investment will achieve ${projectData.simulation.threatReduction}% threat reduction and significant biodiversity outcomes.`
            ];
            
            let textY = yPos + 10;
            requestText.forEach(line => {
                doc.text(line, 25, textY);
                textY += 7;
            });
        }

        // ====== ADD THE MISSING FUNCTION IMPLEMENTATIONS ======

        function createTasmanianContext(doc, reportType) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("Tasmanian Context", 20, 30);
            doc.setDrawColor(46, 139, 87);
            doc.line(20, 32, 60, 32);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const context = `Tasmania is recognized globally for its unique biodiversity and significant conservation values. The island's geographic isolation has resulted in high levels of endemism, with many species found nowhere else on Earth. Tasmania contains approximately:
            
 44% of Australia's threatened native vegetation communities
 Important populations of threatened species including the Tasmanian devil, wedge-tailed eagle, and orange-bellied parrot
 World Heritage Areas covering approximately 1.58 million hectares
 Extensive wilderness areas of global significance

This project contributes to the protection and management of these important natural values in the face of ongoing threats from climate change, invasive species, and habitat modification.`;

            const contextLines = doc.splitTextToSize(context, 170);
            contextLines.forEach(line => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 30;
                }
                doc.text(line, 20, yPos);
                yPos += 7;
            });
            
            doc.addPage();
        }

        function createAppendices(doc, reportType) {
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("Appendices", 20, 30);
            doc.setDrawColor(46, 139, 87);
            doc.line(20, 32, 60, 32);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const appendices = [
                "A.1 Project Location Map",
                "A.2 Detailed Threat Assessment Methodology",
                "A.3 Action Implementation Guidelines",
                "A.4 Monitoring Protocols",
                "A.5 References and Further Reading"
            ];
            
            appendices.forEach(appendix => {
                doc.text(appendix, 25, yPos);
                yPos += 8;
            });
        }

        // Add other missing function implementations
        function createMonitoringEvaluation(doc) {
            // Implementation for monitoring and evaluation section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("6. Monitoring & Evaluation", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const content = `A comprehensive monitoring program will track project effectiveness and adapt management as needed. Key monitoring components include:

 Baseline assessment of current ecological condition
 Regular threat monitoring (quarterly for high-priority threats)
 Biodiversity indicators (annual surveys)
 Implementation tracking against planned activities
 Adaptive management reviews (biannual)

Success will be measured against the projected ${projectData.simulation.threatReduction}% threat reduction and specific biodiversity targets.`;

            const lines = doc.splitTextToSize(content, 170);
            lines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 7;
            });
        }

        function createBudgetAnalysis(doc) {
            // Implementation for budget analysis section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("7. Budget Analysis", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const totalCost = projectData.actions.reduce((sum, a) => sum + a.cost, 0);
            const costPerHectare = projectData.area ? totalCost / projectData.area : 0;
            
            const content = `Total Project Budget: $${totalCost.toLocaleString()}
Cost per Hectare: $${costPerHectare.toFixed(2)}
Timeframe: ${Math.max(...projectData.actions.map(a => a.time))} months

The budget represents a cost-effective investment in conservation, with funds allocated to highest-priority actions based on threat severity and potential biodiversity outcomes.`;

            const lines = doc.splitTextToSize(content, 170);
            lines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 7;
            });
        }

        function createRiskAssessment(doc) {
            // Implementation for risk assessment section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("8. Risk Assessment", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const risks = [
                "Climate change impacts exceeding projections",
                "Unexpected pest or disease outbreaks",
                "Funding or resource constraints",
                "Community engagement challenges",
                "Regulatory or policy changes"
            ];
            
            risks.forEach(risk => {
                doc.text(` ${risk}`, 25, yPos);
                yPos += 7;
            });
        }

        function createProjectJustification(doc) {
            // Implementation for project justification section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("5. Project Justification", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const justification = `This project addresses critical conservation needs in Tasmania's ${getEcosystemName(projectData.ecosystem)} ecosystem. The proposed actions will:

 Protect ${projectData.area ? projectData.area.toFixed(2) + ' hectares of significant habitat' : 'important habitat values'}
 Address ${projectData.threats.length} identified threats to biodiversity
 Achieve ${projectData.simulation.threatReduction}% reduction in threat impacts
 Contribute to regional and national conservation priorities
 Engage local community in conservation activities

The investment represents excellent value for conservation outcomes, with measurable benefits for threatened species and ecosystems.`;

            const lines = doc.splitTextToSize(justification, 170);
            lines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 7;
            });
        }

        function createEvaluationFramework(doc) {
            // Implementation for evaluation framework section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("7. Evaluation Framework", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const framework = `Project success will be evaluated against the following key performance indicators:

 Threat reduction: Target ${projectData.simulation.threatReduction}% reduction
 Biodiversity outcomes: Improvement in condition metrics
 Implementation rate: >90% of planned actions completed
 Community engagement: Target participation levels met
 Adaptive management: Regular review and adjustment of activities

Evaluation will occur at 6-month intervals with comprehensive reporting to stakeholders.`;

            const lines = doc.splitTextToSize(framework, 170);
            lines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 7;
            });
        }

        function createOrganizationalCapacity(doc) {
            // Implementation for organizational capacity section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("8. Organizational Capacity", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const capacity = `${projectData.organization || "Our organization"} has extensive experience in environmental management and conservation in Tasmania. We have:

 Proven track record in similar conservation projects
 Qualified staff with ecological expertise
 Strong partnerships with government and community groups
 Established monitoring and reporting systems
 Financial management systems for grant administration

We are well-positioned to deliver this project successfully and achieve the conservation outcomes outlined in this proposal.`;

            const lines = doc.splitTextToSize(capacity, 170);
            lines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 7;
            });
        }

        function createMethodologySection(doc) {
            // Implementation for methodology section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("5. Methodology", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const methodology = `This research employed a systematic approach to environmental management planning:

1. Site Assessment: Comprehensive ecological assessment using standardized protocols
2. Threat Analysis: Identification and prioritization of threats using severity-impact matrix
3. Action Selection: Evidence-based selection of management interventions
4. Simulation Modeling: Projection of outcomes using established ecological relationships
5. Adaptive Framework: Integration of monitoring and evaluation for continuous improvement

The methodology aligns with best practice in conservation planning and adaptive management.`;

            const lines = doc.splitTextToSize(methodology, 170);
            lines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 7;
            });
        }

        function createResultsAnalysis(doc) {
            // Implementation for results analysis section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("6. Results Analysis", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const analysis = `The analysis indicates that implementation of the proposed ${projectData.actions.length} management actions would result in:

 ${projectData.simulation.threatReduction}% reduction in overall threat impacts
 Significant improvement in ecosystem condition metrics
 Cost-effectiveness ratio of $${projectData.area ? Math.round(projectData.simulation.totalCost/projectData.area).toLocaleString() : 'N/A'} per hectare
 Positive return on investment for conservation outcomes

These results demonstrate the potential for effective conservation intervention in Tasmanian ${getEcosystemName(projectData.ecosystem)} ecosystems.`;

            const lines = doc.splitTextToSize(analysis, 170);
            lines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 7;
            });
        }

        function createDiscussionSection(doc) {
            // Implementation for discussion section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("7. Discussion", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const discussion = `This study demonstrates the value of systematic conservation planning for Tasmanian ecosystems. The projected outcomes highlight:

 The importance of targeted threat management
 Cost-effectiveness of evidence-based interventions
 Potential for significant biodiversity gains
 Value of integrating local knowledge with scientific approaches

These findings contribute to the growing body of evidence supporting strategic investment in conservation management in high-value ecosystems.`;

            const lines = doc.splitTextToSize(discussion, 170);
            lines.forEach(line => {
                doc.text(line, 20, yPos);
                yPos += 7;
            });
        }

        function createReferencesSection(doc) {
            // Implementation for references section
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text("8. References", 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            let yPos = 45;
            const references = [
                "DPIPWE (2020). Tasmania's Natural Values Atlas.",
                "Kirkpatrick, J.B. (2007). Tasmanian Native Bush: A Management Handbook.",
                "Williams, K.J. et al. (2010). Forest Ecology and Management.",
                "Tasmanian Government (2013). Tasmanian Wilderness World Heritage Area Management Plan.",
                "NRM South (2018). Regional Natural Resource Management Strategy."
            ];
            
            references.forEach(ref => {
                doc.text(` ${ref}`, 25, yPos);
                yPos += 7;
            });
        }

        // ====== UPDATE THE EXISTING HELPER FUNCTIONS ======

        function getFundingSources() {
            const sources = [
                "Tasmanian Government NRM grants",
                "Commonwealth Environment Restoration Fund", 
                "Bush Heritage Australia partnerships",
                "Local government environmental grants",
                "Philanthropic foundation support"
            ];
            return sources[Math.floor(Math.random() * sources.length)];
        }

        // Update the ecosystem name function to be more comprehensive
        function getEcosystemName(ecosystem) {
            const names = {
                'dry-eucalypt': 'Dry Eucalypt Forest',
                'wet-eucalypt': 'Wet Eucalypt Forest', 
                'rainforest': 'Temperate Rainforest',
                'wetland': 'Wetland Ecosystem',
                'grassland': 'Native Grassland',
                'coastal': 'Coastal Heathland',
                'alpine': 'Alpine Vegetation',
                'riparian': 'Riparian Zone',
                'agricultural': 'Agricultural Landscape',
                'urban': 'Urban/Peri-urban Area',
                'other': 'Mixed Ecosystem'
            };
            return names[ecosystem] || 'Unspecified Ecosystem';
        }

        function getProtectionName(protection) {
            const names = {
                'none': 'Not Protected',
                'private': 'Private Conservation',
                'local': 'Local Reserve',
                'state': 'State Reserve',
                'national': 'National Park/World Heritage'
            };
            return names[protection] || 'Unknown';
        }

        // File management
        document.getElementById('newProject').addEventListener('click', function() {
            if (confirm("Start a new project? Unsaved changes will be lost.")) {
                projectData = {
                    name: "",
                    organization: "",
                    userLevel: "community",
                    ecosystem: "",
                    coordinates: [],
                    area: 0,
                    condition: "moderate",
                    protection: "none",
                    threats: [],
                    actions: [],
                    simulation: null,
                    assessment: {},
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                drawnItems.clearLayers();
                document.getElementById('lat').value = '';
                document.getElementById('lng').value = '';
                document.getElementById('projectName').value = '';
                document.getElementById('organization').value = '';
                document.getElementById('areaCalculation').style.display = 'none';
                
                resetUI();
                showToast("New project created", "success");
            }
        });

        document.getElementById('saveProject').addEventListener('click', function() {
            try {
                // Update project data from form fields
                projectData.name = document.getElementById('projectName').value;
                projectData.organization = document.getElementById('organization').value;
                projectData.userLevel = document.getElementById('userLevel').value;
                projectData.ecosystem = document.getElementById('ecosystemType').value;
                projectData.updatedAt = new Date().toISOString();
                
                // Validate required fields
                if (!projectData.name) {
                    showToast("Please enter a project name before saving", "error");
                    return;
                }
                
                if (projectData.coordinates.length === 0) {
                    showToast("Please set a project location before saving", "error");
                    return;
                }
                
                // Create a blob and download link
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
                const downloadAnchor = document.createElement('a');
                downloadAnchor.setAttribute("href", dataStr);
                downloadAnchor.setAttribute("download", `${projectData.name.replace(/[^a-z0-9]/gi, '_')}_EcoSim_Project.json`);
                document.body.appendChild(downloadAnchor);
                downloadAnchor.click();
                document.body.removeChild(downloadAnchor);
                
                showToast(`Project "${projectData.name}" saved successfully`, "success");
            } catch (err) {
                console.error("Error saving project:", err);
                showToast("Error saving project", "error");
            }
        });

        document.getElementById('loadProject').addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';

            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = readerEvent => {
                    try {
                        const content = readerEvent.target.result;
                        const data = JSON.parse(content);
                        
                        // Basic validation
                        if (!data.coordinates || !data.ecosystem) {
                            throw new Error("Invalid project file format");
                        }
                        
                        projectData = data;
                        loadProjectData();
                        showToast(`Project "${projectData.name}" loaded successfully`, "success");
                    } catch (err) {
                        console.error("Error loading project:", err);
                        showToast("Error loading project file. Please check the file format.", "error");
                    }
                };
                reader.onerror = () => {
                    showToast("Error reading file", "error");
                };
                reader.readAsText(file);
            };

            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        });

        document.getElementById('shareProject').addEventListener('click', function() {
            try {
                // Update project data from form fields
                projectData.name = document.getElementById('projectName').value;
                projectData.organization = document.getElementById('organization').value;
                projectData.userLevel = document.getElementById('userLevel').value;
                projectData.ecosystem = document.getElementById('ecosystemType').value;
                projectData.updatedAt = new Date().toISOString();
                
                // Validate required fields
                if (!projectData.name) {
                    showToast("Please enter a project name before sharing", "error");
                    return;
                }
                
                if (projectData.coordinates.length === 0) {
                    showToast("Please set a project location before sharing", "error");
                    return;
                }
                
                // Create a shareable URL (using URL hash)
                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(projectData));
                const url = window.location.href.split('#')[0] + '#' + compressed;
                
                // Copy to clipboard
                navigator.clipboard.writeText(url).then(() => {
                    showToast("Shareable link copied to clipboard!", "success");
                }).catch(err => {
                    // Fallback if clipboard API fails
                    prompt("Copy this link to share your project:", url);
                });
            } catch (err) {
                console.error("Error sharing project:", err);
                showToast("Error generating share link", "error");
            }
        });

        function loadProjectData() {
            try {
                // Load basic info
                document.getElementById('userLevel').value = projectData.userLevel;
                document.getElementById('ecosystemType').value = projectData.ecosystem;
                document.getElementById('projectName').value = projectData.name || '';
                document.getElementById('organization').value = projectData.organization || '';
                
                // Load assessment data if exists
                if (projectData.assessment) {
                    if (document.getElementById('siteSize')) {
                        document.getElementById('siteSize').value = projectData.assessment.size || '';
                    }
                    if (document.getElementById('siteCondition')) {
                        document.getElementById('siteCondition').value = projectData.condition || 'moderate';
                    }
                    if (document.getElementById('protectionStatus')) {
                        document.getElementById('protectionStatus').value = projectData.protection || 'none';
                    }
                    
                    // Add this new block to handle completed assessments
                    if (projectData.assessment.completed) {
                        document.getElementById('assessmentForm').classList.add('expanded');
                        document.getElementById('startAssessment').innerHTML = '<i class="fas fa-eye-slash"></i> Hide Assessment';
                        document.getElementById('analyzeThreats').disabled = false;  // This enables the button
                    }
                }
                
                // Load map data
                drawnItems.clearLayers();
                if (projectData.coordinates.length === 1) {
                    L.marker(projectData.coordinates[0]).addTo(drawnItems);
                    document.getElementById('lat').value = projectData.coordinates[0][0];
                    document.getElementById('lng').value = projectData.coordinates[0][1];
                    document.getElementById('areaCalculation').style.display = 'none';
                } else if (projectData.coordinates.length > 1) {
                    const polygon = L.polygon(projectData.coordinates, {
                        color: '#2E8B57',
                        fillColor: '#2E8B57',
                        fillOpacity: 0.2
                    }).addTo(drawnItems);
                    
                    if (projectData.area > 0) {
                        document.getElementById('areaValue').textContent = projectData.area.toFixed(2);
                        document.getElementById('areaCalculation').style.display = 'block';
                    }
                }
                
                // Update UI based on loaded data
                if (projectData.ecosystem) {
                    updateCustomQuestions();
                    
                    if (projectData.assessment && projectData.assessment.completed) {
                        document.getElementById('assessmentForm').classList.add('expanded');
                        document.getElementById('startAssessment').innerHTML = '<i class="fas fa-eye-slash"></i> Hide Assessment';
                        document.getElementById('analyzeThreats').disabled = false;
                    }
                }
                
                if (projectData.threats.length > 0) {
                    document.getElementById('threatForm').classList.add('expanded');
                    document.getElementById('analyzeThreats').innerHTML = '<i class="fas fa-eye-slash"></i> Hide Threats';
                    document.getElementById('selectActions').disabled = false;
                    updateThreatList();
                }
                
                if (projectData.actions.length > 0) {
                    document.getElementById('actionForm').classList.add('expanded');
                    document.getElementById('selectActions').innerHTML = '<i class="fas fa-eye-slash"></i> Hide Actions';
                    document.getElementById('runSimulation').disabled = false;
                    updateActionList();
                }
                
                if (projectData.simulation) {
                    document.getElementById('simulationResults').classList.add('expanded');
                    document.getElementById('generateReport').disabled = false;
                    document.getElementById('reportOutput').style.display = 'block';
                    
                    let results = `
                        <h4><i class="fas fa-chart-line"></i> Simulation Results (Loaded from Project)</h4>
                        <p><strong>Threat Reduction:</strong> ${projectData.simulation.threatReduction}%</p>
                        <p><strong>Total Cost:</strong> $${projectData.simulation.totalCost.toLocaleString()}</p>
                        <p><strong>Timeframe:</strong> ${projectData.simulation.timeframe} months</p>
                    `;
                    
                    if (projectData.simulation.recommendations && projectData.simulation.recommendations.length > 0) {
                        results += `
                            <h5>Recommendations:</h5>
                            <ul>
                                ${projectData.simulation.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        `;
                    }
                    
                    document.getElementById('simulationResults').innerHTML = results;
                    document.getElementById('reportContent').innerHTML = results;
                    
                    // Animate the visual bars for loaded simulation
                    setTimeout(() => {
                        const bars = document.querySelectorAll('.visual-bar');
                        bars.forEach((bar, i) => {
                            if (projectData.simulation.visualData[i]) {
                                setTimeout(() => {
                                    bar.style.height = `${projectData.simulation.visualData[i].reducedHeight}%`;
                                    bar.style.backgroundColor = projectData.simulation.visualData[i].reducedColor;
                                    bar.classList.add('reduced');
                                }, i * 200);
                            }
                        });
                    }, 100);
                }
                
                // Zoom to project area
                if (projectData.coordinates.length > 0) {
                    if (projectData.coordinates.length === 1) {
                        map.setView(projectData.coordinates[0], 13);
                    } else {
                        const bounds = L.latLngBounds(projectData.coordinates);
                        map.fitBounds(bounds);
                    }
                }
            } catch (err) {
                console.error("Error loading project data:", err);
                showToast("Error loading project data", "error");
            }
        }

        function resetUI() {
            // Reset all forms
            document.getElementById('assessmentForm').classList.remove('expanded');
            document.getElementById('threatForm').classList.remove('expanded');
            document.getElementById('actionForm').classList.remove('expanded');
            document.getElementById('simulationResults').classList.remove('expanded');
            document.getElementById('reportOutput').style.display = 'none';
            
            // Reset button text
            document.getElementById('startAssessment').innerHTML = '<i class="fas fa-clipboard-check"></i> Begin Detailed Assessment';
            document.getElementById('analyzeThreats').innerHTML = '<i class="fas fa-search"></i> Analyze Threats';
            document.getElementById('selectActions').innerHTML = '<i class="fas fa-check-circle"></i> Select Actions';
            
            // Disable all buttons except first
            document.getElementById('analyzeThreats').disabled = true;
            document.getElementById('selectActions').disabled = true;
            document.getElementById('runSimulation').disabled = true;
            document.getElementById('generateReport').disabled = true;
        }

        function updateUI() {
            // Enable/disable buttons based on state
            if (projectData.coordinates.length > 0) {
                document.getElementById('startAssessment').disabled = false;
            } else {
                document.getElementById('startAssessment').disabled = true;
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
            
            // Add type class
            if (type === 'error') toast.classList.add('error');
            if (type === 'success') toast.classList.add('success');
            if (type === 'warning') toast.classList.add('warning');
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
                
                // Hide after delay
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }, 100);
        }

        // Help system
        document.getElementById('helpButton').addEventListener('click', function() {
            document.getElementById('helpModal').style.display = 'flex';
        });

        document.getElementById('closeHelp').addEventListener('click', function() {
            document.getElementById('helpModal').style.display = 'none';
        });

        // Tab switching in help
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update active content
                const tabName = this.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    if (content.dataset.tab === tabName) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // Check for shared project in URL hash
        window.addEventListener('load', function() {
            if (window.location.hash && window.location.hash.length > 1) {
                try {
                    const decompressed = LZString.decompressFromEncodedURIComponent(window.location.hash.substring(1));
                    if (decompressed) {
                        if (confirm("Load shared project from URL?")) {
                            projectData = JSON.parse(decompressed);
                            loadProjectData();
                            showToast("Shared project loaded", "success");
                            
                            // Remove hash from URL
                            history.replaceState(null, null, ' ');
                        }
                    }
                } catch (err) {
                    console.error("Error loading shared project:", err);
                    showToast("Error loading shared project", "error");
                }
            }
        });

        // Initialize
        resetUI();
        updateUI();
    </script>
</body>
</html>










Here's the complete updated table data generation code for both threat assessment and management actions sections:

Updated Threat Assessment Section

```javascript
function createThreatAssessment(doc, reportType) {
    doc.setFontSize(16);
    doc.setTextColor(46, 139, 87);
    doc.text("3. Threat Assessment", 20, 30);
    doc.setDrawColor(46, 139, 87);
    doc.line(20, 32, 60, 32);
    
    // Summary statistics
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    
    const totalThreats = projectData.threats.length;
    const avgSeverity = (projectData.threats.reduce((sum, t) => sum + t.severity, 0) / totalThreats).toFixed(1);
    const highSeverity = projectData.threats.filter(t => t.severity >= 4).length;
    
    let yPos = 45;
    doc.text(`Total Threats Identified: ${totalThreats}`, 20, yPos);
    doc.text(`Average Severity: ${avgSeverity}/5`, 20, yPos + 8);
    doc.text(`High Severity Threats (4): ${highSeverity}`, 20, yPos + 16);
    
    yPos += 30;
    
    // UPDATED: Threats table with proper string conversion
    const threatRows = projectData.threats.map(t => [
        String(t.name || 'Unnamed Threat'),
        String(t.severity || '0'),
        String(getSeverityDescription(t.severity) || 'Unknown'),
        String(t.description || 'No description provided')
    ]);
    
    doc.autoTable({
        startY: yPos,
        head: [['Threat', 'Severity', 'Level', 'Description']],
        body: threatRows,
        headStyles: {
            fillColor: [46, 139, 87],
            textColor: 255,
            fontStyle: 'bold'
        },
        columnStyles: {
            0: { cellWidth: 45, fontStyle: 'bold' },
            1: { cellWidth: 20, halign: 'center' },
            2: { cellWidth: 35 },
            3: { cellWidth: 'auto' }
        },
        styles: {
            fontSize: reportType === 'academic' ? 9 : 10,
            cellPadding: 3,
            overflow: 'linebreak'
        },
        alternateRowStyles: {
            fillColor: [240, 240, 240]
        }
    });
    
    // Threat analysis for detailed reports
    if (reportType === 'detailed' || reportType === 'academic') {
        yPos = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14);
        doc.setTextColor(46, 139, 87);
        doc.text("Threat Analysis", 20, yPos);
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        yPos += 10;
        
        const analysis = generateThreatAnalysis();
        const analysisLines = doc.splitTextToSize(analysis, 170);
        analysisLines.forEach(line => {
            if (yPos > 270) {
                doc.addPage();
                yPos = 30;
            }
            doc.text(line, 20, yPos);
            yPos += 6;
        });
    }
    
    doc.addPage();
}
```

Updated Management Actions Section

```javascript
function createManagementActions(doc, reportType) {
    doc.setFontSize(16);
    doc.setTextColor(46, 139, 87);
    doc.text("4. Management Actions", 20, 30);
    doc.setDrawColor(46, 139, 87);
    doc.line(20, 32, 60, 32);
    
    // Action summary
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    
    const totalActions = projectData.actions.length;
    const totalCost = projectData.actions.reduce((sum, a) => sum + (a.cost || 0), 0);
    const maxTime = Math.max(...projectData.actions.map(a => a.time || 0));
    
    let yPos = 45;
    doc.text(`Total Actions: ${totalActions}`, 20, yPos);
    doc.text(`Total Estimated Cost: $${totalCost.toLocaleString()}`, 20, yPos + 8);
    doc.text(`Maximum Timeframe: ${maxTime} months`, 20, yPos + 16);
    doc.text(`Projected Threat Reduction: ${projectData.simulation ? projectData.simulation.threatReduction : 0}%`, 20, yPos + 24);
    
    yPos += 40;
    
    // UPDATED: Actions table with proper string conversion and null safety
    const actionRows = projectData.actions.map(a => [
        String(a.name || 'Unnamed Action'),
        String(`$${(a.cost || 0).toLocaleString()}`),
        String(`${a.time || 0} months`),
        String(a.effectiveness ? `${a.effectiveness}/5` : 'N/A'),
        String(a.description || 'No description provided')
    ]);
    
    const tableHeaders = ['Action', 'Cost', 'Timeframe', 'Effectiveness', 'Description'];
    
    // For basic reports, simplify the table
    if (reportType === 'basic') {
        const basicActionRows = projectData.actions.map(a => [
            String(a.name || 'Unnamed Action'),
            String(`$${(a.cost || 0).toLocaleString()}`),
            String(`${a.time || 0} months`),
            String(a.effectiveness ? `${a.effectiveness}/5` : 'N/A')
        ]);
        
        doc.autoTable({
            startY: yPos,
            head: [['Action', 'Cost', 'Timeframe', 'Effectiveness']],
            body: basicActionRows,
            headStyles: {
                fillColor: [46, 139, 87],
                textColor: 255,
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { cellWidth: 60, fontStyle: 'bold' },
                1: { cellWidth: 30, halign: 'right' },
                2: { cellWidth: 25, halign: 'center' },
                3: { cellWidth: 25, halign: 'center' }
            },
            styles: {
                fontSize: reportType === 'academic' ? 9 : 10,
                cellPadding: 3,
                overflow: 'linebreak'
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240]
            }
        });
    } else {
        // Full table for other report types
        doc.autoTable({
            startY: yPos,
            head: [tableHeaders],
            body: actionRows,
            headStyles: {
                fillColor: [46, 139, 87],
                textColor: 255,
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { cellWidth: 45, fontStyle: 'bold' },
                1: { cellWidth: 25, halign: 'right' },
                2: { cellWidth: 25, halign: 'center' },
                3: { cellWidth: 25, halign: 'center' },
                4: { cellWidth: 'auto' }
            },
            styles: {
                fontSize: reportType === 'academic' ? 9 : 10,
                cellPadding: 3,
                overflow: 'linebreak'
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240]
            }
        });
    }
    
    doc.addPage();
}
```

Updated Budget Proposal Section (for Funding Reports)

```javascript
function createBudgetProposal(doc) {
    doc.setFontSize(16);
    doc.setTextColor(46, 139, 87);
    doc.text("6. Budget Proposal", 20, 30);
    
    // UPDATED: Detailed budget table with string conversion
    const budgetRows = projectData.actions.map(a => [
        String(a.name || 'Unnamed Action'),
        String(`$${(a.cost || 0).toLocaleString()}`),
        String(`${a.time || 0} months`),
        String(`$${Math.round((a.cost || 0) / (a.time || 1)).toLocaleString()}/month`)
    ]);
    
    // Add total row
    const totalCost = projectData.actions.reduce((sum, a) => sum + (a.cost || 0), 0);
    const maxTime = Math.max(...projectData.actions.map(a => a.time || 0));
    budgetRows.push([
        'TOTAL',
        String(`$${totalCost.toLocaleString()}`),
        String(`${maxTime} months`),
        String(`$${Math.round(totalCost / (maxTime || 1)).toLocaleString()}/month`)
    ]);
    
    doc.autoTable({
        startY: 45,
        head: [['Action', 'Total Cost', 'Duration', 'Monthly Cost']],
        body: budgetRows,
        headStyles: {
            fillColor: [46, 139, 87],
            textColor: 255,
            fontStyle: 'bold'
        },
        footStyles: {
            fillColor: [200, 200, 200],
            fontStyle: 'bold'
        },
        columnStyles: {
            0: { cellWidth: 80, fontStyle: 'bold' },
            1: { cellWidth: 30, halign: 'right' },
            2: { cellWidth: 25, halign: 'center' },
            3: { cellWidth: 30, halign: 'right' }
        },
        styles: {
            fontSize: 10,
            cellPadding: 3
        }
    });
    
    // Funding request
    const yPos = doc.lastAutoTable.finalY + 20;
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'bold');
    doc.text("Funding Request", 20, yPos);
    doc.setFont(undefined, 'normal');
    
    const requestText = [
        `Total Funding Requested: $${totalCost.toLocaleString()}`,
        `Project Duration: ${maxTime} months (${(maxTime/12).toFixed(1)} years)`,
        `This investment will achieve ${projectData.simulation ? projectData.simulation.threatReduction : 0}% threat reduction and significant biodiversity outcomes.`
    ];
    
    let textY = yPos + 10;
    requestText.forEach(line => {
        doc.text(line, 25, textY);
        textY += 7;
    });
}
```

Key Changes Made:

1. String Conversion: All values are explicitly converted to strings using String()
2. Null Safety: Added fallback values (|| 0, || 'Unknown', etc.) to handle missing data
3. Consistent Formatting: Ensured all numeric values are properly formatted before conversion
4. Error Prevention: Added safety checks for potentially undefined properties

These changes should resolve the "type of text must be string or array" error by ensuring that all data passed to the autoTable plugin are properly formatted strings.
