<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Mapping Tool - Cert III Conservation & Ecosystem Management</title>
    <style>
        /* ========== COMPLETE CSS ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --color-safety: #ff6b6b;
            --color-foundational: #4ecdc4;
            --color-practical: #45b7d1;
            --color-machinery: #96ceb4;
            --color-apex: #ffeaa7;
            --color-project: #a29bfe;
            --color-specialist: #fd79a8;
            --color-seasonal: #55efc4;
            --color-holiday: #dfe6e9;
            --color-term-break: #b2bec3;
            --color-grid: #636e72;
            --color-easter: #fab1a0;
            --color-teacher-training: #a29bfe;
            --color-leave: #fd79a8;
            --week-width: 150px;
            --student-week-width: 120px;
            --total-weeks: 37;
            --sidebar-width: 280px;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        body.student-view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) fixed;
        }

        body.editor-view {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) fixed;
        }

        /* Loading */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2d3436 0%, #0984e3 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d3436 0%, #0984e3 100%);
            color: white;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body.student-view .header {
            background: linear-gradient(135deg, #0984e3 0%, #2d3436 100%);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        /* View Toggle */
        .view-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .view-toggle button {
            background: white;
            border: 2px solid #0984e3;
            color: #0984e3;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s;
            position: relative;
        }

        .view-toggle button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* Controls - Hidden in Student View */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        body.student-view .controls {
            display: none;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }

        .control-group label {
            font-size: 14px;
            font-weight: 600;
            color: #2d3436;
        }

        select, button, input {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover, button:hover, input:hover {
            border-color: #0984e3;
        }

        button.primary {
            background: #0984e3;
            color: white;
            border: none;
            font-weight: 600;
        }

        button.primary:hover {
            background: #0770c4;
        }

        button.warning {
            background: #ff6b6b;
            color: white;
            border: none;
            font-weight: 600;
        }

        button.warning:hover {
            background: #ff5252;
        }

        button.success {
            background: #00b894;
            color: white;
            border: none;
            font-weight: 600;
        }

        button.success:hover {
            background: #00a085;
        }

        /* Legend - Hidden in Student View */
        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 0 20px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        body.student-view .legend {
            display: none;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            padding: 5px 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Workspace */
        .workspace {
            display: flex;
            gap: 20px;
            margin: 0 20px 20px;
            min-height: 600px;
        }

        /* Sidebar - Hidden in Student View */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-y: auto;
            max-height: 800px;
        }

        body.student-view .sidebar {
            display: none;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #2d3436;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f2f6;
        }

        /* Timeline Container */
        .timeline-container {
            flex: 1;
            background: white;
            border-radius: 10px;
            overflow: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            min-height: 800px;
        }

        /* Term Headers */
        .term-headers {
            display: flex;
            position: sticky;
            top: 0;
            left: 0;
            background: white;
            z-index: 20;
            border-bottom: 3px solid #2d3436;
            min-width: min-content;
        }

        .term-spacer {
            width: 120px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-right: 2px solid #ddd;
        }

        .term-header {
            flex-shrink: 0;
            padding: 15px 10px;
            background: #2d3436;
            color: white;
            text-align: center;
            font-weight: 600;
            border-right: 2px solid white;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .term-header:hover {
            background: #0984e3;
        }

        /* Week Headers */
        .week-headers {
            display: flex;
            position: sticky;
            top: 53px;
            left: 0;
            background: white;
            z-index: 15;
            min-width: min-content;
        }

        .week-spacer {
            width: 120px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-right: 2px solid #ddd;
        }

        .week-header {
            width: var(--week-width);
            flex-shrink: 0;
            padding: 10px;
            text-align: center;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            border-bottom: 2px solid #636e72;
            font-weight: 600;
            position: relative;
        }

        .week-number {
            font-size: 16px;
            margin-bottom: 5px;
        }

        /* Timeline Grid */
        .timeline-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: min-content;
            position: relative;
        }

        .swimlane {
            display: flex;
            min-height: 120px;
            position: relative;
        }

        .lane-label {
            width: 120px;
            flex-shrink: 0;
            padding: 10px;
            background: #f8f9fa;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 2px solid #ddd;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .lane-content {
            display: flex;
            flex: 1;
            position: relative;
        }

        .week-slot {
            width: var(--week-width);
            flex-shrink: 0;
            min-height: 120px;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            padding: 5px;
            position: relative;
            transition: background 0.2s;
        }

        .week-slot:hover {
            background: rgba(9, 132, 227, 0.05);
        }

        .week-slot.blocked-week {
            background: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.1) 10px,
                rgba(0, 0, 0, 0.05) 10px,
                rgba(0, 0, 0, 0.05) 20px
            ) !important;
        }

        /* Unit Items */
        .unit-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: grab;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
            position: relative;
        }

        .unit-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Unit Blocks */
        .unit-block {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: move;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            min-height: 60px;
            z-index: 2;
        }

        .unit-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .unit-block.dragging {
            opacity: 0.8;
            transform: rotate(3deg);
        }

        .unit-code {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .unit-name {
            font-size: 11px;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .unit-duration {
            font-size: 10px;
            color: rgba(0,0,0,0.6);
            position: absolute;
            bottom: 5px;
            right: 8px;
            background: rgba(255,255,255,0.8);
            padding: 1px 5px;
            border-radius: 3px;
        }

        /* Project Markers */
        .project-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--color-project);
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--color-project), 0 2px 4px rgba(0,0,0,0.2);
            cursor: grab;
            transition: all 0.2s;
        }

        .project-marker:hover {
            transform: translateY(-50%) scale(1.2);
            box-shadow: 0 0 0 3px var(--color-project), 0 4px 8px rgba(0,0,0,0.3);
        }

        .project-marker.dragging {
            cursor: grabbing;
            opacity: 0.8;
            transform: translateY(-50%) scale(1.1);
        }

        .project-marker-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            white-space: nowrap;
            color: #2d3436;
            background: white;
            padding: 3px 8px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            font-weight: 600;
            min-width: 100px;
            text-align: center;
            z-index: 11;
            pointer-events: none;
        }

        .project-marker-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: #ff6b6b;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 12;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .project-marker:hover .project-marker-delete {
            opacity: 1;
        }

        .project-marker-delete:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        /* Empty Slot */
        .empty-slot {
            width: 100%;
            height: 100%;
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #b2bec3;
            font-size: 12px;
            font-style: italic;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.02) 10px,
                rgba(0,0,0,0.02) 20px
            );
        }

        /* Student Term Overviews */
        .student-term-overviews {
            display: none;
            margin: 20px;
        }

        body.student-view .student-term-overviews {
            display: block;
        }

        .term-overview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .term-overview h3 {
            color: #2d3436;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f2f6;
        }

        .term-units {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .term-unit-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #0984e3;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: #00b894;
        }

        .toast-error {
            background: #ff6b6b;
        }

        .toast-info {
            background: #0984e3;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #2d3436;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #636e72;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Footer */
        .footer {
            background: #2d3436;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        /* Share Panel */
        .share-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 300px;
            display: none;
        }

        .share-panel.show {
            display: block;
        }

        .share-panel h4 {
            margin-bottom: 10px;
            color: #2d3436;
        }

        .share-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .share-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        /* Progress Indicator */
        .progress-indicator {
            position: absolute;
            bottom: 5px;
            left: 5px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
        }

        .progress-indicator.completed {
            background: #00b894;
        }

        /* Sync Status */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #00b894;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .sync-status.show {
            display: flex;
        }

        /* Unit Count */
        .unit-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        /* Week Summary */
        .week-summary {
            font-size: 12px;
            margin-top: 5px;
            color: #636e72;
        }

        /* Project Marker Controls */
        .project-marker-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        .project-marker-controls button {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .workspace {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 400px;
            }
            
            :root {
                --week-width: 120px;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                min-width: 100%;
            }
            
            :root {
                --week-width: 100px;
            }
            
            .view-toggle {
                top: 10px;
                right: 10px;
            }
            
            .view-toggle button {
                padding: 8px 15px;
                font-size: 14px;
            }
            
            .project-marker-label {
                font-size: 10px;
                padding: 2px 6px;
                min-width: 80px;
            }
        }

        /* Print Styles */
        @media print {
            .view-toggle,
            .controls,
            .legend,
            .sidebar,
            .share-panel,
            .sync-status,
            .toast {
                display: none !important;
            }
            
            .workspace {
                margin: 0;
            }
            
            .timeline-container {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .header {
                background: #2d3436 !important;
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>
<body class="editor-view">
    <!-- Loading -->
    <div id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Course Planner...</div>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="view-toggle">
        <button id="toggleView">
            <span id="viewIcon">üëÅÔ∏è</span>
            <span id="viewLabel">Student View</span>
        </button>
    </div>

    <!-- Share Panel -->
    <div class="share-panel" id="sharePanel">
        <h4>Share Student View</h4>
        <div class="share-input">
            <input type="text" id="shareLink" readonly>
            <button id="copyShareLink" class="primary">Copy</button>
        </div>
        <p style="font-size: 12px; color: #636e72; margin-bottom: 10px;">
            Share this link with students for read-only access
        </p>
        <div class="qr-code" id="qrCode">
            <!-- QR code will be generated here -->
        </div>
    </div>

    <!-- Sync Status -->
    <div class="sync-status" id="syncStatus">
        <span>‚úì</span>
        <span id="syncMessage">Changes saved to student view</span>
    </div>

    <!-- Header -->
    <header class="header">
        <h1 id="courseTitle">Certificate III in Conservation & Ecosystem Management</h1>
        <div class="subtitle" id="courseSubtitle">Course Sequencing Tool | <span id="viewModeIndicator">Interactive Planner</span></div>
        <div style="font-size: 14px; opacity: 0.8;" id="courseDescription">
            Drag units to adjust sequence | Click units to edit details | Save/load your custom plans
        </div>
    </header>

    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <label for="viewMode">View Mode</label>
            <select id="viewMode">
                <option value="week">Week View</option>
                <option value="term">Term View</option>
                <option value="teacher">Teacher View</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="highlightMode">Highlight</label>
            <select id="highlightMode">
                <option value="none">None</option>
                <option value="specialist">Specialist Units</option>
                <option value="safety">Safety Units</option>
                <option value="seasonal">Seasonal Timing</option>
                <option value="assessment">Assessment Points</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="weekBlocking">Block Weeks</label>
            <select id="weekBlocking">
                <option value="">Select action...</option>
                <option value="easter">Mark as Easter Break</option>
                <option value="term-break">Mark as Term Break</option>
                <option value="training">Mark as Teacher Training</option>
                <option value="leave">Mark as Leave</option>
                <option value="clear">Clear Blocking</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="weekRange">Week Range</label>
            <input type="text" id="weekRange" placeholder="e.g., 5-7 or 12,13,14">
        </div>
        
        <button id="applyBlocking" class="primary">Apply Blocking</button>
        
        <div style="flex: 1;"></div>
        
        <button class="primary" id="savePlan">üíæ Save Plan</button>
        <button id="sharePlan">üîó Share</button>
        <button id="forceSync" class="success">üîÑ Force Sync</button>
        <button id="resetPlan">üîÑ Reset</button>
        <button id="printPlan">üñ®Ô∏è Print</button>
        <button id="exportPlan">üì§ Export</button>
        <button id="clearTimetable" class="warning">üóëÔ∏è Clear All</button>
        
        <div class="control-group">
            <label>Manage Weeks</label>
            <div style="display: flex; gap: 5px; flex-direction: column;">
                <div style="display: flex; gap: 5px;">
                    <button id="addWeekBtn" class="success" style="flex: 1;">+ Add Week</button>
                    <button id="removeWeekBtn" class="warning" style="flex: 1;">- Remove Week</button>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button id="addWeekToTermBtn" class="success" style="flex: 1;">+ To Term</button>
                    <button id="removeWeekFromTermBtn" class="warning" style="flex: 1;">- From Term</button>
                </div>
            </div>
        </div>
        
        <!-- Project Marker Controls -->
        <div class="control-group">
            <label>Project Milestones</label>
            <div class="project-marker-controls">
                <button id="addProjectMarker" class="success" title="Add a project milestone">+ Add Marker</button>
                <button id="clearProjectMarkers" class="warning" title="Clear all project milestones">üóëÔ∏è Clear All</button>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-safety);"></div>
            <span>Safety Units</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-foundational);"></div>
            <span>Foundational Skills</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-practical);"></div>
            <span>Practical Application</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-machinery);"></div>
            <span>Machinery Units</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-apex);"></div>
            <span>Apex Units</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-project);"></div>
            <span>Integrated Project</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-specialist);"></div>
            <span>Other Teacher</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-seasonal);"></div>
            <span>Seasonal Timing</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-easter);"></div>
            <span>Easter Break</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-teacher-training);"></div>
            <span>Teacher Training</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-leave);"></div>
            <span>Leave</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-term-break);"></div>
            <span>Term Break</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #a29bfe; border: 1px solid #888;"></div>
            <span>Project Milestones</span>
        </div>
    </div>

    <!-- Workspace -->
    <div class="workspace">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>üìö Unit Palette</h3>
            <div id="unitPalette">
                <!-- Units will be loaded here -->
            </div>
            
            <div style="margin-top: 30px;">
                <h3>‚ûï Add Custom Unit</h3>
                <button id="addCustomUnit" style="width: 100%; margin-top: 10px;">+ Add Custom Unit/Block</button>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üíæ Saved Plans</h3>
                <div id="savedPlans">
                    <!-- Saved plans will appear here -->
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üì§ Import Plan</h3>
                <input type="file" id="importPlan" accept=".json" style="width: 100%; margin-top: 10px;">
                <button id="importPlanBtn" style="width: 100%; margin-top: 10px;">Import Plan File</button>
            </div>
        </aside>

        <!-- Timeline -->
        <main class="timeline-container">
            <div id="timelineContent">
                <!-- Timeline will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Student Term Overviews -->
    <div class="student-term-overviews" id="studentTermOverviews">
        <!-- Will be populated for student view -->
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Course Mapping Tool v3.0 | Designed for Cert III Conservation & Ecosystem Management | <span id="totalWeeksDisplay">37</span> Teaching Weeks</p>
        <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
            Drag units to adjust sequence. Seasonal units have constraints. Click units to add notes and resources.
        </p>
        <div style="margin-top: 10px; font-size: 11px; color: #999;">
            <span>Press Ctrl+Z to undo, Ctrl+Y to redo | Ctrl+S to save | Ctrl+P to print</span>
        </div>
    </footer>

    <!-- Modals -->
    <div class="modal" id="unitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Edit Unit Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be populated -->
            </div>
        </div>
    </div>

    <div class="modal" id="termModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Term</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="termModalBody">
                <!-- Term management will be populated -->
            </div>
        </div>
    </div>

    <!-- Toasts Container -->
    <div id="toastsContainer"></div>

    <!-- Main JavaScript -->
<script>
    // ========== SIMPLIFIED VERSION - GUARANTEED TO WORK ==========
    const SHARED_STORAGE_KEY = 'course_planner_shared_data';
    
    class CoursePlanner {
        constructor() {
            this.units = [];
            this.isStudentView = window.location.search.includes('student=true');
            this.init();
        }
        
        init() {
            console.log('=== INITIALIZING ===');
            console.log('Is Student View:', this.isStudentView);
            console.log('URL:', window.location.href);
            
            this.loadData();
            this.setupUI();
            this.renderEverything();
            this.setupEventListeners();
            this.hideLoadingScreen();
        }
        
        // ========== SINGLE DATA SOURCE ==========
        loadData() {
            console.log('=== LOADING DATA ===');
            
            // Try to load from shared storage
            const sharedData = localStorage.getItem(SHARED_STORAGE_KEY);
            console.log('Shared data found:', !!sharedData);
            
            if (sharedData) {
                try {
                    const data = JSON.parse(sharedData);
                    console.log('Parsed data:', data);
                    
                    if (data.units && Array.isArray(data.units)) {
                        this.units = data.units;
                        console.log('Loaded', this.units.length, 'units from shared storage');
                        
                        // Log first few units to verify
                        console.log('First 3 units:', this.units.slice(0, 3));
                    } else {
                        console.log('No valid units in shared storage, using defaults');
                        this.loadDefaultUnits();
                    }
                } catch (error) {
                    console.error('Error parsing shared data:', error);
                    this.loadDefaultUnits();
                }
            } else {
                console.log('No shared data found, using defaults');
                this.loadDefaultUnits();
            }
        }
        
        loadDefaultUnits() {
            this.units = [
                {
                    id: '1',
                    code: 'AHCWHS302',
                    name: 'Work Health & Safety',
                    weeks: [1, 2],
                    color: 'safety',
                    teacher: 'main'
                },
                {
                    id: '2',
                    code: 'HLTAID011',
                    name: 'First Aid',
                    weeks: [1, 2],
                    color: 'safety',
                    teacher: 'other'
                },
                {
                    id: '3',
                    code: 'AHCECR305',
                    name: 'Collect native seed',
                    weeks: [3, 4],
                    color: 'seasonal',
                    teacher: 'main'
                }
            ];
        }
        
        saveData() {
            console.log('=== SAVING DATA ===');
            console.log('Current units:', this.units);
            
            const data = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                units: JSON.parse(JSON.stringify(this.units))
            };
            
            localStorage.setItem(SHARED_STORAGE_KEY, JSON.stringify(data));
            console.log('Saved to shared storage:', SHARED_STORAGE_KEY);
            
            // Verify save worked
            const verify = localStorage.getItem(SHARED_STORAGE_KEY);
            console.log('Verification - data saved:', !!verify);
            
            this.showToast('Data saved successfully', 'success');
        }
        
        // ========== SIMPLE RENDERING ==========
        renderEverything() {
            console.log('=== RENDERING ===');
            console.log('Current units to render:', this.units.length);
            
            if (this.isStudentView) {
                this.renderStudentView();
            } else {
                this.renderEditorView();
            }
        }
        
        renderEditorView() {
            const container = document.getElementById('timelineContent');
            if (!container) return;
            
            // Simple timeline for testing
            let html = '<div style="padding: 20px;">';
            html += '<h3>Editor View - Current Units</h3>';
            html += '<p>Total units: ' + this.units.length + '</p>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
            
            this.units.forEach(unit => {
                html += `
                    <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; min-width: 200px;">
                        <strong>${unit.code}</strong><br>
                        ${unit.name}<br>
                        Weeks: ${unit.weeks.join(', ')}<br>
                        Teacher: ${unit.teacher}
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button onclick="app.moveUnitForTest()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Test: Move First Unit to Week 5</button>';
            html += '<button onclick="app.sharePlan()" style="margin-top: 20px; margin-left: 10px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Generate Share Link</button>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        renderStudentView() {
            const container = document.getElementById('timelineContent');
            if (!container) return;
            
            // Simple student view for testing
            let html = '<div style="padding: 20px;">';
            html += '<h3>Student View - Course Schedule</h3>';
            html += '<p>This view should match the editor view exactly</p>';
            html += '<p>Total units: ' + this.units.length + '</p>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
            
            this.units.forEach(unit => {
                html += `
                    <div style="background: #e0f7fa; padding: 10px; border-radius: 5px; min-width: 200px;">
                        <strong>${unit.code}</strong><br>
                        ${unit.name}<br>
                        Weeks: ${unit.weeks.join(', ')}<br>
                        Teacher: ${unit.teacher}
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Refresh to Check for Updates</button>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // ========== TEST FUNCTIONS ==========
        moveUnitForTest() {
            console.log('=== MOVING UNIT FOR TEST ===');
            
            if (this.units.length > 0) {
                // Move first unit to week 5
                this.units[0].weeks = [5];
                console.log('Moved unit to week 5:', this.units[0]);
                
                // Save immediately
                this.saveData();
                
                // Re-render
                this.renderEverything();
                
                this.showToast('Test: Moved first unit to week 5 and saved', 'success');
            }
        }
        
        sharePlan() {
            console.log('=== GENERATING SHARE LINK ===');
            
            // Save current data first
            this.saveData();
            
            // Create share URL
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = baseUrl + '?student=true&v=' + Date.now(); // Add timestamp to bypass cache
            
            console.log('Share URL:', shareUrl);
            
            // Show URL
            alert(`Share this URL with students:\n\n${shareUrl}\n\nStudent view will show EXACTLY what you see now.`);
            
            // Also copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                this.showToast('Share link copied to clipboard!', 'success');
            });
        }
        
        // ========== UI SETUP ==========
        setupUI() {
            if (this.isStudentView) {
                document.body.classList.add('student-view');
                document.body.classList.remove('editor-view');
                document.getElementById('courseTitle').textContent = 'Student View - Course Schedule';
                document.getElementById('viewIcon').textContent = '‚úèÔ∏è';
                document.getElementById('viewLabel').textContent = 'Editor View';
                
                // Hide editor controls
                const controls = document.querySelector('.controls');
                const legend = document.querySelector('.legend');
                const sidebar = document.querySelector('.sidebar');
                if (controls) controls.style.display = 'none';
                if (legend) legend.style.display = 'none';
                if (sidebar) sidebar.style.display = 'none';
            } else {
                document.body.classList.add('editor-view');
                document.body.classList.remove('student-view');
                document.getElementById('courseTitle').textContent = 'Editor - Course Planner';
                document.getElementById('viewIcon').textContent = 'üëÅÔ∏è';
                document.getElementById('viewLabel').textContent = 'Student View';
            }
        }
        
        setupEventListeners() {
            // View toggle
            const toggleBtn = document.getElementById('toggleView');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    if (this.isStudentView) {
                        // Go to editor
                        window.location.href = window.location.pathname;
                    } else {
                        // Generate share link
                        this.sharePlan();
                    }
                });
            }
            
            // Save button
            const saveBtn = document.getElementById('savePlan');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => this.saveData());
            }
            
            // Share button
            const shareBtn = document.getElementById('sharePlan');
            if (shareBtn) {
                shareBtn.addEventListener('click', () => this.sharePlan());
            }
            
            // Force sync button
            const forceSyncBtn = document.getElementById('forceSync');
            if (forceSyncBtn) {
                forceSyncBtn.addEventListener('click', () => {
                    this.saveData();
                    this.showToast('Forced sync to student view', 'success');
                });
            }
        }
        
        // ========== UTILITIES ==========
        showToast(message, type = 'info') {
            console.log('Toast:', message);
            alert(message); // Simple alert for testing
        }
        
        hideLoadingScreen() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 300);
            }
        }
    }
    
    // ========== INITIALIZE ==========
    let app;
    document.addEventListener('DOMContentLoaded', () => {
        app = new CoursePlanner();
        window.app = app;
        
        // Add a clear storage button for debugging
        const debugDiv = document.createElement('div');
        debugDiv.style.position = 'fixed';
        debugDiv.style.bottom = '10px';
        debugDiv.style.left = '10px';
        debugDiv.style.zIndex = '9999';
        debugDiv.innerHTML = `
            <button onclick="localStorage.clear(); location.reload();" 
                    style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; font-size: 12px;">
                üî• Clear Storage & Reload
            </button>
            <button onclick="console.log('Storage:', localStorage.getItem('${SHARED_STORAGE_KEY}'))" 
                    style="margin-left: 5px; padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 3px; font-size: 12px;">
                üìä Debug Storage
            </button>
        `;
        document.body.appendChild(debugDiv);
    });
</script>
</body>
</html>
