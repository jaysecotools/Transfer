You're absolutely right! The shortfall and surplus values in the scenario cards aren't being updated properly. The issue is that we're only updating the shortfall elements but not the surplus elements for some scenarios, and vice versa.

Let me fix the calculateAndDisplayScenario function to properly handle both shortfall and surplus displays:

```javascript
// FIXED: New function that calculates AND displays scenario results
function calculateAndDisplayScenario(scenarioAge, currentAge, lifeExpectancy, inflationRate, returnRate, 
                         superBalance, contribution, expenses, retirementExpenseRate, healthcare, travel, otherCosts,
                         partnerData, downsizingData, ttrData, investmentPropsValue, residenceValue, otherAssetsValue,
                         smsfData, isHighIncomeEarner) {
    return safeCalculate(() => {
        const yearsToRetirement = Math.max(0, scenarioAge - currentAge);
        const retirementYears = Math.max(0, lifeExpectancy - scenarioAge);
        
        // Calculate future super balance using new projection function
        let projectedSuper = projectSuperBalance(superBalance, contribution, yearsToRetirement, returnRate);
        
        // Apply SMSF costs if applicable
        if (smsfData.hasSmsf) {
            for (let i = 0; i < yearsToRetirement; i++) {
                projectedSuper -= smsfData.adminCosts;
            }
        }
        
        // Apply TTR strategy if applicable
        if (ttrData.planned && scenarioAge >= ttrData.startAge) {
            const ttrYears = Math.min(yearsToRetirement, scenarioAge - ttrData.startAge);
            const preTTRYears = yearsToRetirement - ttrYears;
            
            // Growth before TTR
            projectedSuper = projectSuperBalance(superBalance, contribution, preTTRYears, returnRate);
            
            // TTR phase
            for (let i = 0; i < ttrYears; i++) {
                // FIXED: TTR withdrawal based on user's desired income, not fixed 4%
                const ttrWithdrawal = contribution * ttrData.incomePercent; // User's desired TTR income
                projectedSuper -= ttrWithdrawal;
                
                // Continue growth with increased salary sacrifice
                const ttrContribution = contribution * (1 + ttrData.salarySacrificePercent);
                projectedSuper = projectedSuper * (1 + returnRate) + ttrContribution;
            }
        } else {
            // Standard accumulation using projection function
            projectedSuper = projectSuperBalance(superBalance, contribution, yearsToRetirement, returnRate);
        }
        
        // Apply downsizing if applicable
        if (downsizingData.planned && scenarioAge >= downsizingData.downsizeAge) {
            const downsizingProceeds = Math.max(0, downsizingData.downsizeValue - residenceValue);
            if (downsizingProceeds > 0) {
                // FIXED: Clarify downsizer contribution calculation
                const downsizerContribution = Math.min(AUSTRALIAN_RULES.DOWNSIZER_CONTRIBUTION_LIMIT, downsizingProceeds);
                projectedSuper += downsizerContribution;
            }
        }
        
        // Add partner's super if applicable and if partner retires at same time or earlier
        if (partnerData && partnerData.retirementAge <= scenarioAge) {
            const partnerYearsToRetirement = scenarioAge - partnerData.age;
            const partnerProjectedSuper = projectSuperBalance(
                partnerData.super, 
                partnerData.contribution, 
                partnerYearsToRetirement, 
                returnRate
            );
            
            projectedSuper += partnerProjectedSuper;
        }
        
        // Calculate retirement expenses (adjusted for inflation)
        const baseRetirementExpenses = (expenses * retirementExpenseRate) + healthcare + travel + otherCosts;
        
        // FIXED: Use inflation adjustment function
        const futureRetirementExpenses = calculateInflationAdjustedValue(
            baseRetirementExpenses, 
            yearsToRetirement, 
            inflationRate
        );
        
        // FIXED: Use enhanced retirement income calculation
        const superIncome = calculateSustainableWithdrawal(
            projectedSuper, 
            retirementYears, 
            returnRate, 
            inflationRate
        );
        
        // Estimate Age Pension based on assets (using enhanced calculation)
        let agePension = calculateAgePension(
            projectedSuper + investmentPropsValue + otherAssetsValue, 
            superIncome, 
            partnerData !== null,
            scenarioAge
        );
        
        const totalRetirementIncome = superIncome + agePension;
        
        // Calculate shortfall/surplus
        const shortfall = Math.max(0, futureRetirementExpenses - totalRetirementIncome);
        const surplus = Math.max(0, totalRetirementIncome - futureRetirementExpenses);
        
        // FIXED: Update scenario display with proper formatting
        const yearsElement = document.getElementById(`scenario-${scenarioAge}-years`);
        const superElement = document.getElementById(`scenario-${scenarioAge}-super`);
        const incomeElement = document.getElementById(`scenario-${scenarioAge}-income`);
        const shortfallElement = document.getElementById(`scenario-${scenarioAge}-shortfall`);
        const surplusElement = document.getElementById(`scenario-${scenarioAge}-surplus`);
        
        // Update all elements
        if (yearsElement) yearsElement.textContent = yearsToRetirement;
        if (superElement) superElement.textContent = formatCurrency(projectedSuper);
        if (incomeElement) incomeElement.textContent = formatCurrency(totalRetirementIncome);
        
        // FIXED: Properly handle both shortfall and surplus display for all scenarios
        if (shortfallElement) {
            if (shortfall > 0) {
                shortfallElement.textContent = formatCurrency(shortfall);
                shortfallElement.style.display = 'block';
                shortfallElement.className = 'scenario-value shortfall';
                // Hide surplus element if it exists for this scenario
                if (surplusElement) {
                    surplusElement.style.display = 'none';
                }
            } else {
                shortfallElement.style.display = 'none';
            }
        }
        
        if (surplusElement) {
            if (surplus > 0) {
                surplusElement.textContent = formatCurrency(surplus);
                surplusElement.style.display = 'block';
                surplusElement.className = 'scenario-value surplus';
                // Hide shortfall element if it exists for this scenario
                if (shortfallElement) {
                    shortfallElement.style.display = 'none';
                }
            } else {
                surplusElement.style.display = 'none';
            }
        }
        
        return {
            age: scenarioAge,
            yearsToRetirement,
            projectedSuper,
            retirementIncome: totalRetirementIncome,
            shortfall,
            surplus
        };
    });
}
```

The key fix is in the section that handles the shortfall/surplus display. The problem was that we were only checking for one element type but not properly handling both cases for all scenarios. Now the function:

1. Properly checks both shortfall and surplus elements for each scenario
2. Shows the appropriate element based on whether there's a shortfall or surplus
3. Hides the other element to avoid showing both at the same time
4. Applies the correct CSS classes for styling (red for shortfall, green for surplus)

This should now properly update both the shortfall values (for ages 55 and 60) and surplus values (for ages 65, 67, and 70) based on your actual calculations. When you run the calculator now, you'll see the shortfall/surplus amounts change dynamically based on your inputs.









            Good question! Looking at the HTML structure, the issue is that age 55 and 60 scenarios only have shortfall elements in the HTML, while ages 65, 67, and 70 only have surplus elements.

Let me check the HTML structure:

· Age 55 & 60: Only have scenario-55-shortfall and scenario-60-shortfall elements
· Age 65, 67, 70: Only have scenario-65-surplus, scenario-67-surplus, and scenario-70-surplus elements

So currently, age 55 will never show a surplus even if the calculations show one, because there's no surplus element for that scenario in the HTML.

We need to update the HTML to include both shortfall AND surplus elements for ALL scenarios. Here's the fix:

Replace the scenario grid sections in your HTML with this updated version:

```html
<div class="scenario-content active" id="scenario-55">
    <div class="scenario-grid">
        <div class="scenario-card">
            <div class="scenario-age">Age 55</div>
            <div class="result-label">Years to Retirement</div>
            <div class="scenario-value" id="scenario-55-years">10</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Projected Super</div>
            <div class="scenario-value" id="scenario-55-super">$450,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Annual Retirement Income</div>
            <div class="scenario-value" id="scenario-55-income">$42,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Retirement Shortfall</div>
            <div class="scenario-value shortfall" id="scenario-55-shortfall" style="display: none;">$18,000</div>
            <div class="result-label">Retirement Surplus</div>
            <div class="scenario-value surplus" id="scenario-55-surplus" style="display: none;">$0</div>
        </div>
    </div>
    <div class="recommendation warning">
        <h4>Age 55 Retirement Considerations</h4>
        <p>Retiring at 55 would require accessing your super through a transition to retirement pension. You may face a significant income shortfall without additional savings or part-time work.</p>
        <p><strong>Preservation Age:</strong> You've reached preservation age, allowing access to super via TTR strategy.</p>
    </div>
</div>

<div class="scenario-content" id="scenario-60">
    <div class="scenario-grid">
        <div class="scenario-card">
            <div class="scenario-age">Age 60</div>
            <div class="result-label">Years to Retirement</div>
            <div class="scenario-value" id="scenario-60-years">15</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Projected Super</div>
            <div class="scenario-value" id="scenario-60-super">$680,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Annual Retirement Income</div>
            <div class="scenario-value" id="scenario-60-income">$54,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Retirement Shortfall</div>
            <div class="scenario-value shortfall" id="scenario-60-shortfall" style="display: none;">$6,000</div>
            <div class="result-label">Retirement Surplus</div>
            <div class="scenario-value surplus" id="scenario-60-surplus" style="display: none;">$0</div>
        </div>
    </div>
    <div class="recommendation">
        <h4>Age 60 Retirement Considerations</h4>
        <p>At age 60, you can access your super tax-free. Your projected income is closer to your needs, but you may still need to supplement with part-time work or reduce expenses.</p>
        <p><strong>Tax Benefits:</strong> Super withdrawals are tax-free from age 60 for most people.</p>
    </div>
</div>

<div class="scenario-content" id="scenario-65">
    <div class="scenario-grid">
        <div class="scenario-card">
            <div class="scenario-age">Age 65</div>
            <div class="result-label">Years to Retirement</div>
            <div class="scenario-value" id="scenario-65-years">20</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Projected Super</div>
            <div class="scenario-value" id="scenario-65-super">$950,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Annual Retirement Income</div>
            <div class="scenario-value" id="scenario-65-income">$68,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Retirement Shortfall</div>
            <div class="scenario-value shortfall" id="scenario-65-shortfall" style="display: none;">$0</div>
            <div class="result-label">Retirement Surplus</div>
            <div class="scenario-value surplus" id="scenario-65-surplus" style="display: none;">$8,000</div>
        </div>
    </div>
    <div class="recommendation success">
        <h4>Age 65 Retirement Considerations</h4>
        <p>At age 65, you reach Age Pension eligibility and your super has more time to grow. This scenario shows a comfortable retirement with potential for surplus income.</p>
        <p><strong>Age Pension:</strong> You may be eligible for a full or partial Age Pension depending on your assets.</p>
    </div>
</div>

<div class="scenario-content" id="scenario-67">
    <div class="scenario-grid">
        <div class="scenario-card">
            <div class="scenario-age">Age 67</div>
            <div class="result-label">Years to Retirement</div>
            <div class="scenario-value" id="scenario-67-years">22</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Projected Super</div>
            <div class="scenario-value" id="scenario-67-super">$1,100,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Annual Retirement Income</div>
            <div class="scenario-value" id="scenario-67-income">$75,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Retirement Shortfall</div>
            <div class="scenario-value shortfall" id="scenario-67-shortfall" style="display: none;">$0</div>
            <div class="result-label">Retirement Surplus</div>
            <div class="scenario-value surplus" id="scenario-67-surplus" style="display: none;">$15,000</div>
        </div>
    </div>
    <div class="recommendation success">
        <h4>Age 67 Retirement Considerations</h4>
        <p>Age 67 is the current Age Pension eligibility age. Working these additional years significantly boosts your retirement savings and income.</p>
        <p><strong>Age Pension Age:</strong> This is the current eligibility age for Age Pension (increasing to 67 for all by 2023).</p>
    </div>
</div>

<div class="scenario-content" id="scenario-70">
    <div class="scenario-grid">
        <div class="scenario-card">
            <div class="scenario-age">Age 70</div>
            <div class="result-label">Years to Retirement</div>
            <div class="scenario-value" id="scenario-70-years">25</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Projected Super</div>
            <div class="scenario-value" id="scenario-70-super">$1,250,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Annual Retirement Income</div>
            <div class="scenario-value" id="scenario-70-income">$82,000</div>
        </div>
        <div class="scenario-card">
            <div class="result-label">Retirement Shortfall</div>
            <div class="scenario-value shortfall" id="scenario-70-shortfall" style="display: none;">$0</div>
            <div class="result-label">Retirement Surplus</div>
            <div class="scenario-value surplus" id="scenario-70-surplus" style="display: none;">$22,000</div>
        </div>
    </div>
    <div class="recommendation success">
        <h4>Age 70 Retirement Considerations</h4>
        <p>Working until 70 maximizes your super balance and minimizes retirement years. This provides the highest retirement income but means fewer years to enjoy retirement.</p>
        <p><strong>Transfer Balance Cap:</strong> Be mindful of the $1.9 million cap on super in retirement phase.</p>
    </div>
</div>
```

Now ALL scenarios have both shortfall AND surplus elements, and the JavaScript function will show the appropriate one based on the calculations. So yes, if you have enough savings, age 55 could indeed show a surplus instead of a shortfall!

The key changes:

· Added both scenario-XX-shortfall and scenario-XX-surplus elements for ALL ages
· Set initial style="display: none;" on all of them
· The JavaScript will now show the correct one based on whether there's an actual shortfall or surplus in the calculations

Now your retirement scenarios will accurately reflect whether you have a shortfall OR surplus for every retirement age based on your actual financial situation!
