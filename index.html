<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Mapping Tool - Cert III Conservation & Ecosystem Management</title>
    <style>
        /* ========== CRITICAL CSS ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --color-safety: #ff6b6b;
            --color-foundational: #4ecdc4;
            --color-practical: #45b7d1;
            --color-machinery: #96ceb4;
            --color-apex: #ffeaa7;
            --color-project: #a29bfe;
            --color-specialist: #fd79a8;
            --color-seasonal: #55efc4;
            --color-holiday: #dfe6e9;
            --color-term-break: #b2bec3;
            --color-grid: #636e72;
            --color-easter: #fab1a0;
            --color-teacher-training: #a29bfe;
            --color-leave: #fd79a8;
            
            --week-width: 150px;
            --student-week-width: 120px;
            --total-weeks: 37;
            --sidebar-width: 280px;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }

        /* Loading overlay */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d3436 0%, #0984e3 100%);
            color: white;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Controls */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }

        .control-group label {
            font-size: 14px;
            font-weight: 600;
            color: #2d3436;
        }

        select, button, input {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover, button:hover, input:hover {
            border-color: #0984e3;
        }

        button.primary {
            background: #0984e3;
            color: white;
            border: none;
            font-weight: 600;
        }

        button.primary:hover {
            background: #0770c4;
        }

        button.warning {
            background: #ff6b6b;
            color: white;
            border: none;
            font-weight: 600;
        }

        button.warning:hover {
            background: #ff5252;
        }

        /* Legend */
        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 0 20px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            padding: 5px 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Workspace */
        .workspace {
            display: flex;
            gap: 20px;
            margin: 0 20px 20px;
            min-height: 600px;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-y: auto;
            max-height: 800px;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #2d3436;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f2f6;
        }

        /* Timeline */
        .timeline-container {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: auto;
            position: relative;
        }

        .timeline-header {
            display: flex;
            margin-bottom: 10px;
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            min-width: min-content;
        }

        .week-spacer {
            width: 120px;
            flex-shrink: 0;
        }

        .week-header {
            width: var(--week-width);
            flex-shrink: 0;
            padding: 10px;
            text-align: center;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            border-bottom: 2px solid #636e72;
            font-weight: 600;
        }

        .week-number {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .timeline-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: min-content;
        }

        .swimlane {
            display: flex;
            min-height: 120px;
        }

        .lane-label {
            width: 120px;
            flex-shrink: 0;
            padding: 10px;
            background: #f8f9fa;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 2px solid #ddd;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .lane-content {
            display: flex;
            flex: 1;
        }

        .week-slot {
            width: var(--week-width);
            flex-shrink: 0;
            min-height: 120px;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            padding: 5px;
            position: relative;
        }

        .unit-block {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: move;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            min-height: 60px;
        }

        .unit-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .unit-code {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .unit-name {
            font-size: 11px;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .unit-duration {
            font-size: 10px;
            color: rgba(0,0,0,0.6);
            position: absolute;
            bottom: 5px;
            right: 8px;
            background: rgba(255,255,255,0.8);
            padding: 1px 5px;
            border-radius: 3px;
        }

        /* Unit items in sidebar */
        .unit-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: grab;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
            position: relative;
        }

        .unit-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: #00b894;
        }

        .toast-error {
            background: #ff6b6b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Footer */
        .footer {
            background: #2d3436;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        /* Drag and drop states */
        .drag-ghost {
            opacity: 0.8;
            transform: rotate(5deg) scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
            z-index: 9999 !important;
        }

        .drop-zone-active {
            background: rgba(9, 132, 227, 0.1) !important;
            border: 2px dashed #0984e3 !important;
        }

        /* Student view */
        body.student-view .controls,
        body.student-view .legend,
        body.student-view .sidebar {
            display: none !important;
        }

        body.student-view .workspace {
            margin: 20px;
        }

        body.student-view .timeline-container {
            margin: 0;
        }

        /* Empty slot */
        .empty-slot {
            width: 100%;
            height: 100%;
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #b2bec3;
            font-size: 12px;
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .workspace {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 400px;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                min-width: 100%;
            }
            
            :root {
                --week-width: 120px;
            }
            
            .header-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Course Planner...</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <h1 id="courseTitle">Certificate III in Conservation & Ecosystem Management</h1>
        <div class="subtitle" id="courseSubtitle">Course Sequencing Tool | <span id="viewModeIndicator">Interactive Planner</span></div>
        <div style="font-size: 14px; opacity: 0.8;" id="courseDescription">
            Drag units to adjust sequence | Click units to edit details | Save/load your custom plans
        </div>
        <div class="header-actions">
            <button class="primary" id="savePlanBtn">üíæ Save Plan</button>
            <button class="primary" id="sharePlanBtn">üîó Share Student View</button>
            <button class="primary" id="resetPlanBtn">üîÑ Reset to Default</button>
            <button class="warning" id="clearTimetableBtn">üóëÔ∏è Clear Timetable</button>
            <button id="toggleViewBtn">üëÅÔ∏è Toggle Student View</button>
        </div>
    </header>

    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <label for="viewMode">View Mode</label>
            <select id="viewMode">
                <option value="week">Week View</option>
                <option value="term">Term View</option>
                <option value="teacher">Teacher View</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="highlightMode">Highlight</label>
            <select id="highlightMode">
                <option value="none">None</option>
                <option value="safety">Safety Units</option>
                <option value="seasonal">Seasonal Timing</option>
                <option value="assessment">Assessment Points</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Manage Weeks</label>
            <div style="display: flex; gap: 5px;">
                <button class="primary" id="addWeekBtn" style="flex: 1;">+ Add Week</button>
                <button class="warning" id="removeWeekBtn" style="flex: 1;">- Remove Week</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>Quick Actions</label>
            <div style="display: flex; gap: 5px;">
                <button class="primary" id="addUnitBtn" style="flex: 1;">+ Add Unit</button>
                <button id="exportPlanBtn" style="flex: 1;">üì§ Export</button>
                <button id="printBtn" style="flex: 1;">üñ®Ô∏è Print</button>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-safety);"></div>
            <span>Safety Units</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-foundational);"></div>
            <span>Foundational Skills</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-practical);"></div>
            <span>Practical Application</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-machinery);"></div>
            <span>Machinery Units</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-apex);"></div>
            <span>Apex Units</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-project);"></div>
            <span>Integrated Project</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-specialist);"></div>
            <span>Other Teacher</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--color-seasonal);"></div>
            <span>Seasonal Timing</span>
        </div>
    </div>

    <!-- Workspace -->
    <div class="workspace">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3>üìö Unit Library</h3>
            <div id="unitLibrary">
                <!-- Units will be loaded here -->
            </div>
            
            <h3 style="margin-top: 30px;">üíæ Saved Plans</h3>
            <div id="savedPlans">
                <!-- Saved plans will appear here -->
            </div>
        </aside>

        <!-- Timeline -->
        <main class="timeline-container">
            <div id="timelineContent">
                <!-- Timeline will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Course Mapping Tool v3.0 | Designed for Cert III Conservation & Ecosystem Management | <span id="totalWeeksDisplay">37</span> Teaching Weeks</p>
        <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
            Drag units to adjust sequence. Seasonal units have constraints. Click units to add notes and resources.
        </p>
        <div style="margin-top: 10px; font-size: 11px; color: #999;">
            <span>Press Ctrl+Z to undo, Ctrl+Y to redo</span>
        </div>
    </footer>

    <!-- Modals -->
    <div class="modal" id="unitModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalTitle">Edit Unit Details</h3>
                <button onclick="document.getElementById('unitModal').style.display = 'none'" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be populated -->
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Share Student View</h3>
                <button onclick="document.getElementById('shareModal').style.display = 'none'" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 15px; color: #666;">Share this link with students for read-only access:</p>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="shareLinkInput" readonly style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    <button class="primary" id="copyShareLinkBtn">Copy</button>
                </div>
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">Scan QR Code:</div>
                    <div id="qrCodeContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toasts Container -->
    <div id="toastsContainer"></div>

    <!-- Main JavaScript -->
    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            APP_VERSION: '3.0.0',
            STORAGE_PREFIX: 'cet_',
            DEFAULT_TOTAL_WEEKS: 37
        };

        // ========== STATE MANAGEMENT ==========
        class CoursePlanner {
            constructor() {
                this.units = [];
                this.courseData = {
                    totalWeeks: CONFIG.DEFAULT_TOTAL_WEEKS,
                    terms: [
                        { number: 1, weeks: 10, startWeek: 1, name: "Safety, Foundations & Summer Harvest" },
                        { number: 2, weeks: 10, startWeek: 11, name: "Practical Skills & Application" },
                        { number: 3, weeks: 10, startWeek: 21, name: "Machinery & Advanced Integration" },
                        { number: 4, weeks: 7, startWeek: 31, name: "Apex & Finalisation" }
                    ],
                    projectMilestones: [
                        { week: 18, label: "Project Start" },
                        { week: 25, label: "Phase 2" },
                        { week: 30, label: "Integration" },
                        { week: 34, label: "Final Phase" }
                    ]
                };
                this.blockedWeeks = {};
                this.currentView = 'week';
                this.history = [];
                this.historyIndex = -1;
                this.isStudentView = false;
                this.currentPlanId = null;
                
                this.colorMap = {
                    safety: '#ff6b6b',
                    foundational: '#4ecdc4',
                    practical: '#45b7d1',
                    machinery: '#96ceb4',
                    apex: '#ffeaa7',
                    project: '#a29bfe',
                    specialist: '#fd79a8',
                    seasonal: '#55efc4',
                    holiday: '#dfe6e9',
                    'term-break': '#b2bec3',
                    easter: '#fab1a0',
                    'teacher-training': '#a29bfe',
                    leave: '#fd79a8'
                };

                this.defaultUnits = [
                    {
                        id: '1',
                        code: 'AHCWHS302',
                        name: 'Work Health & Safety',
                        weeks: [1, 2],
                        color: 'safety',
                        tags: ['SAFETY'],
                        teacher: 'main',
                        notes: 'Non-negotiable foundation'
                    },
                    {
                        id: '2',
                        code: 'HLTAID011',
                        name: 'First Aid',
                        weeks: [1, 2],
                        color: 'safety',
                        tags: ['SAFETY', 'SPECIALIST'],
                        teacher: 'other',
                        notes: 'Clustered with WHS for efficiency'
                    },
                    {
                        id: '3',
                        code: 'AHCECR305',
                        name: 'Collect native seed',
                        weeks: [3, 4],
                        color: 'seasonal',
                        tags: ['SEASONAL'],
                        teacher: 'main',
                        notes: 'Must be early due to seed season'
                    },
                    {
                        id: '4',
                        code: 'AHCBIO303',
                        name: 'Biosecurity',
                        weeks: [3, 4],
                        color: 'foundational',
                        tags: [],
                        teacher: 'main',
                        notes: 'Essential for seed/plant handling'
                    },
                    {
                        id: '5',
                        code: 'AHCPCM303',
                        name: 'Identify plant specimens',
                        weeks: [5, 6, 7],
                        color: 'foundational',
                        tags: [],
                        teacher: 'main',
                        notes: 'Foundational skill - use seed collection trips'
                    },
                    {
                        id: '6',
                        code: 'AHCNSY207',
                        name: 'Undertake propagation activities',
                        weeks: [8],
                        color: 'foundational',
                        tags: [],
                        teacher: 'main',
                        notes: 'Follow-up to seed collection'
                    },
                    {
                        id: '7',
                        code: 'AHCFAU302',
                        name: 'Identify fauna in the field',
                        weeks: [9, 10],
                        color: 'foundational',
                        tags: ['SEASONAL'],
                        teacher: 'main',
                        notes: 'Late summer/early autumn activity'
                    },
                    {
                        id: '8',
                        code: 'AHCPMG301',
                        name: 'Control weeds',
                        weeks: [11, 12],
                        color: 'practical',
                        tags: [],
                        teacher: 'main',
                        notes: 'Builds on plant ID'
                    },
                    {
                        id: '9',
                        code: 'AHCCHM304',
                        name: 'Transport/handle chemicals',
                        weeks: [13],
                        color: 'practical',
                        tags: ['SPECIALIST'],
                        teacher: 'other',
                        notes: 'Clustered with weed control'
                    },
                    {
                        id: '10',
                        code: 'AHCCHM307',
                        name: 'Apply chemicals',
                        weeks: [13],
                        color: 'practical',
                        tags: ['SPECIALIST'],
                        teacher: 'other',
                        notes: 'Clustered chemical application'
                    }
                ];

                this.unitTemplates = [
                    { code: 'AHCWHS302', name: 'Work Health & Safety', color: 'safety', tags: ['SAFETY'], defaultWeeks: 2 },
                    { code: 'HLTAID011', name: 'First Aid', color: 'safety', tags: ['SAFETY', 'SPECIALIST'], defaultWeeks: 2 },
                    { code: 'AHCECR305', name: 'Collect native seed', color: 'seasonal', tags: ['SEASONAL'], defaultWeeks: 2 },
                    { code: 'AHCBIO303', name: 'Biosecurity', color: 'foundational', tags: [], defaultWeeks: 2 },
                    { code: 'AHCPCM303', name: 'Identify plant specimens', color: 'foundational', tags: [], defaultWeeks: 3 },
                    { code: 'AHCNSY207', name: 'Undertake propagation activities', color: 'foundational', tags: [], defaultWeeks: 1 },
                    { code: 'AHCFAU302', name: 'Identify fauna in the field', color: 'foundational', tags: ['SEASONAL'], defaultWeeks: 2 },
                    { code: 'AHCPMG301', name: 'Control weeds', color: 'practical', tags: [], defaultWeeks: 2 },
                    { code: 'AHCCHM304', name: 'Transport/handle chemicals', color: 'practical', tags: ['SPECIALIST'], defaultWeeks: 1 },
                    { code: 'AHCCHM307', name: 'Apply chemicals', color: 'practical', tags: ['SPECIALIST'], defaultWeeks: 1 }
                ];

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadInitialData();
                this.renderEverything();
                this.hideLoadingScreen();
            }

            loadInitialData() {
                // Check URL for student view
                const urlParams = new URLSearchParams(window.location.search);
                this.isStudentView = urlParams.has('student');
                const planId = urlParams.get('plan');

                if (this.isStudentView) {
                    this.setupStudentView(planId);
                } else {
                    // Try to load saved data
                    const saved = localStorage.getItem(`${CONFIG.STORAGE_PREFIX}autosave`);
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            if (data.version === CONFIG.APP_VERSION) {
                                this.units = data.units || this.defaultUnits;
                                this.courseData = data.courseData || this.courseData;
                                this.blockedWeeks = data.blockedWeeks || {};
                            }
                        } catch (e) {
                            console.error('Failed to load saved data:', e);
                            this.units = [...this.defaultUnits];
                        }
                    } else {
                        this.units = [...this.defaultUnits];
                    }
                }

                this.saveHistory();
            }

            setupStudentView(planId) {
                document.body.classList.add('student-view');
                document.getElementById('courseTitle').textContent = 'Student View - Course Schedule';
                document.getElementById('viewModeIndicator').textContent = 'Student View';
                
                if (planId) {
                    this.loadSharedPlan(planId);
                } else {
                    this.units = [...this.defaultUnits];
                }
            }

            loadSharedPlan(planId) {
                try {
                    const planData = localStorage.getItem(`${CONFIG.STORAGE_PREFIX}shared_${planId}`);
                    if (planData) {
                        const plan = JSON.parse(planData);
                        this.units = plan.units || this.defaultUnits;
                        this.courseData = plan.courseData || this.courseData;
                        this.blockedWeeks = plan.blockedWeeks || {};
                    }
                } catch (e) {
                    console.error('Failed to load shared plan:', e);
                    this.units = [...this.defaultUnits];
                }
            }

            renderEverything() {
                this.renderUnitLibrary();
                this.renderTimeline();
                this.updateTotalWeeksDisplay();
                this.renderSavedPlans();
            }

            renderUnitLibrary() {
                const container = document.getElementById('unitLibrary');
                if (!container) return;

                container.innerHTML = this.unitTemplates.map(template => `
                    <div class="unit-item" draggable="true" data-template='${JSON.stringify(template)}'
                         style="border-left: 4px solid ${this.colorMap[template.color]};">
                        <div class="unit-code">${template.code}</div>
                        <div class="unit-name">${template.name}</div>
                        <div style="display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap;">
                            ${template.tags.map(tag => `
                                <span style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: #e9ecef; color: #495057;">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                // Add drag event listeners
                container.querySelectorAll('.unit-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        const template = JSON.parse(e.currentTarget.dataset.template);
                        e.dataTransfer.setData('text/plain', JSON.stringify(template));
                        e.currentTarget.style.opacity = '0.5';
                    });

                    item.addEventListener('dragend', (e) => {
                        e.currentTarget.style.opacity = '1';
                    });
                });
            }

            renderTimeline() {
                const container = document.getElementById('timelineContent');
                if (!container) return;

                const { totalWeeks, terms } = this.courseData;
                const weekWidth = this.isStudentView ? 120 : 150;
                
                // Update CSS variable
                document.documentElement.style.setProperty('--week-width', `${weekWidth}px`);
                document.documentElement.style.setProperty('--total-weeks', totalWeeks);

                // Build timeline HTML
                let html = `
                    <div class="timeline-header">
                        <div class="week-spacer"></div>
                `;

                // Week headers
                for (let week = 1; week <= totalWeeks; week++) {
                    const term = terms.find(t => week >= t.startWeek && week < t.startWeek + t.weeks);
                    html += `
                        <div class="week-header" style="width: ${weekWidth}px;">
                            <div class="week-number">Week ${week}</div>
                            ${term ? `<div style="font-size: 11px; color: #666;">Term ${term.number}</div>` : ''}
                        </div>
                    `;
                }

                html += `</div><div class="timeline-grid">`;

                // Swimlanes
                const swimlanes = [
                    { id: 'core', label: 'Core Units (Main Teacher)' },
                    { id: 'specialist', label: 'Specialist Units (Other Teacher)' },
                    { id: 'project', label: 'Integrated Project' }
                ];

                swimlanes.forEach(lane => {
                    html += `
                        <div class="swimlane" data-lane="${lane.id}">
                            <div class="lane-label">${lane.label}</div>
                            <div class="lane-content">
                    `;

                    for (let week = 1; week <= totalWeeks; week++) {
                        const unitsInWeek = this.units.filter(unit => 
                            unit.weeks.includes(week) && 
                            this.getLaneForUnit(unit) === lane.id
                        );

                        html += `
                            <div class="week-slot" data-week="${week}" data-lane="${lane.id}" 
                                 style="width: ${weekWidth}px;">
                        `;

                        if (unitsInWeek.length > 0) {
                            unitsInWeek.forEach(unit => {
                                const isFirstWeek = week === Math.min(...unit.weeks);
                                html += this.renderUnitBlock(unit, week, isFirstWeek);
                            });
                        } else {
                            html += `<div class="empty-slot">Drag unit here</div>`;
                        }

                        html += `</div>`;
                    }

                    html += `</div></div>`;
                });

                html += `</div>`;
                container.innerHTML = html;

                // Add event listeners to timeline
                this.setupTimelineEvents();
            }

            renderUnitBlock(unit, week, isFirstWeek = false) {
                const color = this.colorMap[unit.color] || this.colorMap.foundational;
                const darkColor = this.darkenColor(color, 30);
                
                return `
                    <div class="unit-block" data-unit-id="${unit.id}" data-week="${week}"
                         style="background: ${color}; border-left-color: ${darkColor};"
                         draggable="true">
                        <div class="unit-code">${unit.code}</div>
                        ${isFirstWeek ? `<div class="unit-name">${unit.name}</div>` : ''}
                        ${unit.weeks.length > 1 && isFirstWeek ? 
                            `<div class="unit-duration">${unit.weeks.length}w</div>` : ''}
                    </div>
                `;
            }

            getLaneForUnit(unit) {
                if (unit.teacher === 'other') return 'specialist';
                if (unit.code === 'INTEGRATION' || unit.code === 'PROJECT' || unit.tags.includes('PROJECT')) return 'project';
                return 'core';
            }

            setupTimelineEvents() {
                const container = document.getElementById('timelineContent');
                if (!container) return;

                // Unit drag start
                container.querySelectorAll('.unit-block').forEach(block => {
                    block.addEventListener('dragstart', (e) => {
                        const unitId = e.currentTarget.dataset.unitId;
                        const unit = this.units.find(u => u.id === unitId);
                        if (unit) {
                            e.dataTransfer.setData('text/plain', JSON.stringify({
                                type: 'move',
                                unitId: unitId
                            }));
                            e.currentTarget.style.opacity = '0.5';
                        }
                    });

                    block.addEventListener('dragend', (e) => {
                        e.currentTarget.style.opacity = '1';
                    });

                    block.addEventListener('click', (e) => {
                        const unitId = e.currentTarget.dataset.unitId;
                        this.openUnitModal(unitId);
                    });
                });

                // Week slot drop zones
                container.querySelectorAll('.week-slot').forEach(slot => {
                    slot.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        slot.classList.add('drop-zone-active');
                    });

                    slot.addEventListener('dragleave', () => {
                        slot.classList.remove('drop-zone-active');
                    });

                    slot.addEventListener('drop', (e) => {
                        e.preventDefault();
                        slot.classList.remove('drop-zone-active');
                        
                        const week = parseInt(slot.dataset.week);
                        const lane = slot.dataset.lane;
                        
                        try {
                            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                            
                            if (data.type === 'move') {
                                // Moving existing unit
                                this.moveUnit(data.unitId, week, lane);
                            } else {
                                // Adding new unit from template
                                this.addUnitFromTemplate(data, week, lane);
                            }
                            
                            this.showToast('Unit placed successfully', 'success');
                        } catch (error) {
                            console.error('Drop failed:', error);
                        }
                    });
                });
            }

            moveUnit(unitId, week, lane) {
                const unitIndex = this.units.findIndex(u => u.id === unitId);
                if (unitIndex === -1) return;

                this.saveHistory();
                
                const unit = this.units[unitIndex];
                unit.weeks = [week];
                
                if (lane === 'specialist') {
                    unit.teacher = 'other';
                    if (!unit.tags.includes('SPECIALIST')) {
                        unit.tags.push('SPECIALIST');
                    }
                } else if (lane !== 'specialist' && unit.teacher === 'other') {
                    unit.teacher = 'main';
                    unit.tags = unit.tags.filter(tag => tag !== 'SPECIALIST');
                }

                this.renderEverything();
            }

            addUnitFromTemplate(template, week, lane) {
                this.saveHistory();
                
                const newUnit = {
                    id: Date.now().toString(),
                    code: template.code,
                    name: template.name,
                    weeks: [week],
                    color: template.color,
                    tags: [...template.tags],
                    teacher: lane === 'specialist' ? 'other' : 'main',
                    notes: '',
                    resources: []
                };

                this.units.push(newUnit);
                this.renderEverything();
                
                // Open modal to edit the new unit
                setTimeout(() => this.openUnitModal(newUnit.id), 100);
            }

            openUnitModal(unitId) {
                const unit = this.units.find(u => u.id === unitId);
                if (!unit) return;

                const modal = document.getElementById('unitModal');
                const modalBody = document.getElementById('modalBody');
                const modalTitle = document.getElementById('modalTitle');

                modalTitle.textContent = `Edit Unit: ${unit.code}`;
                
                modalBody.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Unit Code</label>
                            <input type="text" id="editUnitCode" value="${unit.code}" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Unit Name</label>
                            <input type="text" id="editUnitName" value="${unit.name}" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Weeks</label>
                            <input type="text" id="editUnitWeeks" value="${unit.weeks.join(',')}" 
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"
                                   placeholder="e.g., 1,2,3 or 5-7">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Unit Type</label>
                            <select id="editUnitColor" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="safety" ${unit.color === 'safety' ? 'selected' : ''}>Safety</option>
                                <option value="foundational" ${unit.color === 'foundational' ? 'selected' : ''}>Foundational</option>
                                <option value="practical" ${unit.color === 'practical' ? 'selected' : ''}>Practical</option>
                                <option value="machinery" ${unit.color === 'machinery' ? 'selected' : ''}>Machinery</option>
                                <option value="apex" ${unit.color === 'apex' ? 'selected' : ''}>Apex</option>
                                <option value="project" ${unit.color === 'project' ? 'selected' : ''}>Project</option>
                                <option value="seasonal" ${unit.color === 'seasonal' ? 'selected' : ''}>Seasonal</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Teacher</label>
                            <select id="editUnitTeacher" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="main" ${unit.teacher === 'main' ? 'selected' : ''}>Main Teacher</option>
                                <option value="other" ${unit.teacher === 'other' ? 'selected' : ''}>Other Teacher</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes</label>
                            <textarea id="editUnitNotes" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">${unit.notes || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="primary" onclick="app.saveUnitChanges('${unitId}')" style="flex: 1;">Save Changes</button>
                            <button class="warning" onclick="app.deleteUnit('${unitId}')" style="flex: 1;">Delete Unit</button>
                            <button onclick="document.getElementById('unitModal').style.display = 'none'" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                `;

                modal.style.display = 'flex';
            }

            saveUnitChanges(unitId) {
                const unitIndex = this.units.findIndex(u => u.id === unitId);
                if (unitIndex === -1) return;

                this.saveHistory();
                
                const unit = this.units[unitIndex];
                unit.code = document.getElementById('editUnitCode').value;
                unit.name = document.getElementById('editUnitName').value;
                
                const weeksInput = document.getElementById('editUnitWeeks').value;
                if (weeksInput.includes('-')) {
                    const [start, end] = weeksInput.split('-').map(Number);
                    unit.weeks = Array.from({length: end - start + 1}, (_, i) => start + i);
                } else if (weeksInput.includes(',')) {
                    unit.weeks = weeksInput.split(',').map(w => parseInt(w.trim())).filter(w => !isNaN(w));
                } else {
                    unit.weeks = [parseInt(weeksInput) || 1];
                }
                
                unit.color = document.getElementById('editUnitColor').value;
                unit.teacher = document.getElementById('editUnitTeacher').value;
                unit.notes = document.getElementById('editUnitNotes').value;

                document.getElementById('unitModal').style.display = 'none';
                this.renderEverything();
                this.showToast('Unit updated successfully', 'success');
            }

            deleteUnit(unitId) {
                if (confirm('Are you sure you want to delete this unit?')) {
                    this.saveHistory();
                    this.units = this.units.filter(u => u.id !== unitId);
                    document.getElementById('unitModal').style.display = 'none';
                    this.renderEverything();
                    this.showToast('Unit deleted', 'success');
                }
            }

            addNewUnit() {
                this.saveHistory();
                
                const newUnit = {
                    id: Date.now().toString(),
                    code: 'NEW001',
                    name: 'New Custom Unit',
                    weeks: [1],
                    color: 'foundational',
                    tags: ['CUSTOM'],
                    teacher: 'main',
                    notes: 'Custom added unit'
                };

                this.units.push(newUnit);
                this.renderEverything();
                
                setTimeout(() => this.openUnitModal(newUnit.id), 100);
            }

            clearTimetable() {
                if (confirm('Are you sure you want to clear ALL units from the timetable?')) {
                    this.saveHistory();
                    this.units = [];
                    this.renderEverything();
                    this.showToast('Timetable cleared', 'success');
                }
            }

            addWeek() {
                this.saveHistory();
                this.courseData.totalWeeks++;
                
                // Update the last term
                const lastTerm = this.courseData.terms[this.courseData.terms.length - 1];
                if (lastTerm) {
                    lastTerm.weeks++;
                }
                
                this.renderEverything();
                this.showToast('Week added', 'success');
            }

            removeWeek() {
                if (this.courseData.totalWeeks <= 1) {
                    this.showToast('Cannot remove the last week', 'error');
                    return;
                }

                if (confirm('Remove the last week? This will remove any units in that week.')) {
                    this.saveHistory();
                    
                    // Remove units in the last week
                    const lastWeek = this.courseData.totalWeeks;
                    this.units = this.units.filter(unit => 
                        !unit.weeks.includes(lastWeek)
                    );
                    
                    // Update weeks for units after the removed week
                    this.units.forEach(unit => {
                        unit.weeks = unit.weeks
                            .filter(w => w !== lastWeek)
                            .map(w => w > lastWeek ? w - 1 : w);
                    });
                    
                    this.courseData.totalWeeks--;
                    
                    // Update the last term
                    const lastTerm = this.courseData.terms[this.courseData.terms.length - 1];
                    if (lastTerm && lastTerm.weeks > 1) {
                        lastTerm.weeks--;
                    }
                    
                    this.renderEverything();
                    this.showToast('Week removed', 'success');
                }
            }

            savePlan() {
                const planName = prompt('Enter a name for this plan:', `Plan ${new Date().toLocaleDateString()}`);
                if (!planName) return;

                const plan = {
                    id: Date.now().toString(),
                    name: planName,
                    date: new Date().toISOString(),
                    units: this.units,
                    courseData: this.courseData,
                    blockedWeeks: this.blockedWeeks,
                    version: CONFIG.APP_VERSION
                };

                try {
                    let savedPlans = JSON.parse(localStorage.getItem(`${CONFIG.STORAGE_PREFIX}plans`) || '[]');
                    savedPlans.push(plan);
                    localStorage.setItem(`${CONFIG.STORAGE_PREFIX}plans`, JSON.stringify(savedPlans));
                    
                    // Also save as autosave
                    localStorage.setItem(`${CONFIG.STORAGE_PREFIX}autosave`, JSON.stringify({
                        units: this.units,
                        courseData: this.courseData,
                        blockedWeeks: this.blockedWeeks,
                        timestamp: Date.now(),
                        version: CONFIG.APP_VERSION
                    }));
                    
                    this.showToast(`Plan "${planName}" saved!`, 'success');
                    this.renderSavedPlans();
                } catch (error) {
                    console.error('Failed to save plan:', error);
                    this.showToast('Failed to save plan', 'error');
                }
            }

            renderSavedPlans() {
                const container = document.getElementById('savedPlans');
                if (!container) return;

                try {
                    const savedPlans = JSON.parse(localStorage.getItem(`${CONFIG.STORAGE_PREFIX}plans`) || '[]');
                    
                    if (savedPlans.length === 0) {
                        container.innerHTML = '<p style="color: #666; font-size: 14px;">No saved plans yet.</p>';
                        return;
                    }

                    container.innerHTML = savedPlans.map(plan => `
                        <div style="padding: 10px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #0984e3;">
                            <div style="font-weight: 600; margin-bottom: 5px;">${plan.name}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                                ${new Date(plan.date).toLocaleDateString()} ‚Ä¢ ${plan.units?.length || 0} units
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="app.loadPlan('${plan.id}')" 
                                        style="flex: 1; padding: 5px; font-size: 12px; background: #0984e3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Load
                                </button>
                                <button onclick="app.deleteSavedPlan('${plan.id}')" 
                                        style="flex: 1; padding: 5px; font-size: 12px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Failed to render saved plans:', error);
                    container.innerHTML = '<p style="color: #666; font-size: 14px;">Error loading saved plans.</p>';
                }
            }

            loadPlan(planId) {
                try {
                    const savedPlans = JSON.parse(localStorage.getItem(`${CONFIG.STORAGE_PREFIX}plans`) || '[]');
                    const plan = savedPlans.find(p => p.id === planId);
                    
                    if (plan) {
                        this.saveHistory();
                        this.units = plan.units || [];
                        this.courseData = plan.courseData || this.courseData;
                        this.blockedWeeks = plan.blockedWeeks || {};
                        this.renderEverything();
                        this.showToast(`Loaded "${plan.name}"`, 'success');
                    }
                } catch (error) {
                    console.error('Failed to load plan:', error);
                    this.showToast('Failed to load plan', 'error');
                }
            }

            deleteSavedPlan(planId) {
                if (confirm('Delete this saved plan?')) {
                    try {
                        let savedPlans = JSON.parse(localStorage.getItem(`${CONFIG.STORAGE_PREFIX}plans`) || '[]');
                        savedPlans = savedPlans.filter(p => p.id !== planId);
                        localStorage.setItem(`${CONFIG.STORAGE_PREFIX}plans`, JSON.stringify(savedPlans));
                        this.renderSavedPlans();
                        this.showToast('Plan deleted', 'success');
                    } catch (error) {
                        console.error('Failed to delete plan:', error);
                        this.showToast('Failed to delete plan', 'error');
                    }
                }
            }

            sharePlan() {
                const shareId = `shared_${Date.now()}`;
                const shareData = {
                    id: shareId,
                    name: 'Shared Student View',
                    date: new Date().toISOString(),
                    units: this.units,
                    courseData: this.courseData,
                    blockedWeeks: this.blockedWeeks,
                    lastUpdate: new Date().toISOString(),
                    version: CONFIG.APP_VERSION
                };

                localStorage.setItem(`${CONFIG.STORAGE_PREFIX}${shareId}`, JSON.stringify(shareData));

                const shareUrl = `${window.location.origin}${window.location.pathname}?student=true&plan=${shareId}`;
                
                // Show share modal
                const modal = document.getElementById('shareModal');
                const input = document.getElementById('shareLinkInput');
                const copyBtn = document.getElementById('copyShareLinkBtn');
                const qrContainer = document.getElementById('qrCodeContainer');
                
                input.value = shareUrl;
                modal.style.display = 'flex';
                
                // Generate QR code
                qrContainer.innerHTML = `
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareUrl)}" 
                         alt="QR Code" style="border: 1px solid #ddd; border-radius: 6px;">
                `;
                
                copyBtn.onclick = () => {
                    input.select();
                    document.execCommand('copy');
                    this.showToast('Link copied to clipboard!', 'success');
                };
            }

            resetToDefault() {
                if (confirm('Reset to default course sequence? Any unsaved changes will be lost.')) {
                    this.saveHistory();
                    this.units = [...this.defaultUnits];
                    this.courseData = {
                        totalWeeks: CONFIG.DEFAULT_TOTAL_WEEKS,
                        terms: [
                            { number: 1, weeks: 10, startWeek: 1, name: "Safety, Foundations & Summer Harvest" },
                            { number: 2, weeks: 10, startWeek: 11, name: "Practical Skills & Application" },
                            { number: 3, weeks: 10, startWeek: 21, name: "Machinery & Advanced Integration" },
                            { number: 4, weeks: 7, startWeek: 31, name: "Apex & Finalisation" }
                        ],
                        projectMilestones: [
                            { week: 18, label: "Project Start" },
                            { week: 25, label: "Phase 2" },
                            { week: 30, label: "Integration" },
                            { week: 34, label: "Final Phase" }
                        ]
                    };
                    this.blockedWeeks = {};
                    
                    this.renderEverything();
                    this.showToast('Reset to default sequence', 'success');
                }
            }

            toggleViewMode() {
                if (this.isStudentView) {
                    // Switch to editor view
                    window.location.href = window.location.pathname;
                } else {
                    // Switch to student view
                    this.sharePlan();
                }
            }

            exportPlan() {
                const data = {
                    version: CONFIG.APP_VERSION,
                    timestamp: new Date().toISOString(),
                    units: this.units,
                    courseData: this.courseData,
                    blockedWeeks: this.blockedWeeks
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `course-plan-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('Plan exported successfully', 'success');
            }

            printPlan() {
                window.print();
            }

            updateTotalWeeksDisplay() {
                const display = document.getElementById('totalWeeksDisplay');
                if (display) {
                    display.textContent = this.courseData.totalWeeks;
                }
            }

            saveHistory() {
                this.history = this.history.slice(0, this.historyIndex + 1);
                this.history.push({
                    units: JSON.parse(JSON.stringify(this.units)),
                    courseData: JSON.parse(JSON.stringify(this.courseData)),
                    blockedWeeks: JSON.parse(JSON.stringify(this.blockedWeeks)),
                    timestamp: Date.now()
                });
                
                if (this.history.length > 50) {
                    this.history.shift();
                }
                
                this.historyIndex = this.history.length - 1;
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    const state = this.history[this.historyIndex];
                    this.units = JSON.parse(JSON.stringify(state.units));
                    this.courseData = JSON.parse(JSON.stringify(state.courseData));
                    this.blockedWeeks = JSON.parse(JSON.stringify(state.blockedWeeks));
                    this.renderEverything();
                    this.showToast('Undo', 'success');
                    return true;
                }
                return false;
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    const state = this.history[this.historyIndex];
                    this.units = JSON.parse(JSON.stringify(state.units));
                    this.courseData = JSON.parse(JSON.stringify(state.courseData));
                    this.blockedWeeks = JSON.parse(JSON.stringify(state.blockedWeeks));
                    this.renderEverything();
                    this.showToast('Redo', 'success');
                    return true;
                }
                return false;
            }

            showToast(message, type = 'info') {
                const container = document.getElementById('toastsContainer');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            hideLoadingScreen() {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.style.opacity = '0';
                    setTimeout(() => {
                        loading.style.display = 'none';
                    }, 300);
                }
            }

            darkenColor(color, percent) {
                // Simple color darkening
                const num = parseInt(color.replace('#', ''), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return '#' + (
                    0x1000000 +
                    (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)
                ).toString(16).slice(1);
            }

            setupEventListeners() {
                // Header buttons
                document.getElementById('savePlanBtn').addEventListener('click', () => this.savePlan());
                document.getElementById('sharePlanBtn').addEventListener('click', () => this.sharePlan());
                document.getElementById('resetPlanBtn').addEventListener('click', () => this.resetToDefault());
                document.getElementById('clearTimetableBtn').addEventListener('click', () => this.clearTimetable());
                document.getElementById('toggleViewBtn').addEventListener('click', () => this.toggleViewMode());

                // Control buttons
                document.getElementById('addUnitBtn').addEventListener('click', () => this.addNewUnit());
                document.getElementById('addWeekBtn').addEventListener('click', () => this.addWeek());
                document.getElementById('removeWeekBtn').addEventListener('click', () => this.removeWeek());
                document.getElementById('exportPlanBtn').addEventListener('click', () => this.exportPlan());
                document.getElementById('printBtn').addEventListener('click', () => this.printPlan());

                // Modal close buttons
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'z':
                                e.preventDefault();
                                if (e.shiftKey) {
                                    this.redo();
                                } else {
                                    this.undo();
                                }
                                break;
                            case 'y':
                                e.preventDefault();
                                this.redo();
                                break;
                            case 's':
                                e.preventDefault();
                                this.savePlan();
                                break;
                        }
                    }
                    
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal').forEach(modal => {
                            modal.style.display = 'none';
                        });
                    }
                });

                // View mode changes
                document.getElementById('viewMode').addEventListener('change', (e) => {
                    this.currentView = e.target.value;
                    // In a real implementation, this would trigger a different rendering
                    this.showToast(`Switched to ${e.target.value} view`, 'success');
                });

                document.getElementById('highlightMode').addEventListener('change', (e) => {
                    // Highlight units based on selection
                    this.showToast(`Highlighting ${e.target.value} units`, 'success');
                });
            }
        }

        // ========== INITIALIZE APP ==========
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new CoursePlanner();
            window.app = app; // Make available globally
        });
    </script>
</body>
</html>
