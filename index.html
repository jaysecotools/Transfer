// Fixed: Enhanced expense calculation for retirement scenarios
function calculateRetirementExpensesWithDependents(scenarioAge, currentAge, currentExpenses, retirementExpenseRate, 
                                                 dependents, educationCosts, annualChildCost, inflationRate) {
    const yearsToRetirement = scenarioAge - currentAge;
    const currentYear = new Date().getFullYear();
    const retirementYear = currentYear + yearsToRetirement;
    
    const baseHouseholdExpenses = currentExpenses - (dependents.length * annualChildCost) - educationCosts;
    
    // FIXED: Properly calculate which dependents will still be at home at retirement
    const dependentsAtRetirement = dependents.filter(dep => {
        const ageAtRetirement = dep.age + yearsToRetirement;
        // A dependent is considered "at home" if they haven't reached their supportUntil age
        // AND they're still in education or below typical leaving age (usually 18-22)
        return ageAtRetirement < dep.supportUntil;
    });
    
    // FIXED: Calculate remaining education costs more accurately
    let remainingEducationCosts = 0;
    dependents.forEach(dep => {
        const ageAtRetirement = dep.age + yearsToRetirement;
        
        // Only count education costs if the dependent is still in education at retirement
        if (ageAtRetirement < dep.supportUntil) {
            if (dep.educationType === 'secondary' && ageAtRetirement < 18) {
                // Full secondary education costs
                remainingEducationCosts += educationCosts / dependents.length;
            } else if ((dep.educationType === 'university' || dep.educationType === 'tafe') && ageAtRetirement < dep.supportUntil) {
                // Tertiary education costs (typically lower than full household costs)
                remainingEducationCosts += (educationCosts / dependents.length) * 0.7;
            }
        }
    });
    
    let retirementExpenses = baseHouseholdExpenses * (retirementExpenseRate / 100);
    retirementExpenses += (dependentsAtRetirement.length * annualChildCost);
    retirementExpenses += remainingEducationCosts;
    
    retirementExpenses = calculateInflationAdjustedValue(retirementExpenses, yearsToRetirement, inflationRate);
    
    return {
        retirementExpenses: retirementExpenses,
        dependentsAtRetirement: dependentsAtRetirement,
        remainingEducationCosts: remainingEducationCosts
    };
}

// Fixed: Enhanced scenario context with accurate family information
function updateScenarioContext(scenarioAge, yearsToRetirement, expenseData) {
    let contextText = `At age ${scenarioAge}, `;
    
    if (expenseData.dependentsAtRetirement.length > 0) {
        const dependentAges = expenseData.dependentsAtRetirement.map(dep => {
            const ageAtRetirement = dep.age + yearsToRetirement;
            return `${dep.name} (age ${ageAtRetirement})`;
        });
        
        contextText += `you'll still have ${expenseData.dependentsAtRetirement.length} dependent${expenseData.dependentsAtRetirement.length > 1 ? 's' : ''} at home: ${dependentAges.join(', ')}. `;
        
        // Add education context if applicable
        if (expenseData.remainingEducationCosts > 0) {
            contextText += `Education costs will continue for some dependents. `;
        }
    } else {
        contextText += `all your dependents will have left home. Your household expenses will be significantly lower. `;
    }
    
    contextText += `Your household expenses are projected to be ${formatCurrency(expenseData.retirementExpenses)} annually.`;
    return contextText;
}

// Update the scenario calculation to use the fixed context function
function calculateAndDisplayScenario(scenarioAge, currentAge, lifeExpectancy, inflationRate, returnRate, 
                            superBalance, contribution, currentExpenses, retirementExpenseRate, healthcare, travel, otherCosts,
                            dependents, educationCosts, annualChildCost, partnerData, downsizingData, ttrData,
                            investmentPropsValue, residenceValue, otherAssetsValue, smsfData, isHighIncomeEarner) {
    return safeCalculate(() => {
        const yearsToRetirement = Math.max(0, scenarioAge - currentAge);
        const retirementYears = Math.max(0, lifeExpectancy - scenarioAge);
        
        // ... (existing scenario calculation code remains the same until the end)
        
        // FIXED: Update scenario context with accurate family information
        const scenarioContextElement = document.getElementById(`scenario-${scenarioAge}-family-context`);
        if (scenarioContextElement) {
            const contextText = updateScenarioContext(scenarioAge, yearsToRetirement, expenseData);
            scenarioContextElement.textContent = contextText;
        }
        
        return {
            age: scenarioAge,
            yearsToRetirement,
            projectedSuper,
            retirementIncome: totalRetirementIncome,
            shortfall,
            surplus
        };
    });
}

// Also update the expense timeline calculation to be more accurate
function calculateExpenseTimeline(currentAge, currentExpenses, dependents, educationCosts, annualChildCost) {
    const timeline = [];
    const currentYear = new Date().getFullYear();
    
    // Calculate base expenses without dependents
    const baseExpenses = currentExpenses - (dependents.length * annualChildCost) - educationCosts;
    
    // Create events for when each dependent leaves home and finishes education
    const dependentEvents = [];
    
    dependents.forEach(dep => {
        // Event: Dependent leaves home (reaches supportUntil age)
        const leavingYear = currentYear + (dep.supportUntil - dep.age);
        dependentEvents.push({
            year: leavingYear,
            type: 'leaving',
            name: dep.name,
            costReduction: annualChildCost,
            description: `${dep.name} leaves home`
        });
        
        // Event: Education ends (depends on education type)
        let educationEndAge;
        switch(dep.educationType) {
            case 'secondary':
                educationEndAge = 18;
                break;
            case 'university':
                educationEndAge = 22;
                break;
            case 'tafe':
                educationEndAge = 20;
                break;
            case 'none':
            default:
                educationEndAge = 18;
                break;
        }
        
        const educationEndYear = currentYear + (educationEndAge - dep.age);
        if (educationEndYear !== leavingYear) { // Only add if different from leaving year
            dependentEvents.push({
                year: educationEndYear,
                type: 'education_end',
                name: dep.name,
                costReduction: educationCosts / dependents.length,
                description: `${dep.name} finishes education`
            });
        }
    });
    
    // Sort events by year
    dependentEvents.sort((a, b) => a.year - b.year);
    
    // Calculate expenses for each year
    let currentAnnualExpense = currentExpenses;
    let year = currentYear;
    const maxYears = 30;
    
    for (let i = 0; i < maxYears; i++) {
        const eventsThisYear = dependentEvents.filter(event => event.year === year);
        
        // Apply cost reductions for events this year
        eventsThisYear.forEach(event => {
            currentAnnualExpense -= event.costReduction;
        });
        
        // Only add to timeline if there are events or it's the current year
        if (eventsThisYear.length > 0 || year === currentYear) {
            timeline.push({
                year: year,
                age: currentAge + (year - currentYear),
                annualExpense: currentAnnualExpense,
                events: eventsThisYear
            });
        }
        
        year++;
        
        // Stop if we've projected beyond when all dependents are gone
        if (currentAnnualExpense <= baseExpenses && year > currentYear + 5) {
            break;
        }
    }
    
    return timeline;
}
