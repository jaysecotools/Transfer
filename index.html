<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Image Marker App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --info-color: #17a2b8;
            --link-color: #28a745;
            --video-color: #dc3545;
            --audio-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .app-description {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }

        .app-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .toolbar {
            flex: 1;
            min-width: 250px;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            max-height: 80vh;
            overflow-y: auto;
        }

        .image-container {
            flex: 3;
            min-width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            height: 70vh;
        }

        .tool-section {
            margin-bottom: 25px;
        }

        .tool-section h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            color: var(--primary-color);
        }

        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background-color: var(--secondary-color);
        }

        .btn-danger {
            background-color: var(--accent-color);
        }

        .btn-danger:hover {
            background-color: #ff5252;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px dashed #ccc;
            border-radius: var(--border-radius);
        }

        .marker-types {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .marker-type {
            padding: 8px 12px;
            background-color: #f1f3f5;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .marker-type.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"], input[type="url"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        #imageCanvas, #panoramaViewer {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            cursor: crosshair;
        }

        #panoramaViewer {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .marker {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            z-index: 10;
        }

        .marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .marker.selected {
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .marker.info {
            background-color: var(--info-color);
        }

        .marker.link {
            background-color: var(--link-color);
        }

        .marker.video {
            background-color: var(--video-color);
        }

        .marker.audio {
            background-color: var(--audio-color);
        }

        .marker-info {
            position: absolute;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            min-width: 200px;
            max-width: 300px;
            z-index: 100;
            display: none;
        }

        .marker-info h4 {
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .marker-info p {
            margin-bottom: 10px;
        }

        .marker-info a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .marker-info a:hover {
            text-decoration: underline;
        }

        .close-info {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-weight: bold;
            color: #999;
        }

        .saved-projects {
            margin-top: 20px;
        }

        .project-item {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item:hover {
            background-color: #e9ecef;
        }

        .project-name {
            font-weight: 500;
        }

        .project-date {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .project-actions {
            display: flex;
            gap: 5px;
        }

        .project-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .project-action-btn:hover {
            color: var(--primary-color);
        }

        .delete-project-btn:hover {
            color: var(--accent-color);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #dee2e6;
        }

        .hidden {
            display: none;
        }

        .marker-list {
            margin-top: 20px;
        }

        .marker-item {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .marker-item.selected {
            background-color: #e2f0ff;
            border-left: 4px solid var(--primary-color);
        }

        .marker-item-info {
            flex: 1;
        }

        .marker-item-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .marker-item-type {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: capitalize;
        }

        .marker-item-actions {
            display: flex;
            gap: 5px;
        }

        .marker-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .marker-action-btn:hover {
            color: var(--primary-color);
        }

        .delete-btn:hover {
            color: var(--accent-color);
        }

        .export-options {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .export-option {
            margin-bottom: 10px;
        }

        .export-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .viewer-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            display: flex;
            gap: 10px;
        }

        .instructions-360 {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 50;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background-color: var(--link-color);
        }

        .toast.error {
            background-color: var(--accent-color);
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .toolbar, .image-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Interactive Image Marker</h1>
            <p class="app-description">Upload any image and add interactive markers with links, text, and more. Save your projects and share them with others.</p>
        </header>

        <div class="app-container">
            <div class="toolbar">
                <div class="tool-section">
                    <h3>Upload Image</h3>
                    <input type="file" id="imageUpload" accept="image/*">
                    <button id="toggle360" class="btn btn-warning">Enable 360° View</button>
                    <div class="export-description">For 360° images, use equirectangular format</div>
                </div>

                <div class="tool-section">
                    <h3>Marker Type</h3>
                    <div class="marker-types">
                        <div class="marker-type active" data-type="info">
                            <i class="fas fa-info-circle"></i> Info
                        </div>
                        <div class="marker-type" data-type="link">
                            <i class="fas fa-link"></i> Link
                        </div>
                        <div class="marker-type" data-type="video">
                            <i class="fas fa-video"></i> Video
                        </div>
                        <div class="marker-type" data-type="audio">
                            <i class="fas fa-volume-up"></i> Audio
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="markerTitle">Title *</label>
                        <input type="text" id="markerTitle" placeholder="Enter marker title" required>
                    </div>

                    <div class="form-group">
                        <label for="markerDescription">Description</label>
                        <textarea id="markerDescription" placeholder="Enter marker description"></textarea>
                    </div>

                    <div class="form-group hidden" id="linkGroup">
                        <label for="markerLink">Link (for Link type) *</label>
                        <input type="url" id="markerLink" placeholder="https://example.com">
                    </div>

                    <button id="saveMarker" class="btn">Save Marker</button>
                    <button id="updateMarker" class="btn btn-success">Update Marker</button>
                    <button id="deleteMarker" class="btn btn-danger">Delete Marker</button>
                    <button id="clearMarkers" class="btn btn-danger">Clear All Markers</button>
                </div>

                <div class="tool-section">
                    <h3>Markers</h3>
                    <div class="marker-list" id="markerList">
                        <div class="empty-state">
                            <i class="fas fa-map-marker-alt"></i>
                            <p>No markers added yet</p>
                        </div>
                    </div>
                </div>

                <div class="tool-section">
                    <h3>Project Management</h3>
                    <button id="saveProject" class="btn btn-success">Save Project</button>
                    <button id="loadProject" class="btn">Load Project</button>
                    
                    <div class="export-options">
                        <h4>Export Options:</h4>
                        <div class="export-option">
                            <button id="exportProject" class="btn">Export as JSON</button>
                            <div class="export-description">For backup or importing back into this app</div>
                        </div>
                        <div class="export-option">
                            <button id="exportHTML" class="btn btn-success">Export as HTML</button>
                            <div class="export-description">Creates a standalone file you can share with anyone</div>
                        </div>
                    </div>

                    <div class="saved-projects">
                        <h4>Saved Projects</h4>
                        <div id="projectsList">
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>No saved projects yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="image-container">
                <div id="imageArea">
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-camera"></i>
                        <h3>No Image Loaded</h3>
                        <p>Upload an image to get started</p>
                    </div>
                    <canvas id="imageCanvas" class="hidden"></canvas>
                    <div id="panoramaViewer" class="hidden"></div>
                    <div id="instructions360" class="instructions-360 hidden">
                        <i class="fas fa-mouse"></i> Click and drag to look around
                    </div>
                    <div class="viewer-controls">
                        <button id="resetView" class="btn hidden">Reset View</button>
                    </div>
                </div>
                <div id="markerInfo" class="marker-info">
                    <span class="close-info">×</span>
                    <h4 id="infoTitle"></h4>
                    <p id="infoDescription"></p>
                    <a id="infoLink" href="#" target="_blank"></a>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Global variables
        let markers = [];
        let currentMarkerType = 'info';
        let is360Mode = false;
        let currentImage = null;
        let selectedMarkerId = null;
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        
        // Three.js variables for 360 viewer
        let scene, camera, renderer, controls, sphere;
        
        // DOM Elements
        const imageUpload = document.getElementById('imageUpload');
        const toggle360Btn = document.getElementById('toggle360');
        const resetViewBtn = document.getElementById('resetView');
        const panoramaViewer = document.getElementById('panoramaViewer');
        const instructions360 = document.getElementById('instructions360');
        const markerTypes = document.querySelectorAll('.marker-type');
        const markerTitle = document.getElementById('markerTitle');
        const markerDescription = document.getElementById('markerDescription');
        const markerLink = document.getElementById('markerLink');
        const linkGroup = document.getElementById('linkGroup');
        const saveMarkerBtn = document.getElementById('saveMarker');
        const updateMarkerBtn = document.getElementById('updateMarker');
        const deleteMarkerBtn = document.getElementById('deleteMarker');
        const clearMarkersBtn = document.getElementById('clearMarkers');
        const saveProjectBtn = document.getElementById('saveProject');
        const loadProjectBtn = document.getElementById('loadProject');
        const exportProjectBtn = document.getElementById('exportProject');
        const exportHTMLBtn = document.getElementById('exportHTML');
        const markerList = document.getElementById('markerList');
        const projectsList = document.getElementById('projectsList');
        const emptyState = document.getElementById('emptyState');
        const markerInfo = document.getElementById('markerInfo');
        const infoTitle = document.getElementById('infoTitle');
        const infoDescription = document.getElementById('infoDescription');
        const infoLink = document.getElementById('infoLink');
        const closeInfo = document.querySelector('.close-info');
        const toast = document.getElementById('toast');

        // Event Listeners
        imageUpload.addEventListener('change', handleImageUpload);
        toggle360Btn.addEventListener('click', toggle360Mode);
        resetViewBtn.addEventListener('click', reset360View);
        saveMarkerBtn.addEventListener('click', saveMarker);
        updateMarkerBtn.addEventListener('click', updateMarker);
        deleteMarkerBtn.addEventListener('click', deleteMarker);
        clearMarkersBtn.addEventListener('click', clearMarkers);
        saveProjectBtn.addEventListener('click', saveProject);
        loadProjectBtn.addEventListener('click', loadProject);
        exportProjectBtn.addEventListener('click', exportProject);
        exportHTMLBtn.addEventListener('click', exportAsHTML);
        closeInfo.addEventListener('click', hideMarkerInfo);

        // Marker type selection
        markerTypes.forEach(type => {
            type.addEventListener('click', () => {
                markerTypes.forEach(t => t.classList.remove('active'));
                type.classList.add('active');
                currentMarkerType = type.getAttribute('data-type');
                
                // Show/hide link field based on marker type
                if (currentMarkerType === 'link') {
                    linkGroup.classList.remove('hidden');
                } else {
                    linkGroup.classList.add('hidden');
                }
            });
        });

        // Handle image upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select a valid image file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    
                    if (is360Mode) {
                        setup360Viewer(img);
                    } else {
                        setupCanvas(img);
                    }
                    
                    emptyState.classList.add('hidden');
                    markers = []; // Clear existing markers when new image is loaded
                    selectedMarkerId = null;
                    updateMarkerList();
                    renderMarkers();
                    showToast('Image loaded successfully', 'success');
                };
                img.onerror = function() {
                    showToast('Error loading image', 'error');
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                showToast('Error reading file', 'error');
            };
            reader.readAsDataURL(file);
        }

        // Setup canvas dimensions and position
        function setupCanvas(img) {
            const canvas = document.getElementById('imageCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.classList.remove('hidden');
            panoramaViewer.classList.add('hidden');
            instructions360.classList.add('hidden');
            resetViewBtn.classList.add('hidden');
            
            // Clean up Three.js resources if they exist
            if (renderer) {
                renderer.dispose();
                if (renderer.domElement) {
                    renderer.domElement.remove();
                }
                renderer = null;
            }
            
            const container = document.getElementById('imageArea');
            const maxWidth = container.clientWidth - 40;
            const maxHeight = container.clientHeight - 40;

            let width = img.width;
            let height = img.height;

            // Scale image to fit container while maintaining aspect ratio
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }

            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }

            canvas.width = width;
            canvas.height = height;

            // Draw the image
            ctx.drawImage(img, 0, 0, width, height);
            
            // Add click event listener for adding markers
            canvas.addEventListener('click', addMarker);
        }

        // Setup 360 viewer
        function setup360Viewer(img) {
            const canvas = document.getElementById('imageCanvas');
            canvas.classList.add('hidden');
            panoramaViewer.classList.remove('hidden');
            instructions360.classList.remove('hidden');
            resetViewBtn.classList.remove('hidden');
            
            // Clear previous Three.js scene if it exists
            if (renderer) {
                panoramaViewer.removeChild(renderer.domElement);
                renderer.dispose();
            }
            
            try {
                // Set up Three.js scene
                scene = new THREE.Scene();
                
                // Create camera
                camera = new THREE.PerspectiveCamera(75, panoramaViewer.clientWidth / panoramaViewer.clientHeight, 0.1, 1000);
                camera.position.set(0, 0, 0.1);
                
                // Create renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(panoramaViewer.clientWidth, panoramaViewer.clientHeight);
                panoramaViewer.appendChild(renderer.domElement);
                
                // Create sphere geometry
                const geometry = new THREE.SphereGeometry(500, 60, 40);
                geometry.scale(-1, 1, 1); // Invert the sphere to view from inside
                
                // Create texture from image
                const texture = new THREE.Texture(img);
                texture.needsUpdate = true;
                
                // Create material with texture
                const material = new THREE.MeshBasicMaterial({ map: texture });
                
                // Create mesh and add to scene
                sphere = new THREE.Mesh(geometry, material);
                scene.add(sphere);
                
                // Add controls
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableZoom = true;
                controls.enablePan = false;
                controls.rotateSpeed = 0.5;
                controls.minDistance = 0.1;
                controls.maxDistance = 1.0;
                
                // Handle window resize
                window.addEventListener('resize', onWindowResize);
                
                // Start animation loop
                animate();
                
                // Add click event for markers on the 360 viewer
                renderer.domElement.addEventListener('click', addMarker360);
            } catch (error) {
                console.error('Error setting up 360 viewer:', error);
                showToast('Error setting up 360 viewer. Please try a different image or disable 360 mode.', 'error');
                is360Mode = false;
                toggle360Btn.textContent = 'Enable 360° View';
                setupCanvas(img);
            }
        }

        // Animation loop for 360 viewer
        function animate() {
            if (!renderer) return;
            
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // Handle window resize for 360 viewer
        function onWindowResize() {
            if (camera && renderer) {
                camera.aspect = panoramaViewer.clientWidth / panoramaViewer.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(panoramaViewer.clientWidth, panoramaViewer.clientHeight);
            }
        }

        // Add marker to 360 viewer
        function addMarker360(e) {
            if (isDragging) {
                isDragging = false;
                return;
            }
            
            // Convert mouse coordinates to 3D world coordinates
            const mouse = new THREE.Vector2();
            const rect = renderer.domElement.getBoundingClientRect();
            
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObject(sphere);
            
            if (intersects.length > 0) {
                const point = intersects[0].point;
                
                // Convert 3D point to spherical coordinates
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(point);
                
                // Validate form
                if (!validateMarkerForm()) return;
                
                // Create marker data with spherical coordinates
                const markerId = Date.now();
                const markerData = {
                    id: markerId,
                    type: currentMarkerType,
                    phi: spherical.phi,    // vertical angle
                    theta: spherical.theta, // horizontal angle
                    title: markerTitle.value || `Marker ${markers.length + 1}`,
                    description: markerDescription.value || '',
                    link: markerLink.value || '',
                    is360: true
                };
                
                markers.push(markerData);
                
                // Create marker element
                create360MarkerElement(markerData);
                
                // Select the new marker
                selectMarker(markerId);
                
                // Clear form fields
                clearMarkerForm();
                
                // Update marker list
                updateMarkerList();
                
                showToast('Marker added successfully', 'success');
            }
        }

        // Create 360 marker element
        function create360MarkerElement(markerData) {
            // Convert spherical coordinates to 3D position
            const spherical = new THREE.Spherical(500, markerData.phi, markerData.theta);
            const position = new THREE.Vector3();
            position.setFromSpherical(spherical);
            
            // Project 3D position to screen coordinates
            const vector = position.clone();
            vector.project(camera);
            
            const x = (vector.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
            const y = -(vector.y * 0.5 - 0.5) * renderer.domElement.clientHeight;
            
            const marker = document.createElement('div');
            marker.className = `marker ${markerData.type}`;
            marker.id = `marker-${markerData.id}`;
            marker.style.left = `${x}px`;
            marker.style.top = `${y}px`;
            
            // Set icon based on marker type
            let iconClass = 'fas fa-info-circle';
            if (markerData.type === 'link') iconClass = 'fas fa-link';
            else if (markerData.type === 'video') iconClass = 'fas fa-video';
            else if (markerData.type === 'audio') iconClass = 'fas fa-volume-up';
            
            marker.innerHTML = `<i class="${iconClass}"></i>`;
            
            // Add event listeners
            marker.addEventListener('mousedown', startDragging360);
            marker.addEventListener('click', (event) => {
                event.stopPropagation();
                selectMarker(markerData.id);
                showMarkerInfo(markerData);
            });
            
            // Add marker to panorama viewer
            panoramaViewer.appendChild(marker);
            
            return marker;
        }

        // Start dragging a 360 marker
        function startDragging360(e) {
            e.stopPropagation();
            isDragging = true;
            const marker = e.target.closest('.marker');
            const markerId = parseInt(marker.id.replace('marker-', ''));
            
            // Select the marker being dragged
            selectMarker(markerId);
            
            const rect = marker.getBoundingClientRect();
            const markerX = rect.left + rect.width / 2;
            const markerY = rect.top + rect.height / 2;
            
            dragOffsetX = e.clientX - markerX;
            dragOffsetY = e.clientY - markerY;
            
            document.addEventListener('mousemove', dragMarker360);
            document.addEventListener('mouseup', stopDragging360);
        }

        // Drag 360 marker
        function dragMarker360(e) {
            if (!isDragging) return;
            
            const marker = document.getElementById(`marker-${selectedMarkerId}`);
            if (!marker) return;
            
            const rect = panoramaViewer.getBoundingClientRect();
            let x = e.clientX - dragOffsetX - rect.left;
            let y = e.clientY - dragOffsetY - rect.top;
            
            // Constrain marker to viewer bounds
            x = Math.max(0, Math.min(x, rect.width));
            y = Math.max(0, Math.min(y, rect.height));
            
            marker.style.left = `${x}px`;
            marker.style.top = `${y}px`;
            
            // Convert screen coordinates back to spherical coordinates
            const vector = new THREE.Vector3();
            vector.x = (x / rect.width) * 2 - 1;
            vector.y = -(y / rect.height) * 2 + 1;
            vector.z = 0.5;
            
            vector.unproject(camera);
            
            const direction = vector.sub(camera.position).normalize();
            const spherical = new THREE.Spherical();
            spherical.setFromVector3(direction);
            
            // Update marker data
            const markerIndex = markers.findIndex(m => m.id === selectedMarkerId);
            if (markerIndex !== -1) {
                markers[markerIndex].phi = spherical.phi;
                markers[markerIndex].theta = spherical.theta;
            }
        }

        // Stop dragging 360 marker
        function stopDragging360() {
            isDragging = false;
            document.removeEventListener('mousemove', dragMarker360);
            document.removeEventListener('mouseup', stopDragging360);
        }

        // Toggle 360 mode
        function toggle360Mode() {
            if (!currentImage) {
                showToast('Please upload an image first.', 'error');
                return;
            }
            
            is360Mode = !is360Mode;
            toggle360Btn.textContent = is360Mode ? 'Disable 360° View' : 'Enable 360° View';
            toggle360Btn.classList.toggle('btn-warning', is360Mode);
            toggle360Btn.classList.toggle('btn', !is360Mode);
            
            if (is360Mode) {
                setup360Viewer(currentImage);
            } else {
                setupCanvas(currentImage);
            }
            renderMarkers();
        }

        // Reset 360 view
        function reset360View() {
            if (controls) {
                controls.reset();
            }
        }

        // Add marker to canvas (for 2D mode)
        function addMarker(e) {
            // Don't add marker if we're dragging an existing one
            if (isDragging) {
                isDragging = false;
                return;
            }
            
            const canvas = document.getElementById('imageCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Validate form
            if (!validateMarkerForm()) return;
            
            // Create marker data
            const markerId = Date.now();
            const markerData = {
                id: markerId,
                type: currentMarkerType,
                x: x,
                y: y,
                title: markerTitle.value || `Marker ${markers.length + 1}`,
                description: markerDescription.value || '',
                link: markerLink.value || '',
                is360: false
            };
            
            markers.push(markerData);
            
            // Create marker element
            createMarkerElement(markerData);
            
            // Select the new marker
            selectMarker(markerId);
            
            // Clear form fields
            clearMarkerForm();
            
            // Update marker list
            updateMarkerList();
            
            showToast('Marker added successfully', 'success');
        }

        // Validate marker form
        function validateMarkerForm() {
            if (!markerTitle.value.trim()) {
                showToast('Please enter a marker title', 'error');
                markerTitle.focus();
                return false;
            }
            
            if (currentMarkerType === 'link' && !markerLink.value.trim()) {
                showToast('Please enter a link for link markers', 'error');
                markerLink.focus();
                return false;
            }
            
            return true;
        }

        // Clear marker form
        function clearMarkerForm() {
            markerTitle.value = '';
            markerDescription.value = '';
            markerLink.value = '';
        }

        // Create marker DOM element (for 2D mode)
        function createMarkerElement(markerData) {
            const marker = document.createElement('div');
            marker.className = `marker ${markerData.type}`;
            marker.id = `marker-${markerData.id}`;
            marker.style.left = `${markerData.x}px`;
            marker.style.top = `${markerData.y}px`;
            
            // Set icon based on marker type
            let iconClass = 'fas fa-info-circle';
            if (markerData.type === 'link') iconClass = 'fas fa-link';
            else if (markerData.type === 'video') iconClass = 'fas fa-video';
            else if (markerData.type === 'audio') iconClass = 'fas fa-volume-up';
            
            marker.innerHTML = `<i class="${iconClass}"></i>`;
            
            // Add event listeners
            marker.addEventListener('mousedown', startDragging);
            marker.addEventListener('click', (event) => {
                event.stopPropagation();
                selectMarker(markerData.id);
                showMarkerInfo(markerData);
            });
            
            // Add marker to image container
            document.getElementById('imageArea').appendChild(marker);
            
            return marker;
        }

        // Start dragging a marker (for 2D mode)
        function startDragging(e) {
            e.stopPropagation();
            isDragging = true;
            const marker = e.target.closest('.marker');
            const markerId = parseInt(marker.id.replace('marker-', ''));
            
            // Select the marker being dragged
            selectMarker(markerId);
            
            const rect = marker.getBoundingClientRect();
            const markerX = rect.left + rect.width / 2;
            const markerY = rect.top + rect.height / 2;
            
            dragOffsetX = e.clientX - markerX;
            dragOffsetY = e.clientY - markerY;
            
            document.addEventListener('mousemove', dragMarker);
            document.addEventListener('mouseup', stopDragging);
        }

        // Drag marker (for 2D mode)
        function dragMarker(e) {
            if (!isDragging) return;
            
            const marker = document.getElementById(`marker-${selectedMarkerId}`);
            if (!marker) return;
            
            const canvas = document.getElementById('imageCanvas');
            const rect = canvas.getBoundingClientRect();
            let x = e.clientX - dragOffsetX - rect.left;
            let y = e.clientY - dragOffsetY - rect.top;
            
            // Constrain marker to canvas bounds
            x = Math.max(0, Math.min(x, canvas.width));
            y = Math.max(0, Math.min(y, canvas.height));
            
            marker.style.left = `${x}px`;
            marker.style.top = `${y}px`;
            
            // Update marker data
            const markerIndex = markers.findIndex(m => m.id === selectedMarkerId);
            if (markerIndex !== -1) {
                markers[markerIndex].x = x;
                markers[markerIndex].y = y;
            }
        }

        // Stop dragging marker (for 2D mode)
        function stopDragging() {
            isDragging = false;
            document.removeEventListener('mousemove', dragMarker);
            document.removeEventListener('mouseup', stopDragging);
        }

        // Select a marker
        function selectMarker(markerId) {
            // Deselect all markers
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            document.querySelectorAll('.marker-item').forEach(m => m.classList.remove('selected'));
            
            // Select the specified marker
            const marker = document.getElementById(`marker-${markerId}`);
            if (marker) {
                marker.classList.add('selected');
                selectedMarkerId = markerId;
                
                // Find and select the corresponding list item
                const listItem = document.querySelector(`.marker-item[data-id="${markerId}"]`);
                if (listItem) {
                    listItem.classList.add('selected');
                }
                
                // Populate form with marker data
                const markerData = markers.find(m => m.id === markerId);
                if (markerData) {
                    markerTitle.value = markerData.title;
                    markerDescription.value = markerData.description;
                    markerLink.value = markerData.link;
                    
                    // Set active marker type
                    markerTypes.forEach(t => t.classList.remove('active'));
                    document.querySelector(`.marker-type[data-type="${markerData.type}"]`).classList.add('active');
                    currentMarkerType = markerData.type;
                    
                    // Show/hide link field
                    if (currentMarkerType === 'link') {
                        linkGroup.classList.remove('hidden');
                    } else {
                        linkGroup.classList.add('hidden');
                    }
                }
            }
        }

        // Save marker (from form)
        function saveMarker() {
            if (markers.length === 0) {
                showToast('Please add a marker to the image first by clicking on it.', 'error');
                return;
            }
            
            // Update the last added marker with form data
            const lastMarker = markers[markers.length - 1];
            lastMarker.title = markerTitle.value || lastMarker.title;
            lastMarker.description = markerDescription.value || lastMarker.description;
            lastMarker.link = markerLink.value || lastMarker.link;
            
            // Update marker icon if type changed
            const markerElement = document.getElementById(`marker-${lastMarker.id}`);
            if (markerElement && lastMarker.type !== currentMarkerType) {
                lastMarker.type = currentMarkerType;
                markerElement.className = `marker ${currentMarkerType}`;
                
                // Update icon
                let iconClass = 'fas fa-info-circle';
                if (currentMarkerType === 'link') iconClass = 'fas fa-link';
                else if (currentMarkerType === 'video') iconClass = 'fas fa-video';
                else if (currentMarkerType === 'audio') iconClass = 'fas fa-volume-up';
                
                markerElement.innerHTML = `<i class="${iconClass}"></i>`;
            }
            
            updateMarkerList();
            showToast('Marker saved successfully!', 'success');
        }

        // Update selected marker
        function updateMarker() {
            if (!selectedMarkerId) {
                showToast('Please select a marker to update.', 'error');
                return;
            }
            
            if (!validateMarkerForm()) return;
            
            const markerIndex = markers.findIndex(m => m.id === selectedMarkerId);
            if (markerIndex === -1) return;
            
            markers[markerIndex].title = markerTitle.value;
            markers[markerIndex].description = markerDescription.value;
            markers[markerIndex].link = markerLink.value;
            markers[markerIndex].type = currentMarkerType;
            
            // Update marker element
            const markerElement = document.getElementById(`marker-${selectedMarkerId}`);
            if (markerElement) {
                markerElement.className = `marker ${currentMarkerType}`;
                
                // Update icon
                let iconClass = 'fas fa-info-circle';
                if (currentMarkerType === 'link') iconClass = 'fas fa-link';
                else if (currentMarkerType === 'video') iconClass = 'fas fa-video';
                else if (currentMarkerType === 'audio') iconClass = 'fas fa-volume-up';
                
                markerElement.innerHTML = `<i class="${iconClass}"></i>`;
            }
            
            updateMarkerList();
            showToast('Marker updated successfully!', 'success');
        }

        // Delete selected marker
        function deleteMarker() {
            if (!selectedMarkerId) {
                showToast('Please select a marker to delete.', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this marker?')) {
                // Remove marker from array
                markers = markers.filter(m => m.id !== selectedMarkerId);
                
                // Remove marker element from DOM
                const markerElement = document.getElementById(`marker-${selectedMarkerId}`);
                if (markerElement) {
                    markerElement.remove();
                }
                
                // Remove from marker list
                const listItem = document.querySelector(`.marker-item[data-id="${selectedMarkerId}"]`);
                if (listItem) {
                    listItem.remove();
                }
                
                // Clear selection
                selectedMarkerId = null;
                clearMarkerForm();
                
                // Hide marker info
                hideMarkerInfo();
                
                // Update marker list UI
                if (markers.length === 0) {
                    markerList.innerHTML = '<div class="empty-state"><i class="fas fa-map-marker-alt"></i><p>No markers added yet</p></div>';
                }
                
                showToast('Marker deleted successfully', 'success');
            }
        }

        // Show marker info
        function showMarkerInfo(marker) {
            infoTitle.textContent = marker.title;
            infoDescription.textContent = marker.description;
            
            if (marker.link) {
                infoLink.href = marker.link;
                infoLink.textContent = marker.link;
                infoLink.style.display = 'block';
            } else {
                infoLink.style.display = 'none';
            }
            
            // Position the info box near the marker
            const markerElement = document.getElementById(`marker-${marker.id}`);
            if (markerElement) {
                const rect = markerElement.getBoundingClientRect();
                const containerRect = document.getElementById('imageArea').getBoundingClientRect();
                
                let left = rect.left + rect.width / 2;
                let top = rect.top + rect.height;
                
                // Adjust position if info box would go outside the container
                const infoWidth = 250;
                const infoHeight = 150;
                
                if (left + infoWidth > containerRect.right) {
                    left = containerRect.right - infoWidth;
                }
                
                if (top + infoHeight > containerRect.bottom) {
                    top = rect.top - infoHeight;
                }
                
                if (left < containerRect.left) {
                    left = containerRect.left;
                }
                
                if (top < containerRect.top) {
                    top = containerRect.top;
                }
                
                markerInfo.style.left = `${left - containerRect.left}px`;
                markerInfo.style.top = `${top - containerRect.top}px`;
            }
            
            markerInfo.style.display = 'block';
        }

        // Hide marker info
        function hideMarkerInfo() {
            markerInfo.style.display = 'none';
        }

        // Clear all markers
        function clearMarkers() {
            if (markers.length === 0) {
                showToast('No markers to clear', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to clear all markers?')) {
                markers = [];
                selectedMarkerId = null;
                document.querySelectorAll('.marker').forEach(marker => marker.remove());
                markerList.innerHTML = '<div class="empty-state"><i class="fas fa-map-marker-alt"></i><p>No markers added yet</p></div>';
                clearMarkerForm();
                hideMarkerInfo();
                showToast('All markers cleared', 'success');
            }
        }

        // Update marker list in sidebar
        function updateMarkerList() {
            if (markers.length === 0) {
                markerList.innerHTML = '<div class="empty-state"><i class="fas fa-map-marker-alt"></i><p>No markers added yet</p></div>';
                return;
            }
            
            let html = '';
            markers.forEach(marker => {
                html += `
                    <div class="marker-item ${marker.id === selectedMarkerId ? 'selected' : ''}" data-id="${marker.id}">
                        <div class="marker-item-info">
                            <div class="marker-item-title">${marker.title}</div>
                            <div class="marker-item-type">${marker.type} marker ${marker.is360 ? '(360°)' : ''}</div>
                        </div>
                        <div class="marker-item-actions">
                            <button class="marker-action-btn edit-btn" title="Edit marker">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="marker-action-btn delete-btn" title="Delete marker">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            markerList.innerHTML = html;
            
            // Add event listeners to marker list items
            markerList.querySelectorAll('.marker-item').forEach(item => {
                const markerId = parseInt(item.getAttribute('data-id'));
                
                item.addEventListener('click', () => {
                    selectMarker(markerId);
                    
                    // Show marker info
                    const markerData = markers.find(m => m.id === markerId);
                    if (markerData) {
                        showMarkerInfo(markerData);
                    }
                });
                
                // Edit button
                item.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectMarker(markerId);
                });
                
                // Delete button
                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedMarkerId = markerId;
                    deleteMarker();
                });
            });
        }

        // Render markers on canvas
        function renderMarkers() {
            // Clear existing markers
            document.querySelectorAll('.marker').forEach(marker => marker.remove());
            
            // Add markers to canvas
            markers.forEach(marker => {
                if (is360Mode && marker.is360) {
                    create360MarkerElement(marker);
                } else if (!is360Mode && !marker.is360) {
                    createMarkerElement(marker);
                }
            });
            
            updateMarkerList();
        }

        // Show toast notification
        function showToast(message, type = '') {
            toast.textContent = message;
            toast.className = 'toast';
            
            if (type) {
                toast.classList.add(type);
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Save project to localStorage
        function saveProject() {
            if (!currentImage) {
                showToast('Please upload an image first.', 'error');
                return;
            }
            
            const projectName = prompt('Enter a name for your project:');
            if (!projectName) return;
            
            if (!projectName.trim()) {
                showToast('Project name cannot be empty', 'error');
                return;
            }
            
            const project = {
                name: projectName,
                date: new Date().toISOString(),
                image: currentImage.src,
                markers: markers,
                is360: is360Mode
            };
            
            // Get existing projects or initialize empty array
            const projects = JSON.parse(localStorage.getItem('imageMarkerProjects') || '[]');
            
            // Check if project with same name exists
            const existingIndex = projects.findIndex(p => p.name === projectName);
            if (existingIndex !== -1) {
                if (!confirm(`A project named "${projectName}" already exists. Do you want to overwrite it?`)) {
                    return;
                }
                projects[existingIndex] = project;
            } else {
                projects.push(project);
            }
            
            // Save to localStorage
            localStorage.setItem('imageMarkerProjects', JSON.stringify(projects));
            
            // Update projects list
            updateProjectsList();
            
            showToast('Project saved successfully!', 'success');
        }

        // Load project from localStorage
        function loadProject() {
            const projects = JSON.parse(localStorage.getItem('imageMarkerProjects') || '[]');
            
            if (projects.length === 0) {
                showToast('No saved projects found.', 'error');
                return;
            }
            
            // Create project selection dialog
            let projectListHTML = '<h3>Select a project to load:</h3>';
            projects.forEach((project, index) => {
                projectListHTML += `
                    <div class="project-item" data-index="${index}">
                        <div class="project-name">${project.name}</div>
                        <div class="project-date">${new Date(project.date).toLocaleString()}</div>
                    </div>
                `;
            });
            
            const selectionDiv = document.createElement('div');
            selectionDiv.innerHTML = projectListHTML;
            
            // Show modal with project list
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '8px';
            modalContent.style.maxWidth = '500px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflowY = 'auto';
            
            modalContent.appendChild(selectionDiv);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Add event listeners to project items
            modalContent.querySelectorAll('.project-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'));
                    const project = projects[index];
                    
                    // Load the project
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        is360Mode = project.is360 || false;
                        toggle360Btn.textContent = is360Mode ? 'Disable 360° View' : 'Enable 360° View';
                        toggle360Btn.classList.toggle('btn-warning', is360Mode);
                        toggle360Btn.classList.toggle('btn', !is360Mode);
                        
                        if (is360Mode) {
                            setup360Viewer(img);
                        } else {
                            setupCanvas(img);
                        }
                        
                        emptyState.classList.add('hidden');
                        
                        markers = project.markers || [];
                        selectedMarkerId = null;
                        renderMarkers();
                        
                        // Close modal
                        document.body.removeChild(modal);
                        
                        showToast(`Project "${project.name}" loaded successfully`, 'success');
                    };
                    img.onerror = function() {
                        showToast('Error loading project image', 'error');
                    };
                    img.src = project.image;
                });
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Export project as JSON file
        function exportProject() {
            if (!currentImage || markers.length === 0) {
                showToast('Please create a project with markers before exporting.', 'error');
                return;
            }
            
            const projectName = prompt('Enter a name for your exported project:') || 'My Image Project';
            
            const project = {
                name: projectName,
                date: new Date().toISOString(),
                image: currentImage.src,
                markers: markers,
                is360: is360Mode
            };
            
            const dataStr = JSON.stringify(project, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${projectName.replace(/\s+/g, '_')}.json`;
            link.click();
            
            showToast('Project exported as JSON', 'success');
        }

        // Export project as standalone HTML file
        function exportAsHTML() {
            if (!currentImage || markers.length === 0) {
                showToast('Please create a project with markers before exporting.', 'error');
                return;
            }
            
            const projectName = prompt('Enter a name for your exported project:') || 'Interactive Image';
            
            // Create the standalone HTML content
            const htmlContent = createStandaloneHTML(projectName);
            
            // Create and download the file
            const dataBlob = new Blob([htmlContent], {type: 'text/html'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${projectName.replace(/\s+/g, '_')}.html`;
            link.click();
            
            showToast('Standalone HTML file created! You can now share this file with anyone.', 'success');
        }

        // Create standalone HTML content
        function createStandaloneHTML(projectName) {
            // Check if this is a 360 project
            const is360Project = markers.some(marker => marker.is360) || is360Mode;
            
            if (is360Project) {
                return create360StandaloneHTML(projectName);
            } else {
                return create2DStandaloneHTML(projectName);
            }
        }

        // Create standalone 2D HTML content
        function create2DStandaloneHTML(projectName) {
            const markers2D = markers.filter(m => !m.is360);
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${projectName}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 1000px; width: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 20px; }
        h1 { text-align: center; color: #4a6fa5; margin-bottom: 20px; }
        .image-container { position: relative; display: inline-block; max-width: 100%; }
        #viewerImage { max-width: 100%; max-height: 70vh; display: block; border: 1px solid #eee; border-radius: 8px; }
        .marker { position: absolute; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transform: translate(-50%, -50%); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); transition: transform 0.2s; }
        .marker:hover { transform: translate(-50%, -50%) scale(1.2); }
        .marker.info { background-color: #17a2b8; }
        .marker.link { background-color: #28a745; }
        .marker.video { background-color: #dc3545; }
        .marker.audio { background-color: #ffc107; }
        .marker-info { position: absolute; background-color: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); min-width: 200px; max-width: 300px; z-index: 100; display: none; }
        .marker-info h4 { margin-bottom: 8px; color: #4a6fa5; }
        .marker-info p { margin-bottom: 10px; }
        .marker-info a { color: #4a6fa5; text-decoration: none; font-weight: 500; }
        .marker-info a:hover { text-decoration: underline; }
        .close-info { position: absolute; top: 5px; right: 10px; cursor: pointer; font-weight: bold; color: #999; }
        .instructions { text-align: center; color: #666; margin-top: 15px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>${projectName}</h1>
        <div class="image-container">
            <img id="viewerImage" src="${currentImage.src}" alt="Interactive Image">
            <div id="markersContainer"></div>
            <div id="markerInfo" class="marker-info">
                <span class="close-info">×</span>
                <h4 id="infoTitle"></h4>
                <p id="infoDescription"></p>
                <a id="infoLink" href="#" target="_blank"></a>
            </div>
        </div>
        <p class="instructions">Click on the markers to see more information</p>
    </div>

    <script>
        const markersData = ${JSON.stringify(markers2D)};
        const markersContainer = document.getElementById('markersContainer');
        const markerInfo = document.getElementById('markerInfo');
        const infoTitle = document.getElementById('infoTitle');
        const infoDescription = document.getElementById('infoDescription');
        const infoLink = document.getElementById('infoLink');
        const closeInfo = document.querySelector('.close-info');
        const viewerImage = document.getElementById('viewerImage');
        
        viewerImage.onload = function() { createMarkers(); };
        if (viewerImage.complete) { createMarkers(); }
        
        function createMarkers() {
            markersData.forEach(marker => {
                const markerElement = document.createElement('div');
                markerElement.className = \`marker \${marker.type}\`;
                markerElement.style.left = \`\${marker.x}px\`;
                markerElement.style.top = \`\${marker.y}px\`;
                let iconClass = 'fas fa-info-circle';
                if (marker.type === 'link') iconClass = 'fas fa-link';
                else if (marker.type === 'video') iconClass = 'fas fa-video';
                else if (marker.type === 'audio') iconClass = 'fas fa-volume-up';
                markerElement.innerHTML = \`<i class="\${iconClass}"></i>\`;
                markerElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showMarkerInfo(marker);
                });
                markersContainer.appendChild(markerElement);
            });
        }
        
        function showMarkerInfo(marker) {
            infoTitle.textContent = marker.title;
            infoDescription.textContent = marker.description;
            if (marker.link) {
                infoLink.href = marker.link;
                infoLink.textContent = marker.link;
                infoLink.style.display = 'block';
            } else {
                infoLink.style.display = 'none';
            }
            markerInfo.style.left = \`\${marker.x + 20}px\`;
            markerInfo.style.top = \`\${marker.y}px\`;
            markerInfo.style.display = 'block';
        }
        
        function hideMarkerInfo() {
            markerInfo.style.display = 'none';
        }
        
        closeInfo.addEventListener('click', hideMarkerInfo);
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.marker') && !e.target.closest('.marker-info')) {
                hideMarkerInfo();
            }
        });
    </script>
</body>
</html>`;
        }

        // Create standalone 360 HTML content
        function create360StandaloneHTML(projectName) {
            const markers360 = markers.filter(m => m.is360);
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${projectName}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 1000px; width: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 20px; }
        h1 { text-align: center; color: #4a6fa5; margin-bottom: 20px; }
        .viewer-container { position: relative; width: 100%; height: 60vh; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        #panoramaViewer { width: 100%; height: 100%; }
        .marker { position: absolute; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transform: translate(-50%, -50%); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); transition: transform 0.2s; z-index: 10; }
        .marker:hover { transform: translate(-50%, -50%) scale(1.2); }
        .marker.info { background-color: #17a2b8; }
        .marker.link { background-color: #28a745; }
        .marker.video { background-color: #dc3545; }
        .marker.audio { background-color: #ffc107; }
        .marker-info { position: absolute; background-color: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); min-width: 200px; max-width: 300px; z-index: 100; display: none; }
        .marker-info h4 { margin-bottom: 8px; color: #4a6fa5; }
        .marker-info p { margin-bottom: 10px; }
        .marker-info a { color: #4a6fa5; text-decoration: none; font-weight: 500; }
        .marker-info a:hover { text-decoration: underline; }
        .close-info { position: absolute; top: 5px; right: 10px; cursor: pointer; font-weight: bold; color: #999; }
        .instructions { text-align: center; color: #666; margin-top: 15px; font-size: 0.9rem; }
        .instructions-360 { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem; z-index: 50; }
    </style>
</head>
<body>
    <div class="container">
        <h1>${projectName}</h1>
        <div class="viewer-container">
            <div id="panoramaViewer"></div>
            <div id="markersContainer"></div>
            <div class="instructions-360">
                <i class="fas fa-mouse"></i> Click and drag to look around • Click markers for info
            </div>
            <div id="markerInfo" class="marker-info">
                <span class="close-info">×</span>
                <h4 id="infoTitle"></h4>
                <p id="infoDescription"></p>
                <a id="infoLink" href="#" target="_blank"></a>
            </div>
        </div>
        <p class="instructions">360° Interactive Experience - Drag to look around and click markers for information</p>
    </div>

    <script>
        const markersData = ${JSON.stringify(markers360)};
        const panoramaViewer = document.getElementById('panoramaViewer');
        const markersContainer = document.getElementById('markersContainer');
        const markerInfo = document.getElementById('markerInfo');
        const infoTitle = document.getElementById('infoTitle');
        const infoDescription = document.getElementById('infoDescription');
        const infoLink = document.getElementById('infoLink');
        const closeInfo = document.querySelector('.close-info');
        let scene, camera, renderer, controls, sphere;
        
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, panoramaViewer.clientWidth / panoramaViewer.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 0.1);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(panoramaViewer.clientWidth, panoramaViewer.clientHeight);
            panoramaViewer.appendChild(renderer.domElement);
            const geometry = new THREE.SphereGeometry(500, 60, 40);
            geometry.scale(-1, 1, 1);
            const texture = new THREE.Texture();
            const image = new Image();
            image.onload = function() {
                texture.image = image;
                texture.needsUpdate = true;
                createMarkers();
            };
            image.src = '${currentImage.src}';
            const material = new THREE.MeshBasicMaterial({ map: texture });
            sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableZoom = true;
            controls.enablePan = false;
            controls.rotateSpeed = 0.5;
            window.addEventListener('resize', onWindowResize);
            animate();
        }
        
        function createMarkers() {
            markersData.forEach(marker => {
                const spherical = new THREE.Spherical(500, marker.phi, marker.theta);
                const position = new THREE.Vector3();
                position.setFromSpherical(spherical);
                updateMarkerPosition(marker, position);
            });
        }
        
        function updateMarkerPosition(markerData, position) {
            const vector = position.clone();
            vector.project(camera);
            const x = (vector.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
            const y = -(vector.y * 0.5 - 0.5) * renderer.domElement.clientHeight;
            let markerElement = document.getElementById(\`marker-\${markerData.id}\`);
            if (!markerElement) {
                markerElement = document.createElement('div');
                markerElement.className = \`marker \${markerData.type}\`;
                markerElement.id = \`marker-\${markerData.id}\`;
                let iconClass = 'fas fa-info-circle';
                if (markerData.type === 'link') iconClass = 'fas fa-link';
                else if (markerData.type === 'video') iconClass = 'fas fa-video';
                else if (markerData.type === 'audio') iconClass = 'fas fa-volume-up';
                markerElement.innerHTML = \`<i class="\${iconClass}"></i>\`;
                markerElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showMarkerInfo(markerData);
                });
                markersContainer.appendChild(markerElement);
            }
            markerElement.style.left = \`\${x}px\`;
            markerElement.style.top = \`\${y}px\`;
        }
        
        function showMarkerInfo(marker) {
            infoTitle.textContent = marker.title;
            infoDescription.textContent = marker.description;
            if (marker.link) {
                infoLink.href = marker.link;
                infoLink.textContent = marker.link;
                infoLink.style.display = 'block';
            } else {
                infoLink.style.display = 'none';
            }
            const markerElement = document.getElementById(\`marker-\${marker.id}\`);
            if (markerElement) {
                const rect = markerElement.getBoundingClientRect();
                const containerRect = panoramaViewer.getBoundingClientRect();
                markerInfo.style.left = \`\${rect.left - containerRect.left + 20}px\`;
                markerInfo.style.top = \`\${rect.top - containerRect.top}px\`;
            }
            markerInfo.style.display = 'block';
        }
        
        function hideMarkerInfo() {
            markerInfo.style.display = 'none';
        }
        
        function animate() {
            requestAnimationFrame(animate);
            markersData.forEach(marker => {
                const spherical = new THREE.Spherical(500, marker.phi, marker.theta);
                const position = new THREE.Vector3();
                position.setFromSpherical(spherical);
                updateMarkerPosition(marker, position);
            });
            controls.update();
            renderer.render(scene, camera);
        }
        
        function onWindowResize() {
            camera.aspect = panoramaViewer.clientWidth / panoramaViewer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(panoramaViewer.clientWidth, panoramaViewer.clientHeight);
        }
        
        closeInfo.addEventListener('click', hideMarkerInfo);
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.marker') && !e.target.closest('.marker-info')) {
                hideMarkerInfo();
            }
        });
        init();
    </script>
</body>
</html>`;
        }

        // Update projects list in UI
        function updateProjectsList() {
            const projects = JSON.parse(localStorage.getItem('imageMarkerProjects') || '[]');
            
            if (projects.length === 0) {
                projectsList.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>No saved projects yet</p></div>';
                return;
            }
            
            let html = '';
            projects.forEach((project, index) => {
                html += `
                    <div class="project-item" data-index="${index}">
                        <div class="project-info">
                            <div class="project-name">${project.name}</div>
                            <div class="project-date">${new Date(project.date).toLocaleString()}</div>
                        </div>
                        <div class="project-actions">
                            <button class="project-action-btn delete-project-btn" title="Delete project">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            projectsList.innerHTML = html;
            
            // Add event listeners to project items
            projectsList.querySelectorAll('.project-item').forEach(item => {
                const index = parseInt(item.getAttribute('data-index'));
                
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.project-actions')) {
                        const projects = JSON.parse(localStorage.getItem('imageMarkerProjects') || '[]');
                        const project = projects[index];
                        
                        // Load the project
                        const img = new Image();
                        img.onload = function() {
                            currentImage = img;
                            is360Mode = project.is360 || false;
                            toggle360Btn.textContent = is360Mode ? 'Disable 360° View' : 'Enable 360° View';
                            toggle360Btn.classList.toggle('btn-warning', is360Mode);
                            toggle360Btn.classList.toggle('btn', !is360Mode);
                            
                            if (is360Mode) {
                                setup360Viewer(img);
                            } else {
                                setupCanvas(img);
                            }
                            
                            emptyState.classList.add('hidden');
                            
                            markers = project.markers || [];
                            selectedMarkerId = null;
                            renderMarkers();
                            
                            showToast(`Project "${project.name}" loaded successfully`, 'success');
                        };
                        img.onerror = function() {
                            showToast('Error loading project image', 'error');
                        };
                        img.src = project.image;
                    }
                });
                
                // Delete project button
                item.querySelector('.delete-project-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const projects = JSON.parse(localStorage.getItem('imageMarkerProjects') || '[]');
                    const projectName = projects[index].name;
                    
                    if (confirm(`Are you sure you want to delete the project "${projectName}"?`)) {
                        projects.splice(index, 1);
                        localStorage.setItem('imageMarkerProjects', JSON.stringify(projects));
                        updateProjectsList();
                        showToast(`Project "${projectName}" deleted`, 'success');
                    }
                });
            });
        }

        // Initialize the app
        function init() {
            updateProjectsList();
            
            // Hide marker info when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.marker') && !e.target.closest('.marker-info')) {
                    hideMarkerInfo();
                }
            });
            
            // Initialize link field visibility
            if (currentMarkerType === 'link') {
                linkGroup.classList.remove('hidden');
            } else {
                linkGroup.classList.add('hidden');
            }
        }

        // Run initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
