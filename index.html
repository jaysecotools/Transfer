    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Tasmania-specific wildlife and locations
        const tasmaniaWildlife = {
            tassie_devil: { name: "Tasmanian Devil", rarity: "endangered", habitat: "forest", indicator: "forest health", image: "ðŸ¦˜" },
            wedge_eagle: { name: "Wedge-tailed Eagle", rarity: "vulnerable", habitat: "varied", indicator: "ecosystem health", image: "ðŸ¦…" },
            platypus: { name: "Platypus", rarity: "rare", habitat: "riparian", indicator: "water quality", image: "ðŸ¦†" },
            quoll: { name: "Eastern Quoll", rarity: "endangered", habitat: "forest", indicator: "habitat quality", image: "ðŸ¾" },
            rosella: { name: "Green Rosella", rarity: "common", habitat: "forest", indicator: "forest health", image: "ðŸ¦" },
            pademelon: { name: "Tasmanian Pademelon", rarity: "common", habitat: "forest", indicator: "understory health", image: "ðŸ¦˜" },
            wombat: { name: "Common Wombat", rarity: "common", habitat: "forest", indicator: "soil health", image: "ðŸ»" },
            black_currawong: { name: "Black Currawong", rarity: "common", habitat: "forest", indicator: "forest health", image: "ðŸ¦" },
            Maugean_skate: { name: "Maugean Skate", rarity: "endangered", habitat: "harbour", indicator: "water quality", image: "ðŸ¦ž" },
            blue_gum: { name: "Tasmanian Blue Gum", rarity: "common", habitat: "forest", indicator: "forest maturity", image: "ðŸŒ³" }
        };

        // Tasmania facts for educational popups
        const tasmaniaFacts = [
            "Tasmania has some of the world's oldest trees, with Huon pines living over 3,000 years.",
            "The Tasmanian devil is the world's largest carnivorous marsupial.",
            "Tasmania's Tarkine rainforest is the second-largest temperate rainforest in the world.",
            "Over 40% of Tasmania is protected as national parks and reserves.",
            "Tasmania is home to 12 endemic bird species found nowhere else on Earth.",
            "The Maugean skate is a rare ray found only in Tasmania's Macquarie Harbour and Bathurst Harbour, making it one of the world's few estuarine skates and a species at extreme risk of extinction.",
            "Tasmania has some of the cleanest air in the world, measured at Cape Grim.",
            "The island was connected to mainland Australia until about 12,000 years ago.",
            "Tasmania has 18 national parks, covering diverse ecosystems from alpine to coastal.",
            "The Tasmanian wedge-tailed eagle has a wingspan of up to 2.3 meters."
        ];

        // Fundraiser and budget limits
        const FUNDRAISER_COOLDOWN_DAYS = 5;
        const MAX_BUDGET = 7500;

        // Achievement system - FIXED: Corrected all_projects achievement condition
        const achievements = [
            { id: "first_tree", name: "First Tree Planted", description: "Plant your first native tree", icon: "ðŸŒ±", condition: (data) => data.treesPlanted >= 1 },
            { id: "five_species", name: "Wildlife Observer", description: "Observe 5 different species", icon: "ðŸ¾", condition: (data) => data.wildlifeObserved.length >= 5 },
            { id: "health_75", name: "Ecosystem Steward", description: "Reach 75% ecosystem health", icon: "ðŸ’š", condition: (data) => data.ecosystemHealth >= 75 },
            { id: "all_locations", name: "Explorer", description: "Discover all locations", icon: "ðŸ—ºï¸", condition: (data) => data.locationsVisited.length >= Object.keys(locations).length },
            { id: "water_quality", name: "Water Guardian", description: "Achieve 80% water quality", icon: "ðŸ’§", condition: (data) => data.waterQuality >= 80 },
            { id: "carbon_100", name: "Carbon Champion", description: "Sequester 100 tons of carbon", icon: "ðŸŒ", condition: (data) => data.carbonSequestration >= 100 },
            { id: "volunteers_10", name: "Community Leader", description: "Recruit 10 volunteers", icon: "ðŸ‘¥", condition: (data) => data.volunteers >= 10 },
            { id: "all_projects", name: "Project Manager", description: "Complete all projects in one location", icon: "âœ…", condition: (data) => {
                return Object.values(data.unlockedProjects || {}).some(projects => projects && projects.length === 0);
            }},
            { id: "budget_5000", name: "Financial Manager", description: "Accumulate $5000 budget", icon: "ðŸ’°", condition: (data) => data.budget >= 5000 },
            { id: "all_achievements", name: "Master Conservationist", description: "Unlock all achievements", icon: "ðŸ†", condition: (data, achieved) => (achieved || data.achievementsUnlocked || []).length >= achievements.length - 1 }
        ];

        // Challenge modes
        const challengeModes = {
            normal: { name: "Standard Mode", description: "Standard gameplay with balanced economy" },
            time_attack: { name: "Time Attack", description: "Restore the ecosystem within 100 days", timeLimit: 100, budgetMultiplier: 1.2 },
            budget_restricted: { name: "Budget Restricted", description: "Limited funding with higher costs", budgetMultiplier: 0.7, costMultiplier: 1.3 },
            climate_crisis: { name: "Climate Crisis", description: "Increased climate events and challenges", eventFrequency: 2, climateSeverity: 1.5 }
        };

        // Tasmania-specific locations with projects
        const locations = {
            tarkine_forest: {
                name: "Tarkine Rainforest",
                description: "A vast temperate rainforest with ancient myrtle trees, lush ferns, and pristine rivers.",
                restorationPotential: "Very High",
                keySpecies: ["tassie_devil", "quoll", "platypus", "blue_gum"],
                threats: ["logging", "climate change", "invasive species"],
                coordinates: [-41.2, 145.0],
                biome: "temperate_rainforest",
                projects: [
                    { id: "plant_trees_tarkine", name: "Reforestation Program", cost: 120, effect: "Plant native trees to restore canopy cover", healthImpact: 10, biodiversityImpact: 8, waterImpact: 3 },
                    { id: "devil_tracking", name: "Devil Tracking Program", cost: 160, effect: "Monitor Tasmanian devil populations", healthImpact: 5, biodiversityImpact: 10 },
                    { id: "water_monitoring", name: "Water Quality Monitoring", cost: 80, effect: "Establish water quality monitoring stations", healthImpact: 3, waterImpact: 8 }
                ]
            },
            cradle_mountain: {
                name: "Cradle Mountain-Lake St Clair",
                description: "An alpine area with rugged mountains, glacial lakes, and diverse alpine vegetation.",
                restorationPotential: "High",
                keySpecies: ["wombat", "pademelon", "wedge_eagle", "black_currawong"],
                threats: ["climate change", "tourist impact", "feral animals"],
                coordinates: [-41.65, 145.95],
                biome: "alpine",
                projects: [
                    { id: "alpine_restoration", name: "Alpine Vegetation Restoration", cost: 150, effect: "Restore fragile alpine plant communities", healthImpact: 12, biodiversityImpact: 10 },
                    { id: "visitor_education", name: "Visitor Education Program", cost: 100, effect: "Educate tourists about conservation", healthImpact: 6, reputationImpact: 8 },
                    { id: "feral_control", name: "Feral Animal Control", cost: 200, effect: "Control feral cats and foxes", healthImpact: 8, biodiversityImpact: 12 }
                ]
            },
            freycinet: {
                name: "Freycinet Peninsula",
                description: "Coastal heathland with pink granite mountains, white sandy beaches, and abundant birdlife.",
                restorationPotential: "Medium",
                keySpecies: ["rosella", "wedge_eagle"],
                threats: ["coastal erosion", "tourist impact", "development"],
                coordinates: [-42.13, 148.3],
                biome: "coastal",
                projects: [
                    { id: "coastal_rehab", name: "Coastal Rehabilitation", cost: 140, effect: "Stabilize dunes and restore coastal vegetation", healthImpact: 10, biodiversityImpact: 7, waterImpact: 5 },
                    { id: "bird_monitoring", name: "Shorebird Monitoring", cost: 110, effect: "Monitor migratory shorebird populations", healthImpact: 4, biodiversityImpact: 9 },
                    { id: "marine_debris", name: "Marine Debris Cleanup", cost: 70, effect: "Remove plastic and debris from beaches", healthImpact: 6, waterImpact: 8 }
                ]
            },
            maria_island: {
                name: "Maria Island",
                description: "A island sanctuary with convict history, diverse ecosystems, and reintroduced wildlife.",
                restorationPotential: "High",
                keySpecies: ["tassie_devil", "wombat", "pademelon", "rosella"],
                threats: ["invasive species", "erosion", "climate change"],
                coordinates: [-42.63, 148.0],
                biome: "island",
                projects: [
                    { id: "species_reintroduction", name: "Species Reintroduction", cost: 250, effect: "Reintroduce native species to the island", healthImpact: 15, biodiversityImpact: 20 },
                    { id: "erosion_control", name: "Erosion Control", cost: 130, effect: "Stabilize soil and prevent erosion", healthImpact: 10, waterImpact: 7 },
                    { id: "invasive_removal", name: "Invasive Species Removal", cost: 150, effect: "Remove invasive plants and animals", healthImpact: 12, biodiversityImpact: 15 }
                ]
            },
            macquarie_harbor: {
                name: "Macquarie Harbor",
                description: "A large harbor with salmon farming and historical sites.",
                restorationPotential: "Medium",
                keySpecies: ["platypus", "maugean_skate", "black_currawong"],
                threats: ["aquaculture", "pollution", "water quality"],
                coordinates: [-42.3, 145.3],
                biome: "harbour",
                projects: [
                    { id: "harbour_restoration", name: "Harbour Restoration", cost: 180, effect: "Restore degraded harbour areas", healthImpact: 12, waterImpact: 15, biodiversityImpact: 10 },
                    { id: "water_quality", name: "Water Quality Improvement", cost: 150, effect: "Improve water quality through filtration", healthImpact: 8, waterImpact: 18 },
                    { id: "Maugean_skate_conservation", name: "Maugean skate Conservation", cost: 120, effect: "Protect endangered Maugean skate habitat", healthImpact: 7, biodiversityImpact: 12 }
                ]
            }
        };

        // Enhanced ecosystem data with more metrics - FIXED: Added proper storyLog initialization
        const initialEcosystemData = {
            shrubsPlanted: 0,
            treesPlanted: 0,
            wildlifeObserved: [],
            invasiveSpeciesRemoved: 0,
            ecosystemHealth: 50,
            biodiversityIndex: 30,
            carbonSequestration: 0,
            waterQuality: 40,
            locationsVisited: ['tarkine_forest'],
            currentLocation: 'tarkine_forest',
            season: 'spring',
            day: 1,
            budget: 1500,
            reputation: 50,
            educationLevel: 0,
            volunteers: 0,
            historicalData: [{day: 1, health: 50, biodiversity: 30, waterQuality: 40}],
            temperature: 12,
            rainfall: 80,
            co2Level: 410,
            policiesEnacted: [],
            climateEvents: [],
            gameMode: 'solo',
            npcTeam: [],
            chatMessages: [],
            unlockedProjects: {
                tarkine_forest: locations.tarkine_forest.projects.map(p => p.id)
            },
            achievementsUnlocked: [],
            challengeMode: 'normal',
            tutorialStep: 0,
            storyLog: [
                "ðŸŒ¿ Welcome to EcoQuest: Tasmania! Your mission is to restore balance to Tasmania's unique ecosystems.",
                "You arrive in the Tarkine rainforest, one of the last temperate rainforests in the world with ancient myrtle trees and lush ferns."
            ],
            lastFundraiserDay: 0 // Added for fundraiser cooldown tracking
        };

        // Tutorial steps
        const tutorialSteps = [
            { message: "Welcome to EcoQuest Tasmania! Click on actions to restore the ecosystem.", highlight: "choices" },
            { message: "Monitor your resources and ecosystem health in the dashboard.", highlight: "stats" },
            { message: "Explore new locations to discover more conservation opportunities.", highlight: "map" },
            { message: "Complete projects to make significant improvements to the environment.", highlight: "projects" },
            { message: "You're ready to explore on your own! Check the help section if you need guidance.", highlight: null }
        ];

        // More diverse initial choices
        const initialChoices = [
            { id: "plant_shrubs", text: "Plant native shrubs", cost: 40, time: 1 },
            { id: "remove_weeds", text: "Remove invasive species", cost: 15, time: 1 },
            { id: "observe_wildlife", text: "Observe wildlife", cost: 0, time: 1 },
            { id: "explore", text: "Explore nearby areas", cost: 0, time: 1, className: "bg-blue-100 border-blue-300" }
        ];

        // NPC team members
        const npcTeamMembers = [
            { id: "botanist", name: "Dr. Lily Chen", role: "Botanist", skills: ["plant_id", "restoration"], efficiency: 1.5, cost: 200, portrait: "ðŸ‘©â€ðŸ”¬" },
            { id: "ecologist", name: "David Wilson", role: "Ecologist", skills: ["wildlife", "monitoring"], efficiency: 1.3, cost: 180, portrait: "ðŸ‘¨â€ðŸ”¬" },
            { id: "ranger", name: "Sarah Jones", role: "Park Ranger", skills: ["management", "community"], efficiency: 1.2, cost: 150, portrait: "ðŸ‘©â€ðŸ’¼" },
            { id: "indigenous", name: "Michael Brown", role: "Indigenous Guide", skills: ["traditional_knowledge", "tracking"], efficiency: 1.4, cost: 170, portrait: "ðŸ‘¨â€ðŸŽ“" }
        ];

        // Policy options with costs and effects
        const policyOptions = [
            { id: "carbon_tax", name: "Carbon Tax", cost: 500, effect: "Reduces CO2 levels but may impact budget", co2Impact: -20, budgetImpact: -100, reputationImpact: 10 },
            { id: "renewable_incentives", name: "Renewable Energy Incentives", cost: 800, effect: "Lowers carbon footprint over time", co2Impact: -30, budgetImpact: -200, reputationImpact: 15 },
            { id: "conservation_funding", name: "Conservation Funding", cost: 1000, effect: "Increases ecosystem health metrics", healthImpact: 15, biodiversityImpact: 10, budgetImpact: -300, reputationImpact: 20 },
            { id: "education_reform", name: "Environmental Education", cost: 600, effect: "Raises public awareness and support", educationImpact: 25, reputationImpact: 15, volunteerImpact: 5 },
            { id: "water_regulations", name: "Water Quality Regulations", cost: 700, effect: "Improves water quality but may face opposition", waterQualityImpact: 20, reputationImpact: 5, budgetImpact: -250 },
            { id: "habitat_protection", name: "Habitat Protection Law", cost: 1200, effect: "Preserves critical habitats from development", healthImpact: 20, biodiversityImpact: 25, budgetImpact: -400, reputationImpact: 25 }
        ];

        // Climate events that can occur
        const climateEvents = [
            { id: "drought", name: "Drought", severity: "high", effect: "Reduces water availability and stresses ecosystems", healthImpact: -15, waterQualityImpact: -20, temperatureImpact: 3 },
            { id: "heatwave", name: "Heat Wave", severity: "medium", effect: "Increases temperature and evaporation", healthImpact: -10, temperatureImpact: 5 },
            { id: "flood", name: "Flood", severity: "medium", effect: "Causes erosion but can distribute nutrients", healthImpact: -5, waterQualityImpact: -15, biodiversityImpact: 5 },
            { id: "wildfire", name: "Wildfire", severity: "high", effect: "Destroys habitat but can renew ecosystems long-term", healthImpact: -30, biodiversityImpact: -20, temperatureImpact: 2 },
            { id: "storm", name: "Severe Storm", severity: "medium", effect: "Causes physical damage to restoration projects", healthImpact: -10, budgetImpact: -200 }
        ];

        // Tooltips for UI elements
        const tooltips = {
            ecosystemHealth: "Overall health of the ecosystem based on biodiversity, water quality, and habitat condition",
            biodiversityIndex: "Measure of species diversity in the area - higher is better",
            waterQuality: "Quality of water in rivers and harbours - affects aquatic life",
            budget: "Available funds for conservation actions - earn more through fundraising",
            reputation: "Public support for your conservation efforts - affects volunteer recruitment",
            volunteers: "Community members helping with conservation - provides passive benefits",
            temperature: "Average temperature - rising due to climate change",
            co2Level: "Atmospheric CO2 concentration - affects climate change",
            shrubsPlanted: "Number of native shrubs planted - improves habitat and reduces erosion",
            treesPlanted: "Number of native trees planted - provides habitat and sequesters carbon",
            invasiveSpeciesRemoved: "Number of invasive plants and animals removed - helps native species"
        };

        // AI model simulation with more sophisticated responses
        const generateAIResponse = (choice, ecosystemData, location) => {
            const { ecosystemHealth, biodiversityIndex, waterQuality, season, temperature, co2Level } = ecosystemData;
            
            const responses = {
                "plant_shrubs": [
                    `You plant native Tasmanian shrubs. ${season === 'spring' ? 'The spring rains will help them establish quickly.' : ''}`,
                    "Native shrubs take root, providing habitat for small animals and insects.",
                    "The newly planted shrubs help reduce erosion along the water's edge."
                ],
                "remove_weeds": [
                    `You remove invasive species. ${waterQuality < 50 ? 'You notice the water looks clearer already.' : ''}`,
                    "Manual weeding is slow but effective. You clear a small area of invasive species.",
                    "Removing weeds reduces competition for water and nutrients."
                ],
                "observe_wildlife": [
                    `You spot ${ecosystemHealth > 60 ? 'increased wildlife activity' : 'signs of struggling wildlife'}.`,
                    `${season === 'spring' ? 'Spring brings new life to the area.' : ''} You notice animal tracks and feeding signs.`,
                    "Careful observation reveals how species are interacting with the habitat."
                ],
                "explore": [
                    `You explore the area. ${biodiversityIndex > 40 ? 'The biodiversity seems richer here.' : ''}`,
                    "Exploring reveals connections between different parts of the ecosystem.",
                    "You find a area that would benefit from restoration efforts."
                ],
                "plant_trees": [
                    "You plant native trees. Their roots will stabilize the soil and provide shade.",
                    "Tree planting creates future canopy cover, cooling the area for wildlife.",
                    "New trees will eventually provide nesting sites for birds and habitat for insects."
                ],
                "build_habitat": [
                    "You construct brush piles for small mammals and reptiles to shelter in.",
                    "Creating habitat structures provides hiding places for native wildlife.",
                    "Installing nest boxes attracts birds that help control insects."
                ],
                "test_water": [
                    "You test the water's pH and find it slightly acidic but within acceptable range.",
                    "Water testing reveals good oxygen levels but some sediment pollution.",
                    "The water quality is improving but still shows signs of upstream impacts."
                ],
                "continue_exploring": [
                    "You venture further and find areas that could be restored.",
                    "Exploring reveals issues that need addressing.",
                    "You discover beautiful areas that support native species."
                ],
                "check_harbour": [
                    "The harbour is thriving with native plants and aquatic insects.",
                    "You notice invasive species are starting to take over part of the harbour.",
                    "The harbour acts as a natural filter, improving water quality."
                ],
                "educational_program": [
                    "You organize a community workshop on native plants. Attendance is good!",
                    "Local students participate in a habitat restoration field day.",
                    "Your educational efforts raise awareness about ecosystem conservation."
                ],
                "fundraiser": [
                    "You host a fundraiser and attract support from local businesses.",
                    "Community members donate to support your conservation work.",
                    "Your fundraising efforts secure resources for future projects."
                ],
                "recruit_volunteers": [
                    "You post volunteer opportunities and several people sign up to help.",
                    "Local community groups offer to participate in restoration days.",
                    "Your volunteer recruitment brings new energy and resources to the project."
                ],
                "research_grants": [
                    "You apply for and receive a small research grant to study the ecosystem.",
                    "A university partner provides funding for monitoring equipment.",
                    "Your grant application is successful, providing funds for restoration."
                ],
                "enact_policy": [
                    "The new policy begins to take effect, with mixed reactions from the community.",
                    "Implementing this policy requires careful balancing of economic and environmental concerns.",
                    "Stakeholders respond to the new regulations, creating both challenges and opportunities."
                ],
                "climate_mitigation": [
                    "Your mitigation efforts help buffer the ecosystem from climate impacts.",
                    "Implementing climate-resilient practices strengthens the ecosystem's ability to adapt.",
                    "The habitat modifications provide refuge for species affected by changing conditions."
                ],
                "hire_npc": [
                    "You recruit a specialist to join your team. Their expertise will be valuable.",
                    "A new team member joins your conservation effort, bringing specialized skills.",
                    "Adding expertise to your team improves your effectiveness."
                ],
                "clean_waterways": [
                    "You organize a community cleanup of local waterways, removing debris and pollutants.",
                    "Cleaning up the waterways improves habitat for aquatic species.",
                    "The water looks clearer after your cleanup efforts."
                ],
                "install_filtration": [
                    "You install natural filtration systems to improve water quality.",
                    "The new filtration systems help remove pollutants from runoff water.",
                    "Natural filtration improves water quality without chemical treatments."
                ],
                "plant_riparian": [
                    "You plant native vegetation along riverbanks to prevent erosion.",
                    "Riparian planting stabilizes banks and filters runoff before it enters waterways.",
                    "The new vegetation provides shade, cooling the water for aquatic life."
                ],
                "run_project": [
                    "You implement a conservation project in the area.",
                    "The project makes measurable improvements to the ecosystem.",
                    "Your conservation efforts are showing positive results."
                ]
            };

            // Select a random response from the appropriate array
            const possibleResponses = responses[choice.id] || [
                "Your action has consequences for the ecosystem.",
                "The environment responds to your intervention.",
                "Nature adapts to your conservation efforts."
            ];
            
            // Add climate context if relevant
            let response = possibleResponses[Math.floor(Math.random() * possibleResponses.length)];
            
            if (temperature > 20 && choice.id.includes("plant")) {
                response += " The warm weather makes this work challenging - these plants will need extra water to establish.";
            }
            
            if (choice.id === "run_project" && choice.projectId) {
                const project = locations[location]?.projects.find(p => p.id === choice.projectId);
                if (project) {
                    response = `You implement the ${project.name} project. ${project.effect}`;
                }
            }
            
            return response;
        };

        // More sophisticated ecosystem update function - FIXED: Proper storyLog handling
        const updateEcosystem = (choice, ecosystemData, currentLocation) => {
            const updatedData = { ...ecosystemData };
            const locationData = locations[currentLocation];
            const challengeMode = challengeModes[updatedData.challengeMode];
            
            // Apply challenge mode modifiers
            const costMultiplier = challengeMode.costMultiplier || 1;
            const budgetMultiplier = challengeMode.budgetMultiplier || 1;
            const eventFrequencyMultiplier = challengeMode.eventFrequency || 1;
            
            // Ensure storyLog exists
            if (!updatedData.storyLog) {
                updatedData.storyLog = [...initialEcosystemData.storyLog];
            }
            
            // Update based on action
            switch(choice.id) {
                case "plant_shrubs":
                    updatedData.shrubsPlanted += 1;
                    updatedData.ecosystemHealth += 5;
                    updatedData.biodiversityIndex += 3;
                    updatedData.carbonSequestration += 0.5;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "plant_trees":
                    updatedData.treesPlanted += 1;
                    updatedData.ecosystemHealth += 8;
                    updatedData.biodiversityIndex += 5;
                    updatedData.carbonSequestration += 5;
                    updatedData.waterQuality += 2;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "remove_weeds":
                    updatedData.invasiveSpeciesRemoved += 1;
                    updatedData.ecosystemHealth += 3;
                    updatedData.biodiversityIndex += 2;
                    updatedData.waterQuality += 1;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
// ... inside updateEcosystem, in the "observe_wildlife" case ...
case "observe_wildlife":
    // Improved: Allow "forest" species in forest biomes, "varied" everywhere
    const possibleNewSpecies = Object.keys(tasmaniaWildlife).filter(species => {
        if (updatedData.wildlifeObserved.includes(species)) return false;
        const habitat = tasmaniaWildlife[species].habitat;
        if (habitat === "varied") return true;
        if (habitat === "forest" && locationData.biome.includes("forest")) return true;
        return habitat === locationData.biome;
    });
    if (Math.random() < updatedData.biodiversityIndex / 100 && possibleNewSpecies.length > 0) {
        const newSpecies = possibleNewSpecies[Math.floor(Math.random() * possibleNewSpecies.length)];
        updatedData.wildlifeObserved.push(newSpecies);
        updatedData.biodiversityIndex += 2;
        if (!updatedData.storyLog) updatedData.storyLog = [];
        updatedData.storyLog.push(`ðŸ¦˜ You discovered a ${tasmaniaWildlife[newSpecies].name}!`);
    }
    updatedData.ecosystemHealth += 1;
    break;
                case "explore":
                    // Explore new locations
                    const unexploredLocations = Object.keys(locations).filter(
                        loc => !updatedData.locationsVisited.includes(loc)
                    );
                    if (unexploredLocations.length > 0 && Math.random() > 0.5) {
                        const newLocation = unexploredLocations[Math.floor(Math.random() * unexploredLocations.length)];
                        updatedData.locationsVisited.push(newLocation);
                        updatedData.currentLocation = newLocation;
                        
                        // Unlock all projects for this location
                        if (!updatedData.unlockedProjects[newLocation]) {
                            updatedData.unlockedProjects[newLocation] = locations[newLocation].projects.map(p => p.id);
                        }
                    }
                    updatedData.ecosystemHealth += 1;
                    break;
                case "test_water":
                    updatedData.waterQuality += 5;
                    updatedData.ecosystemHealth += 2;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "check_harbour":
                    if (!updatedData.locationsVisited.includes('macquarie_harbor')) {
                        updatedData.locationsVisited.push('macquarie_harbor');
                    }
                    if (!updatedData.wildlifeObserved.includes('platypus')) {
                        updatedData.wildlifeObserved.push('platypus');
                    }
                    updatedData.ecosystemHealth += 4;
                    updatedData.waterQuality += 5;
                    break;
                case "educational_program":
                    updatedData.educationLevel += 10;
                    updatedData.reputation += 5;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "fundraiser":
                    // Check if fundraiser is on cooldown
                    if (updatedData.lastFundraiserDay && 
                        updatedData.day - updatedData.lastFundraiserDay < FUNDRAISER_COOLDOWN_DAYS) {
                        // Still on cooldown - don't allow fundraising
                        if (!updatedData.storyLog) updatedData.storyLog = [];
                        updatedData.storyLog.push("â° Fundraising is on cooldown. You need to wait before organizing another fundraiser.");
                        break; // Exit early without processing the fundraiser
                    }
                    
                    // Check if budget is already at maximum
                    if (updatedData.budget >= MAX_BUDGET) {
                        if (!updatedData.storyLog) updatedData.storyLog = [];
                        updatedData.storyLog.push("ðŸ’° You've reached the maximum budget of $" + MAX_BUDGET + ". No need for more fundraising!");
                        break; // Exit early without processing the fundraiser
                    }
                    
                    // More effective fundraising based on reputation
                    const fundraisingAmount = (300 + Math.floor(Math.random() * 400) + (updatedData.reputation * 2)) * budgetMultiplier;
                    
                    // Apply the maximum budget limit
                    const newBudget = updatedData.budget + fundraisingAmount;
                    updatedData.budget = Math.min(newBudget, MAX_BUDGET);
                    
                    // Set cooldown
                    updatedData.lastFundraiserDay = updatedData.day;
                    
                    updatedData.reputation += 5;
                    
                    // Add message if we hit the cap
                    if (updatedData.budget >= MAX_BUDGET) {
                        if (!updatedData.storyLog) updatedData.storyLog = [];
                        updatedData.storyLog.push("ðŸŽ¯ You've reached the maximum budget of $" + MAX_BUDGET + "!");
                    }
                    break;
                case "recruit_volunteers":
                    updatedData.volunteers += 3 + Math.floor(Math.random() * 5);
                    updatedData.reputation += 4;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "research_grants":
                    updatedData.budget += (1500 + Math.floor(Math.random() * 2000)) * budgetMultiplier;
                    updatedData.reputation += 8;
                    break;
                case "enact_policy":
                    const policy = policyOptions.find(p => p.id === choice.policyId);
                    if (policy) {
                        updatedData.policiesEnacted.push(choice.policyId);
                        updatedData.budget += (policy.budgetImpact || 0) * budgetMultiplier;
                        updatedData.ecosystemHealth += policy.healthImpact || 0;
                        updatedData.biodiversityIndex += policy.biodiversityImpact || 0;
                        updatedData.waterQuality += policy.waterQualityImpact || 0;
                        updatedData.reputation += policy.reputationImpact || 0;
                        updatedData.co2Level += policy.co2Impact || 0;
                        if (policy.volunteerImpact) {
                            updatedData.volunteers += policy.volunteerImpact;
                        }
                    }
                    break;
                case "climate_mitigation":
                    updatedData.ecosystemHealth += 5;
                    updatedData.budget -= choice.cost * costMultiplier;
                    // Reduce severity of next climate event
                    if (updatedData.climateEvents.length > 0) {
                        updatedData.climateEvents[0].severity = "low";
                    }
                    break;
                case "hire_npc":
                    const npc = npcTeamMembers.find(m => m.id === choice.npcId);
                    if (npc && !updatedData.npcTeam.some(m => m.id === choice.npcId)) {
                        updatedData.npcTeam.push(npc);
                        updatedData.budget -= choice.cost * costMultiplier;
                    }
                    break;
                case "clean_waterways":
                    updatedData.waterQuality += 8;
                    updatedData.ecosystemHealth += 4;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "install_filtration":
                    updatedData.waterQuality += 10;
                    updatedData.ecosystemHealth += 5;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "plant_riparian":
                    updatedData.waterQuality += 12;
                    updatedData.ecosystemHealth += 6;
                    updatedData.biodiversityIndex += 4;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "run_project":
                    const project = locationData.projects.find(p => p.id === choice.projectId);
                    if (project) {
                        updatedData.ecosystemHealth += project.healthImpact || 0;
                        updatedData.biodiversityIndex += project.biodiversityImpact || 0;
                        updatedData.waterQuality += project.waterImpact || 0;
                        updatedData.budget -= project.cost * costMultiplier;
                        
                        // Mark project as completed
                        if (!updatedData.unlockedProjects[currentLocation]) {
                            updatedData.unlockedProjects[currentLocation] = [];
                        }
                        updatedData.unlockedProjects[currentLocation] = updatedData.unlockedProjects[currentLocation].filter(id => id !== project.id);
                    }
                    break;
                case "build_habitat":
                    updatedData.ecosystemHealth += 7;
                    updatedData.biodiversityIndex += 6;
                    updatedData.budget -= choice.cost * costMultiplier;
                    break;
                case "end_adventure":
                    // This case is handled separately in handleChoice function
                    break;
                default:
                    updatedData.ecosystemHealth += 1;
            }
            
            // NPC team effects
            updatedData.npcTeam.forEach(npc => {
                // Each NPC provides a bonus to certain actions
                updatedData.ecosystemHealth += 0.5 * npc.efficiency;
                updatedData.biodiversityIndex += 0.3 * npc.efficiency;
                updatedData.waterQuality += 0.2 * npc.efficiency;
            });
            
            // Natural water quality recovery (if no negative events)
            if (updatedData.climateEvents.length === 0 || !updatedData.climateEvents[0].active) {
                if (updatedData.waterQuality < 70) {
                    updatedData.waterQuality += 1;
                }
            }
            
            // Volunteer effects - volunteers help with fundraising
            if (updatedData.volunteers > 0) {
                // Volunteers improve various metrics
                updatedData.ecosystemHealth += Math.floor(updatedData.volunteers / 5);
                updatedData.waterQuality += Math.floor(updatedData.volunteers / 10);
                
                // Volunteers enable passive fundraising (respect budget cap)
                if (updatedData.day % 5 === 0 && updatedData.budget < MAX_BUDGET) {
                    const volunteerFundraising = Math.floor(updatedData.volunteers * 2.5) * budgetMultiplier;
                    const newBudget = updatedData.budget + volunteerFundraising;
                    updatedData.budget = Math.min(newBudget, MAX_BUDGET);
                }
            }
            
            // Update day and possibly season
            updatedData.day += choice.time || 1;
            
            // Check for time attack challenge failure
            if (updatedData.challengeMode === 'time_attack' && updatedData.day > challengeModes.time_attack.timeLimit && updatedData.ecosystemHealth < 80) {
                updatedData.gameCompleted = true;
                updatedData.gameCompletedReason = "Time Attack Challenge Failed";
            }
            
            if (updatedData.day % 30 === 0) {
                const seasons = ['spring', 'summer', 'autumn', 'winter'];
                const currentSeasonIndex = seasons.indexOf(updatedData.season);
                updatedData.season = seasons[(currentSeasonIndex + 1) % 4];
                
                // Seasonal effects (adjusted for Tasmania's climate)
                if (updatedData.season === 'spring') {
                    updatedData.ecosystemHealth += 5;
                    updatedData.rainfall += 10;
                    updatedData.waterQuality += 3;
                } else if (updatedData.season === 'summer') {
                    updatedData.temperature += 2;
                    updatedData.rainfall -= 5;
                    updatedData.waterQuality -= 2;
                } else if (updatedData.season === 'autumn') {
                    updatedData.temperature -= 2;
                    updatedData.waterQuality += 1;
                } else if (updatedData.season === 'winter') {
                    updatedData.temperature -= 3;
                    updatedData.rainfall += 5;
                    updatedData.waterQuality += 2;
                }
            }
            
            // Climate change effects - gradual changes over time
            if (updatedData.day % 10 === 0) {
                updatedData.temperature += 0.1;
                updatedData.co2Level += 0.5;
                
                // More extreme weather patterns
                if (Math.random() > 0.7) {
                    updatedData.rainfall += (Math.random() > 0.5 ? 5 : -5);
                }
            }
            
            // Random climate events (frequency affected by challenge mode)
            if (Math.random() < (0.1 * eventFrequencyMultiplier) && updatedData.day > 10) {
                const event = {...climateEvents[Math.floor(Math.random() * climateEvents.length)]};
                // Apply challenge mode severity modifier
                if (challengeMode.climateSeverity) {
                    event.healthImpact = Math.round(event.healthImpact * challengeMode.climateSeverity);
                    event.waterQualityImpact = Math.round(event.waterQualityImpact * challengeMode.climateSeverity);
                    event.biodiversityImpact = Math.round(event.biodiversityImpact * challengeMode.climateSeverity);
                    event.temperatureImpact = event.temperatureImpact * challengeMode.climateSeverity;
                    event.budgetImpact = Math.round(event.budgetImpact * challengeMode.climateSeverity);
                }
                
                updatedData.climateEvents.unshift({
                    ...event,
                    day: updatedData.day,
                    active: true
                });
                
                // Apply event effects
                updatedData.ecosystemHealth += event.healthImpact || 0;
                updatedData.waterQuality += event.waterQualityImpact || 0;
                updatedData.biodiversityIndex += event.biodiversityImpact || 0;
                updatedData.temperature += event.temperatureImpact || 0;
                updatedData.budget += event.budgetImpact || 0;
            }
            
            // Natural processes - ecosystem changes over time
            if (updatedData.ecosystemHealth > 70) {
                updatedData.biodiversityIndex += 1;
            }
            
            if (updatedData.waterQuality < 50 && updatedData.day % 5 === 0) {
                updatedData.ecosystemHealth -= 1;
            }
            
            // Policy effects
            updatedData.policiesEnacted.forEach(policyId => {
                const policy = policyOptions.find(p => p.id === policyId);
                if (policy) {
                    // Ongoing effects of policies
                    updatedData.co2Level += (policy.co2Impact || 0) / 10;
                }
            });
            
            // Cap values (including budget cap)
            updatedData.ecosystemHealth = Math.min(Math.max(updatedData.ecosystemHealth, 0), 100);
            updatedData.biodiversityIndex = Math.min(Math.max(updatedData.biodiversityIndex, 0), 100);
            updatedData.waterQuality = Math.min(Math.max(updatedData.waterQuality, 0), 100);
            updatedData.budget = Math.min(Math.max(updatedData.budget, 0), MAX_BUDGET); // Enforce budget cap
            updatedData.temperature = Math.min(Math.max(updatedData.temperature, -5), 35);
            updatedData.rainfall = Math.min(Math.max(updatedData.rainfall, 0), 200);
            
            // Add to historical data (throttled for performance)
            if (updatedData.day % 2 === 0 || updatedData.historicalData.length < 10) {
                updatedData.historicalData.push({
                    day: updatedData.day,
                    health: updatedData.ecosystemHealth,
                    biodiversity: updatedData.biodiversityIndex,
                    waterQuality: updatedData.waterQuality,
                    temperature: updatedData.temperature,
                    co2Level: updatedData.co2Level
                });
            }
            
// Check for achievements - FIXED: Proper achievement checking
achievements.forEach(achievement => {
    if (!updatedData.achievementsUnlocked.includes(achievement.id) && 
        achievement.condition(updatedData, updatedData.achievementsUnlocked)) {
        updatedData.achievementsUnlocked.push(achievement.id);
        // Ensure storyLog exists before pushing
        if (!updatedData.storyLog) updatedData.storyLog = [];
        updatedData.storyLog.push(`ðŸŽ‰ Achievement Unlocked: ${achievement.name}! ${achievement.description}`);
    }
});
            
            // Random Tasmania fact popup (5% chance)
            if (Math.random() < 0.05) {
                const randomFact = tasmaniaFacts[Math.floor(Math.random() * tasmaniaFacts.length)];
                if (!updatedData.storyLog) updatedData.storyLog = [];
                updatedData.storyLog.push(`ðŸ’¡ Tasmania Fact: ${randomFact}`);
            }
            
            return updatedData;
        };

        // More dynamic choice generation - FIXED: Improved choice generation logic
        const getNextChoices = (ecosystemData, currentLocation) => {
            const { ecosystemHealth, biodiversityIndex, budget, reputation, educationLevel, volunteers, locationsVisited, policiesEnacted, climateEvents, npcTeam, unlockedProjects, day, lastFundraiserDay } = ecosystemData;
            const challengeMode = challengeModes[ecosystemData.challengeMode];
            const costMultiplier = challengeMode.costMultiplier || 1;
            const budgetMultiplier = challengeMode.budgetMultiplier || 1;
            const eventFrequencyMultiplier = challengeMode.eventFrequency || 1;
            
            const baseChoices = [
                { id: "observe_wildlife", text: "Observe wildlife", cost: 0, time: 1 },
                { id: "explore", text: "Explore new areas", cost: 0, time: 1, className: "bg-blue-100 border-blue-300" }
            ];
            
            const specialChoices = [];
            
// Show hire NPC option if in team mode and you have enough budget, and haven't hired all professionals
if (
    ecosystemData.gameMode === 'team' &&
    ecosystemData.day >= 12 &&
    ecosystemData.reputation > 28 &&
    npcTeamMembers.some(npc => !ecosystemData.npcTeam.map(m => m.id).includes(npc.id)) &&
    budget >= Math.min(...npcTeamMembers.map(npc => npc.cost))
) {
    const hireableNPCs = npcTeamMembers.filter(npc =>
        !ecosystemData.npcTeam.map(m => m.id).includes(npc.id) &&
        budget >= npc.cost
    );
    
    // Only add ONE NPC option, choose randomly from available
    if (hireableNPCs.length > 0) {
        const npc = hireableNPCs[Math.floor(Math.random() * hireableNPCs.length)];
        specialChoices.push({
            id: "hire_npc",
            text: `Hire ${npc.name} (${npc.role})`,
            cost: npc.cost,
            time: 1,
            npcId: npc.id,
            className: "bg-blue-200 border-blue-400"
        });
    }
}

// Policy options - only show one at a time
if (
    ecosystemData.day >= 10 &&
    ecosystemData.reputation > 35 &&
    ecosystemData.budget >= 700
) {
    const availablePolicies = policyOptions.filter(policy =>
        !ecosystemData.policiesEnacted.includes(policy.id) &&
        ecosystemData.budget >= policy.cost * costMultiplier
    );
    
    // Only add ONE policy option, choose randomly from available
    if (availablePolicies.length > 0) {
        const policy = availablePolicies[Math.floor(Math.random() * availablePolicies.length)];
        specialChoices.push({
            id: "enact_policy",
            text: `Enact Policy: ${policy.name}`,
            cost: policy.cost,
            time: 2,
            policyId: policy.id,
            className: "policy-card"
        });
    }
}

// Project options - only show one at a time per location
if (
    ecosystemData.day >= 8 &&
    ecosystemData.reputation > 18 &&
    ecosystemData.budget >= 300 &&
    unlockedProjects &&
    unlockedProjects[currentLocation] &&
    unlockedProjects[currentLocation].length > 0
) {
    const availableProjects = locations[currentLocation].projects.filter(project =>
        unlockedProjects[currentLocation].includes(project.id) &&
        budget >= project.cost * costMultiplier
    );
    
    // Only add ONE project option, choose randomly from available
    if (availableProjects.length > 0) {
        const project = availableProjects[Math.floor(Math.random() * availableProjects.length)];
        specialChoices.push({
            id: "run_project",
            text: `Project: ${project.name}`,
            cost: project.cost,
            time: 2,
            projectId: project.id,
            className: "location-unlocked pulse-animation"
        });
    }
}
            
            // Add other actions based on budget and conditions
            if (budget >= 50 * costMultiplier) {
                specialChoices.push({ id: "plant_shrubs", text: "Plant native shrubs", cost: 50, time: 1 });
            }
            
            if (budget >= 20 * costMultiplier) {
                specialChoices.push({ id: "remove_weeds", text: "Remove invasive species", cost: 20, time: 1 });
            }
            
            if (budget >= 100 * costMultiplier) {
                specialChoices.push({ id: "plant_trees", text: "Plant native trees", cost: 100, time: 2, className: "tree-planting-action" });
            }

                // Only show harbour actions if currently at Macquarie Harbor
if (currentLocation === 'macquarie_harbor') {
    specialChoices.push({ id: "check_harbour", text: "Monitor harbour health", cost: 0, time: 1, className: "water-quality-action" });
            }
            
            // Add fundraising and volunteer actions based on reputation
            if (reputation >= 15) {
                // Check if fundraiser is available (not on cooldown and not at max budget)
                const isFundraiserOnCooldown = lastFundraiserDay && (day - lastFundraiserDay < FUNDRAISER_COOLDOWN_DAYS);
                const isAtMaxBudget = budget >= MAX_BUDGET;
                
                let fundraiserText = "Organize fundraiser";
                let fundraiserDisabled = false;
                let fundraiserClassName = "fundraising-action";
                
                if (isFundraiserOnCooldown) {
                    const daysLeft = FUNDRAISER_COOLDOWN_DAYS - (day - lastFundraiserDay);
                    fundraiserText = `Fundraiser (${daysLeft}d cooldown)`;
                    fundraiserDisabled = true;
                    fundraiserClassName += " opacity-50 cursor-not-allowed";
                } else if (isAtMaxBudget) {
                    fundraiserText = "Max Budget Reached";
                    fundraiserDisabled = true;
                    fundraiserClassName += " opacity-50 cursor-not-allowed";
                }
                
                specialChoices.push({ 
                    id: "fundraiser", 
                    text: fundraiserText, 
                    cost: 30, 
                    time: 2, 
                    className: fundraiserClassName,
                    disabled: fundraiserDisabled
                });
            }
            
            if (reputation >= 25) {
                specialChoices.push({ id: "recruit_volunteers", text: "Recruit volunteers", cost: 20, time: 1 });
            }
            
            // Always include "End Adventure" once significant progress is made
            if ((ecosystemHealth > 40 || biodiversityIndex > 35)) {
                specialChoices.push({ id: "end_adventure", text: "End Adventure", cost: 0, time: 0 });
            }
            
            // Combine all choices - special choices first, then base choices
            const allChoices = [...specialChoices, ...baseChoices];
            
            // Return up to 8 choices for better UI
            return allChoices.slice(0, 8);
        };

        // Map component for location visualization
        const LocationMap = ({ locationKey, onLocationChange }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef({});
            
            useEffect(() => {
                if (mapRef.current) {
                    // Initialize map if not already exists
                    if (!mapInstance.current) {
                        mapInstance.current = L.map(mapRef.current).setView([-42.5, 146.5], 7);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(mapInstance.current);
                        
                        // Add Tasmania outline
                        L.polygon([
                            [-40.68, 144.72],
                            [-40.68, 148.25],
                            [-43.63, 148.25],
                            [-43.63, 144.72]
                        ], {color: '#3388ff', weight: 2, fill: false}).addTo(mapInstance.current);
                    }
                    
                    // Clear existing markers
                    Object.values(markersRef.current).forEach(marker => {
                        if (mapInstance.current && marker) {
                            mapInstance.current.removeLayer(marker);
                        }
                    });
                    markersRef.current = {};
                    
                    // Add markers for all locations
                    Object.entries(locations).forEach(([key, location]) => {
                        const marker = L.marker(location.coordinates)
                            .addTo(mapInstance.current)
                            .bindPopup(`<b>${location.name}</b><br>${location.description}`);
                        
                        markersRef.current[key] = marker;
                        
                        // Make marker clickable to change location
                        marker.on('click', () => {
                            if (onLocationChange) {
                                onLocationChange(key);
                            }
                        });
                    });
                    
                    // Highlight current location
                    if (locationKey && markersRef.current[locationKey]) {
                        markersRef.current[locationKey].openPopup();
                    }
                }
                
                return () => {
                    // Clean up map instance when component unmounts
                    if (mapInstance.current) {
                        mapInstance.current.remove();
                        mapInstance.current = null;
                    }
                };
            }, [locationKey, onLocationChange]);
            
            return <div id="map" ref={mapRef} />;
        };

        // Chart component for data visualization
        const EcosystemChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            useEffect(() => {
                if (chartRef.current && data && data.length > 0) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Destroy previous chart if it exists
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    // Create new chart
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => `Day ${d.day}`),
                            datasets: [
                                {
                                    label: 'Ecosystem Health',
                                    data: data.map(d => d.health),
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Biodiversity Index',
                                    data: data.map(d => d.biodiversity),
                                    borderColor: 'rgb(153, 102, 255)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Water Quality',
                                    data: data.map(d => d.waterQuality),
                                    borderColor: 'rgb(54, 162, 235)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Temperature (Â°C)',
                                    data: data.map(d => d.temperature),
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1,
                                    fill: false,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Ecosystem Metrics Over Time'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Percentage'
                                    }
                                },
                                y1: {
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Temperature (Â°C)'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });
                } else if (chartRef.current) {
                    // Clear canvas if no data
                    const ctx = chartRef.current.getContext('2d');
                    ctx.clearRect(0, 0, chartRef.current.width, chartRef.current.height);
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    }
                };
            }, [data]);
            
            return <canvas ref={chartRef} />;
        };

        // Climate chart component
        const ClimateChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            useEffect(() => {
                if (chartRef.current && data && data.length > 0) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Destroy previous chart if it exists
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    // Create new chart
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => `Day ${d.day}`),
                            datasets: [
                                {
                                    label: 'Temperature (Â°C)',
                                    data: data.map(d => d.temperature),
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'CO2 Level (ppm)',
                                    data: data.map(d => d.co2Level),
                                    borderColor: 'rgb(100, 100, 100)',
                                    tension: 0.1,
                                    fill: false,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Climate Metrics Over Time'
                                }
                            },
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Temperature (Â°C)'
                                    }
                                },
                                y1: {
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'CO2 (ppm)'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });
                } else if (chartRef.current) {
                    // Clear canvas if no data
                    const ctx = chartRef.current.getContext('2d');
                    ctx.clearRect(0, 0, chartRef.current.width, chartRef.current.height);
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    }
                };
            }, [data]);
            
            return <canvas ref={chartRef} />;
        };

        // Tooltip component
        const Tooltip = ({ text, children }) => {
            return (
                <div className="tooltip">
                    {children}
                    <span className="tooltiptext">{text}</span>
                </div>
            );
        };

        // Seasonal overlay component
        const SeasonalOverlay = ({ season }) => {
            return <div className={`seasonal-overlay ${season}-overlay`}></div>;
        };

        // Time-lapse replay component
        const ReplaySlider = ({ historicalData, currentDay, onDayChange }) => {
            return (
                <div className="mt-4 p-4 bg-white rounded-lg shadow">
                    <h3 className="text-lg font-medium text-green-700 mb-2">Time-Lapse Replay</h3>
                    <input 
                        type="range" 
                        min="1" 
                        max={historicalData[historicalData.length - 1]?.day || 1} 
                        value={currentDay} 
                        onChange={(e) => onDayChange(parseInt(e.target.value))}
                        className="replay-slider"
                    />
                    <div className="flex justify-between text-sm text-gray-600 mt-2">
                        <span>Day 1</span>
                        <span>Day {currentDay}</span>
                        <span>Day {historicalData[historicalData.length - 1]?.day || 1}</span>
                    </div>
                </div>
            );
        };

        // Main component
        function EcoQuest() {
            const [gameStarted, setGameStarted] = useState(false);
            const [gameModeSelected, setGameModeSelected] = useState(false);
            const [gameCompleted, setGameCompleted] = useState(false);
            const [gameCompletedReason, setGameCompletedReason] = useState("");
            const [storyLog, setStoryLog] = useState(initialEcosystemData.storyLog);
            const [ecosystemData, setEcosystemData] = useState(() => {
                // Load saved game data from localStorage if available
                const savedData = localStorage.getItem('ecoQuestSaveData');
                return savedData ? JSON.parse(savedData) : initialEcosystemData;
            });
            const [currentChoices, setCurrentChoices] = useState(initialChoices);
            const [currentLocation, setCurrentLocation] = useState('tarkine_forest');
            const [showCharts, setShowCharts] = useState(false);
            const [showClimateChart, setShowClimateChart] = useState(false);
            const [weatherData, setWeatherData] = useState(null);
            const [showAchievements, setShowAchievements] = useState(false);
            const [showTutorial, setShowTutorial] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [replayDay, setReplayDay] = useState(null);
            const [showShareModal, setShowShareModal] = useState(false);
            const [showAllAchievements, setShowAllAchievements] = useState(true);

            // Save game data to localStorage whenever it changes
            useEffect(() => {
                if (gameStarted) {
                    localStorage.setItem('ecoQuestSaveData', JSON.stringify(ecosystemData));
                }
            }, [ecosystemData, gameStarted]);

            // Function to fetch Tasmania weather data (simulated)
            const fetchWeatherData = async (coordinates) => {
                // Simulated Tasmania weather data
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const baseTemp = 8 + (Math.random() * 12);
                        const rainfall = 30 + (Math.random() * 70);
                        resolve({
                            temperature: Math.round(baseTemp * 10) / 10,
                            rainfall: Math.round(rainfall * 10) / 10,
                            conditions: rainfall > 70 ? "rainy" : rainfall > 40 ? "cloudy" : "sunny"
                        });
                    }, 500);
                });
            };

            useEffect(() => {
                // Fetch weather data when location changes
                const fetchData = async () => {
                    const data = await fetchWeatherData(locations[currentLocation].coordinates);
                    setWeatherData(data);
                };
                
                if (gameStarted && !gameCompleted) {
                    fetchData();
                }
            }, [currentLocation, gameStarted, gameCompleted]);

const handleChoice = (choice) => {
    if (choice.id === "end_adventure") {
        setGameCompleted(true);
        setGameCompletedReason("Adventure Completed Successfully!");
        return;
    }
    
    // Generate AI response
    const response = generateAIResponse(choice, ecosystemData, currentLocation);
    
// Helper function to generate action descriptions
const getActionDescription = (choice, currentLocation) => {
    const locationName = locations[currentLocation]?.name || "the area";
    
    const actionDescriptions = {
        "plant_shrubs": `ðŸŒ¿ You planted native shrubs in ${locationName}.`,
        "remove_weeds": `ðŸŒ± You removed invasive species from ${locationName}.`,
        "observe_wildlife": `ðŸ” You spent time observing wildlife in ${locationName}.`,
        "explore": `ðŸ—ºï¸ You explored new areas around ${locationName}.`,
        "plant_trees": `ðŸŒ³ You planted native trees in ${locationName}.`,
        "build_habitat": `ðŸ  You built habitat structures in ${locationName}.`,
        "test_water": `ðŸ’§ You tested water quality in ${locationName}.`,
        "check_harbour": `âš“ You monitored the harbour health at ${locationName}.`,
        "educational_program": `ðŸ“š You organized an educational program in ${locationName}.`,
        "fundraiser": `ðŸ’° You hosted a fundraising event for ${locationName}.`,
        "recruit_volunteers": `ðŸ‘¥ You recruited volunteers to help in ${locationName}.`,
        "research_grants": `ðŸ“Š You applied for research grants for ${locationName}.`,
        "enact_policy": `ðŸ“œ You enacted a new conservation policy for ${locationName}.`,
        "climate_mitigation": `ðŸŒ You implemented climate mitigation measures in ${locationName}.`,
        "hire_npc": `ðŸ‘¨â€ðŸ”¬ You hired a specialist to join your team.`,
        "clean_waterways": `ðŸš® You cleaned up waterways in ${locationName}.`,
        "install_filtration": `âš—ï¸ You installed water filtration systems in ${locationName}.`,
        "plant_riparian": `ðŸŒŠ You planted riparian vegetation along waterways in ${locationName}.`,
        "run_project": `ðŸš€ You started a new project in ${locationName}.`
    };
    
    // Special handling for project runs
    if (choice.id === "run_project" && choice.projectId) {
        const project = locations[currentLocation]?.projects.find(p => p.id === choice.projectId);
        if (project) {
            return `ðŸš€ You started the "${project.name}" project in ${locationName}.`;
        }
    }
    
    // Special handling for NPC hiring
    if (choice.id === "hire_npc" && choice.npcId) {
        const npc = npcTeamMembers.find(m => m.id === choice.npcId);
        if (npc) {
            return `ðŸ‘¨â€ðŸ”¬ You hired ${npc.name} (${npc.role}) to join your team.`;
        }
    }
    
    // Special handling for policy enactment
    if (choice.id === "enact_policy" && choice.policyId) {
        const policy = policyOptions.find(p => p.id === choice.policyId);
        if (policy) {
            return `ðŸ“œ You enacted the "${policy.name}" policy.`;
        }
    }
    
    return actionDescriptions[choice.id] || `âš¡ You took action in ${locationName}.`;
};

    // Update ecosystem data
    const updatedEcosystem = updateEcosystem(choice, ecosystemData, currentLocation);
    setEcosystemData(updatedEcosystem);
    
    // Add the action description to story log BEFORE the AI response
    const actionDescription = getActionDescription(choice, currentLocation);
    const newStoryLog = [...(updatedEcosystem.storyLog || []), actionDescription, response];
    
    // Update story log with both action and response
    setStoryLog(newStoryLog);
    
    // Update the ecosystem data with the new story log
    setEcosystemData(prev => ({
        ...prev,
        storyLog: newStoryLog
    }));
    
    // Determine next choices
    const nextChoices = getNextChoices(updatedEcosystem, currentLocation);
    setCurrentChoices(nextChoices);
    
    // Possibly change location based on exploration
    if (choice.id === "explore" && updatedEcosystem.locationsVisited.length > ecosystemData.locationsVisited.length) {
        const newLocation = updatedEcosystem.locationsVisited[updatedEcosystem.locationsVisited.length - 1];
        setCurrentLocation(newLocation);
        setStoryLog(prevLog => [...prevLog, `You've discovered a new area: ${locations[newLocation].name}! This location now has projects available.`]);
    }

    // Advance tutorial if needed
    if (updatedEcosystem.tutorialStep < tutorialSteps.length - 1) {
        if (updatedEcosystem.tutorialStep === 0 && choice.id !== "observe_wildlife") {
            setEcosystemData(prev => ({...prev, tutorialStep: 1}));
        } else if (updatedEcosystem.tutorialStep === 1 && choice.id === "explore") {
            setEcosystemData(prev => ({...prev, tutorialStep: 2}));
        } else if (updatedEcosystem.tutorialStep === 2 && choice.id.includes("run_project")) {
            setEcosystemData(prev => ({...prev, tutorialStep: 3}));
        } else if (updatedEcosystem.tutorialStep === 3 && updatedEcosystem.day > 5) {
            setEcosystemData(prev => ({...prev, tutorialStep: 4}));
        }
    }
};

            const handleLocationChange = (locationKey) => {
                if (ecosystemData.locationsVisited.includes(locationKey)) {
                    setCurrentLocation(locationKey);
                    setStoryLog(prevLog => [...prevLog, `You travel to ${locations[locationKey].name}.`]);
                    
                    // Update choices for the new location
                    const nextChoices = getNextChoices(ecosystemData, locationKey);
                    setCurrentChoices(nextChoices);
                }
            };

            const startGame = (mode) => {
                setEcosystemData(prev => ({
                    ...prev,
                    gameMode: mode
                }));
                setGameModeSelected(true);
                setGameStarted(true);
            };

            const restartGame = () => {
                setGameStarted(false);
                setGameModeSelected(false);
                setGameCompleted(false);
                setGameCompletedReason("");
                setStoryLog(initialEcosystemData.storyLog);
                setEcosystemData(initialEcosystemData);
                setCurrentChoices(initialChoices);
                setCurrentLocation('tarkine_forest');
                setWeatherData(null);
                setReplayDay(null);
                setShowAllAchievements(true);
                localStorage.removeItem('ecoQuestSaveData');
            };

            const loadGame = () => {
                const savedData = localStorage.getItem('ecoQuestSaveData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    setEcosystemData(data);
                    setGameModeSelected(true);
                    setGameStarted(true);
                    setCurrentLocation(data.currentLocation);
                    setStoryLog(data.storyLog || initialEcosystemData.storyLog);
                    
                    // Update choices for the loaded location
                    const nextChoices = getNextChoices(data, data.currentLocation);
                    setCurrentChoices(nextChoices);
                }
            };

            const shareResults = () => {
                const text = `I restored Tasmania's ecosystem to ${ecosystemData.ecosystemHealth}% health in EcoQuest! 
Planted ${ecosystemData.treesPlanted} trees and observed ${ecosystemData.wildlifeObserved.length} species. 
Try it yourself at: ${window.location.href}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'EcoQuest Tasmania Results',
                        text: text,
                        url: window.location.href
                    });
                } else {
                    navigator.clipboard.writeText(text);
                    setStoryLog(prev => [...prev, "Results copied to clipboard!"]);
                }
                setShowShareModal(false);
            };

            const changeChallengeMode = (mode) => {
                setEcosystemData(prev => ({...prev, challengeMode: mode}));
                setStoryLog(prev => [...prev, `Challenge mode changed to: ${challengeModes[mode].name}`]);
            };

            // Auto-scroll to bottom of story panel
            const storyPanelRef = useRef(null);
            useEffect(() => {
                if (storyPanelRef.current) {
                    storyPanelRef.current.scrollTop = storyPanelRef.current.scrollHeight;
                }
            }, [storyLog]);

            // Get current data for replay slider
            const getReplayData = useCallback(() => {
                if (replayDay === null) return ecosystemData;
                
                const historicalData = ecosystemData.historicalData;
                const dataForDay = historicalData.find(d => d.day === replayDay) || 
                                  historicalData.reduce((prev, curr) => 
                                    Math.abs(curr.day - replayDay) < Math.abs(prev.day - replayDay) ? curr : prev);
                
                return {
                    ...ecosystemData,
                    ecosystemHealth: dataForDay.health,
                    biodiversityIndex: dataForDay.biodiversity,
                    waterQuality: dataForDay.waterQuality,
                    temperature: dataForDay.temperature,
                    co2Level: dataForDay.co2Level
                };
            }, [replayDay, ecosystemData]);

            const displayData = replayDay !== null ? getReplayData() : ecosystemData;

            return (
                <div className="min-h-screen p-4 md:p-6">
                    <SeasonalOverlay season={displayData.season} />
                    
                    {!gameModeSelected ? (
                        // Game Mode Selection Page
                        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-10 text-center fade-in">
                            <h1 className="text-4xl font-bold text-green-800 mb-4">ðŸŒ± EcoQuest: Tasmania</h1>
                            <h2 className="text-2xl font-semibold text-green-700 mb-6">Choose Your Adventure Mode</h2>
                            <p className="text-gray-600 mb-8 text-lg">
                                Explore Tasmania's unique ecosystems and work to protect its endangered species.
                            </p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div 
                                    className="border-2 border-green-200 rounded-xl p-6 cursor-pointer hover:bg-green-50 transition-colors"
                                    onClick={() => startGame('solo')}
                                >
                                    <div className="text-4xl mb-4">ðŸ‘¤</div>
                                    <h3 className="text-xl font-semibold text-green-700 mb-2">Solo Explorer</h3>
                                    <p className="text-gray-600">Work alone to restore Tasmania's ecosystems at your own pace.</p>
                                    <ul className="text-left text-gray-600 mt-4 space-y-2 text-sm">
                                        <li className="flex items-start">
                                            <span className="text-green-500 mr-2">â€¢</span>
                                            <span>More focused decision-making</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-green-500 mr-2">â€¢</span>
                                            <span>Complete control over strategies</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-green-500 mr-2">â€¢</span>
                                            <span>Slower progress but full autonomy</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div 
                                    className="border-2 border-blue-200 rounded-xl p-6 cursor-pointer hover:bg-blue-50 transition-colors"
                                    onClick={() => startGame('team')}
                                >
                                    <div className="text-4xl mb-4">ðŸ‘¥</div>
                                    <h3 className="text-xl font-semibold text-blue-700 mb-2">Team Leader</h3>
                                    <p className="text-gray-600">Build a team of specialists to tackle complex conservation challenges.</p>
                                    <ul className="text-left text-gray-600 mt-4 space-y-2 text-sm">
                                        <li className="flex items-start">
                                            <span className="text-blue-500 mr-2">â€¢</span>
                                            <span>Hire NPC specialists with unique skills</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-blue-500 mr-2">â€¢</span>
                                            <span>Faster progress with team bonuses</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-blue-500 mr-2">â€¢</span>
                                            <span>More complex management required</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div className="border-t pt-6">
                                <h3 className="text-lg font-medium text-green-700 mb-3">Tasmanian Regions</h3>
                                <div className="flex flex-wrap justify-center gap-2">
                                    {Object.values(locations).map((location, idx) => (
                                        <span key={idx} className="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full">
                                            {location.name}
                                        </span>
                                    ))}
                                </div>
                            </div>

                            <div className="mt-6">
                                <button 
                                    onClick={loadGame}
                                    className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition btn-hover flex items-center mx-auto"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd" />
                                    </svg>
                                    Load Saved Game
                                </button>
                            </div>
                        </div>
                    ) : !gameStarted ? (
                        // Landing Page
                        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-10 text-center fade-in">
                            <h1 className="text-4xl font-bold text-green-800 mb-4">ðŸŒ± EcoQuest: Tasmania</h1>
                            <h2 className="text-2xl font-semibold text-green-700 mb-6">Interactive Ecosystem Management</h2>
                            <p className="text-gray-600 mb-8 text-lg">
                                Embark on an interactive conservation adventure where your choices shape Tasmania's unique ecosystems. 
                                Restore balance to threatened landscapes and protect endangered species.
                            </p>
                            <button 
                                onClick={() => setGameStarted(true)}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 btn-hover pulse-animation"
                            >
                                Start Adventure
                            </button>
                            
                            <div className="mt-10 border-t pt-6">
                                <h3 className="text-lg font-medium text-green-700 mb-3">How to Play</h3>
                                <ul className="text-left text-gray-600 space-y-2 max-w-md mx-auto">
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">â€¢</span>
                                        <span>Make strategic choices to restore ecosystems</span>
                                    </li>
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">â€¢</span>
                                        <span>Manage limited resources and budget effectively</span>
                                    </li>
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">â€¢</span>
                                        <span>Track multiple environmental metrics over time</span>
                                    </li>
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">â€¢</span>
                                        <span>Discover Tasmania's unique locations and wildlife</span>
                                    </li>
                                    <li className="flex items-start">
                                        <span className="text-green-500 mr-2">â€¢</span>
                                        <span>{ecosystemData.gameMode === 'team' ? 'Build and manage your conservation team' : 'Work solo to restore ecosystems'}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    ) : gameCompleted ? (
                        // Game Completion Screen
                        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-10 text-center fade-in">
                            <h1 className="text-4xl font-bold text-green-800 mb-4">ðŸ† {gameCompletedReason || "Adventure Complete!"}</h1>
                            <h2 className="text-2xl font-semibold text-green-700 mb-6">Your Conservation Results</h2>
                            
                            <div className="mb-6 p-4 bg-green-50 rounded-lg">
                                <h3 className="text-lg font-medium text-green-700 mb-2">Final Ecosystem Health: {ecosystemData.ecosystemHealth}%</h3>
                                <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                    <div 
                                        className="bg-green-600 h-4 rounded-full transition-all duration-500 health-bar" 
                                        style={{ width: `${ecosystemData.ecosystemHealth}%` }}
                                    ></div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4 text-left">
                                    <div>
                                        <p className="font-medium">Biodiversity Index</p>
                                        <p>{ecosystemData.biodiversityIndex}%</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">Water Quality</p>
                                        <p>{ecosystemData.waterQuality}%</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">Carbon Sequestered</p>
                                        <p>{ecosystemData.carbonSequestration.toFixed(1)} tons</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">Species Observed</p>
                                        <p>{ecosystemData.wildlifeObserved.length}</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">Temperature Change</p>
                                        <p>+{(ecosystemData.temperature - 12).toFixed(1)}Â°C</p>
                                    </div>
                                    <div>
                                        <p className="font-medium">CO2 Level</p>
                                        <p>{ecosystemData.co2Level.toFixed(1)} ppm</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex flex-wrap justify-center gap-4 mb-6">
                                <button 
                                    onClick={restartGame}
                                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 btn-hover"
                                >
                                    Play Again
                                </button>
                                
                                <button 
                                    onClick={() => setShowShareModal(true)}
                                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 btn-hover"
                                >
                                    Share Results
                                </button>
                            </div>
                            
                            <div className="mt-6 space-y-4">
                                <button 
                                    onClick={() => setShowCharts(!showCharts)}
                                    className="text-green-600 hover:text-green-800 font-medium mx-2"
                                >
                                    {showCharts ? 'Hide' : 'Show'} Progress Charts
                                </button>
                                
                                <button 
                                    onClick={() => setShowClimateChart(!showClimateChart)}
                                    className="text-green-600 hover:text-green-800 font-medium mx-2"
                                >
                                    {showClimateChart ? 'Hide' : 'Show'} Climate Charts
                                </button>
                                
                                <button 
                                    onClick={() => setShowAchievements(!showAchievements)}
                                    className="text-green-600 hover:text-green-800 font-medium mx-2"
                                >
                                    {showAchievements ? 'Hide' : 'Show'} Achievements
                                </button>
                                
                                {showCharts && (
                                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                        <EcosystemChart data={ecosystemData.historicalData} />
                                    </div>
                                )}
                                
                                {showClimateChart && (
                                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                        <ClimateChart data={ecosystemData.historicalData} />
                                    </div>
                                )}
                                
                                {showAchievements && (
                                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-lg font-medium text-green-700">Your Achievements</h3>
                                            <div className="flex items-center space-x-2">
                                                <span className="text-sm text-gray-600">{showAllAchievements ? 'Showing All' : 'Achieved Only'}</span>
                                                <button 
                                                    onClick={() => setShowAllAchievements(!showAllAchievements)}
                                                    className="text-sm bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded transition"
                                                >
                                                    {showAllAchievements ? 'Show Achieved Only' : 'Show All'}
                                                </button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            {achievements
                                                .filter(a => showAllAchievements || ecosystemData.achievementsUnlocked.includes(a.id))
                                                .map(achievement => (
                                                    <div key={achievement.id} className={`p-3 rounded-lg text-center ${ecosystemData.achievementsUnlocked.includes(achievement.id) ? 'bg-green-100 border border-green-300' : 'bg-gray-100 opacity-50'}`}>
                                                        <div className="achievement-badge">
                                                            {achievement.icon}
                                                        </div>
                                                        <h4 className="font-medium text-sm">{achievement.name}</h4>
                                                        <p className="text-xs text-gray-600">{achievement.description}</p>
                                                        {!ecosystemData.achievementsUnlocked.includes(achievement.id) && (
                                                            <p className="text-xs text-red-500 mt-1">Locked</p>
                                                        )}
                                                    </div>
                                                ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        // Game Interface
                        <div className="max-w-7xl mx-auto fade-in">
                            <header className="flex justify-between items-center mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-green-800 flex items-center">
                                        <span className="mr-2">ðŸŒ¿</span> EcoQuest: Tasmania
                                    </h1>
                                    <p className="text-green-600">
                                        {ecosystemData.gameMode === 'solo' ? 'Solo Explorer' : 'Team Leader'} Mode â€¢ {challengeModes[ecosystemData.challengeMode].name}
                                    </p>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <div className="bg-white rounded-lg py-1 px-3 shadow-sm">
                                        <span className="text-green-700 font-medium">Day {displayData.day}</span>
                                        <span className="mx-2">â€¢</span>
                                        <span className="text-green-600 capitalize">{displayData.season}</span>
                                    </div>
                                    
                                    <button 
                                        onClick={() => setShowSettings(!showSettings)}
                                        className="bg-white hover:bg-gray-100 text-gray-800 font-medium py-2 px-4 rounded-lg transition btn-hover flex items-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" />
                                        </svg>
                                        Settings
                                    </button>

                                    <button 
                                        onClick={() => setShowCharts(!showCharts)}
                                        className="bg-white hover:bg-gray-100 text-gray-800 font-medium py-2 px-4 rounded-lg transition btn-hover flex items-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                                        </svg>
                                        {showCharts ? 'Hide Charts' : 'Show Charts'}
                                    </button>
                                    
                                    <button 
                                        onClick={() => setShowTutorial(true)}
                                        className="bg-white hover:bg-gray-100 text-gray-800 font-medium py-2 px-4 rounded-lg transition btn-hover flex items-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" />
                                        </svg>
                                        Help
                                    </button>
                                    
                                    <button 
                                        onClick={restartGame}
                                        className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition btn-hover flex items-center"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd" />
                                        </svg>
                                        Restart
                                    </button>
                                </div>
                            </header>
                            
                            {showSettings && (
                                <div className="mb-6 bg-white rounded-xl shadow-md p-6">
                                    <h2 className="text-xl font-semibold text-green-700 mb-4">Game Settings</h2>
                                    
                                    <div className="mb-4">
                                        <h3 className="text-lg font-medium text-green-700 mb-2">Challenge Mode</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {Object.entries(challengeModes).map(([key, mode]) => (
                                                <div 
                                                    key={key}
                                                    className={`p-4 border rounded-lg cursor-pointer transition-colors ${ecosystemData.challengeMode === key ? 'challenge-mode border-orange-500' : 'border-gray-200 hover:bg-gray-50'}`}
                                                    onClick={() => changeChallengeMode(key)}
                                                >
                                                    <h4 className="font-medium">{mode.name}</h4>
                                                    <p className="text-sm text-gray-600">{mode.description}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div className="flex justify-end space-x-4">
                                        <button 
                                            onClick={() => setShowSettings(false)}
                                            className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition"
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                            )}

                            {showCharts && (
                                <div className="mb-6 bg-white rounded-xl shadow-md p-4">
                                    <EcosystemChart data={ecosystemData.historicalData} />
                                    <div className="mt-4">
                                        <ClimateChart data={ecosystemData.historicalData} />
                                    </div>
                                </div>
                            )}
                            
                            {showTutorial && (
                                <div className="mb-6 bg-white rounded-xl shadow-md p-6">
                                    <h2 className="text-xl font-semibold text-green-700 mb-4">Game Guide</h2>
                                    
                                    <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                                        <h3 className="text-lg font-medium text-blue-700 mb-2">Current Tip</h3>
                                        <p>{tutorialSteps[ecosystemData.tutorialStep].message}</p>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <h3 className="text-lg font-medium text-green-700 mb-2">Game Basics</h3>
                                        <ul className="space-y-2">
                                            <li className="flex items-start">
                                                <span className="text-green-500 mr-2">â€¢</span>
                                                <span>Choose actions to improve ecosystem health, biodiversity, and water quality</span>
                                            </li>
                                            <li className="flex items-start">
                                                <span className="text-green-500 mr-2">â€¢</span>
                                                <span>Manage your budget carefully - some actions cost money</span>
                                            </li>
                                            <li className="flex items-start">
                                                <span className="text-green-500 mr-2">â€¢</span>
                                                <span>Explore new locations to discover more conservation opportunities</span>
                                            </li>
                                            <li className="flex items-start">
                                                <span className="text-green-500 mr-2">â€¢</span>
                                                <span>Complete projects for significant ecosystem improvements</span>
                                            </li>
                                            <li className="flex items-start">
                                                <span className="text-green-500 mr-2">â€¢</span>
                                                <span>Watch for climate events that can impact your progress</span>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <div className="flex justify-end">
                                        <div className="flex space-x-2">
                                            <a 
                                                href="USER_GUIDE.md" 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clipRule="evenodd" />
                                                </svg>
                                                View Full Guide
                                            </a>
                                            <button 
                                                onClick={() => setShowTutorial(false)}
                                                className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition"
                                            >
                                                Close Tutorial
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                {/* Story Panel */}
                                <div className="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
                                    <h2 className="text-xl font-semibold text-green-700 mb-4 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" />
                                        </svg>
                                        Your Adventure at {locations[currentLocation].name}
                                    </h2>
                                    
                                    {/* Location Map - Now interactive */}
                                    <div className="mb-4">
                                        <LocationMap locationKey={currentLocation} onLocationChange={handleLocationChange} />
                                        <p className="text-sm text-gray-600 mt-2">Click on any discovered location to travel there</p>
                                    </div>
                                    
                                    {/* Weather Data */}
                                    {weatherData && (
                                        <div className="flex items-center justify-around mb-4 p-3 bg-blue-50 rounded-lg">
                                            <div className="text-center">
                                                <span className="block text-xl font-bold">{weatherData.temperature}Â°C</span>
                                                <span className="text-sm text-gray-600">Temperature</span>
                                            </div>
                                            <div className="text-center">
                                                <span className="block text-xl font-bold">{weatherData.rainfall}mm</span>
                                                <span className="text-sm text-gray-600">Rainfall</span>
                                            </div>
                                            <div className="text-center">
                                                <span className="block text-xl font-bold capitalize">{weatherData.conditions}</span>
                                                <span className="text-sm text-gray-600">Conditions</span>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div 
                                        ref={storyPanelRef}
                                        className="h-96 overflow-y-auto mb-4 p-4 bg-green-50 rounded-lg border border-green-200"
                                    >
                                        {storyLog.map((msg, idx) => (
                                            <p key={idx} className="mb-3 text-gray-700 story-text">{msg}</p>
                                        ))}
                                    </div>
                                    
                                    {/* Climate Events */}
                                    {displayData.climateEvents.length > 0 && displayData.climateEvents[0].active && (
                                        <div className="mb-4 p-4 bg-red-100 rounded-lg border border-red-300 climate-event">
                                            <h3 className="font-bold text-red-800 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                                </svg>
                                                Climate Event: {displayData.climateEvents[0].name}
                                            </h3>
                                            <p className="text-red-700">{displayData.climateEvents[0].effect}</p>
                                        </div>
                                    )}
                                    
                                    {/* Choice Buttons */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                                        {currentChoices.map((choice, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => !choice.disabled && handleChoice(choice)}
                                                disabled={displayData.budget < choice.cost || choice.disabled}
                                                className={`${displayData.budget < choice.cost || choice.disabled ? 
                                                    'bg-gray-300 cursor-not-allowed opacity-50' : 
                                                    choice.className ? choice.className : 'bg-green-500 hover:bg-green-600'} 
                                                    text-white font-medium py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105 btn-hover flex items-center justify-center`}
                                            >
                                                {choice.cost > 0 && (
                                                    <span className="mr-2 bg-green-500 rounded-full px-2 py-1 text-xs">
                                                        ${choice.cost}
                                                    </span>
                                                )}
                                                {choice.text}
                                                {choice.time > 1 && (
                                                    <span className="ml-2 bg-green-500 rounded-full px-2 py-1 text-xs">
                                                        {choice.time}d
                                                    </span>
                                                )}
                                                {/* Add cooldown indicator */}
                                                {choice.id === "fundraiser" && ecosystemData.lastFundraiserDay && 
                                                    (ecosystemData.day - ecosystemData.lastFundraiserDay < FUNDRAISER_COOLDOWN_DAYS) && (
                                                    <span className="ml-2 bg-yellow-500 rounded-full px-2 py-1 text-xs">
                                                        â°
                                                    </span>
                                                )}
                                                {/* Add max budget indicator */}
                                                {choice.id === "fundraiser" && ecosystemData.budget >= MAX_BUDGET && (
                                                    <span className="ml-2 bg-red-500 rounded-full px-2 py-1 text-xs">
                                                        ðŸ’°
                                                    </span>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Stats Panel */}
                                <div className="bg-white rounded-xl shadow-md p-6">
                                    <h2 className="text-xl font-semibold text-green-700 mb-4 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clipRule="evenodd" />
                                        </svg>
                                        Ecosystem Dashboard
                                    </h2>
                                    
                                    <div className="mb-6">
                                        <div className="flex justify-between items-center mb-2">
                                            <Tooltip text={tooltips.ecosystemHealth}>
                                                <span className="text-gray-600">Overall Health</span>
                                            </Tooltip>
                                            <span className="font-semibold">{displayData.ecosystemHealth.toFixed(1)}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                            <div 
                                                className="bg-green-600 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${displayData.ecosystemHealth}%` }}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-2">
                                            <Tooltip text={tooltips.biodiversityIndex}>
                                                <span className="text-gray-600">Biodiversity</span>
                                            </Tooltip>
                                            <span className="font-semibold">{displayData.biodiversityIndex.toFixed(1)}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                            <div 
                                                className="bg-purple-500 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${displayData.biodiversityIndex}%` }}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-2">
                                            <Tooltip text={tooltips.waterQuality}>
                                                <span className="text-gray-600">Water Quality</span>
                                            </Tooltip>
                                            <span className="font-semibold">{displayData.waterQuality.toFixed(1)}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                            <div 
                                                className="bg-blue-500 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${displayData.waterQuality}%` }}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-2">
                                            <Tooltip text={tooltips.temperature}>
                                                <span className="text-gray-600">Temperature</span>
                                            </Tooltip>
                                            <span className="font-semibold">{displayData.temperature.toFixed(1)}Â°C</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4 mb-4">
                                            <div 
                                                className="bg-red-500 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${((displayData.temperature + 5) / 40) * 100}%` }}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-2">
                                            <Tooltip text={tooltips.co2Level}>
                                                <span className="text-gray-600">CO2 Level</span>
                                            </Tooltip>
                                            <span className="font-semibold">{displayData.co2Level.toFixed(1)} ppm</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-4">
                                            <div 
                                                className="bg-gray-600 h-4 rounded-full transition-all duration-500 health-bar" 
                                                style={{ width: `${((displayData.co2Level - 300) / 200) * 100}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center justify-between">
                                                <Tooltip text={tooltips.budget}>
                                                    <span>Resources</span>
                                                </Tooltip>
                                                <span className="text-lg font-bold text-green-600">${displayData.budget} / ${MAX_BUDGET}</span>
                                            </h3>
                                            <div className="mt-1 mb-2">
                                                <div className="flex justify-between text-xs text-gray-600">
                                                    <span>Budget Progress</span>
                                                    <span>{Math.round((displayData.budget / MAX_BUDGET) * 100)}%</span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                    <div 
                                                        className="bg-green-500 h-2 rounded-full transition-all duration-300" 
                                                        style={{ width: `${(displayData.budget / MAX_BUDGET) * 100}%` }}
                                                    ></div>
                                                </div>
                                            </div>
                                            <ul className="space-y-2">
                                                <li className="flex justify-between">
                                                    <Tooltip text={tooltips.shrubsPlanted}>
                                                        <span className="flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fillRule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clipRule="evenodd" />
                                                            </svg>
                                                            Shrubs Planted
                                                        </span>
                                                    </Tooltip>
                                                    <span className="font-semibold">{displayData.shrubsPlanted}</span>
                                                </li>
                                                <li className="flex justify-between">
                                                    <Tooltip text={tooltips.treesPlanted}>
                                                        <span className="flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fillRule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clipRule="evenodd" />
                                                            </svg>
                                                            Trees Planted
                                                        </span>
                                                    </Tooltip>
                                                    <span className="font-semibold">{displayData.treesPlanted}</span>
                                                </li>
                                                <li className="flex justify-between">
                                                    <Tooltip text={tooltips.invasiveSpeciesRemoved}>
                                                        <span className="flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fillRule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clipRule="evenodd" />
                                                            </svg>
                                                            Invasives Removed
                                                        </span>
                                                    </Tooltip>
                                                    <span className="font-semibold">{displayData.invasiveSpeciesRemoved}</span>
                                                </li>
                                                <li className="flex justify-between">
                                                    <Tooltip text={tooltips.volunteers}>
                                                        <span className="flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
                                                            </svg>
                                                            Volunteers
                                                        </span>
                                                    </Tooltip>
                                                    <span className="font-semibold">{displayData.volunteers}</span>
                                                </li>
                                            </ul>
                                        </div>
                                        
                                        <div>
                                            <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                                                </svg>
                                                Wildlife Observed
                                            </h3>
                                            <div className="flex flex-wrap gap-2">
                                                {displayData.wildlifeObserved.length > 0 ? (
                                                    displayData.wildlifeObserved.map((animal, idx) => (
                                                        <span key={idx} className="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full wildlife-item flex items-center">
                                                            <span className="mr-1">{tasmaniaWildlife[animal]?.image || 'ðŸ¾'}</span>
                                                            {tasmaniaWildlife[animal]?.name || animal}
                                                        </span>
                                                    ))
                                                ) : (
                                                    <p className="text-gray-500">No wildlife observed yet</p>
                                                )}
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd" />
                                                </svg>
                                                Locations Discovered
                                            </h3>
                                            <div className="flex flex-wrap gap-2">
                                                {displayData.locationsVisited.map((location, idx) => (
                                                    <span key={idx} className="bg-yellow-100 text-yellow-800 text-sm px-3 py-1 rounded-full flex items-center">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd" />
                                                        </svg>
                                                        {locations[location]?.name || location.replace('_', ' ')}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {/* Location Projects */}
                                        {displayData.unlockedProjects && displayData.unlockedProjects[currentLocation] && displayData.unlockedProjects[currentLocation].length > 0 && (
                                            <div>
                                                <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                                        <path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd" />
                                                    </svg>
                                                    Available Projects
                                                </h3>
                                                <div className="space-y-2">
                                                    {locations[currentLocation].projects.map((project, idx) => (
                                                        displayData.unlockedProjects[currentLocation].includes(project.id) && (
                                                            <div key={idx} className="flex items-center justify-between bg-green-50 p-2 rounded">
                                                                <div>
                                                                    <div className="font-medium">{project.name}</div>
                                                                    <div className="text-sm text-gray-600">{project.effect}</div>
                                                                </div>
                                                                <span className="text-sm bg-green-200 text-green-800 px-2 py-1 rounded-full">
                                                                    ${project.cost}
                                                                </span>
                                                            </div>
                                                        )
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {displayData.gameMode === 'team' && (
                                            <div>
                                                <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                                                    </svg>
                                                    Your Team
                                                </h3>
                                                <div className="space-y-2">
                                                    {displayData.npcTeam.length > 0 ? (
                                                        displayData.npcTeam.map((npc, idx) => (
                                                            <div key={idx} className="flex items-center justify-between bg-green-50 p-2 rounded">
                                                                <div className="flex items-center">
                                                                    <span className="text-2xl mr-2">{npc.portrait}</span>
                                                                    <div>
                                                                        <div className="font-medium">{npc.name}</div>
                                                                        <div className="text-sm text-gray-600">{npc.role}</div>
                                                                    </div>
                                                                </div>
                                                                <span className="text-sm bg-green-200 text-green-800 px-2 py-1 rounded-full">
                                                                    +{npc.efficiency}x efficiency
                                                                </span>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <p className="text-gray-500">No team members yet. Hire specialists to help your efforts.</p>
                                                    )}
                                                </div>
                                            </div>
                                        )}

                                        {/* Time-lapse replay slider */}
                                        {ecosystemData.historicalData.length > 10 && (
                                            <ReplaySlider 
                                                historicalData={ecosystemData.historicalData}
                                                currentDay={replayDay || ecosystemData.day}
                                                onDayChange={setReplayDay}
                                            />
                                        )}

                                        {/* Achievements preview */}
                                        <div>
                                            <h3 className="text-lg font-medium text-green-700 mb-2 flex items-center justify-between">
                                                <span>Achievements</span>
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-xs text-gray-600">{showAllAchievements ? 'All' : 'Achieved'}</span>
                                                    <button 
                                                        onClick={() => setShowAllAchievements(!showAllAchievements)}
                                                        className="text-sm bg-green-100 hover:bg-green-200 text-green-800 px-2 py-1 rounded transition"
                                                    >
                                                        {showAllAchievements ? 'Achieved Only' : 'Show All'}
                                                    </button>
                                                </div>
                                            </h3>
                                            <div className="grid grid-cols-3 gap-2">
                                                {achievements
                                                    .filter(a => showAllAchievements || ecosystemData.achievementsUnlocked.includes(a.id))
                                                    .map(achievement => (
                                                        <div key={achievement.id} className={`p-2 rounded-lg text-center ${ecosystemData.achievementsUnlocked.includes(achievement.id) ? 'bg-green-100 border border-green-300' : 'bg-gray-100 opacity-50'}`}>
                                                            <div className="text-xl">{achievement.icon}</div>
                                                            <p className="text-xs mt-1">{achievement.name}</p>
                                                        </div>
                                                    ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Share Modal */}
                    {showShareModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full">
                                <h2 className="text-xl font-semibold text-green-700 mb-4">Share Your Results</h2>
                                <p className="text-gray-600 mb-4">
                                    Share your conservation achievements with others and encourage them to try EcoQuest Tasmania!
                                </p>
                                <div className="flex justify-end space-x-4">
                                    <button 
                                        onClick={() => setShowShareModal(false)}
                                        className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={shareResults}
                                        className="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition"
                                    >
                                        Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

// Render the app - ALTERNATIVE FIX
const appContainer = document.getElementById('root');
try {
    // Try React 18 approach first
    if (ReactDOM.createRoot) {
        const root = ReactDOM.createRoot(appContainer);
        root.render(<EcoQuest />);
    } else {
        throw new Error('Use React 17 method');
    }
} catch (error) {
    // Fallback to React 17 method
    ReactDOM.render(<EcoQuest />, appContainer);
}
    </script>
