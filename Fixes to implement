<!-- Main JavaScript -->
<script>
    // ========== CONFIGURATION ==========
    const CONFIG = {
        APP_VERSION: '3.0.0',
        // SINGLE SOURCE OF TRUTH: One key for everything
        SHARED_STORAGE_KEY: 'course_planner_shared_data',
        DEFAULT_TOTAL_WEEKS: 37
    };

    // ========== STATE MANAGEMENT ==========
    class CoursePlanner {
        constructor() {
            this.units = [];
            this.courseData = {
                totalWeeks: CONFIG.DEFAULT_TOTAL_WEEKS,
                terms: [
                    { number: 1, weeks: 10, startWeek: 1, name: "Safety, Foundations & Summer Harvest" },
                    { number: 2, weeks: 10, startWeek: 11, name: "Practical Skills & Application" },
                    { number: 3, weeks: 10, startWeek: 21, name: "Machinery & Advanced Integration" },
                    { number: 4, weeks: 7, startWeek: 31, name: "Apex & Finalisation" }
                ],
                projectMilestones: [
                    { id: 'milestone-1', week: 18, label: "Project Start" },
                    { id: 'milestone-2', week: 25, label: "Phase 2" },
                    { id: 'milestone-3', week: 30, label: "Integration" },
                    { id: 'milestone-4', week: 34, label: "Final Phase" }
                ]
            };
            this.blockedWeeks = {};
            this.currentView = 'week';
            this.history = [];
            this.historyIndex = -1;
            this.isStudentView = false;
            this.draggedUnit = null;
            this.draggedMarker = null;
            this.draggedFromPalette = false;
            
            this.colorMap = {
                safety: '#ff6b6b',
                foundational: '#4ecdc4',
                practical: '#45b7d1',
                machinery: '#96ceb4',
                apex: '#ffeaa7',
                project: '#a29bfe',
                specialist: '#fd79a8',
                seasonal: '#55efc4',
                holiday: '#dfe6e9',
                'term-break': '#b2bec3',
                easter: '#fab1a0',
                'teacher-training': '#a29bfe',
                leave: '#fd79a8'
            };

            this.blockingLabels = {
                easter: 'EASTER BREAK',
                'term-break': 'TERM BREAK',
                training: 'TEACHER TRAINING',
                leave: 'LEAVE'
            };

            this.defaultUnits = [
                {
                    id: '1',
                    code: 'AHCWHS302',
                    name: 'Work Health & Safety',
                    weeks: [1, 2],
                    color: 'safety',
                    tags: ['SAFETY'],
                    teacher: 'main',
                    notes: 'Non-negotiable foundation'
                },
                {
                    id: '2',
                    code: 'HLTAID011',
                    name: 'First Aid',
                    weeks: [1, 2],
                    color: 'safety',
                    tags: ['SAFETY', 'SPECIALIST'],
                    teacher: 'other',
                    notes: 'Clustered with WHS for efficiency'
                },
                {
                    id: '3',
                    code: 'AHCECR305',
                    name: 'Collect native seed',
                    weeks: [3, 4],
                    color: 'seasonal',
                    tags: ['SEASONAL'],
                    teacher: 'main',
                    notes: 'Must be early due to seed season'
                },
                {
                    id: '4',
                    code: 'AHCBIO303',
                    name: 'Biosecurity',
                    weeks: [3, 4],
                    color: 'foundational',
                    tags: [],
                    teacher: 'main',
                    notes: 'Essential for seed/plant handling'
                },
                {
                    id: '5',
                    code: 'AHCPCM303',
                    name: 'Identify plant specimens',
                    weeks: [5, 6, 7],
                    color: 'foundational',
                    tags: [],
                    teacher: 'main',
                    notes: 'Foundational skill - use seed collection trips'
                },
                {
                    id: '6',
                    code: 'AHCNSY207',
                    name: 'Undertake propagation activities',
                    weeks: [8],
                    color: 'foundational',
                    tags: [],
                    teacher: 'main',
                    notes: 'Follow-up to seed collection'
                },
                {
                    id: '7',
                    code: 'AHCFAU302',
                    name: 'Identify fauna in the field',
                    weeks: [9, 10],
                    color: 'foundational',
                    tags: ['SEASONAL'],
                    teacher: 'main',
                    notes: 'Late summer/early autumn activity'
                },
                {
                    id: '8',
                    code: 'AHCPMG301',
                    name: 'Control weeds',
                    weeks: [11, 12],
                    color: 'practical',
                    tags: [],
                    teacher: 'main',
                    notes: 'Builds on plant ID'
                },
                {
                    id: '9',
                    code: 'AHCCHM304',
                    name: 'Transport/handle chemicals',
                    weeks: [13],
                    color: 'practical',
                    tags: ['SPECIALIST'],
                    teacher: 'other',
                    notes: 'Clustered with weed control'
                },
                {
                    id: '10',
                    code: 'AHCCHM307',
                    name: 'Apply chemicals',
                    weeks: [13],
                    color: 'practical',
                    tags: ['SPECIALIST'],
                    teacher: 'other',
                    notes: 'Clustered chemical application'
                },
                {
                    id: '11',
                    code: 'FWPCOT2266',
                    name: 'Operate brush cutter',
                    weeks: [14, 15],
                    color: 'practical',
                    tags: ['SPECIALIST'],
                    teacher: 'other',
                    notes: 'Practical vegetation management'
                },
                {
                    id: '12',
                    code: 'AHCECR301',
                    name: 'Maintain native ecosystem areas',
                    weeks: [16, 17],
                    color: 'practical',
                    tags: [],
                    teacher: 'main',
                    notes: 'Ecosystem-scale application'
                },
                {
                    id: '13',
                    code: 'AHCLPW313',
                    name: 'Water sampling & testing',
                    weeks: [18, 19, 20],
                    color: 'practical',
                    tags: ['SEASONAL'],
                    teacher: 'main',
                    notes: 'Wetter months activity'
                },
                {
                    id: '14',
                    code: 'AHCMOM213',
                    name: 'Operate chainsaw',
                    weeks: [21, 22, 23],
                    color: 'machinery',
                    tags: ['SPECIALIST'],
                    teacher: 'other',
                    notes: 'Requires significant planning'
                },
                {
                    id: '15',
                    code: 'AHCMOM216',
                    name: 'Operate SSUV',
                    weeks: [21, 22, 23],
                    color: 'machinery',
                    tags: ['SPECIALIST'],
                    teacher: 'other',
                    notes: 'Clustered machinery units'
                },
                {
                    id: '16',
                    code: 'AHCECR301',
                    name: 'Ecosystem maintenance (cont.)',
                    weeks: [24, 25, 26, 27],
                    color: 'practical',
                    tags: [],
                    teacher: 'main',
                    notes: 'Enhanced capability application'
                },
                {
                    id: '17',
                    code: 'INTEGRATION',
                    name: 'Skill Integration & Project Work',
                    weeks: [28, 29, 30],
                    color: 'project',
                    tags: ['FLEXIBLE'],
                    teacher: 'main',
                    notes: 'Buffer for weather/adaptation'
                },
                {
                    id: '18',
                    code: 'AHCECR309',
                    name: 'Conduct ecological site inspection',
                    weeks: [31, 32, 33],
                    color: 'apex',
                    tags: ['APEX'],
                    teacher: 'main',
                    notes: 'Synthesis of all skills'
                },
                {
                    id: '19',
                    code: 'PROJECT',
                    name: 'Final Project Phase',
                    weeks: [34, 35, 36],
                    color: 'project',
                    tags: [],
                    teacher: 'main',
                    notes: 'Complete integrated project'
                },
                {
                    id: '20',
                    code: 'ADMIN',
                    name: 'Portfolio Finalisation',
                    weeks: [37],
                    color: 'safety',
                    tags: [],
                    teacher: 'main',
                    notes: 'Verification and closure'
                }
            ];

            this.unitTemplates = [
                { code: 'AHCWHS302', name: 'Work Health & Safety', color: 'safety', tags: ['SAFETY'], defaultWeeks: 2 },
                { code: 'HLTAID011', name: 'First Aid', color: 'safety', tags: ['SAFETY', 'SPECIALIST'], defaultWeeks: 2 },
                { code: 'AHCECR305', name: 'Collect native seed', color: 'seasonal', tags: ['SEASONAL'], defaultWeeks: 2 },
                { code: 'AHCBIO303', name: 'Biosecurity', color: 'foundational', tags: [], defaultWeeks: 2 },
                { code: 'AHCPCM303', name: 'Identify plant specimens', color: 'foundational', tags: [], defaultWeeks: 3 },
                { code: 'AHCNSY207', name: 'Undertake propagation activities', color: 'foundational', tags: [], defaultWeeks: 1 },
                { code: 'AHCFAU302', name: 'Identify fauna in the field', color: 'foundational', tags: ['SEASONAL'], defaultWeeks: 2 },
                { code: 'AHCPMG301', name: 'Control weeds', color: 'practical', tags: [], defaultWeeks: 2 },
                { code: 'AHCCHM304', name: 'Transport/handle chemicals', color: 'practical', tags: ['SPECIALIST'], defaultWeeks: 1 },
                { code: 'AHCCHM307', name: 'Apply chemicals', color: 'practical', tags: ['SPECIALIST'], defaultWeeks: 1 },
                { code: 'FWPCOT2266', name: 'Operate brush cutter', color: 'practical', tags: ['SPECIALIST'], defaultWeeks: 2 },
                { code: 'AHCECR301', name: 'Maintain native ecosystem areas', color: 'practical', tags: [], defaultWeeks: 2 },
                { code: 'AHCLPW313', name: 'Water sampling & testing', color: 'practical', tags: ['SEASONAL'], defaultWeeks: 3 },
                { code: 'AHCMOM213', name: 'Operate chainsaw', color: 'machinery', tags: ['SPECIALIST'], defaultWeeks: 3 },
                { code: 'AHCMOM216', name: 'Operate SSUV', color: 'machinery', tags: ['SPECIALIST'], defaultWeeks: 3 },
                { code: 'AHCECR309', name: 'Conduct ecological site inspection', color: 'apex', tags: ['APEX'], defaultWeeks: 3 },
                { code: 'CUSTOM', name: 'Custom Unit/Block', color: 'foundational', tags: ['CUSTOM'], defaultWeeks: 1 }
            ];

            this.init();
        }

        init() {
            console.log('Initializing CoursePlanner...');
            
            // Set up event listeners immediately
            this.setupEventListeners();
            
            // Load data
            this.loadInitialData();
            
            // Check if DOM is ready before rendering
            if (document.readyState === 'loading') {
                console.log('DOM still loading, waiting...');
                document.addEventListener('DOMContentLoaded', () => {
                    this.renderEverything();
                    this.setupStudentViewIfNeeded();
                    this.hideLoadingScreen();
                    this.setupKeyboardShortcuts();
                    console.log('CoursePlanner initialized after DOM loaded');
                });
            } else {
                // DOM is already ready
                this.renderEverything();
                this.setupStudentViewIfNeeded();
                this.hideLoadingScreen();
                this.setupKeyboardShortcuts();
                console.log('CoursePlanner initialized');
            }
        }
            
        // ========== CRITICAL FIX: LOAD DATA FROM SINGLE SOURCE ==========
       loadInitialData() {
            try {
                // Check URL for student view
                const urlParams = new URLSearchParams(window.location.search);
                this.isStudentView = urlParams.has('student');
                
                console.log('=== DATA LOADING START ===');
                console.log('Student View:', this.isStudentView);
                console.log('URL timestamp param:', urlParams.get('v'));
                console.log('Loading from single source:', CONFIG.SHARED_STORAGE_KEY);
                
                // SINGLE SOURCE OF TRUTH: Always load from the same key
                const sharedData = localStorage.getItem(CONFIG.SHARED_STORAGE_KEY);
                
                if (sharedData) {
                    console.log('Found shared data in storage');
                    try {
                        const data = JSON.parse(sharedData);
                        
                        // Validate version
                        if (data.version === CONFIG.APP_VERSION) {
                            this.units = data.units || [...this.defaultUnits];
                            this.courseData = data.courseData || this.courseData;
                            this.blockedWeeks = data.blockedWeeks || {};
                            
                            // Ensure project milestones have IDs
                            if (this.courseData.projectMilestones) {
                                this.courseData.projectMilestones = this.courseData.projectMilestones.map((milestone, index) => ({
                                    ...milestone,
                                    id: milestone.id || `milestone-${index + 1}`
                                }));
                            }
                            
                            console.log('âœ“ Successfully loaded shared data');
                            console.log('  Units:', this.units.length);
                            console.log('  Total weeks:', this.courseData.totalWeeks);
                            console.log('  Last update:', data.lastUpdate || 'unknown');
                            
                            // If in student view, show data verification
                            if (this.isStudentView) {
                                console.log('=== STUDENT VIEW DATA LOADED ===');
                                console.log('Loaded units:', this.units.map(u => u.code).join(', '));
                            }
                        } else {
                            console.warn('Version mismatch, using defaults');
                            this.units = [...this.defaultUnits];
                            // Don't show toast here - DOM might not be ready
                        }
                    } catch (e) {
                        console.error('Failed to parse shared data:', e);
                        this.units = [...this.defaultUnits];
                        // Don't show toast here - DOM might not be ready
                    }
                } else {
                    console.log('No shared data found, using defaults');
                    this.units = [...this.defaultUnits];
                    // Don't show toast here - DOM might not be ready
                }
                
                this.saveHistory();
                
                console.log('=== DATA LOADING COMPLETE ===');
                
            } catch (error) {
                console.error('Error in loadInitialData:', error);
                this.units = [...this.defaultUnits];
                // Don't show toast here - DOM might not be ready
            }
        } 

        // ========== CRITICAL FIX: SAVE DATA TO SINGLE SOURCE ==========
        saveData() {
            try {
                const dataToSave = {
                    version: CONFIG.APP_VERSION,
                    lastUpdate: new Date().toISOString(),
                    units: JSON.parse(JSON.stringify(this.units)),
                    courseData: JSON.parse(JSON.stringify(this.courseData)),
                    blockedWeeks: JSON.parse(JSON.stringify(this.blockedWeeks))
                };
                
                // SINGLE SOURCE OF TRUTH: Save to the single key
                localStorage.setItem(CONFIG.SHARED_STORAGE_KEY, JSON.stringify(dataToSave));
                
                console.log('=== DATA SAVED ===');
                console.log('Saved to:', CONFIG.SHARED_STORAGE_KEY);
                console.log('Units saved:', dataToSave.units.length);
                console.log('Timestamp:', dataToSave.lastUpdate);
                
                // Also save as autosave for backward compatibility
                localStorage.setItem('cet_autosave', JSON.stringify({
                    units: this.units,
                    courseData: this.courseData,
                    blockedWeeks: this.blockedWeeks,
                    timestamp: Date.now(),
                    version: CONFIG.APP_VERSION
                }));
                
                return true;
            } catch (error) {
                console.error('Failed to save data:', error);
                this.showToast('Failed to save data', 'error');
                return false;
            }
        }

        // ========== MODIFIED: Save history with auto-save ==========
        saveHistory() {
            this.history = this.history.slice(0, this.historyIndex + 1);
            this.history.push({
                units: JSON.parse(JSON.stringify(this.units)),
                courseData: JSON.parse(JSON.stringify(this.courseData)),
                blockedWeeks: JSON.parse(JSON.stringify(this.blockedWeeks)),
                timestamp: Date.now()
            });
            
            if (this.history.length > 50) {
                this.history.shift();
            }
            
            this.historyIndex = this.history.length - 1;
            
            // AUTO-SAVE: Save to shared storage on every change
            if (!this.isStudentView) {
                this.saveData();
            }
        }

        // ========== RENDERING ==========
        renderEverything() {
            this.renderUnitPalette();
            this.renderTimeline();
            this.renderSavedPlans();
            this.updateTotalWeeksDisplay();
            
            if (this.isStudentView) {
                this.renderStudentTermOverviews();
            }
        }

        renderTimeline() {
            const container = document.getElementById('timelineContent');
            if (!container) return;

            const { totalWeeks, terms } = this.courseData;
            const weekWidth = this.isStudentView ? 120 : 150;
            
            // Update CSS variables
            document.documentElement.style.setProperty('--week-width', `${weekWidth}px`);
            document.documentElement.style.setProperty('--total-weeks', totalWeeks);

            let html = '';

            // Term headers
            html += `<div class="term-headers">`;
            html += `<div class="term-spacer"></div>`;
            
            terms.forEach(term => {
                const termWidth = term.weeks * weekWidth;
                const clickable = !this.isStudentView ? 'cursor: pointer;' : '';
                html += `
                    <div class="term-header" data-term="${term.number}" 
                         style="width: ${termWidth}px; ${clickable}" 
                         title="${this.isStudentView ? '' : 'Click to manage term'}">
                        Term ${term.number} (Weeks ${term.startWeek}-${term.startWeek + term.weeks - 1})
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 3px;">${term.name}</div>
                    </div>
                `;
            });

            html += `</div>`;

            // Week headers
            html += `<div class="week-headers">`;
            html += `<div class="week-spacer"></div>`;
            
            for (let week = 1; week <= totalWeeks; week++) {
                const term = this.getTermForWeek(week);
                html += `
                    <div class="week-header" style="width: ${weekWidth}px;">
                        <div class="week-number">Week ${week}</div>
                        ${term ? `<div style="font-size: 11px; color: #666;">Term ${term.number}</div>` : ''}
                    </div>
                `;
            }

            html += `</div>`;

            // Timeline grid
            html += `<div class="timeline-grid">`;

            // Determine swimlanes based on view mode
            let swimlanes = [];
            const viewMode = this.isStudentView ? 'week' : (document.getElementById('viewMode')?.value || 'week');
            
            if (viewMode === 'teacher') {
                swimlanes = [
                    { id: 'main', label: 'Main Teacher' },
                    { id: 'other', label: 'Other Teacher' },
                    { id: 'project', label: 'Projects' }
                ];
            } else if (viewMode === 'term') {
                // For term view, show one swimlane per term
                terms.forEach(term => {
                    swimlanes.push({
                        id: `term-${term.number}`,
                        label: `Term ${term.number}: ${term.name}`
                    });
                });
            } else {
                // Default week view
                swimlanes = [
                    { id: 'core', label: 'Core Units (Main Teacher)' },
                    { id: 'specialist', label: 'Specialist Units (Other Teacher)' },
                    { id: 'project', label: 'Integrated Project' },
                    { id: 'apex', label: 'Apex & Assessment' }
                ];
            }

            swimlanes.forEach((lane, laneIndex) => {
                html += `
                    <div class="swimlane" data-lane="${lane.id}">
                        <div class="lane-label">${lane.label}</div>
                        <div class="lane-content" data-lane-id="${lane.id}">
                `;

                for (let week = 1; week <= totalWeeks; week++) {
                    const isBlocked = this.blockedWeeks[week];
                    const blockedClass = isBlocked ? 'blocked-week' : '';
                    
                    html += `
                        <div class="week-slot ${blockedClass}" data-week="${week}" data-lane="${lane.id}" 
                             style="width: ${weekWidth}px; ${isBlocked ? `background: ${this.colorMap[isBlocked.type] || '#f8f9fa'}; opacity: 0.7;` : ''}">
                    `;

                    if (isBlocked) {
                        html += `
                            <div style="position: absolute; top: 5px; left: 5px; font-size: 10px; 
                                        color: white; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 3px;">
                                ${this.blockingLabels[isBlocked.type] || 'BLOCKED'}
                            </div>
                        `;
                    }

                    const unitsInWeek = this.getUnitsForWeekAndLane(week, lane.id, viewMode);
                    
                    if (unitsInWeek.length > 0) {
                        unitsInWeek.forEach(unit => {
                            const isFirstWeek = week === Math.min(...unit.weeks);
                            html += this.renderUnitBlock(unit, week, isFirstWeek);
                        });
                    } else if (!isBlocked) {
                        html += `<div class="empty-slot">${this.isStudentView ? 'No units' : 'Drag unit here'}</div>`;
                    }

                    html += `</div>`;
                }

                html += `</div></div>`;
            });

            html += `</div>`;
            container.innerHTML = html;

            // Add project markers to the project lane
            if (viewMode !== 'term') {
                this.renderProjectMarkers();
            }

            // Add event listeners
            this.setupTimelineEvents();
            
            // Add term click handlers
            if (!this.isStudentView) {
                container.querySelectorAll('.term-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const termNumber = parseInt(e.currentTarget.dataset.term);
                        this.openTermModal(termNumber);
                    });
                });
            }
            
            // Apply highlighting if enabled
            if (!this.isStudentView) {
                const highlightMode = document.getElementById('highlightMode');
                if (highlightMode && highlightMode.value !== 'none') {
                    this.applyHighlighting(highlightMode.value);
                }
            }
        }

        renderUnitBlock(unit, week, isFirstWeek = false) {
            const color = this.colorMap[unit.color] || this.colorMap.foundational;
            const darkColor = this.darkenColor(color, 30);
            const isStudentView = this.isStudentView;
            const cursorStyle = isStudentView ? 'cursor: pointer;' : '';
            
            return `
                <div class="unit-block" data-unit-id="${unit.id}" data-week="${week}"
                     style="background: ${color}; border-left-color: ${darkColor}; ${cursorStyle}"
                     draggable="${!isStudentView}">
                    <div class="unit-code">${unit.code}</div>
                    ${isFirstWeek ? `<div class="unit-name">${unit.name}</div>` : ''}
                    ${unit.weeks.length > 1 && isFirstWeek ? 
                        `<div class="unit-duration">${unit.weeks.length}w</div>` : ''}
                    ${isStudentView && unit.teacher === 'other' ? 
                        `<div class="week-summary" style="color: #fd79a8;">Other Teacher</div>` : ''}
                    ${isStudentView && unit.tags && unit.tags.includes('SEASONAL') ? 
                        `<div class="week-summary" style="color: #55efc4;">Seasonal Timing</div>` : ''}
                </div>
            `;
        }

        getUnitsForWeekAndLane(week, laneId, viewMode) {
            if (viewMode === 'teacher') {
                if (laneId === 'main') {
                    return this.units.filter(unit => 
                        unit.weeks.includes(week) && unit.teacher === 'main'
                    );
                } else if (laneId === 'other') {
                    return this.units.filter(unit => 
                        unit.weeks.includes(week) && unit.teacher === 'other'
                    );
                } else if (laneId === 'project') {
                    return this.units.filter(unit => 
                        unit.weeks.includes(week) && 
                        (unit.code === 'INTEGRATION' || unit.code === 'PROJECT' || unit.tags.includes('PROJECT'))
                    );
                }
            } else if (viewMode === 'term') {
                const termNumber = parseInt(laneId.split('-')[1]);
                const term = this.courseData.terms.find(t => t.number === termNumber);
                if (term && week >= term.startWeek && week < term.startWeek + term.weeks) {
                    return this.units.filter(unit => unit.weeks.includes(week));
                }
                return [];
            } else {
                // Default week view
                if (laneId === 'core') {
                    return this.units.filter(unit => 
                        unit.weeks.includes(week) && 
                        unit.teacher === 'main' &&
                        !unit.tags.includes('APEX') &&
                        unit.code !== 'INTEGRATION' &&
                        unit.code !== 'PROJECT'
                    );
                } else if (laneId === 'specialist') {
                    return this.units.filter(unit => 
                        unit.weeks.includes(week) && unit.teacher === 'other'
                    );
                } else if (laneId === 'project') {
                    return this.units.filter(unit => 
                        unit.weeks.includes(week) && 
                        (unit.code === 'INTEGRATION' || unit.code === 'PROJECT')
                    );
                } else if (laneId === 'apex') {
                    return this.units.filter(unit => 
                        unit.weeks.includes(week) && unit.tags.includes('APEX')
                    );
                }
            }
            return [];
        }

        renderProjectMarkers() {
            const projectLane = document.querySelector('.lane-content[data-lane-id="project"]');
            if (!projectLane) return;

            const weekWidth = this.isStudentView ? 120 : 150;
            const laneHeight = projectLane.offsetHeight;
            
            // Remove existing markers first
            document.querySelectorAll('.project-marker').forEach(marker => marker.remove());
            
            // Render each project milestone
            this.courseData.projectMilestones.forEach(milestone => {
                if (milestone.week < 1 || milestone.week > this.courseData.totalWeeks) return;
                
                const markerLeft = (milestone.week - 1) * weekWidth + weekWidth/2 - 8;
                
                const marker = document.createElement('div');
                marker.className = 'project-marker';
                marker.dataset.milestoneId = milestone.id;
                marker.dataset.week = milestone.week;
                marker.style.left = `${markerLeft}px`;
                marker.style.top = `${laneHeight / 2}px`;
                marker.style.position = 'absolute';
                marker.style.zIndex = '10';
                
                // Add label
                const label = document.createElement('div');
                label.className = 'project-marker-label';
                label.textContent = milestone.label;
                marker.appendChild(label);
                
                // Add delete button (only in editor view)
                if (!this.isStudentView) {
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'project-marker-delete';
                    deleteBtn.innerHTML = 'Ã—';
                    deleteBtn.title = 'Delete milestone';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteProjectMilestone(milestone.id);
                    });
                    marker.appendChild(deleteBtn);
                    
                    // Make marker draggable
                    marker.draggable = true;
                    marker.style.cursor = 'grab';
                    
                    marker.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', milestone.id);
                        this.draggedMarker = milestone;
                        marker.classList.add('dragging');
                    });
                    
                    marker.addEventListener('dragend', () => {
                        marker.classList.remove('dragging');
                        this.draggedMarker = null;
                    });
                } else {
                    marker.style.cursor = 'default';
                }
                
                // Add click handler for student view
                if (this.isStudentView) {
                    marker.addEventListener('click', () => {
                        this.showProjectMilestoneDetails(milestone);
                    });
                }
                
                projectLane.appendChild(marker);
            });
            
            // Add drop zone for markers
            if (!this.isStudentView) {
                projectLane.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                projectLane.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (!this.draggedMarker) return;
                    
                    const rect = projectLane.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const weekWidth = this.isStudentView ? 120 : 150;
                    const week = Math.floor(x / weekWidth) + 1;
                    
                    if (week >= 1 && week <= this.courseData.totalWeeks) {
                        this.moveProjectMilestone(this.draggedMarker.id, week);
                    }
                });
            }
        }

        // ========== HIGHLIGHTING FUNCTION ==========
        applyHighlighting(mode) {
            if (this.isStudentView) return;
            
            // Remove any existing highlighting first
            document.querySelectorAll('.unit-block').forEach(block => {
                block.style.boxShadow = '';
                block.style.borderColor = '';
                block.style.zIndex = '';
            });
            
            if (mode === 'none') {
                this.showToast('Highlighting cleared', 'info');
                return;
            }
            
            let unitsToHighlight = [];
            
            switch(mode) {
                case 'specialist':
                    unitsToHighlight = this.units.filter(unit => 
                        unit.tags.includes('SPECIALIST') || unit.teacher === 'other'
                    );
                    break;
                case 'safety':
                    unitsToHighlight = this.units.filter(unit => 
                        unit.tags.includes('SAFETY')
                    );
                    break;
                case 'seasonal':
                    unitsToHighlight = this.units.filter(unit => 
                        unit.tags.includes('SEASONAL')
                    );
                    break;
                case 'assessment':
                    unitsToHighlight = this.units.filter(unit => 
                        unit.tags.includes('APEX') || 
                        unit.code === 'INTEGRATION' || 
                        unit.code === 'PROJECT'
                    );
                    break;
            }
            
            // Apply highlighting
            const unitIds = unitsToHighlight.map(unit => unit.id);
            document.querySelectorAll('.unit-block').forEach(block => {
                const unitId = block.dataset.unitId;
                if (unitIds.includes(unitId)) {
                    block.style.boxShadow = '0 0 0 3px gold, 0 4px 8px rgba(0,0,0,0.3)';
                    block.style.borderColor = 'gold';
                    block.style.zIndex = '10';
                }
            });
            
            this.showToast(`Highlighting ${mode} units`, 'info');
        }

        // ========== STUDENT VIEW SETUP ==========
        setupStudentView() {
            try {
                // Wait for DOM to be ready
                if (!document.getElementById('courseTitle')) {
                    console.warn('DOM not ready yet, retrying in 100ms');
                    setTimeout(() => this.setupStudentView(), 100);
                    return;
                }
                
                document.body.classList.remove('editor-view');
                document.body.classList.add('student-view');
                
                // Update UI for student view - check each element exists
                const courseTitle = document.getElementById('courseTitle');
                const courseSubtitle = document.getElementById('courseSubtitle');
                const viewModeIndicator = document.getElementById('viewModeIndicator');
                const courseDescription = document.getElementById('courseDescription');
                const viewIcon = document.getElementById('viewIcon');
                const viewLabel = document.getElementById('viewLabel');
                
                if (courseTitle) courseTitle.textContent = 'Course Schedule - Cert III Conservation & Ecosystem Management';
                if (courseSubtitle) courseSubtitle.textContent = `Student View - ${this.courseData.totalWeeks}-Week Plan`;
                if (viewModeIndicator) viewModeIndicator.textContent = 'Student View';
                if (courseDescription) courseDescription.textContent = 'Click units for details | Term overviews below';
                
                // Update view toggle
                if (viewIcon) viewIcon.textContent = 'âœï¸';
                if (viewLabel) viewLabel.textContent = 'Editor View';
                
                console.log('Student view setup complete');
            } catch (error) {
                console.error('Error in setupStudentView:', error);
                // Retry after a short delay
                setTimeout(() => this.setupStudentView(), 100);
            }
        }

        // ========== NEW: Safe student view setup ==========
        setupStudentViewIfNeeded() {
            if (this.isStudentView) {
                console.log('Setting up student view...');
                this.setupStudentView();
            }
        }

        // ========== EVENT LISTENERS ==========
        setupEventListeners() {
            // View mode changes
            const viewModeSelect = document.getElementById('viewMode');
            if (viewModeSelect && !this.isStudentView) {
                viewModeSelect.addEventListener('change', (e) => {
                    this.currentView = e.target.value;
                    this.renderTimeline();
                });
            }

            // Highlight mode
            const highlightMode = document.getElementById('highlightMode');
            if (highlightMode) {
                highlightMode.addEventListener('change', (e) => {
                    this.applyHighlighting(e.target.value);
                });
            }

            // Control buttons
            const savePlanBtn = document.getElementById('savePlan');
            if (savePlanBtn) savePlanBtn.addEventListener('click', () => this.savePlan());
            
            const sharePlanBtn = document.getElementById('sharePlan');
            if (sharePlanBtn) sharePlanBtn.addEventListener('click', () => this.sharePlan());
            
            const resetPlanBtn = document.getElementById('resetPlan');
            if (resetPlanBtn) resetPlanBtn.addEventListener('click', () => this.resetToDefault());
            
            const clearTimetableBtn = document.getElementById('clearTimetable');
            if (clearTimetableBtn) clearTimetableBtn.addEventListener('click', () => this.clearTimetable());
            
            const printPlanBtn = document.getElementById('printPlan');
            if (printPlanBtn) printPlanBtn.addEventListener('click', () => this.printPlan());
            
            const exportPlanBtn = document.getElementById('exportPlan');
            if (exportPlanBtn) exportPlanBtn.addEventListener('click', () => this.exportPlan());
            
            const applyBlockingBtn = document.getElementById('applyBlocking');
            if (applyBlockingBtn) applyBlockingBtn.addEventListener('click', () => this.applyWeekBlocking());
            
            // Week management
            const addWeekBtn = document.getElementById('addWeekBtn');
            if (addWeekBtn) addWeekBtn.addEventListener('click', () => this.addWeek());
            
            const removeWeekBtn = document.getElementById('removeWeekBtn');
            if (removeWeekBtn) removeWeekBtn.addEventListener('click', () => this.removeWeek());
            
            const addWeekToTermBtn = document.getElementById('addWeekToTermBtn');
            if (addWeekToTermBtn) addWeekToTermBtn.addEventListener('click', () => this.addWeekToTerm());
            
            const removeWeekFromTermBtn = document.getElementById('removeWeekFromTermBtn');
            if (removeWeekFromTermBtn) removeWeekFromTermBtn.addEventListener('click', () => this.removeWeekFromTerm());
            
            // Project milestone controls
            const addProjectMarkerBtn = document.getElementById('addProjectMarker');
            if (addProjectMarkerBtn) addProjectMarkerBtn.addEventListener('click', () => this.addProjectMilestone());
            
            const clearProjectMarkersBtn = document.getElementById('clearProjectMarkers');
            if (clearProjectMarkersBtn) clearProjectMarkersBtn.addEventListener('click', () => this.clearAllProjectMilestones());
            
            // Unit management
            const addCustomUnitBtn = document.getElementById('addCustomUnit');
            if (addCustomUnitBtn) addCustomUnitBtn.addEventListener('click', () => this.addUnitFromTemplate(
                { code: 'CUSTOM', name: 'Custom Unit/Block', color: 'foundational', tags: ['CUSTOM'] },
                1,
                'core'
            ));
            
            const importPlanBtn = document.getElementById('importPlanBtn');
            if (importPlanBtn) importPlanBtn.addEventListener('click', () => this.importPlan());
            
            // View toggle
            const toggleBtn = document.getElementById('toggleView');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => this.toggleViewMode());
            }
            
            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Close share panel when clicking outside
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('sharePanel');
                const toggleBtn = document.getElementById('toggleView');
                const shareBtn = document.getElementById('sharePlan');
                
                if (panel && panel.classList.contains('show') && 
                    !panel.contains(e.target) && 
                    !(toggleBtn && toggleBtn.contains(e.target)) &&
                    !(shareBtn && shareBtn.contains(e.target))) {
                    panel.classList.remove('show');
                }
            });
            
            // Close share panel with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const panel = document.getElementById('sharePanel');
                    if (panel && panel.classList.contains('show')) {
                        panel.classList.remove('show');
                    }
                }
            });
            
            // Add sync data button dynamically
            setTimeout(() => {
                if (!this.isStudentView) {
                    const syncDataBtn = document.createElement('button');
                    syncDataBtn.className = 'primary';
                    syncDataBtn.id = 'syncDataBtn';
                    syncDataBtn.innerHTML = 'ðŸ’¾ Sync Now';
                    syncDataBtn.title = 'Force sync data to student view';
                    syncDataBtn.addEventListener('click', () => {
                        if (this.saveData()) {
                            this.showToast('Data synced to student view!', 'success');
                            this.showSyncNotification('Data synced');
                        }
                    });
                    
                    // Insert after save plan button
                    const savePlanBtn = document.getElementById('savePlan');
                    if (savePlanBtn && savePlanBtn.parentNode) {
                        savePlanBtn.parentNode.insertBefore(syncDataBtn, savePlanBtn.nextSibling);
                    }
                }
            }, 500);
        }

        setupTimelineEvents() {
            const container = document.getElementById('timelineContent');
            if (!container) return;

            // Unit click handlers for student view
            container.querySelectorAll('.unit-block').forEach(block => {
                block.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const unitId = e.currentTarget.dataset.unitId;
                    if (this.isStudentView) {
                        this.showStudentUnitDetails(unitId);
                    } else {
                        this.openUnitModal(unitId);
                    }
                });

                // Drag and drop for editor view
                if (!this.isStudentView) {
                    block.addEventListener('dragstart', (e) => {
                        const unitId = e.currentTarget.dataset.unitId;
                        const unit = this.units.find(u => u.id === unitId);
                        if (unit) {
                            this.draggedFromPalette = false;
                            this.draggedUnit = unit;
                            e.dataTransfer.setData('text/plain', JSON.stringify({
                                type: 'move',
                                unitId: unitId
                            }));
                            e.currentTarget.classList.add('dragging');
                        }
                    });

                    block.addEventListener('dragend', (e) => {
                        e.currentTarget.classList.remove('dragging');
                        this.draggedFromPalette = false;
                        this.draggedUnit = null;
                    });
                }
            });

            // Week slot drop zones for editor view
            if (!this.isStudentView) {
                container.querySelectorAll('.week-slot').forEach(slot => {
                    slot.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        slot.style.background = 'rgba(9, 132, 227, 0.1)';
                    });

                    slot.addEventListener('dragleave', () => {
                        slot.style.background = '';
                    });

                    slot.addEventListener('drop', (e) => {
                        e.preventDefault();
                        slot.style.background = '';
                        
                        const week = parseInt(slot.dataset.week);
                        const lane = slot.dataset.lane;
                        
                        try {
                            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                            
                            if (data.type === 'move') {
                                // Moving existing unit
                                this.moveUnit(data.unitId, week, lane);
                            } else {
                                // Adding new unit from template
                                this.addUnitFromTemplate(data, week, lane);
                            }
                            
                            this.showToast('Unit placed successfully', 'success');
                        } catch (error) {
                            console.error('Drop failed:', error);
                        }
                    });
                });
            }
        }

        // ========== UNIT OPERATIONS ==========
        moveUnit(unitId, week, lane) {
            const unitIndex = this.units.findIndex(u => u.id === unitId);
            if (unitIndex === -1) return;

            this.saveHistory();
            
            const unit = this.units[unitIndex];
            unit.weeks = [week];
            
            // Update teacher based on lane
            if (lane === 'specialist' || lane === 'other') {
                unit.teacher = 'other';
                if (!unit.tags.includes('SPECIALIST')) {
                    unit.tags.push('SPECIALIST');
                }
            } else if (lane === 'core' || lane === 'main') {
                unit.teacher = 'main';
                unit.tags = unit.tags.filter(tag => tag !== 'SPECIALIST');
            }

            this.renderEverything();
            this.showSyncNotification('Unit moved');
        }

        addUnitFromTemplate(template, week, lane) {
            this.saveHistory();
            
            const newUnit = {
                id: Date.now().toString(),
                code: template.code === 'CUSTOM' ? `CUST${Date.now()}` : template.code,
                name: template.name,
                weeks: [week],
                color: template.color,
                tags: [...template.tags],
                teacher: lane === 'specialist' || lane === 'other' ? 'other' : 'main',
                notes: '',
                resources: []
            };

            this.units.push(newUnit);
            this.renderEverything();
            this.showSyncNotification('Unit added');
            
            // Open modal to edit the new unit
            if (!this.isStudentView) {
                setTimeout(() => this.openUnitModal(newUnit.id), 100);
            }
        }

        // ========== PROJECT MILESTONE OPERATIONS ==========
        addProjectMilestone() {
            const week = prompt('Enter week for new project milestone (1-' + this.courseData.totalWeeks + '):');
            if (!week) return;
            
            const weekNum = parseInt(week);
            if (isNaN(weekNum) || weekNum < 1 || weekNum > this.courseData.totalWeeks) {
                this.showToast('Invalid week number', 'error');
                return;
            }
            
            const label = prompt('Enter milestone label:', 'New Milestone');
            if (!label) return;
            
            this.saveHistory();
            
            const newMilestone = {
                id: `milestone-${Date.now()}`,
                week: weekNum,
                label: label
            };
            
            this.courseData.projectMilestones.push(newMilestone);
            this.renderEverything();
            this.showToast('Project milestone added', 'success');
            this.showSyncNotification('Project milestone added');
        }

        moveProjectMilestone(milestoneId, newWeek) {
            const milestoneIndex = this.courseData.projectMilestones.findIndex(m => m.id === milestoneId);
            if (milestoneIndex === -1) return;
            
            this.saveHistory();
            
            this.courseData.projectMilestones[milestoneIndex].week = newWeek;
            this.renderEverything();
            this.showToast('Project milestone moved to week ' + newWeek, 'success');
            this.showSyncNotification('Project milestone moved');
        }

        deleteProjectMilestone(milestoneId) {
            if (!confirm('Delete this project milestone?')) return;
            
            this.saveHistory();
            
            this.courseData.projectMilestones = this.courseData.projectMilestones.filter(m => m.id !== milestoneId);
            this.renderEverything();
            this.showToast('Project milestone deleted', 'success');
            this.showSyncNotification('Project milestone deleted');
        }

        clearAllProjectMilestones() {
            if (!confirm('Clear ALL project milestones?')) return;
            
            this.saveHistory();
            
            this.courseData.projectMilestones = [];
            this.renderEverything();
            this.showToast('All project milestones cleared', 'success');
            this.showSyncNotification('Project milestones cleared');
        }

        showProjectMilestoneDetails(milestone) {
            const modal = document.getElementById('unitModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');

            modalTitle.textContent = `Project Milestone: ${milestone.label}`;
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 12px; color: #636e72;">Week</div>
                            <div style="font-weight: 600;">Week ${milestone.week}</div>
                        </div>
                    </div>
                    
                    <button onclick="document.getElementById('unitModal').style.display = 'none'" 
                            style="width: 100%; padding: 10px; background: #0984e3; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // ========== MODAL OPERATIONS ==========
        openUnitModal(unitId) {
            if (this.isStudentView) return;
            
            const unit = this.units.find(u => u.id === unitId);
            if (!unit) return;

            const modal = document.getElementById('unitModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');

            modalTitle.textContent = `Edit Unit: ${unit.code}`;
            
            modalBody.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="form-group">
                        <label for="editUnitCode">Unit Code</label>
                        <input type="text" id="editUnitCode" value="${unit.code}">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUnitName">Unit Name</label>
                        <input type="text" id="editUnitName" value="${unit.name}">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUnitWeeks">Weeks</label>
                        <input type="text" id="editUnitWeeks" value="${unit.weeks.join(',')}"
                               placeholder="e.g., 1,2,3 or 5-7">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUnitColor">Unit Type</label>
                        <select id="editUnitColor">
                            <option value="safety" ${unit.color === 'safety' ? 'selected' : ''}>Safety</option>
                            <option value="foundational" ${unit.color === 'foundational' ? 'selected' : ''}>Foundational</option>
                            <option value="practical" ${unit.color === 'practical' ? 'selected' : ''}>Practical</option>
                            <option value="machinery" ${unit.color === 'machinery' ? 'selected' : ''}>Machinery</option>
                            <option value="apex" ${unit.color === 'apex' ? 'selected' : ''}>Apex</option>
                            <option value="project" ${unit.color === 'project' ? 'selected' : ''}>Project</option>
                            <option value="seasonal" ${unit.color === 'seasonal' ? 'selected' : ''}>Seasonal</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUnitTeacher">Teacher</label>
                        <select id="editUnitTeacher">
                            <option value="main" ${unit.teacher === 'main' ? 'selected' : ''}>Main Teacher</option>
                            <option value="other" ${unit.teacher === 'other' ? 'selected' : ''}>Other Teacher</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUnitTags">Tags (comma separated)</label>
                        <input type="text" id="editUnitTags" value="${unit.tags ? unit.tags.join(', ') : ''}"
                               placeholder="SAFETY, SEASONAL, SPECIALIST">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUnitNotes">Notes</label>
                        <textarea id="editUnitNotes" rows="4">${unit.notes || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="primary" onclick="window.app.saveUnitChanges('${unitId}')" style="flex: 1;">Save Changes</button>
                        <button class="warning" onclick="window.app.deleteUnit('${unitId}')" style="flex: 1;">Delete Unit</button>
                        <button onclick="document.getElementById('unitModal').style.display = 'none'" style="flex: 1;">Cancel</button>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        saveUnitChanges(unitId) {
            const unitIndex = this.units.findIndex(u => u.id === unitId);
            if (unitIndex === -1) return;

            this.saveHistory();
            
            const unit = this.units[unitIndex];
            unit.code = document.getElementById('editUnitCode').value;
            unit.name = document.getElementById('editUnitName').value;
            
            const weeksInput = document.getElementById('editUnitWeeks').value;
            unit.weeks = this.parseWeeksInput(weeksInput);
            
            unit.color = document.getElementById('editUnitColor').value;
            unit.teacher = document.getElementById('editUnitTeacher').value;
            
            const tagsInput = document.getElementById('editUnitTags').value;
            unit.tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            unit.notes = document.getElementById('editUnitNotes').value;

            document.getElementById('unitModal').style.display = 'none';
            this.renderEverything();
            this.showToast('Unit updated successfully', 'success');
            this.showSyncNotification('Unit updated');
        }

        parseWeeksInput(input) {
            try {
                if (input.includes('-')) {
                    const [start, end] = input.split('-').map(Number);
                    return Array.from({length: end - start + 1}, (_, i) => start + i);
                } else if (input.includes(',')) {
                    return input.split(',').map(w => parseInt(w.trim())).filter(w => !isNaN(w));
                } else {
                    const week = parseInt(input);
                    return !isNaN(week) ? [week] : [1];
                }
            } catch (error) {
                return [1];
            }
        }

        deleteUnit(unitId) {
            if (confirm('Are you sure you want to delete this unit?')) {
                this.saveHistory();
                this.units = this.units.filter(u => u.id !== unitId);
                document.getElementById('unitModal').style.display = 'none';
                this.renderEverything();
                this.showToast('Unit deleted', 'success');
                this.showSyncNotification('Unit deleted');
            }
        }

        // ========== STUDENT VIEW ==========
        renderStudentTermOverviews() {
            const container = document.getElementById('studentTermOverviews');
            if (!container) return;

            let html = '';
            
            this.courseData.terms.forEach(term => {
                const termUnits = this.units.filter(unit => {
                    const weeks = unit.weeks;
                    return weeks.some(week => 
                        week >= term.startWeek && week < term.startWeek + term.weeks
                    );
                });
                
                // Get unique units by code
                const uniqueUnits = [];
                const seenCodes = new Set();
                termUnits.forEach(unit => {
                    if (!seenCodes.has(unit.code)) {
                        seenCodes.add(unit.code);
                        uniqueUnits.push(unit);
                    }
                });
                
                html += `
                    <div class="term-overview">
                        <h3>Term ${term.number}: ${term.name}</h3>
                        <div class="term-units">
                            ${uniqueUnits.map(unit => `
                                <div class="term-unit-card">
                                    <div style="font-weight: 600; color: #0984e3;">${unit.code}</div>
                                    <div style="font-size: 13px; margin-top: 5px;">${unit.name}</div>
                                    ${unit.teacher === 'other' ? 
                                        `<div style="font-size: 11px; color: #fd79a8; margin-top: 3px;">Other Teacher</div>` : ''}
                                    ${unit.tags && unit.tags.includes('SEASONAL') ? 
                                        `<div style="font-size: 11px; color: #55efc4; margin-top: 3px;">Seasonal Timing</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        showStudentUnitDetails(unitId) {
            const unit = this.units.find(u => u.id === unitId);
            if (!unit) return;

            const modal = document.getElementById('unitModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');

            modalTitle.textContent = `${unit.code} - ${unit.name}`;
            
            const weeks = unit.weeks;
            const startWeek = Math.min(...weeks);
            const endWeek = Math.max(...weeks);
            const duration = weeks.length;
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 12px; color: #636e72;">Timing</div>
                            <div style="font-weight: 600;">Weeks ${startWeek}-${endWeek} (${duration} week${duration > 1 ? 's' : ''})</div>
                        </div>
                        <div style="flex: 1; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 12px; color: #636e72;">Taught by</div>
                            <div style="font-weight: 600;">${unit.teacher === 'other' ? 'Other Teacher' : 'Main Teacher'}</div>
                        </div>
                    </div>
                    
                    ${unit.tags && unit.tags.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #636e72; margin-bottom: 5px;">Tags</div>
                            <div>
                                ${unit.tags.map(tag => `
                                    <span style="display: inline-block; background: #e9ecef; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-right: 5px; margin-bottom: 5px;">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${unit.notes ? `
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 12px; color: #636e72; margin-bottom: 5px;">Description</div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">${unit.notes}</div>
                        </div>
                    ` : ''}
                    
                    <button onclick="document.getElementById('unitModal').style.display = 'none'" 
                            style="width: 100%; padding: 10px; background: #0984e3; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // ========== UNIT PALETTE ==========
        renderUnitPalette() {
            if (this.isStudentView) return;
            
            const container = document.getElementById('unitPalette');
            if (!container) return;

            container.innerHTML = this.unitTemplates.map(template => `
                <div class="unit-item" draggable="true" data-template='${JSON.stringify(template)}'
                     style="border-left: 4px solid ${this.colorMap[template.color]};">
                    <div class="unit-code">${template.code}</div>
                    <div class="unit-name">${template.name}</div>
                    <div style="display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap;">
                        ${template.tags.map(tag => `
                            <span style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: #e9ecef; color: #495057;">
                                ${tag}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Add drag event listeners
            container.querySelectorAll('.unit-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    const template = JSON.parse(e.currentTarget.dataset.template);
                    this.draggedFromPalette = true;
                    this.draggedUnit = template;
                    e.dataTransfer.setData('text/plain', JSON.stringify(template));
                    e.currentTarget.classList.add('dragging');
                });

                item.addEventListener('dragend', (e) => {
                    e.currentTarget.classList.remove('dragging');
                    this.draggedFromPalette = false;
                    this.draggedUnit = null;
                });
            });
        }

        // ========== SAVED PLANS ==========
        renderSavedPlans() {
            if (this.isStudentView) return;
            
            const container = document.getElementById('savedPlans');
            if (!container) return;

            try {
                const savedPlans = JSON.parse(localStorage.getItem('cet_plans') || '[]');
                
                if (savedPlans.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-size: 14px;">No saved plans yet.</p>';
                    return;
                }

                container.innerHTML = savedPlans.map(plan => `
                    <div style="padding: 10px; margin-bottom: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #0984e3;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${plan.name}</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ${new Date(plan.date).toLocaleDateString()} â€¢ ${plan.units?.length || 0} units
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="window.app.loadPlan('${plan.id}')" 
                                    style="flex: 1; padding: 5px; font-size: 12px; background: #0984e3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Load
                            </button>
                            <button onclick="window.app.deleteSavedPlan('${plan.id}')" 
                                    style="flex: 1; padding: 5px; font-size: 12px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to render saved plans:', error);
                container.innerHTML = '<p style="color: #666; font-size: 14px;">Error loading saved plans.</p>';
            }
        }

        savePlan() {
            if (this.isStudentView) return;
            
            const planName = prompt('Enter a name for this plan:', `Plan ${new Date().toLocaleDateString()}`);
            if (!planName) return;

            const plan = {
                id: Date.now().toString(),
                name: planName,
                date: new Date().toISOString(),
                units: this.units,
                courseData: this.courseData,
                blockedWeeks: this.blockedWeeks,
                version: CONFIG.APP_VERSION
            };

            try {
                let savedPlans = JSON.parse(localStorage.getItem('cet_plans') || '[]');
                savedPlans.push(plan);
                localStorage.setItem('cet_plans', JSON.stringify(savedPlans));
                
                this.showToast(`Plan "${planName}" saved!`, 'success');
                this.renderSavedPlans();
                this.showSyncNotification('Plan saved');
            } catch (error) {
                console.error('Failed to save plan:', error);
                this.showToast('Failed to save plan', 'error');
            }
        }

        loadPlan(planId) {
            try {
                const savedPlans = JSON.parse(localStorage.getItem('cet_plans') || '[]');
                const plan = savedPlans.find(p => p.id === planId);
                
                if (plan) {
                    this.saveHistory();
                    this.units = plan.units || [];
                    this.courseData = plan.courseData || this.courseData;
                    this.blockedWeeks = plan.blockedWeeks || {};
                    this.renderEverything();
                    this.showToast(`Loaded "${plan.name}"`, 'success');
                    this.showSyncNotification('Plan loaded');
                }
            } catch (error) {
                console.error('Failed to load plan:', error);
                this.showToast('Failed to load plan', 'error');
            }
        }

        deleteSavedPlan(planId) {
            if (confirm('Delete this saved plan?')) {
                try {
                    let savedPlans = JSON.parse(localStorage.getItem('cet_plans') || '[]');
                    savedPlans = savedPlans.filter(p => p.id !== planId);
                    localStorage.setItem('cet_plans', JSON.stringify(savedPlans));
                    this.renderSavedPlans();
                    this.showToast('Plan deleted', 'success');
                } catch (error) {
                    console.error('Failed to delete plan:', error);
                    this.showToast('Failed to delete plan', 'error');
                }
            }
        }

        // ========== SHARING ==========
        generateShareLink() {
            // First, ensure data is saved to shared storage
            if (!this.saveData()) {
                this.showToast('Failed to save data for sharing', 'error');
                return null;
            }
            
            // Generate simple share URL
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?student=true&v=${Date.now()}`; // Add timestamp to prevent caching
            
            console.log('=== SHARE LINK GENERATED ===');
            console.log('Share URL:', shareUrl);
            console.log('Data saved to:', CONFIG.SHARED_STORAGE_KEY);
            console.log('Units in storage:', this.units.length);
            console.log('Timestamp:', new Date().toISOString());
            
            // Verify data was actually saved
            setTimeout(() => this.verifyDataSync(), 100);
            
            return shareUrl;
        }

        sharePlan() {
            if (this.isStudentView) return;
            
            // Show saving indicator
            this.showToast('Saving data for sharing...', 'info');
            
            // Force immediate save with callback
            const saveSuccess = this.saveData();
            
            if (!saveSuccess) {
                this.showToast('Failed to save data for sharing', 'error');
                return;
            }
            
            // Generate share URL with timestamp to prevent caching
            const baseUrl = window.location.origin + window.location.pathname;
            const timestamp = Date.now();
            const shareUrl = `${baseUrl}?student=true&v=${timestamp}`;
            
            console.log('=== SHARE PLAN ===');
            console.log('Share URL:', shareUrl);
            console.log('Timestamp:', timestamp);
            console.log('Units saved:', this.units.length);
            
            // Show share panel
            const panel = document.getElementById('sharePanel');
            const input = document.getElementById('shareLink');
            const copyBtn = document.getElementById('copyShareLink');
            const qrContainer = document.getElementById('qrCode');
            
            input.value = shareUrl;
            panel.classList.add('show');
            
            // Force QR code refresh by adding a unique parameter
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareUrl)}&qzone=2&t=${timestamp}`;
            
            qrContainer.innerHTML = `
                <div style="text-align: center;">
                    <img src="${qrUrl}" 
                         alt="QR Code" 
                         style="border: 1px solid #ddd; border-radius: 6px;"
                         onload="console.log('QR code loaded for timestamp: ${timestamp}')"
                         onerror="console.error('QR code failed to load')">
                    <div style="margin-top: 10px; font-size: 11px; color: #666;">
                        Scan this QR code to view the current schedule
                    </div>
                </div>
                <div style="font-size: 12px; margin-top: 10px; color: #636e72;">
                    <div style="margin-bottom: 5px;">Students will see:</div>
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 11px;">
                        â€¢ Current schedule (${this.units.length} units, ${this.courseData.totalWeeks} weeks)<br>
                        â€¢ Term overviews<br>
                        â€¢ Unit details on click<br>
                        â€¢ No editing controls<br>
                        â€¢ Updated automatically when you save changes
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 11px;">
                        <strong>Tip:</strong> If students see old data, ask them to refresh their browser.
                    </div>
                    <button onclick="window.app.testStudentView('${shareUrl}')" 
                            style="width: 100%; margin-top: 10px; padding: 8px; background: #00b894; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Test Student View
                    </button>
                    <button onclick="window.open('${shareUrl}', '_blank')" 
                            style="width: 100%; margin-top: 5px; padding: 8px; background: #0984e3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Open Student View in New Tab
                    </button>
                    <button onclick="window.app.refreshQRCode()" 
                            style="width: 100%; margin-top: 5px; padding: 8px; background: #a29bfe; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ðŸ”„ Refresh QR Code
                    </button>
                </div>
            `;
            
            copyBtn.onclick = () => {
                input.select();
                input.setSelectionRange(0, 99999);
                document.execCommand('copy');
                this.showToast('Link copied to clipboard!', 'success');
            };
            
            this.showToast('Share link generated! QR code shows current schedule.', 'success');
            
            // Add a verification step
            setTimeout(() => {
                console.log('=== VERIFYING SHARED DATA ===');
                const storedData = localStorage.getItem(CONFIG.SHARED_STORAGE_KEY);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    console.log('Data verified in storage:', {
                        units: data.units?.length || 0,
                        weeks: data.courseData?.totalWeeks || 0,
                        timestamp: data.lastUpdate
                    });
                }
            }, 100);
        }

        // ========== NEW: Refresh QR Code ==========
        refreshQRCode() {
            if (this.isStudentView) return;
            
            this.showToast('Refreshing QR code...', 'info');
            
            // Force save current data
            this.saveData();
            
            // Generate new URL with fresh timestamp
            const baseUrl = window.location.origin + window.location.pathname;
            const timestamp = Date.now();
            const shareUrl = `${baseUrl}?student=true&v=${timestamp}`;
            
            // Update the share link input
            const input = document.getElementById('shareLink');
            if (input) {
                input.value = shareUrl;
            }
            
            // Update QR code with fresh image
            const qrContainer = document.getElementById('qrCode');
            if (qrContainer) {
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareUrl)}&qzone=2&t=${timestamp}`;
                
                // Find and update the QR code image
                const qrImg = qrContainer.querySelector('img');
                if (qrImg) {
                    qrImg.src = qrUrl;
                    qrImg.onload = () => {
                        this.showToast('QR code refreshed! Scan again for latest data.', 'success');
                        console.log('QR code refreshed with timestamp:', timestamp);
                    };
                }
            }
        }

        // ========== TEST METHOD ==========
        testStudentView(url) {
            // Open in new window and check data
            const testWindow = window.open(url, '_blank', 'width=1200,height=800');
            
            if (testWindow) {
                this.showToast('Opening test window...', 'info');
                
                // Add a message to the test window
                setTimeout(() => {
                    if (testWindow.closed) return;
                    
                    try {
                        // Check if data loaded in test window
                        testWindow.postMessage({
                            type: 'test_data_load',
                            source: 'editor',
                            timestamp: Date.now(),
                            units: this.units.length,
                            weeks: this.courseData.totalWeeks
                        }, '*');
                        
                        this.showToast('Test window opened. Verify data matches.', 'success');
                    } catch (e) {
                        console.error('Test failed:', e);
                    }
                }, 1000);
            } else {
                this.showToast('Popup blocked. Please allow popups to test.', 'error');
            }
        }

        toggleViewMode() {
            if (this.isStudentView) {
                // Switch to editor view
                window.location.href = window.location.pathname;
            } else {
                // Show preview of student view in the share panel
                this.sharePlan();
            }
        }

        // ========== RESET OPERATIONS ==========
        resetToDefault() {
            if (confirm('Reset to default course sequence? Any unsaved changes will be lost.')) {
                this.saveHistory();
                this.units = [...this.defaultUnits];
                this.courseData = {
                    totalWeeks: CONFIG.DEFAULT_TOTAL_WEEKS,
                    terms: [
                        { number: 1, weeks: 10, startWeek: 1, name: "Safety, Foundations & Summer Harvest" },
                        { number: 2, weeks: 10, startWeek: 11, name: "Practical Skills & Application" },
                        { number: 3, weeks: 10, startWeek: 21, name: "Machinery & Advanced Integration" },
                        { number: 4, weeks: 7, startWeek: 31, name: "Apex & Finalisation" }
                    ],
                    projectMilestones: [
                        { week: 18, label: "Project Start" },
                        { week: 25, label: "Phase 2" },
                        { week: 30, label: "Integration" },
                        { week: 34, label: "Final Phase" }
                    ]
                };
                this.blockedWeeks = {};
                
                this.renderEverything();
                this.showToast('Reset to default sequence', 'success');
                this.showSyncNotification('Reset to default');
            }
        }

        clearTimetable() {
            if (confirm('Are you sure you want to clear ALL units from the timetable?')) {
                this.saveHistory();
                this.units = [];
                this.renderEverything();
                this.showToast('Timetable cleared', 'success');
                this.showSyncNotification('Timetable cleared');
            }
        }

        // ========== WEEK BLOCKING ==========
        applyWeekBlocking() {
            if (this.isStudentView) return;
            
            const blockingType = document.getElementById('weekBlocking').value;
            const weekRangeInput = document.getElementById('weekRange').value;
            
            if (!blockingType || !weekRangeInput) {
                this.showToast('Please select blocking type and enter week range', 'error');
                return;
            }
            
            let weeks = [];
            if (weekRangeInput.includes('-')) {
                const [start, end] = weekRangeInput.split('-').map(Number);
                weeks = Array.from({length: end - start + 1}, (_, i) => start + i);
            } else if (weekRangeInput.includes(',')) {
                weeks = weekRangeInput.split(',').map(w => parseInt(w.trim())).filter(w => !isNaN(w));
            } else {
                weeks = [parseInt(weekRangeInput) || 1];
            }
            
            // Validate weeks
            weeks.forEach(week => {
                if (week < 1 || week > this.courseData.totalWeeks) {
                    this.showToast(`Week ${week} is outside valid range`, 'error');
                    return;
                }
            });
            
            this.saveHistory();
            
            weeks.forEach(week => {
                if (blockingType === 'clear') {
                    delete this.blockedWeeks[week];
                } else {
                    this.blockedWeeks[week] = {
                        type: blockingType,
                        label: this.blockingLabels[blockingType]
                    };
                }
            });
            
            this.renderEverything();
            this.showToast(`Week blocking applied to weeks ${weeks.join(', ')}`, 'success');
            this.showSyncNotification('Week blocking applied');
        }

        // ========== WEEK MANAGEMENT ==========
        addWeek() {
            if (this.isStudentView) return;
            
            const position = prompt(`Add week at which position? (1-${this.courseData.totalWeeks + 1}, or "end" for at the end)`);
            if (!position) return;

            this.saveHistory();
            
            let insertPosition;
            if (position.toLowerCase() === 'end') {
                insertPosition = this.courseData.totalWeeks + 1;
            } else {
                insertPosition = parseInt(position);
                if (isNaN(insertPosition) || insertPosition < 1 || insertPosition > this.courseData.totalWeeks + 1) {
                    this.showToast('Invalid position', 'error');
                    return;
                }
            }

            // Increment total weeks
            this.courseData.totalWeeks++;
            
            // Find which term this week is being inserted into
            let termToUpdate = null;
            let termIndex = -1;
            
            for (let i = 0; i < this.courseData.terms.length; i++) {
                const term = this.courseData.terms[i];
                if (insertPosition >= term.startWeek) {
                    termToUpdate = term;
                    termIndex = i;
                }
            }
            
            // Update the term where week is inserted
            if (termToUpdate && insertPosition >= termToUpdate.startWeek && insertPosition <= termToUpdate.startWeek + termToUpdate.weeks) {
                termToUpdate.weeks++;
            }
            
            // Update subsequent terms' start weeks
            for (let i = termIndex + 1; i < this.courseData.terms.length; i++) {
                this.courseData.terms[i].startWeek++;
            }
            
            // Adjust units
            this.adjustUnitsForWeekInsertion(insertPosition, 1);
            
            this.renderEverything();
            this.showToast('Week added', 'success');
            this.showSyncNotification('Week added');
        }

        removeWeek() {
            if (this.isStudentView) return;
            
            const weekToRemove = parseInt(prompt(`Remove which week? (1-${this.courseData.totalWeeks})`));
            if (isNaN(weekToRemove) || weekToRemove < 1 || weekToRemove > this.courseData.totalWeeks) {
                this.showToast('Invalid week', 'error');
                return;
            }

            if (!confirm(`Remove Week ${weekToRemove}? This will also remove any units scheduled for this week.`)) {
                return;
            }

            this.saveHistory();
            
            // Decrement total weeks
            this.courseData.totalWeeks--;
            
            // Find which term this week is in
            let termToUpdate = null;
            let termIndex = -1;
            
            for (let i = 0; i < this.courseData.terms.length; i++) {
                const term = this.courseData.terms[i];
                if (weekToRemove >= term.startWeek && weekToRemove < term.startWeek + term.weeks) {
                    termToUpdate = term;
                    termIndex = i;
                    break;
                }
            }
            
            if (termToUpdate) {
                termToUpdate.weeks--;
            }
            
            // Update subsequent terms' start weeks
            for (let i = termIndex + 1; i < this.courseData.terms.length; i++) {
                this.courseData.terms[i].startWeek--;
            }
            
            // Remove units in this week and adjust others
            this.adjustUnitsForWeekRemoval(weekToRemove);
            
            this.renderEverything();
            this.showToast('Week removed', 'success');
            this.showSyncNotification('Week removed');
        }

        addWeekToTerm() {
            if (this.isStudentView) return;
            
            const termNumber = parseInt(prompt('Add a week to which term? (1-4)'));
            if (isNaN(termNumber) || termNumber < 1 || termNumber > this.courseData.terms.length) {
                this.showToast('Invalid term number', 'error');
                return;
            }

            this.saveHistory();
            
            const term = this.courseData.terms[termNumber - 1];
            
            // Increment total weeks
            this.courseData.totalWeeks++;
            
            // Add week to this term
            term.weeks++;
            
            // Update subsequent terms' start weeks
            for (let i = termNumber; i < this.courseData.terms.length; i++) {
                this.courseData.terms[i].startWeek++;
            }
            
            // Adjust units in subsequent terms
            this.adjustUnitsForWeekInsertion(term.startWeek + term.weeks - 1, 1);
            
            this.renderEverything();
            this.showToast(`Week added to Term ${termNumber}`, 'success');
            this.showSyncNotification('Week added to term');
        }

        removeWeekFromTerm() {
            if (this.isStudentView) return;
            
            const termNumber = parseInt(prompt('Remove a week from which term? (1-4)'));
            if (isNaN(termNumber) || termNumber < 1 || termNumber > this.courseData.terms.length) {
                this.showToast('Invalid term number', 'error');
                return;
            }

            const term = this.courseData.terms[termNumber - 1];
            
            if (term.weeks <= 1) {
                this.showToast(`Term ${termNumber} already has only 1 week`, 'error');
                return;
            }

            const weekToRemove = term.startWeek + term.weeks - 1;
            
            if (!confirm(`Remove week ${weekToRemove} from Term ${termNumber}?`)) {
                return;
            }

            this.saveHistory();
            
            // Decrement total weeks
            this.courseData.totalWeeks--;
            
            // Remove week from this term
            term.weeks--;
            
            // Update subsequent terms' start weeks
            for (let i = termNumber; i < this.courseData.terms.length; i++) {
                this.courseData.terms[i].startWeek--;
            }
            
            // Remove units in this week and adjust others
            this.adjustUnitsForWeekRemoval(weekToRemove);
            
            this.renderEverything();
            this.showToast(`Week removed from Term ${termNumber}`, 'success');
            this.showSyncNotification('Week removed from term');
        }

        adjustUnitsForWeekInsertion(insertPosition, count) {
            this.units.forEach(unit => {
                unit.weeks = unit.weeks.map(week => {
                    if (week >= insertPosition) {
                        return week + count;
                    }
                    return week;
                });
            });
            
            // Adjust blocked weeks
            const newBlockedWeeks = {};
            Object.keys(this.blockedWeeks).forEach(weekStr => {
                let week = parseInt(weekStr);
                if (week >= insertPosition) {
                    week += count;
                }
                newBlockedWeeks[week] = this.blockedWeeks[weekStr];
            });
            this.blockedWeeks = newBlockedWeeks;
            
            // Adjust project milestones
            this.courseData.projectMilestones.forEach(milestone => {
                if (milestone.week >= insertPosition) {
                    milestone.week += count;
                }
            });
        }

        adjustUnitsForWeekRemoval(weekToRemove) {
            // Remove units in this week
            this.units = this.units.filter(unit => !unit.weeks.includes(weekToRemove));
            
            // Adjust remaining units
            this.units.forEach(unit => {
                unit.weeks = unit.weeks
                    .map(w => w > weekToRemove ? w - 1 : w)
                    .filter(w => w !== weekToRemove);
            });
            
            // Remove blocked week if exists
            delete this.blockedWeeks[weekToRemove];
            
            // Adjust remaining blocked weeks
            const newBlockedWeeks = {};
            Object.keys(this.blockedWeeks).forEach(weekStr => {
                let week = parseInt(weekStr);
                if (week > weekToRemove) {
                    week--;
                }
                newBlockedWeeks[week] = this.blockedWeeks[weekStr];
            });
            this.blockedWeeks = newBlockedWeeks;
            
            // Adjust project milestones
            this.courseData.projectMilestones = this.courseData.projectMilestones
                .filter(milestone => milestone.week !== weekToRemove)
                .map(milestone => {
                    if (milestone.week > weekToRemove) {
                        return { ...milestone, week: milestone.week - 1 };
                    }
                    return milestone;
                });
        }

        // ========== EXPORT/IMPORT ==========
        exportPlan() {
            if (this.isStudentView) return;
            
            const data = {
                version: CONFIG.APP_VERSION,
                timestamp: new Date().toISOString(),
                units: this.units,
                courseData: this.courseData,
                blockedWeeks: this.blockedWeeks
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `course-plan-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showToast('Plan exported successfully', 'success');
        }

        importPlan() {
            if (this.isStudentView) return;
            
            const fileInput = document.getElementById('importPlan');
            if (!fileInput.files.length) return;
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.units && data.courseData) {
                        this.saveHistory();
                        this.units = data.units;
                        this.courseData = data.courseData;
                        this.blockedWeeks = data.blockedWeeks || {};
                        this.renderEverything();
                        this.showToast('Plan imported successfully', 'success');
                        this.showSyncNotification('Plan imported');
                    } else {
                        this.showToast('Invalid plan file', 'error');
                    }
                } catch (error) {
                    console.error('Failed to import plan:', error);
                    this.showToast('Failed to import plan', 'error');
                }
            };
            
            reader.readAsText(file);
            fileInput.value = '';
        }

        printPlan() {
            window.print();
        }

        // ========== UTILITIES ==========
        getTermForWeek(week) {
            return this.courseData.terms.find(term => 
                week >= term.startWeek && week < term.startWeek + term.weeks
            );
        }

        updateTotalWeeksDisplay() {
            const display = document.getElementById('totalWeeksDisplay');
            if (display) {
                display.textContent = this.courseData.totalWeeks;
            }
        }

        showToast(message, type = 'info') {
            try {
                // Check if toast container exists, create it if not
                let container = document.getElementById('toastsContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toastsContainer';
                    document.body.appendChild(container);
                }

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('Failed to show toast:', error);
            }
        }

        showSyncNotification(message) {
            const status = document.getElementById('syncStatus');
            const messageEl = document.getElementById('syncMessage');
            if (status && messageEl) {
                messageEl.textContent = message + ' (synced to student view)';
                status.classList.add('show');
                
                setTimeout(() => {
                    status.classList.remove('show');
                }, 3000);
            }
        }

        hideLoadingScreen() {
            try {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.style.opacity = '0';
                    setTimeout(() => {
                        if (loading.parentNode) {
                            loading.style.display = 'none';
                        }
                    }, 300);
                }
            } catch (error) {
                console.error('Error hiding loading screen:', error);
            }
        }

        darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return '#' + (
                0x1000000 +
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }

        // ========== KEYBOARD SHORTCUTS ==========
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.target.matches('input, textarea, select')) return;
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'z':
                            if (!this.isStudentView) {
                                e.preventDefault();
                                if (e.shiftKey) {
                                    this.redo();
                                } else {
                                    this.undo();
                                }
                            }
                            break;
                        case 'y':
                            if (!this.isStudentView) {
                                e.preventDefault();
                                this.redo();
                            }
                            break;
                        case 's':
                            if (!this.isStudentView) {
                                e.preventDefault();
                                this.savePlan();
                            }
                            break;
                        case 'p':
                            e.preventDefault();
                            this.printPlan();
                            break;
                    }
                }
                
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                    const panel = document.getElementById('sharePanel');
                    if (panel) panel.classList.remove('show');
                }
            });
        }

        undo() {
            if (this.historyIndex > 0) {
                this.historyIndex--;
                const state = this.history[this.historyIndex];
                this.units = JSON.parse(JSON.stringify(state.units));
                this.courseData = JSON.parse(JSON.stringify(state.courseData));
                this.blockedWeeks = JSON.parse(JSON.stringify(state.blockedWeeks));
                this.renderEverything();
                this.showToast('Undo', 'success');
                return true;
            }
            return false;
        }

        redo() {
            if (this.historyIndex < this.history.length - 1) {
                this.historyIndex++;
                const state = this.history[this.historyIndex];
                this.units = JSON.parse(JSON.stringify(state.units));
                this.courseData = JSON.parse(JSON.stringify(state.courseData));
                this.blockedWeeks = JSON.parse(JSON.stringify(state.blockedWeeks));
                this.renderEverything();
                this.showToast('Redo', 'success');
                return true;
            }
            return false;
        }

        // ========== DEBUG METHODS ==========
        verifyDataSync() {
            const sharedData = localStorage.getItem(CONFIG.SHARED_STORAGE_KEY);
            if (!sharedData) {
                console.warn('No shared data found in storage');
                return false;
            }
            
            try {
                const data = JSON.parse(sharedData);
                console.log('=== DATA VERIFICATION ===');
                console.log('Storage key:', CONFIG.SHARED_STORAGE_KEY);
                console.log('Data version:', data.version);
                console.log('Last update:', data.lastUpdate);
                console.log('Units in storage:', data.units?.length || 0);
                console.log('Units in memory:', this.units.length);
                console.log('Match:', data.units?.length === this.units.length);
                return true;
            } catch (error) {
                console.error('Data verification failed:', error);
                return false;
            }
        }
    }

    // ========== INITIALIZE APP ==========
    let app;
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, initializing app...');
        
        // Create the app instance
        app = new CoursePlanner();
        window.app = app;
        
        // Add message listener for testing
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'test_data_load' && event.data.source === 'editor') {
                console.log('=== STUDENT VIEW TEST ===');
                console.log('Editor sent:', event.data.units, 'units,', event.data.weeks, 'weeks');
                console.log('Student has:', app.units.length, 'units,', app.courseData.totalWeeks, 'weeks');
                
                if (event.data.units === app.units.length && event.data.weeks === app.courseData.totalWeeks) {
                    alert('âœ“ Test passed! Data is synchronized correctly.');
                } else {
                    alert('âš  Test failed! Data mismatch. Check console for details.');
                }
            }
        });
        
        // Add debug button for testing (only in editor view)
        setTimeout(() => {
            if (app && !app.isStudentView) {
                const debugBtn = document.createElement('button');
                debugBtn.textContent = 'ðŸ” Verify Sync';
                debugBtn.style.cssText = `
                    position: fixed;
                    bottom: 70px;
                    right: 20px;
                    padding: 10px 15px;
                    background: #2d3436;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    z-index: 1000;
                    font-size: 14px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                `;
                debugBtn.onclick = () => {
                    console.log('=== DEBUG SYNC STATUS ===');
                    const isSynced = app.verifyDataSync();
                    alert(isSynced ? 'âœ“ Data is synchronized!' : 'âœ— Data sync issue - check console');
                };
                document.body.appendChild(debugBtn);
            }
        }, 500); // Wait a bit for everything to settle
    });
</script>
