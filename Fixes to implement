You're right, let me examine the code more carefully. Looking at your original showProjectInModal() function and the context, I can see the issue. The problem is in how the project data is being passed from the table to the function. Let me trace through the exact issue:

The Problem

In your loadProjects() function, you're creating the onclick handler like this:

```javascript
onclick="showProjectInModal(${JSON.stringify(project).replace(/"/g, '&quot;')})"
```

The issue is that when this HTML is inserted into the DOM, the quotes are being escaped, but the JavaScript function is receiving a string instead of a proper JavaScript object.

Solution: Fix the Data Passing

Change the loadProjects() function where it creates the location cell:

Replace this section in loadProjects():

```javascript
locationCell = `
    <div class="d-flex align-items-center">
        <div class="map-preview me-2" 
             style="width: 100px; background-color: #f8f9fa;"
             onclick="showProjectInModal(${JSON.stringify(project).replace(/"/g, '&quot;')})">
            <div class="w-100 h-100 d-flex align-items-center justify-content-center">
                <i class="bi bi-geo-alt-fill text-primary"></i>
            </div>
        </div>
        <button class="btn btn-sm btn-outline-primary" 
                onclick="showProjectInModal(${JSON.stringify(project).replace(/"/g, '&quot;')})">
            <i class="bi bi-eye"></i> View
        </button>
    </div>
`;
```

With this:

```javascript
// Create a safe string representation of the project
const projectJSON = JSON.stringify(project)
    .replace(/"/g, '&quot;')
    .replace(/'/g, "\\'")
    .replace(/\n/g, '\\n');

locationCell = `
    <div class="d-flex align-items-center">
        <div class="map-preview me-2" 
             style="width: 100px; background-color: #f8f9fa;"
             onclick="showProjectInModal(JSON.parse('${projectJSON}'))">
            <div class="w-100 h-100 d-flex align-items-center justify-content-center">
                <i class="bi bi-geo-alt-fill text-primary"></i>
            </div>
        </div>
        <button class="btn btn-sm btn-outline-primary" 
                onclick="showProjectInModal(JSON.parse('${projectJSON}'))">
            <i class="bi bi-eye"></i> View
        </button>
    </div>
`;
```

Alternative Cleaner Solution

An even better approach is to use data attributes instead of inline JavaScript:

Update the loadProjects() function:

```javascript
locationCell = `
    <div class="d-flex align-items-center">
        <div class="map-preview me-2" 
             style="width: 100px; background-color: #f8f9fa;"
             data-project='${JSON.stringify(project).replace(/'/g, "\\'")}'
             onclick="handleProjectMapClick(this)">
            <div class="w-100 h-100 d-flex align-items-center justify-content-center">
                <i class="bi bi-geo-alt-fill text-primary"></i>
            </div>
        </div>
        <button class="btn btn-sm btn-outline-primary" 
                data-project='${JSON.stringify(project).replace(/'/g, "\\'")}'
                onclick="handleProjectMapClick(this)">
            <i class="bi bi-eye"></i> View
        </button>
    </div>
`;
```

Add this helper function near your other utility functions:

```javascript
function handleProjectMapClick(element) {
    try {
        const projectData = element.getAttribute('data-project');
        if (projectData) {
            const project = JSON.parse(projectData);
            showProjectInModal(project);
        }
    } catch (error) {
        console.error('Error parsing project data:', error);
        showToast('Error', 'Could not load project location', 'error');
    }
}
```

Debugging the Current State

To see what's actually happening, add this debug code to your showProjectInModal() function:

```javascript
function showProjectInModal(project) {
    console.log('Project parameter type:', typeof project);
    console.log('Project parameter value:', project);
    
    // If project is a string, try to parse it
    if (typeof project === 'string') {
        console.log('Project is a string, attempting to parse...');
        try {
            project = JSON.parse(project);
            console.log('Parsed successfully:', project);
        } catch (e) {
            console.error('Failed to parse project string:', e);
            console.log('Raw string value:', project);
            showToast('Error', 'Invalid project data format', 'error');
            return;
        }
    }
    
    // Rest of your original function...
}
```

Quick Test Fix

As a quick test, modify the function to handle string inputs:

```javascript
function showProjectInModal(project) {
    // Handle string input
    if (typeof project === 'string') {
        try {
            // Clean up the string - remove any escaped quotes
            let cleanStr = project.replace(/&quot;/g, '"');
            project = JSON.parse(cleanStr);
        } catch (e) {
            console.error('Failed to parse project string:', e, 'Raw:', project);
            showToast('Error', 'Could not load project data', 'error');
            return;
        }
    }
    
    // Now continue with your original function code
    const modalTitle = document.getElementById('projectMapModalTitle');
    const modalMapContainer = document.getElementById('modalProjectMap');
    const modalCoordinates = document.getElementById('modalCoordinates');
    
    // ... rest of your existing function
}
```

The Core Issue

The real problem is that when you do:

```javascript
onclick="showProjectInModal(${JSON.stringify(project).replace(/"/g, '&quot;')})"
```

It generates HTML like:

```html
onclick="showProjectInModal({&quot;id&quot;:&quot;1&quot;,&quot;name&quot;:&quot;Burnie Coastal Restoration&quot;,...})"
```

Which calls showProjectInModal() with a string starting with { instead of a JavaScript object.

The simplest fix is to update just the showProjectInModal() function to handle both string and object inputs:

```javascript
function showProjectInModal(project) {
    // DEBUG: Check what we're receiving
    console.log('Received:', project, 'Type:', typeof project);
    
    // If it's a string that looks like JSON, parse it
    if (typeof project === 'string' && (project.startsWith('{') || project.startsWith('['))) {
        try {
            // First, fix the escaped quotes
            const fixedString = project.replace(/&quot;/g, '"').replace(/\\'/g, "'");
            project = JSON.parse(fixedString);
            console.log('Parsed to:', project);
        } catch (e) {
            console.error('Parse error:', e);
            showToast('Error', 'Invalid project data', 'error');
            return;
        }
    }
    
    // Now we should have an object
    if (typeof project !== 'object' || project === null) {
        console.error('Invalid project data after processing:', project);
        showToast('Error', 'Could not load project', 'error');
        return;
    }
    
    // Continue with your original modal code...
    const modalTitle = document.getElementById('projectMapModalTitle');
    const modalMapContainer = document.getElementById('modalProjectMap');
    const modalCoordinates = document.getElementById('modalCoordinates');
    
    modalTitle.textContent = `${project.name} Location`;
    
    // Clear previous map
    if (modalProjectMap) {
        modalProjectMap.remove();
        modalProjectMap = null;
    }
    
    // Clear container
    modalMapContainer.innerHTML = '';
    
    // Show modal first
    const modal = new bootstrap.Modal(document.getElementById('projectMapModal'));
    modal.show();
    
    // Initialize map after modal is shown
    setTimeout(() => {
        // Create map container
        modalMapContainer.innerHTML = '<div id="modalMap" style="height: 100%; width: 100%;"></div>';
        
        // Initialize map
        let lat = -41.0521;
        let lng = 145.9061;
        let zoom = 11;
        
        if (project.latitude && project.longitude) {
            lat = parseFloat(project.latitude);
            lng = parseFloat(project.longitude);
            zoom = 13;
            modalCoordinates.textContent = `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        } else {
            modalCoordinates.textContent = 'Coordinates: Not specified';
        }
        
        modalProjectMap = L.map('modalMap').setView([lat, lng], zoom);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(modalProjectMap);
        
        if (project.latitude && project.longitude) {
            modalProjectMarker = L.marker([lat, lng])
                .addTo(modalProjectMap)
                .bindPopup(project.name)
                .openPopup();
        }
        
        // Force resize
        setTimeout(() => {
            modalProjectMap.invalidateSize();
        }, 100);
    }, 300);
}
```

Try this updated showProjectInModal() function first. It should handle the string input issue that's causing the crash.
