Looking at your code, the issue with the broken QR code in student view is likely caused by the QR code URL being too long when embedding all the data in the URL. The data parameter with embedded JSON can easily exceed URL length limits for QR codes.

Here's the fix. Replace the sharePlan() method in your CoursePlanner class with this improved version:

```javascript
// ========== FIXED: SHARING ==========
sharePlan() {
    if (this.isStudentView) return;
    
    // Show saving indicator
    this.showToast('Saving data for sharing...', 'info');
    
    // Force immediate save
    const saveSuccess = this.saveData();
    
    if (!saveSuccess) {
        this.showToast('Failed to save data for sharing', 'error');
        return;
    }
    
    // Generate share URL with timestamp to prevent caching
    const baseUrl = window.location.origin + window.location.pathname;
    const timestamp = Date.now();
    
    // FIX 1: Create a minimal data version for QR codes
    const minimalData = {
        v: CONFIG.APP_VERSION,
        t: timestamp,
        u: this.units.length,
        w: this.courseData.totalWeeks
    };
    
    // FIX 2: Use localStorage-based URL for QR code (simpler, shorter)
    const qrUrl = `${baseUrl}?student=true&v=${timestamp}`;
    
    console.log('=== SHARE PLAN (FIXED) ===');
    console.log('QR URL (simple):', qrUrl);
    console.log('Data size:', qrUrl.length, 'characters');
    console.log('Storage key:', CONFIG.SHARED_STORAGE_KEY);
    
    // Show share panel
    const panel = document.getElementById('sharePanel');
    const input = document.getElementById('shareLink');
    const copyBtn = document.getElementById('copyShareLink');
    const qrContainer = document.getElementById('qrCode');
    
    // FIX 3: Use a reliable QR code service with proper error handling
    const qrService = 'https://api.qrserver.com/v1/create-qr-code/';
    const qrParams = new URLSearchParams({
        size: '150x150',
        data: qrUrl,
        qzone: 2,
        format: 'png',
        margin: 1,
        t: timestamp  // Cache buster
    });
    
    const qrImageUrl = `${qrService}?${qrParams.toString()}`;
    
    input.value = qrUrl;
    panel.classList.add('show');
    
    // FIX 4: Better QR code HTML with loading state and fallback
    qrContainer.innerHTML = `
        <div style="text-align: center;">
            <div id="qrLoading" style="padding: 20px; color: #666; font-size: 14px;">
                Generating QR code...
            </div>
            <img id="qrImage" 
                 src="${qrImageUrl}" 
                 alt="QR Code" 
                 style="display: none; border: 1px solid #ddd; border-radius: 6px; max-width: 150px; max-height: 150px;"
                 onload="document.getElementById('qrLoading').style.display='none'; this.style.display='block';"
                 onerror="document.getElementById('qrLoading').innerHTML='QR code failed to load. Try refreshing.'; console.error('QR code failed to load');">
            <div style="margin-top: 10px; font-size: 11px; color: #666;">
                Scan to view current schedule
            </div>
        </div>
        <div style="font-size: 12px; margin-top: 10px; color: #636e72;">
            <div style="margin-bottom: 5px;">Students will see:</div>
            <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 11px;">
                ‚Ä¢ Current schedule (${this.units.length} units, ${this.courseData.totalWeeks} weeks)<br>
                ‚Ä¢ Term overviews<br>
                ‚Ä¢ Unit details on click<br>
                ‚Ä¢ No editing controls
            </div>
            <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 11px;">
                <strong>Important:</strong> QR code uses your saved data. Make sure to save changes before sharing!
            </div>
            <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
                <button onclick="window.app.testStudentView('${qrUrl}')" 
                        style="width: 100%; padding: 8px; background: #00b894; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Test Student View (Browser)
                </button>
                <button onclick="window.open('${qrUrl}', '_blank')" 
                        style="width: 100%; padding: 8px; background: #0984e3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Open Student View in New Tab
                </button>
                <button onclick="window.app.refreshQRCode()" 
                        style="width: 100%; padding: 8px; background: #a29bfe; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    üîÑ Refresh QR Code
                </button>
                <button onclick="window.app.verifyDataSync()" 
                        style="width: 100%; padding: 8px; background: #fdcb6e; color: #2d3436; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    üîç Verify Data Sync
                </button>
            </div>
        </div>
    `;
    
    copyBtn.onclick = () => {
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(input.value).then(() => {
            this.showToast('Link copied to clipboard!', 'success');
        }).catch(() => {
            // Fallback for older browsers
            document.execCommand('copy');
            this.showToast('Link copied to clipboard!', 'success');
        });
    };
    
    this.showToast('Share link generated!', 'success');
    
    // Add a verification step
    setTimeout(() => {
        console.log('=== VERIFYING SHARED DATA ===');
        const storedData = localStorage.getItem(CONFIG.SHARED_STORAGE_KEY);
        if (storedData) {
            const data = JSON.parse(storedData);
            console.log('Data verified in storage:', {
                units: data.units?.length || 0,
                weeks: data.courseData?.totalWeeks || 0,
                timestamp: data.lastUpdate
            });
            console.log('URL length:', qrUrl.length, 'characters');
        } else {
            console.warn('No data found in shared storage!');
            this.showToast('Warning: No data saved to storage!', 'error');
        }
    }, 100);
}
```

Also, update the refreshQRCode() method:

```javascript
// ========== NEW: Improved Refresh QR Code ==========
refreshQRCode() {
    if (this.isStudentView) return;
    
    this.showToast('Refreshing QR code with latest data...', 'info');
    
    // Force save current data
    this.saveData();
    
    // Generate new URL with fresh timestamp
    const baseUrl = window.location.origin + window.location.pathname;
    const timestamp = Date.now();
    const qrUrl = `${baseUrl}?student=true&v=${timestamp}`;
    
    // Update QR code with fresh image
    const qrContainer = document.getElementById('qrCode');
    if (qrContainer) {
        const qrService = 'https://api.qrserver.com/v1/create-qr-code/';
        const qrParams = new URLSearchParams({
            size: '150x150',
            data: qrUrl,
            qzone: 2,
            format: 'png',
            margin: 1,
            t: timestamp  // Cache buster
        });
        
        const qrImageUrl = `${qrService}?${qrParams.toString()}`;
        
        // Find and update the QR code image
        const qrImg = qrContainer.querySelector('#qrImage');
        if (qrImg) {
            // Show loading state
            const qrLoading = qrContainer.querySelector('#qrLoading');
            if (qrLoading) {
                qrLoading.style.display = 'block';
                qrLoading.textContent = 'Refreshing QR code...';
            }
            qrImg.style.display = 'none';
            
            // Load new image
            qrImg.src = qrImageUrl;
            qrImg.onload = () => {
                if (qrLoading) qrLoading.style.display = 'none';
                qrImg.style.display = 'block';
                this.showToast('QR code refreshed with latest data!', 'success');
                console.log('QR code refreshed with timestamp:', timestamp);
                console.log('Data in storage:', this.units.length, 'units');
            };
            
            qrImg.onerror = () => {
                if (qrLoading) {
                    qrLoading.textContent = 'QR code refresh failed. Try again.';
                }
                this.showToast('Failed to refresh QR code', 'error');
            };
        }
    }
}
```

Key changes made:

1. Simplified QR URL: Instead of embedding all data in the URL (which was likely exceeding URL length limits), we now use a simple URL that relies on localStorage data.
2. Better QR Code Generation: Improved the QR code service parameters and added proper error handling.
3. Loading States: Added visual feedback while QR codes are loading.
4. Storage Verification: Added clearer verification that data is actually being saved to localStorage.
5. Shorter URLs: The QR code URL is now much shorter, making it more reliable for QR code generation.
6. Cache Busting: Added timestamp parameters to prevent caching issues.

The student view will now load data from localStorage using the CONFIG.SHARED_STORAGE_KEY ('course_planner_shared_data'), which should work correctly as long as:

1. You save data before sharing
2. The student accesses the page from the same browser/session context
3. You're not using incognito/private browsing (which isolates localStorage)

If you need cross-device sharing, you might want to consider server-side storage, but for a single-teacher sharing with students scenario, this localStorage approach should work well when accessed on the same device or when the teacher has saved the data and students access it from the same shared computer.
